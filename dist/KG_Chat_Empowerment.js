// ==UserScript==
// @name         KG_Chat_Empowerment
// @namespace    klavogonki
// @version      1.0.0
// @description  Enhance the chat abilities
// @author       Patcher
// @match        *://klavogonki.ru/g*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=klavogonki.ru
// @updateURL    https://raw.githubusercontent.com/VimiummuimiV/KG_Goddies/refs/heads/master/KG_Chat_Empowerment.js
// @downloadURL  https://raw.githubusercontent.com/VimiummuimiV/KG_Goddies/refs/heads/master/KG_Chat_Empowerment.js
// @grant        none
// ==/UserScript==

(()=>{"use strict";const e="http://www.w3.org/2000/svg",t=`\n  <svg xmlns="${e}"\n      width="16"\n      height="16"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="currentColor"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="icon-enter icon-feather icon-log-in">\n    <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>\n    <polyline points="10 17 15 12 10 7"></polyline>\n    <line x1="15" y1="12" x2="3" y2="12"></line>\n  </svg>`,n=`\n  <svg xmlns="${e}"\n      width="16"\n      height="16"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="currentColor" stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="icon-leave icon-feather icon-log-out">\n    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>\n    <polyline points="16 17 21 12 16 7"></polyline>\n    <line x1="21" y1="12" x2="9" y2="12"></line>\n  </svg>`,o=`\n  <svg xmlns="${e}"\n      width="18"\n      height="18"\n      viewBox="0 0 24 24"\n      fill="url(#moderatorGradient)"  \x3c!-- Use a gradient fill --\x3e\n      stroke="none"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-shield">\n    \x3c!-- Define the gradient --\x3e\n    <defs>\n        <linearGradient id="moderatorGradient" x1="0%" y1="0%" x2="0%" y2="100%">\n            <stop offset="0%" style="stop-color: rgb(255, 215, 0); stop-opacity: 1" />\n            <stop offset="100%" style="stop-color: rgb(255, 140, 0); stop-opacity: 1" />\n        </linearGradient>\n    </defs>\n    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>\n  </svg>`,s=`\n  <svg xmlns="${e}"\n       width="16"\n       height="16"\n       viewBox="0 0 24 24"\n       fill="url(#trackedGradient)"  \x3c!-- Use a gradient fill --\x3e\n       class="feather feather-star">\n      \x3c!-- Define the gradient for the fill --\x3e\n    <defs>\n      <linearGradient id="trackedGradient" x1="0%" y1="0%" x2="0%" y2="100%">\n        <stop offset="0%" style="stop-color: rgb(135, 206, 250); stop-opacity: 1" />\n        <stop offset="100%" style="stop-color: rgb(0, 191, 255); stop-opacity: 1" />\n      </linearGradient>\n    </defs>\n    \x3c!-- Use the gradient for the fill --\x3e\n    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"\n      stroke="url(#trackedGradient)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round">\n    </polygon>\n  </svg>`,r=`\n  <svg xmlns="${e}"\n      width="16"\n      height="16"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(255, 160, 122)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-slash">\n    <circle cx="12" cy="12" r="10"></circle>\n    <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>\n  </svg>`,a=`\n  <svg xmlns="${e}"\n       width="16"\n       height="16"\n       viewBox="0 0 24 24"\n       fill="none"\n       stroke="currentColor"\n       stroke-width="2"\n       stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock">\n    <circle cx="12" cy="12" r="10"></circle>\n    <polyline points="12 6 12 12 16 14"></polyline>\n  </svg>`,l=`\n    <svg xmlns="${e}"\n        width="16"\n        height="16"\n        viewBox="0 0 24 24"\n        fill="none"\n        stroke="currentColor"\n        stroke-width="2"\n        stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right">\n      <polyline points="9 18 15 12 9 6"></polyline>\n    </svg>`,i=`\n  <svg xmlns="${e}"\n      width="16"\n      height="16"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="currentColor"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-user">\n    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>\n    <circle cx="12" cy="7" r="4"></circle>\n  </svg>`,c=`\n  <svg xmlns="${e}"\n      width="28"\n      height="28"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="hsl(355, 80%, 65%)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round">\n    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>\n    <line x1="23" y1="9" x2="17" y2="15"></line>\n    <line x1="17" y1="9" x2="23" y2="15"></line>\n  </svg>`,d=`\n  <svg xmlns="${e}"\n      width="28"\n      height="28"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="hsl(55, 80%, 65%)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round">\n    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>\n    <path d="M19.07 4.93a10 10 0 0 1 0 14.14" opacity="0.3"></path>\n    <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>\n  </svg>`,m=`\n  <svg xmlns="${e}"\n      width="28"\n      height="28"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="hsl(80, 80%, 40%)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round">\n    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>\n    <path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>\n    <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>\n  </svg>`,u=`\n  <svg xmlns="${e}"\n      width="28"\n      height="28"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="hsl(100, 50%, 50%)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round">\n    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>\n    <circle cx="9" cy="7" r="4"></circle>\n    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>\n    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>\n  </svg>`,p=`\n  <svg xmlns="${e}"\n      width="28"\n      height="28"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="hsl(180, 60%, 50%)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round">\n    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>\n    <circle cx="12" cy="7" r="4"></circle>\n  </svg>`,g=`\n  <svg xmlns="${e}"\n      width="16"\n      height="16"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="currentColor"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-slash">\n    <circle cx="12" cy="12" r="10"></circle>\n    <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>\n  </svg>`,y=`\n  <svg xmlns="${e}"\n      width="28"\n      height="28"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(180, 213, 131)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-database">\n    <ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>\n    <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path>\n    <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path>\n  </svg>`,h=`\n  <svg xmlns="${e}"\n      width="28"\n      height="28"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(255, 160, 122)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-mail">\n    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>\n    <polyline points="22,6 12,13 2,6"></polyline>\n  </svg>`,f=`\n  <svg xmlns="${e}"\n      width="28"\n      height="28"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(100, 149, 237)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-message-circle">\n      <path \n          d="M21 11.5 a8.38 8.38 0 0 1 -.9 3.8 a8.5 8.5 0 0 1 -7.6 4.7 a8.38 8.38 0 0 1 -3.8 -.9\n          L3 21 l1.9 -5.7 a8.38 8.38 0 0 1 -.9 -3.8 a8.5 8.5 0 0 1 4.7 -7.6\n          a8.38 8.38 0 0 1 3.8 -.9 h.5 a8.48 8.48 0 0 1 8 8 v.5 z">\n      </path>\n  </svg>`,v=`\n  <svg xmlns="${e}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(113, 196, 196)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-film">\n    <rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"></rect>\n    <line x1="7" y1="2" x2="7" y2="22"></line>\n    <line x1="17" y1="2" x2="17" y2="22"></line>\n    <line x1="2" y1="12" x2="22" y2="12"></line>\n    <line x1="2" y1="7" x2="7" y2="7"></line>\n    <line x1="2" y1="17" x2="7" y2="17"></line>\n    <line x1="17" y1="17" x2="22" y2="17"></line>\n    <line x1="17" y1="7" x2="22" y2="7"></line>\n  </svg>`,x=`\n  <svg xmlns="${e}"\n      width="16"\n      height="16"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(255, 100, 100)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-slash">\n    <circle cx="12" cy="12" r="10"></circle>\n    <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>\n  </svg>`,b=`\n  <svg xmlns="${e}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(255, 228, 196)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-sliders">\n    <line x1="4" y1="21" x2="4" y2="14"></line>\n    <line x1="4" y1="10" x2="4" y2="3"></line>\n    <line x1="12" y1="21" x2="12" y2="12"></line>\n    <line x1="12" y1="8" x2="12" y2="3"></line>\n    <line x1="20" y1="21" x2="20" y2="16"></line>\n    <line x1="20" y1="12" x2="20" y2="3"></line>\n    <line x1="1" y1="14" x2="7" y2="14"></line>\n    <line x1="9" y1="8" x2="15" y2="8"></line>\n    <line x1="17" y1="16" x2="23" y2="16"></line>\n  </svg>`,w=`\n  <svg xmlns="${e}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(144, 238, 144)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-x">\n    <line x1="18" y1="6" x2="6" y2="18"></line>\n    <line x1="6" y1="6" x2="18" y2="18"></line>\n  </svg>`,S="rgb(211, 211, 211)",C=`\n  <svg xmlns="${e}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="${S}"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevrons-up">\n    <polyline points="17 11 12 6 7 11"></polyline>\n    <polyline points="17 18 12 13 7 18"></polyline>\n  </svg>`,k=`\n  <svg xmlns="${e}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="${S}"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-up">\n    <polyline points="18 15 12 9 6 15"></polyline>\n  </svg>`,E=`\n  <svg xmlns="${e}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="${S}"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down">\n    <polyline points="6 9 12 15 18 9"></polyline>\n  </svg>`,L=`\n  <svg xmlns="${e}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="${S}"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevrons-down">\n    <polyline points="7 13 12 18 17 13"></polyline>\n    <polyline points="7 6 12 11 17 6"></polyline>\n  </svg>`,$=`\n  <svg xmlns="${e}"\n      width="24"\n      height="24"\n      viewBox="0 0 25 25"\n      fill="none"\n      stroke="rgb(137, 187, 255)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-toggle-right">\n    <rect x="1" y="5" width="22" height="14" rx="7" ry="7"></rect>\n    <circle cx="16" cy="12" r="3"></circle>\n  </svg>`,T=`\n  <svg xmlns="${e}"\n      width="24"\n      height="24"\n      viewBox="0 0 25 25"\n      fill="none"\n      stroke="rgb(137, 187, 255)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-toggle-left">\n    <rect x="1" y="5" width="22" height="14" rx="7" ry="7"></rect>\n    <circle cx="8" cy="12" r="3"></circle>\n  </svg>`,M=`\n  <svg xmlns="${e}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(176, 196, 222)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar">\n    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>\n    <line x1="16" y1="2" x2="16" y2="6"></line>\n    <line x1="8" y1="2" x2="8" y2="6"></line>\n    <line x1="3" y1="10" x2="21" y2="10"></line>\n  </svg>`,N=`\n  <svg xmlns="${e}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(176, 196, 222)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-clipboard">\n    <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>\n    <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>\n  </svg>`,q=`\n  <svg xmlns="${e}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(28, 229, 229)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-left">\n    <polyline points="15 18 9 12 15 6"></polyline>\n  </svg>`,I=`\n  <svg xmlns="${e}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(28, 229, 229)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right">\n      <polyline points="9 18 15 12 9 6"></polyline>\n  </svg>`,A=`\n  <svg xmlns="${e}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(169, 155, 255)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-shuffle">\n    <polyline points="16 3 21 3 21 8"></polyline>\n    <line x1="4" y1="20" x2="21" y2="3"></line>\n    <polyline points="21 16 21 21 16 21"></polyline>\n    <line x1="15" y1="15" x2="21" y2="21"></line>\n    <line x1="4" y1="4" x2="9" y2="9"></line>\n  </svg>`,j=`\n  <svg xmlns="${e}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(255, 140, 0)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-trash-2">\n    <polyline points="3 6 5 6 21 6"></polyline>\n    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>\n    <line x1="10" y1="11" x2="10" y2="17"></line>\n    <line x1="14" y1="11" x2="14" y2="17"></line>\n  </svg>`,O=`\n  <svg xmlns="${e}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="currentColor"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-users">\n    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>\n    <circle cx="9" cy="7" r="4"></circle>\n    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>\n    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>\n  </svg>`,P=`\n  <svg xmlns="${e}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(209, 144, 238)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-download">\n    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>\n    <polyline points="7 10 12 15 17 10"></polyline>\n    <line x1="12" y1="15" x2="12" y2="3"></line>\n  </svg>`,B=`\n  <svg xmlns="${e}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(144, 185, 238)"\n      stroke-width="2" stroke-linecap="round"\n      stroke-linejoin="round" class="feather feather-upload">\n    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>\n    <polyline points="17 8 12 3 7 8"></polyline>\n    <line x1="12" y1="3" x2="12" y2="15"></line>\n  </svg>`,H=`\n  <svg xmlns="${e}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(144, 238, 220)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-save">\n    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>\n    <polyline points="17 21 17 13 7 13 7 21"></polyline>\n    <polyline points="7 3 7 8 15 8"></polyline>\n  </svg>`,D=`\n  <svg xmlns="${e}"\n      width="16"\n      height="16"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(238, 144, 144)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-trash">\n    <polyline points="3 6 5 6 21 6"></polyline>\n    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>\n  </svg>`,F=`\n  <svg xmlns="${e}"\n      width="20"\n      height="20"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(176, 196, 222)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-snowflake">\n    <g id="snowflake">\n      <line x1="12.06" y1="2.74" x2="12.06" y2="12.06" />\n      <line x1="20.12" y1="7.4" x2="12.06" y2="12.06" />\n      <line x1="20.12" y1="16.71" x2="12.06" y2="12.06" />\n      <line x1="12.06" y1="21.37" x2="12.06" y2="12.06" />\n      <line x1="3.99" y1="16.71" x2="12.06" y2="12.06" />\n      <line x1="3.99" y1="7.4" x2="12.06" y2="12.06" />\n      <polyline points="8.96,4.67 12.06,7.77 15.16,4.67"/>\n      <polyline points="16.9,5.68 15.76,9.92 20,11.05"/>\n      <polyline points="20,13.06 15.76,14.2 16.9,18.43"/>\n      <polyline points="15.16,19.44 12.06,16.34 8.96,19.44"/>\n      <polyline points="7.21,18.43 8.35,14.2 4.11,13.06"/>\n      <polyline points="4.11,11.05 8.35,9.92 7.21,5.68"/>\n    </g>\n  </svg>`,U=`\n  <svg xmlns="${e}"\n      width="16"\n      height="16"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(209, 144, 238)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-plus">\n    <line x1="12" y1="5" x2="12" y2="19"></line>\n    <line x1="5" y1="12" x2="19" y2="12"></line>\n  </svg>`;!function(){const e=document.createElement("style");e.classList.add("empowerment-global-styles"),e.innerHTML="\n    /* input error indication */\n    .input-error {\n      transition: background-color 300ms ease-in-out;\n      background-color: #6b2f2f !important;\n    }\n    /* chat length popup on field type with dynamic movement horizontally */\n    .length-field-popup {\n      position: absolute;\n      font: bold 12px Montserrat;\n      bottom: 40px;\n      transition: left 100ms ease-out;\n      height: 20px;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      padding: 2px 4px;\n      margin: 2px;\n      opacity: 0;\n    }\n\n    .bounce-in {\n      animation: bounceIn 500ms forwards;\n    }\n\n    @keyframes bounceIn {\n      0% { transform: translateY(0); opacity: 0; }\n      50% { transform: translateY(-10px); opacity: 1; }\n      100% { transform: translateY(0); opacity: 1; }\n    }\n\n    .bounce-out {\n      animation: bounceOut 500ms forwards;\n    }\n\n    @keyframes bounceOut {\n      0% { transform: translateY(0); opacity: 1; }\n      50% { transform: translateY(-10px); opacity: 1; }\n      100% { transform: translateY(0); opacity: 0; }\n    }\n\n    /* catalogs panel && personal messages panel messages anchors color */\n    .chat-logs-panel .message-text a,\n    .cached-messages-panel .message-text a {\n      color: burlywood !important;\n      transition: color 0.15s ease-in-out;\n    }\n\n    .chat-logs-panel .message-text a:hover,\n    .cached-messages-panel .message-text a:hover {\n      color: lightgoldenrodyellow !important;\n    }\n\n    /* clickable thumbnail hover effect */\n    .thumbnail {\n      opacity: 1;\n      transition: opacity 0.15s ease-in-out;\n    }\n    .thumbnail:hover {\n      opacity: 0.8;\n    }\n    \n    /* element animations */\n    .pulse-effect {\n      animation: pulse 500ms ease-out; \n    }\n\n    @keyframes pulse {\n      0% { filter: brightness(1); }\n      50% { filter: brightness(1.5); }\n      100% { filter: brightness(1); }\n    }\n\n    .shake-effect {\n      animation: shake 500ms cubic-bezier(0.36, 0.07, 0.19, 0.97) both;\n    }\n\n    @keyframes shake {\n      0% { transform: translateX(0); }\n      10% { transform: translateX(-4px); }\n      20% { transform: translateX(6px); }\n      30% { transform: translateX(-8px); }\n      40% { transform: translateX(8px); }\n      50% { transform: translateX(-6px); }\n      60% { transform: translateX(5px); }\n      70% { transform: translateX(-3px); }\n      80% { transform: translateX(2px); }\n      90% { transform: translateX(-1px); }\n      100% { transform: translateX(0); }\n    }\n  ",document.head.appendChild(e);const S=document.querySelector(".userpanel .user-block .user-dropdown .name span").textContent,J=document.querySelector("a.drop-btn.mail")?.href?.match(/\/u\/#\/(\d+)\/messages\//)?.[1],z=new Intl.DateTimeFormat("en-CA").format(new Date);function R(e,t){if(!document.querySelector(`.font-${e.replace(/\s/g,"-")}`)){const n=document.createElement("link");n.rel="stylesheet",n.href=`https://fonts.googleapis.com/css2?family=${e.replace(/\s/g,"+")}:wght@${t.join(";")}&display=swap`,n.classList.add(`font-${e.replace(/\s/g,"-")}`),document.head.appendChild(n)}}R("Montserrat",["100","200","300","400","500","600","700","800","900"]),R("Orbitron",["400","500","600","700","800","900"]),R("Roboto Mono",["100","200","300","400","500","600","700"]);let _=JSON.parse(localStorage.getItem("KG_Chat_Empowerment"));_||(_={voiceSettings:{voiceSpeed:1.5,voicePitch:1},messageSettings:{}},localStorage.setItem("KG_Chat_Empowerment",JSON.stringify(_)));let K=null!==_.voiceSettings.voiceSpeed?_.voiceSettings.voiceSpeed:1.5,W=null!==_.voiceSettings.voicePitch?_.voiceSettings.voicePitch:1;const X="https://klavogonki.ru/u/#/";let V=[{name:"Даниэль",gender:"Male",pronunciation:"Даниэль",state:"thawed"}],Y=[],G=[],Z=[],Q=[],ee=[];const te=JSON.parse(localStorage.getItem("usersToTrack"))||[],ne=JSON.parse(localStorage.getItem("mentionKeywords"))||[],oe=JSON.parse(localStorage.getItem("usernameReplacements"))||[],se=JSON.parse(localStorage.getItem("moderator"))||[],re=JSON.parse(localStorage.getItem("ignored"))||[];V=te?.length?te:V,Y=ne?.length?ne:Y,G=oe?.length?oe:G,Z=se?.length?se:Z,Q=re?.length?re:Q,Y.push(S);let ae=!1,le=!1;function ie(e){e.style.width="48px",e.style.height="48px",e.style.display="flex",e.style.justifyContent="center",e.style.alignItems="center",e.style.cursor="pointer",e.style.setProperty("border-radius","0.2em","important"),e.style.backgroundColor="#282b2f",e.style.margin="0.5em 0",e.style.filter="brightness(1)",e.style.transition="filter 0.3s ease"}function ce({container:e,buttons:t}){const n=0===e.scrollTop,o=e.scrollTop+e.clientHeight>=e.scrollHeight-3;[t.fullScrollUpButton,t.partialScrollUpButton].forEach((e=>{e.style.opacity=n?"0.3":"1",e.style.pointerEvents=n?"none":"auto"})),[t.fullScrollDownButton,t.partialScrollDownButton].forEach((e=>{e.style.opacity=o?"0.3":"1",e.style.pointerEvents=o?"none":"auto"}))}function de({container:e,scrollButtonsContainer:t}){e.scrollHeight>e.clientHeight?t.style.display="flex":t.style.display="none"}function me(e){const t=document.createElement("div");t.className="scroll-buttons-container",t.style.display="flex",t.style.justifyContent="center",t.style.gridArea="scroll",t.style.flexDirection="column",t.style.height="calc(100% - 1em)",t.style.padding="1em";const n=document.createElement("div");n.innerHTML=C,ie(n),n.title="Scroll Up (Full)",t.appendChild(n);const o=document.createElement("div");o.innerHTML=k,ie(o),o.title="Scroll Up (Partial)",t.appendChild(o);const s=document.createElement("div");s.innerHTML=E,ie(s),s.title="Scroll Down (Partial)",t.appendChild(s);const r=document.createElement("div");r.innerHTML=L,ie(r),r.title="Scroll Down (Full)",t.appendChild(r);const a={fullScrollUpButton:n,partialScrollUpButton:o,partialScrollDownButton:s,fullScrollDownButton:r};function l(t,n){const o=n?e.scrollHeight:e.clientHeight;e.scrollBy({top:"up"===t?-o:o,behavior:"smooth"}),ce({container:e,buttons:a})}return n.addEventListener("click",(()=>l("up",!0))),o.addEventListener("click",(()=>l("up",!1))),s.addEventListener("click",(()=>l("down",!1))),r.addEventListener("click",(()=>l("down",!0))),ce({container:e,buttons:a}),de({container:e,scrollButtonsContainer:t}),e.addEventListener("scroll",(()=>{ce({container:e,buttons:a}),de({container:e,scrollButtonsContainer:t})})),{scrollButtonsContainer:t,...a}}["keydown","keyup"].forEach((e=>document.addEventListener(e,(t=>{return n=t.key,o="keydown"===e,"Control"===n&&(ae=o),void("Alt"===n&&(le=o));var n,o})))),["blur","focus"].forEach((e=>document.addEventListener(e,(()=>{(ae||le)&&(console.log(`${ae?"Ctrl ":""}${le?"Alt ":""}key was true`),ae=le=!1)}))));const ue=function(){const e=new AudioContext;return new Promise((t=>{e.onstatechange=function(){"running"===e.state&&t(e)}}))}(),pe=[300,600],ge=[600,300],ye=[500],he=[600,800],fe=.2,ve=100;function xe(e,t){ue.then((n=>{for(let o=0;o<e.length;o++){const s=e[o];if(0===s)setTimeout((()=>{}),80);else{const e=n.createOscillator(),r=n.createGain();e.connect(r),e.frequency.value=s,e.type="sine";const a=n.createBiquadFilter();a.type="lowpass",a.frequency.value=250,e.connect(a);const l=n.createBiquadFilter();l.type="highpass",l.frequency.value=16e3,a.connect(l),r.connect(n.destination),r.gain.setValueAtTime(0,n.currentTime),r.gain.linearRampToValueAtTime(t,n.currentTime+.01),e.start(n.currentTime+o*ve/1e3),e.stop(n.currentTime+(o*ve+80)/1e3),r.gain.setValueAtTime(t,n.currentTime+(o*ve+70)/1e3),r.gain.linearRampToValueAtTime(0,n.currentTime+(o*ve+80)/1e3)}}}))}const be=new Promise((e=>{const t=window.speechSynthesis;let n=t.getVoices();const o="Microsoft Pavel - Russian (Russia)",s="Microsoft Irina - Russian (Russia)";let r=n.find((e=>e.name===o)),a=n.find((e=>e.name===s));if(r&&a&&0!==n.length){const o=new SpeechSynthesisUtterance;o.lang="ru-RU",o.voice=a,e({synth:t,utterance:o,voices:n,pavelVoice:r,irinaVoice:a})}else t.addEventListener("voiceschanged",(()=>{if(n=t.getVoices(),r=n.find((e=>e.name===o)),a=n.find((e=>e.name===s)),r&&a){const o=new SpeechSynthesisUtterance;o.lang="ru-RU",o.voice=a,e({synth:t,utterance:o,voices:n,pavelVoice:r,irinaVoice:a})}}))}));async function we(e,t=t){const n=Le("sound","gTTS"),o=await async function(e){return e.replace(/[-−_]/g," ").replace(/https?:\/\/(?:www\.)?([a-zA-Z0-9.-]+)(\/.*)?/g,((e,t)=>t)).replace(/\s(?=[?!,.:;@])/g,"").replace(/["#$%&'()*+\/<=>[\\\]^`{|}~]/g,"").split(" ").filter(Boolean).join(" ").trim()}(e);if(n){const e=(e=>e.split(/\s+/).reduce(((e,t)=>{const n=/[А-Яа-яЁё0-9]/.test(t)?"ru":"en";return e.length&&e[e.length-1].lang===n?e[e.length-1].text+=" "+t:e.push({lang:n,text:t}),e}),[]))(o);try{for(const{lang:t,text:n}of e)await new Promise(((e,o)=>{fetch(`http://127.0.0.1:5000/speak?text=${encodeURIComponent(n)}&lang=${t}`).then((e=>{if(!e.ok)throw new Error(`HTTP ${e.status}`);return e.arrayBuffer()})).then((t=>{const n=new(window.AudioContext||window.webkitAudioContext),s=new Audio(URL.createObjectURL(new Blob([t],{type:"audio/mp3"}))),r=n.createMediaElementSource(s),a=n.createGain();a.gain.value=2,r.connect(a),a.connect(n.destination),s.onended=e,s.onerror=o,s.play()})).catch(o)}))}catch(e){console.error("Server TTS failed:",e)}}else await async function(e,t=t){const{synth:n,utterance:o,voice:s}=await be;return Object.assign(o,{text:e,rate:t,volume:.8,pitch:W,voice:s}),new Promise((e=>{o.onend=e,n.speak(o)}))}(e,t)}const Se={Male:{enter:"зашёл",leave:"вышел"},Female:{enter:"зашла",leave:"вышла"}};function Ce(e=180,t=50,n=50){return`hsl(${e},${t}%,${n}%)`}const ke=e=>new Promise((t=>setTimeout(t,e)));function Ee(e,t){const n=t.getBoundingClientRect(),o=e.getBoundingClientRect();return o.top>=n.top&&o.bottom<=n.bottom}function Le(e,t){const n=JSON.parse(localStorage.getItem("toggle"))||[],o={notifications:{static:"showChatStaticNotifications",dynamic:"showGlobalDynamicNotifications"},sound:{presence:"enableBeepOnChatJoinLeave",gTTS:"switchToGoogleTTSEngine"}}[e];return!(!o||!o[t])&&n.some((e=>e.name===o[t]&&"yes"===e.option))}function $e(){return(new Date).toLocaleTimeString("en-US",{hour12:!1,hour:"2-digit",minute:"2-digit",second:"2-digit"})}function Te(e,t){const n=Object.values(JSON.parse(localStorage.getItem("fetchedUsers")||"[]")).find((t=>t?.login===e));if(!n)return`❌ User "${e}" not found`;const o=n.actionLog||[],s=o.find((e=>e.timestamp===t));if(!s)return`Action not found at ${t}`;const r=o.indexOf(s);if(0===r)return`🙌 ${e}'s first action`;const a=o.slice(0,r).reverse().find((e=>e.type!==s.type));if(!a)return`❌ No valid previous action found for ${t}`;const l=function(e,t){const n=e=>e.split(":").reduce(((e,t,n)=>e+t*[3600,60,1][n]),0),o=Math.abs(n(t)-n(e));return[Math.floor(o/3600),Math.floor(o%3600/60),o%60].map((e=>e.toString().padStart(2,"0"))).join(":")}(a.timestamp,s.timestamp);return"leave"===s.type?`🛑 ${e} stayed in chat for ${l}`:`✅ ${e} was absent for ${l}`}let Me=null,Ne=null,qe=null,Ie=!1,Ae=!1,je=null;const Oe=e=>{Me&&(Me.style.left=`${e.clientX+0}px`,Me.style.top=`${e.clientY+18}px`)},Pe=()=>{Ie=!1,je=null,clearTimeout(qe),qe=null,clearTimeout(Ne),Ne=setTimeout((()=>{Me&&(Me.style.opacity="0",Ae=!1,setTimeout((()=>{!Ie&&Me&&(Me.style.display="none",document.removeEventListener("mousemove",Oe))}),50))}),100)};function Be(e,t){e.classList.contains("events-included")||(e.classList.add("events-included"),Me||=(()=>{const e=document.createElement("div");return e.classList.add("tooltip"),Object.assign(e.style,{position:"fixed",background:"rgb(22, 22, 22)",color:"rgb(222, 222, 222)",padding:"0.5em",zIndex:1200,fontSize:"0.9em",pointerEvents:"none",whiteSpace:"nowrap",opacity:0,transition:"opacity 0.1s",display:"none",left:0,top:0}),e.style.setProperty("border","1px solid rgb(60, 60, 60)","important"),e.style.setProperty("border-radius","4px","important"),e.style.setProperty("box-shadow","0 2px 5px rgba(0,0,0,0.3)","important"),document.body.appendChild(e),e})(),e.addEventListener("mouseenter",(n=>{Ie=!0,je=e,clearTimeout(qe),clearTimeout(Ne),Me.textContent=t,document.addEventListener("mousemove",Oe),Oe(n),Ae||(qe=setTimeout((()=>{Me.style.display="flex",Me.style.opacity="1",Ae=!0}),600))})),e.addEventListener("mouseleave",Pe))}function He(e){const t=document.createElement("div");return t.classList.add("action-icon"),t.style.margin="0 4px",t.style.setProperty("border","none","important"),t.innerHTML=e,t}function De(e,t,n,o,s){const r={generalChat:".messages-content div",cachePanel:".fetched-users .action-log"}[s];if(!r)return void console.error("Invalid or missing container. Please provide 'generalChat' or 'cachePanel'.");const a=document.querySelector(r);if(!a)return void console.error("Container not found in DOM.");a.classList.add("generalChat"===s?"static-chat-notifications-container":"static-cache-notifications-container");const l=document.createElement("div");l.classList.add("static-chat-notification"),"generalChat"===s&&l.addEventListener("dblclick",(()=>{!async function(e=40,t=600,n=140){const o=document.querySelector(".messages-content");if(!o)return;const s=o.style.scrollBehavior;o.style.scrollBehavior="smooth";const r=[...document.querySelectorAll(".static-chat-notification")].reverse();for(const s of r)!Ee(s,o)&&(o.scrollTop=s.offsetTop-o.offsetTop-o.clientHeight/2,await ke(t)),Object.assign(s.style,{transition:[`opacity ${n/1e3}s cubic-bezier(.3,.1,1,.1)`,`transform ${n/1e3}s cubic-bezier(0,.7,.3,0.95)`].join(","),opacity:0,transformOrigin:"left",transform:"translateX(8em) skewX(-20deg)"}),await ke(n),s.remove(),await ke(e);o.scrollHeight-o.scrollTop<=o.clientHeight||(o.scrollTop=o.scrollHeight,await ke(t)),o.style.scrollBehavior=s}()}));const i=document.createElement("span");i.classList.add("action-user"),i.textContent=e;const c=He(t),d=document.createElement("span");d.classList.add("action-time"),d.textContent=n,l.appendChild(i),l.appendChild(c),l.appendChild(d),l.dataset.username=e,l.dataset.time=n,o?(l.classList.add("user-entered"),l.style.color=Ce(100,50,50),l.style.backgroundColor=Ce(100,50,10),l.style.setProperty("border",`1px solid ${Ce(100,50,25)}`,"important")):(l.classList.add("user-left"),l.style.color=Ce(0,50,70),l.style.backgroundColor=Ce(0,50,15),l.style.setProperty("border",`1px solid ${Ce(0,50,40)}`,"important")),l.style.cursor="default",l.style.whiteSpace="nowrap",l.style.padding="8px",l.style.display="inline-flex",l.style.flex="auto",l.style.justifyContent="center",l.style.margin="4px",l.style.fontSize="1em",l.style.alignItems="center",l.style.setProperty("border-radius","4px","important"),a.appendChild(l),l.addEventListener("mouseover",(()=>{const e=Te(l.dataset.username,l.dataset.time);Be(l,e)}))}new MutationObserver((()=>{je&&!document.contains(je)&&Pe()})).observe(document,{childList:!0,subtree:!0});let Fe=null;const Ue=[];let Je=0,ze=!1;const Re="🎥",_e="🖥️",Ke="💀️️",We=["jpg","jpeg","png","gif","webp"],Xe=["klavogonki.ru","youtube.com","youtu.be","imgur.com","pikabu.ru","userapi.com","ibb.co","yaplakal.com","freepik.com"];function Ve(e){try{const t=new URL(e),n=t.hostname.toLowerCase().split("."),o=n.length>2?n.slice(-2).join("."):t.hostname;return{isTrusted:Xe.includes(o),domain:o}}catch(t){return console.error("Error in isTrustedDomain:",t.message),{isTrusted:!1,domain:e}}}function Ye(e){const t=document.querySelector({generalMessages:".messages-content div",chatlogsMessages:".chat-logs-container",personalMessages:".messages-container-wrapper"}[e]);if(!t)return;const n=t.querySelectorAll("a:not(.skipped):not(.processed-image)");function o(t,n){const o=document.createElement("div");Object.assign(o.style,{border:"none",width:"6vw",minWidth:"100px",maxHeight:"200px",height:"auto",cursor:"pointer",backgroundColor:"transparent",padding:"2px",margin:"6px",overflowY:"auto"}),o.classList.add("thumbnail");const s=document.createElement("img");s.src=t.href,s.style.maxHeight="100%",s.style.maxWidth="100%",s.style.backgroundColor="transparent",s.onload=()=>{o.appendChild(s),t.parentNode.insertBefore(o,t.nextSibling),Ue.push({link:t,imgSrc:t.href}),Qt(e)},s.onerror=()=>{console.error("Failed to load image:",t.href),t.classList.add("skipped")},n?t.querySelector(".thumbnail")||t.addEventListener("click",(e=>{t.querySelector(".thumbnail")||(o.appendChild(s),t.parentNode.insertBefore(o,t.nextSibling))})):(o.appendChild(s),t.parentNode.insertBefore(o,t.nextSibling)),o.addEventListener("click",(e=>{e.stopPropagation(),Fe=function(e){const t=document.createElement("img");t.src=e,t.classList.add("scaled-thumbnail"),t.style.maxHeight="90vh",t.style.maxWidth="90vw",t.style.cursor="pointer",document.body.appendChild(t);const n=e=>{dt(e,"hide"),document.querySelector(".popup-panel")||ct("hide"),Ze()};Ge.unfocusedClick=function(e){t.contains(e.target)||(t.remove(),Ze())},document.addEventListener("click",Ge.unfocusedClick),Ge.keydown=function(e){"Escape"===e.code||"Space"===e.code?(e.preventDefault(),n(t)):"ArrowLeft"===e.code?Qe(-1):"ArrowRight"===e.code&&Qe(1)},document.addEventListener("keydown",Ge.keydown);let o=1,s=!1,r=0,a=0,l=-50,i=-50;return Ge.wheel=function(e){const n=e.deltaY;o+=.1*(n<0?1:-1)*o,o=Math.max(o,1),t.style.transformOrigin="center center",t.style.transform=`translate(${l}%, ${i}%) scale(${o})`,e.preventDefault()},Ge.mousemove=function(e){if(s){const n=(e.clientX-r)/o*5,s=(e.clientY-a)/o*5;l+=n/t.clientWidth*100,i+=s/t.clientHeight*100,t.style.transform=`translate(${l}%, ${i}%) scale(${o})`,r=e.clientX,a=e.clientY}},Ge.mousedown=function(e){const{button:o,clientX:l,clientY:i,target:c,ctrlKey:d}=e;if((0===o||2===o)&&c!==t)return;let m=c.src;0===o?d?window.open(m,"_blank"):Qe(-1):2===o?(e.preventDefault(),d?(navigator.clipboard.writeText(m).catch(console.error),n(t)):Qe(1)):1===o&&(s=!0,[r,a]=[l,i])},Ge.mouseup=function(){s=!1},Ge.contextmenu=function(e){e.preventDefault()},Object.entries(Ge).forEach((([e,t])=>{document.addEventListener(e,t)})),t}(s.src),Object.assign(Fe.style,{top:"50%",left:"50%",transform:"translate(-50%, -50%) scale(1)",position:"fixed",opacity:"0",zIndex:"999",transformOrigin:"center center"}),dt(Fe,"show"),ct("show")}))}n.length&&n.forEach((e=>{if(!e.href||!e.href.startsWith("http"))return;const{allowed:t,extension:n}=function(e){const t=e=>e.match(/\.([^?#.]+)(?:[?#]|$)/i)?.[1]?.toLowerCase()||"";try{const n=t(e);return{allowed:We.includes(n),extension:n}}catch(n){return console.error("Error in isAllowedImageExtension:",n.message),{allowed:!1,extension:t(String(e))}}}(e.href);if(!t)return;e.classList.add("media");const{isTrusted:s,domain:r}=Ve(e.href);e.title=nt(e.href)?ot(e.href):e.href,s?(e.textContent=`📸 Image (${n.toUpperCase()}) ${_e} Hostname (${r})`,e.classList.add("processed-image"),o(e,!1)):(e.classList.add("skipped"),e.textContent=`📸 Image (${n.toUpperCase()}) ${_e} Hostname (${r}) ${Ke} Untrusted`,e.addEventListener("click",(t=>{e.classList.contains("processed-image")||(t.preventDefault(),e.classList.remove("skipped"),e.classList.add("processed-image"),o(e,!0))})))}))}const Ge={};function Ze(){Object.entries(Ge).forEach((([e,t])=>{document.removeEventListener(e,t)}))}function Qe(e){const t=Je+e;if(t>=0&&t<Ue.length){if(ze)return;ze=!0,Fe&&(Fe.src=Ue[t].imgSrc),setTimeout((()=>{ze=!1}),50),Je=t}}const et=["mp4","webm","ogg","mov","avi"];function tt(e){const t={generalMessages:".messages-content div",chatlogsMessages:".chat-logs-container",personalMessages:".messages-container-wrapper"}[e];if(!t)return void console.error("Invalid container type specified");const n=document.querySelector(t);if(!n)return;const o=n.querySelectorAll("a:not(.skipped):not(.processed-video)");function s(t,n,o,s){const{youtubeMatch:r,videoType:a,videoId:l}=s,i=function(e){const t=e=>e.match(/\.([^?#.]+)(?:[?#]|$)/i)?.[1]?.toLowerCase()||"";try{const n=t(e);return{allowed:et.includes(n),extension:n}}catch(n){return console.error("Error in isAllowedVideoExtension:",n.message),{allowed:!1,extension:t(String(e))}}}(n);if(!r&&!i.allowed)return;t.classList.add("processed-video");const c=document.createElement("div");Object.assign(c.style,{display:"flex",width:"fit-content",flexDirection:"column",gap:"6px",marginBottom:"10px"});let d=document.createElement(r?"iframe":"video");Object.assign(d.style,{display:"flex",border:"none",height:"165px"}),r?(t.textContent=`${Re} ${a} ${_e} Hostname (${o})`,d.src=`https://www.youtube.com/embed/${l}`,d.allowFullscreen=!0):(t.textContent=`${Re} ${a} ${_e} Hostname (${o})`,d.src=n,d.controls=!0),t.title=nt(n)?ot(n):n,t.style.display="inline-flex",t.parentNode.insertBefore(c,t),c.append(t,d),Qt(e)}o.length&&o.forEach((e=>{const t=e.href;if(!t)return;const n=function(e){const t=e.match(/(?:shorts\/|live\/|watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/i);if(t)return{youtubeMatch:!0,videoId:t[1],videoType:e.includes("shorts/")?"Shorts":e.includes("live/")?"Live":e.includes("watch?v=")?"Watch":e.includes("youtu.be/")?"Share":"YouTube"};const n=e.split(".").pop().toLowerCase();return!!et.includes(n)&&{youtubeMatch:!1,videoType:`Video (${n.toUpperCase()})`}}(t);if(!n)return;e.classList.add("media");const{isTrusted:o,domain:r}=Ve(t);if(!o)return e.classList.add("skipped"),e.textContent=`${Re} ${n.videoType} ${_e} Hostname (${r}) ${Ke} Untrusted`,void e.addEventListener("click",(o=>{e.classList.contains("processed-video")||(o.preventDefault(),e.classList.remove("skipped"),s(e,t,r,n))}));s(e,t,r,n)}))}function nt(e){return/^https?:\/\//.test(e)&&/%[0-9A-Fa-f]{2}/.test(e)}function ot(e){const[t]=e.split("#");return decodeURIComponent(t).replace(/ /g,"_")}function st(e){document.querySelector({generalMessages:".messages-content div",chatlogsMessages:".chat-logs-container",personalMessages:".messages-container-wrapper"}[e])?.querySelectorAll("a:not(.media):not(.decoded)").forEach((e=>{try{if(nt(e.href)){let t=ot(e.href);e.href=e.textContent=t,e.classList.add("decoded")}}catch(t){console.error("Error decoding link:",t,e.href)}}))}const rt=document.querySelector("body"),at=document.createElement("div");at.classList.add("empowerment-panel");const lt=document.createElement("div");function it(e,t,n){e&&(e.offsetHeight,e.style.transition="opacity 0.3s",e.style.opacity="show"===t?n:"0","hide"===t&&e.addEventListener("transitionend",(()=>{"0"===e.style.opacity&&e.remove()}),{once:!0}))}function ct(e){let t=document.querySelector(".dimming-background"),n=document.querySelector(".scaled-thumbnail");("hide"!==e||t)&&(t||(t=document.createElement("div"),t.classList.add("dimming-background"),t.style.background="black",t.style.top="0",t.style.left="0",t.style.right="0",t.style.bottom="0",t.style.position="fixed",t.style.opacity="0",t.style.zIndex="998",document.body.appendChild(t),t.addEventListener("click",(function(){const e=document.querySelector(".popup-panel")||t.previousElementSibling;e&&it(e,"hide",0),ct("hide"),n&&Ze()}))),it(t,e,.5),"hide"===e&&n&&(Ze(),dt(n,"hide")))}function dt(e,t){e&&(it(e,t,1),e.addEventListener("dblclick",(t=>{document.querySelector(".popup-panel")&&t.target.closest(".scaled-thumbnail")||ct("hide"),dt(e,"hide")})))}lt.title="Current Chat Users Count",lt.classList.add("chat-user-count"),lt.style.filter="grayscale(100%)",lt.style.transition="0.2s ease-in-out",lt.style.fontFamily="'Orbitron', sans-serif",lt.style.fontSize="24px",lt.style.color="#83cf40",lt.style.backgroundColor="#2b4317",lt.style.width="48px",lt.style.height="48px",lt.style.display="flex",lt.style.justifyContent="center",lt.style.alignItems="center",lt.style.border="1px solid #4b7328",lt.style.margin="4px",lt.innerHTML="0",at.appendChild(lt),at.style.position="fixed",at.style.top="60px",at.style.right="12px",at.style.padding="6px",at.style.zIndex="1000",rt.appendChild(at);let mt={};function ut(){Object.values(mt).forEach((e=>{document.removeEventListener("keydown",e)})),mt={};const e=document.querySelector(".popup-panel");e&&e.remove()}const pt={Экстракибер:1,Кибергонщик:2,Супермен:3,Маньяк:4,Гонщик:5,Профи:6,Таксист:7,Любитель:8,Новичок:9},gt={Экстракибер:"#06B4E9",Кибергонщик:"#5681ff",Супермен:"#B543F5",Маньяк:"#DA0543",Гонщик:"#FF8C00",Профи:"#C1AA00",Таксист:"#2DAB4F",Любитель:"#61B5B3",Новичок:"#AFAFAF"};let yt=null;const ht=e=>{const t=document.createElement("iframe");t.classList.add("profile-iframe-container"),t.src=e,Object.assign(t.style,{border:"none",display:"flex",position:"fixed",zIndex:"999",width:"75vw",minWidth:"1000px",height:"80vh",top:"48.5vh",left:"50vw",transform:"translate(-50%, -50%)"}),t.style.setProperty("box-shadow","0 4px 6px rgba(0,0,0,0.1), 0 1px 3px rgba(0,0,0,0.08)","important"),t.style.setProperty("border-radius","0.6em","important"),document.body.appendChild(t);const n=()=>{t.remove(),document.removeEventListener("keydown",o),document.removeEventListener("mousedown",o)},o=e=>{if("keydown"===e.type&&"Space"===e.code){if(yt)return void e.stopPropagation();e.preventDefault(),n()}"mousedown"!==e.type||t.contains(e.target)||n()};document.addEventListener("keydown",o),document.addEventListener("mousedown",o),t.onload=()=>{try{const e=t.contentWindow,s=e.document;s.addEventListener("focusin",(e=>{"TEXTAREA"===e.target.tagName&&(yt=e.target)})),s.addEventListener("focusout",(()=>{setTimeout((()=>{s.activeElement&&"TEXTAREA"===s.activeElement.tagName||(yt=null)}),0)})),e.addEventListener("keydown",o),e.addEventListener("dblclick",n),new MutationObserver(((e,t)=>{e.some((e=>[...e.removedNodes].some((e=>1===e.nodeType&&(e.classList.contains("dimming-background")||e.classList.contains("cached-users-panel"))))))&&(n(),t.disconnect())})).observe(document.body,{childList:!0,subtree:!0})}catch(e){console.warn("Unable to access iframe contents:",e)}}};function ft(){const e=document.querySelector(".cached-users-panel");if(e)return e.remove(),void ct("hide");ut();const o=localStorage.getItem("fetchedUsers");let s=JSON.parse(o)||{};const r=document.createElement("div");r.className="cached-users-panel popup-panel",r.style.opacity="0",r.style.backgroundColor="#1b1b1b",r.style.setProperty("border-radius","0.6em","important"),r.style.position="fixed",r.style.top="100px",r.style.left="50%",r.style.transform="translateX(-50%)",r.style.width="80vw",r.style.height="80vh",r.style.zIndex="999",r.style.display="grid",r.style.gridTemplateColumns="1fr",r.style.gridTemplateRows="min-content",r.style.gridTemplateAreas='\n      "header header"\n      "cache scroll"',mt.handleCacheKeydown=e=>{"Escape"===e.key&&(dt(r,"hide"),ct("hide"),document.removeEventListener("keydown",mt.handleCacheKeydown))},document.addEventListener("keydown",mt.handleCacheKeydown);const a=document.createElement("div");a.className="panel-header",a.style.display="flex",a.style.flexDirection="row",a.style.justifyContent="space-between",a.style.padding="0.6em",a.style.gridArea="header";const l=document.createElement("div");l.className="drop-time",l.style.display="flex",l.style.justifyContent="center",l.style.alignItems="center",l.style.minWidth="fit-content";const i=document.createElement("span");i.className="drop-time-threshold-description",i.textContent="🚧 Threshold",i.style.padding="0.6em",i.style.color="#c6b209";const c=document.createElement("span");c.className="drop-time-threshold",c.style.padding="0.6em",c.style.color="lightcoral",c.style.fontFamily="'Roboto Mono', monospace",c.style.fontSize="1.1em",c.style.fontWeight="bold",c.style.setProperty("border-radius","0.2em","important"),c.style.border="1px solid rgba(240, 128, 128, 0.20)",c.style.backgroundColor="rgba(240, 128, 128, 0.05)",c.style.transition="filter 0.3s",c.style.cursor="pointer",c.addEventListener("mouseover",(()=>{c.style.filter="sepia(1)"})),c.addEventListener("mouseout",(()=>{c.style.filter="sepia(0)"}));const d=localStorage.getItem("cacheRefreshThresholdHours");c.innerHTML=d||"00:00:00",c.addEventListener("click",(function(){let e=!1;for(;!e;){const t=prompt("Enter a cache refresh time (e.g., HH, HH:mm, or HH:mm:ss):"),n=document.querySelector(".drop-time-threshold");if(null===t)e=!0;else if(/^([0-9]+|[01][0-9]|2[0-4])(:([0-5]?[0-9])(:([0-5]?[0-9]))?)?$/.test(t)){const o=t.split(":"),s=("0"+o[0]).slice(-2),r=("0"+(o[1]||"00")).slice(-2),a=("0"+(o[2]||"00")).slice(-2);n.textContent=`${s}:${r}:${a}`;const l=`${s}:${r}:${a}`;localStorage.setItem("cacheRefreshThresholdHours",l),localStorage.removeItem("fetchedUsers"),localStorage.removeItem("lastClearTime"),localStorage.removeItem("nextClearTime"),setTimeout((()=>location.reload()),1e3),e=!0}else alert("Invalid time format. Please enter a valid time in the format HH, HH:mm, or HH:mm:ss.")}}));const m=document.createElement("span");m.className="drop-time-expiration-description",m.textContent="💣 Countdown",m.style.padding="0.6em",m.style.color="#d0562c";const u=document.createElement("span");u.className="drop-time-expiration",u.style.padding="0.6em",u.style.color="antiquewhite",u.style.fontFamily="'Roboto Mono', monospace",u.style.fontSize="1.1em",l.appendChild(i),l.appendChild(c),l.appendChild(m),l.appendChild(u),a.appendChild(l);const p=document.createElement("div");p.className="search-for-cached-users",p.style.width="100%",p.style.margin="0 0.5em",p.style.display="flex";const g=document.createElement("input");g.className="cached-users-search-input",g.type="text",g.style.outline="none",g.style.width="100%",g.style.padding="10px",g.style.fontSize="1em",g.style.fontFamily="Montserrat",g.style.setProperty("color","bisque","important"),g.style.setProperty("border-radius","0.2em","important"),g.style.boxSizing="border-box",g.style.backgroundColor="#111",g.style.border="1px solid #222",p.appendChild(g),g.addEventListener("click",(()=>ae&&(g.value=""))),g.addEventListener("keydown",(async e=>{const t=document.querySelector(".old-users"),n=document.querySelector(".new-users"),o=document.querySelector(".fetched-users");if("Backspace"===e.key&&0===e.target.value.length){t.style.display="grid",n.style.display="grid";const e=document.querySelector(".search-results");e&&o&&o.removeChild(e)}else"Enter"===e.key&&0===e.target.value.trim().length&&(e.preventDefault(),e.target.value="user ")}));g.addEventListener("input",Dt((e=>{const t=e.target.value.trim(),n=localStorage.getItem("cachePanelSearchMode"),o=t.startsWith("user ")?t.substring(5).trim():"fetch"===n?t:"";o&&(async e=>{const t=document.querySelector(".old-users"),n=document.querySelector(".new-users"),o=document.querySelector(".fetched-users");if(e){t.style.display="none",n.style.display="none";let s=document.querySelector(".search-results");s?s.innerHTML=null:(s=E("search-results"),o.appendChild(s));const r=[];try{const t=await async function(e){const t=`https://klavogonki.ru/api/profile/search-users?query=${e}`,n=(await St(t)).all;if(!n||0===n.length)throw new Error(`User ${e} not found.`);return n.map((e=>e.id))}(e);await Promise.all(t.map((async e=>{const t=await wt(e,!1),n={rank:t.rank,login:t.login,registered:t.registeredDate,bestSpeed:t.bestSpeed,ratingLevel:t.ratingLevel,friends:t.friends,cars:t.cars,avatarTimestamp:t.avatarTimestamp,avatar:t.avatar},o=P(e,n);o&&r.push(o)}))),r.sort(((e,t)=>e.order!==t.order?e.order-t.order:t.bestSpeed-e.bestSpeed)),r.forEach((({userElement:e})=>{s.appendChild(e)}));const n=T(`Search Results for: ${e}`,"search-results-description");s.prepend(n)}catch(e){console.error("Error fetching user profile:",e);const t=document.createElement("div");t.className="error-message",t.textContent=`Error fetching user profile: ${e.message}`,t.style.width="fit-content",t.style.whiteSpace="nowrap",t.style.fontFamily="Montserrat",t.style.color="lightcoral",s.appendChild(t)}}})(o)}),Ht)),a.appendChild(p);const y=new MutationObserver((e=>{if(e.some((e=>"childList"===e.type&&e.addedNodes.length>0))){const e=document.querySelector(".cached-users-search-input"),t=Array.from(document.querySelectorAll(".fetched-users .login")),n=(e,t)=>{let n=0,o=0;for(const s of t.toLowerCase())o<e.length&&s===e[o].toLowerCase()&&(n+=2,o++);return o===e.length?n:0},o=e=>{t.forEach((t=>{t.closest(".user").style.display=!e||n(e,t.textContent)>0?"grid":"none"}))};e.focus(),e.addEventListener("input",(()=>o(e.value.trim()))),y.disconnect()}}));y.observe(a,{childList:!0,subtree:!0});const h=document.createElement("div");function f(e,t,n="0 0.5em"){e.style.backgroundColor=t,e.style.width="48px",e.style.height="48px",e.style.display="flex",e.style.justifyContent="center",e.style.alignItems="center",e.style.cursor="pointer",e.style.setProperty("border-radius","0.2em","important"),e.style.margin=n,e.style.filter="brightness(1)",e.style.transition="filter 0.3s ease"}h.className="panel-control-buttons",h.style.display="flex";const v=document.createElement("div");v.className="user-mode-button",v.innerHTML=O,f(v,"darkslateblue");const x=localStorage.getItem("cachePanelSearchMode")||(localStorage.setItem("cachePanelSearchMode","cache"),"cache");function b(e){const t="fetch"===e?"darkslateblue":"#b2a4f9";f(v,"fetch"===e?"#b2a4f9":"darkslateblue");const n=v.querySelector("svg");n&&n.setAttribute("stroke",t)}v.title=`Current active mode: ${x}`,b(x),v.addEventListener("click",(()=>{const e="cache"===localStorage.getItem("cachePanelSearchMode")?"fetch":"cache";localStorage.setItem("cachePanelSearchMode",e),b(e),v.title=`Current active mode: ${e}`})),h.appendChild(v);const S=document.createElement("div");S.className="clear-cache-button",S.title="Clear cache",S.innerHTML=j,f(S,"brown"),S.addEventListener("click",(()=>{vt(),It(!0,qt);const e=document.querySelector(".cache-panel-load-button .cache-user-count");e&&(e.textContent="0")})),h.appendChild(S);const C=document.createElement("div");C.className="close-panel-button",C.title="Close panel",C.innerHTML=w,f(C,"darkolivegreen","0 0 0 0.5em"),C.addEventListener("click",(()=>{vt()})),h.appendChild(C),a.appendChild(h);const k=document.createElement("div");function E(e){const t=document.createElement("div");return t.className=e,t.style.display="grid",t.style.gridTemplateColumns="repeat(auto-fill, minmax(220px, 1fr))",t.style.gap="12px",t.style.padding="1em",t.style.height="fit-content",t}k.className="fetched-users",k.style.display="grid",k.style.gridTemplateRows="1fr 1fr",k.style.height="calc(100% - 0.5em)",k.style.overflowY="auto",k.style.gridArea="cache";const L=E("old-users"),$=E("new-users");function T(e,t){const n=document.createElement("span");return n.className=t,n.textContent=e,n.style.color="bisque",n.style.fontFamily="Montserrat",n.style.fontSize="1em",n.style.margin="0",n.style.padding="0.4em 0.2em",n.style.gridColumn="1 / -1",n.style.height="fit-content",n}const M=T("Active Users","old-users-description"),N=T("New Registrations","new-users-description");L.appendChild(M),$.appendChild(N),k.appendChild(L),k.appendChild($);const q=[];let I=!0;const A=new Date,P=(e,o)=>{const s=document.createElement("div");s.className="user",s.style.padding="0.2em",s.style.margin="0.4em 0.2em",s.style.display="grid",s.style.gridTemplateColumns="auto 1fr",s.style.alignItems="center",s.style.height="fit-content";const r={marginLeft:"8px",padding:"4px 6px",borderRadius:"2px !important",cursor:"pointer",whiteSpace:"pre"},a={tracked:{...r,color:"greenyellow",backgroundColor:"darkgreen",fontWeight:"bold"},untracked:{...r,color:"orange",backgroundColor:"#111111",fontWeight:"normal"}},l=o.tracked?a.tracked:a.untracked,i=document.createElement("div");i.className="avatar",i.style.marginRight="8px";const c=$t[e]?.avatarTimestamp,d=`/storage/avatars/${e}_big.png`;if(c&&"00"!==c||o.avatar&&Object.keys(o.avatar).length>0){const e=`${d}?updated=${c}`,t=document.createElement("img");t.src=e,t.alt=`${o.login}'s avatar`,t.style.height="24px",t.style.width="24px",t.style.objectFit="cover",i.appendChild(t)}else i.style.fontSize="1.8rem",i.innerHTML=Et();const m=document.createElement("div");m.className="user-data";const u=document.createElement("div");u.className="login-container";const p=document.createElement("a");p.className="login",p.textContent=o.login,p.href=`https://klavogonki.ru/profile/${e}`,u.appendChild(p),p.style.setProperty("color","skyblue","important"),p.style.textDecoration="none",p.style.fontFamily="Montserrat",p.style.transition="color 0.3s ease",p.addEventListener("mouseover",(()=>{p.style.setProperty("color","cornsilk","important")})),p.addEventListener("mouseout",(()=>{p.style.setProperty("color","skyblue","important")}));const g=X+e,y=`${X}${J}/messages/${e}/`;if(p.addEventListener("click",(function(e){if(e.preventDefault(),e.ctrlKey&&e.shiftKey){const e=window.open(y,"_blank");e&&e.focus()}else e.ctrlKey?ht(y):ht(g)})),void 0!==o.visits){const s=document.createElement("span");s.className="visits",s.style.cssText=(e=>Object.entries(e).map((([e,t])=>`${e.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase()}: ${t}`)).join("; "))(l),s.textContent=o.visits,s.dataset.userId=e,function(e){const t=Number(e.textContent);if(isNaN(t))return console.warn("Invalid visits count!");const n=t<=10?"💧":t<=20?"💦":t<=30?"🌊":"🔥";e.textContent=`${n} ${t}`}(s),u.appendChild(s);const r={position:"fixed",opacity:"0",padding:"8px",gap:"4px",top:"50%",left:"50%",transform:"translate(-50%, -50%)",maxHeight:"85vh",overflowY:"auto",scrollbarWidth:"none",overflowX:"hidden",display:"flex",minWidth:"30vw",maxWidth:"50vw",flexWrap:"wrap",backgroundColor:"#111111",border:"3px dashed #212121"};s.addEventListener("click",(e=>{I=!0;const a=s.dataset.userId,l=$t[a],i=l?l.actionLog:null;if(l){let s=document.querySelector(".action-log");if(s?s.replaceChildren():(s=document.createElement("div"),s.className="action-log",s.style.setProperty("box-shadow","\n    0 8px 30px rgba(0, 0, 0, 0.12),\n    0 4px 6px rgba(0, 0, 0, 0.04),\n    0 2px 2px rgba(0, 0, 0, 0.08)\n  ","important"),s.style.setProperty("border-radius","0.2em","important"),Object.assign(s.style,r),k.appendChild(s),it(s,"show",1)),i&&I)for(let e=0;e<i.length&&I;e++){const s=i[e];if("object"!=typeof s||null===s)continue;const{type:r,timestamp:a}=s,l=o?.login||"Unknown User",c="enter"===r?t:n,d="enter"===r;(t=>{setTimeout((()=>{t&&De(l,c,a,d,"cachePanel")}),10*(e+1))})(I)}const a=e=>{s.contains(e.target)&&"Space"!==e.code||("Space"===e.code&&e.preventDefault(),it(s,"hide",0),I=!1,["click","keydown"].forEach((e=>document.removeEventListener(e,a))))};["click","keydown"].forEach((e=>document.addEventListener(e,a))),e.stopPropagation()}else console.error("User data not found")}))}m.appendChild(u);const h=document.createElement("div");h.className="rank",h.textContent=o.rank||"N/A",h.style.color=gt[o.rank]||"white",h.style.padding="2px 0",m.appendChild(h);const f=document.createElement("div");let v;f.className="registered",f.textContent=o.registered||"N/A",f.style.color="cadetblue",f.style.fontSize="12px";const x=f.textContent;f.addEventListener("mouseover",(()=>{clearTimeout(v),v=setTimeout((()=>{f.textContent=function(e){const t=Math.floor((new Date-new Date(e))/1e3),n=Math.floor(t/31536e3),o=Math.floor(t%31536e3/(30.44*24*60*60)),s=Math.floor(t%(30.44*24*60*60)/86400),r=Math.floor(t%86400/3600),a=Math.floor(t%3600/60),l=t%60,i=[];return n>0?(i.push(`${n} year${n>1?"s":""}`),o>0&&i.push(`${o} month${o>1?"s":""}`)):o>1||1===o&&s>0?(i.push(`${o} month${o>1?"s":""}`),s>0&&i.push(`${s} day${s>1?"s":""}`)):s>0?(i.push(`${s} day${s>1?"s":""}`),r>0&&i.push(`${r} hour${r>1?"s":""}`),a>0&&i.push(`${a} minute${a>1?"s":""}`)):r>0?(i.push(`${r} hour${r>1?"s":""}`),a>0&&i.push(`${a} minute${a>1?"s":""}`)):a>0?(i.push(`${a} minute${a>1?"s":""}`),l>0&&i.push(`${l} second${l>1?"s":""}`)):i.push(`${l} second${l>1?"s":""}`),i.filter(Boolean).join(" ")}(o.registered)}),300)})),f.addEventListener("mouseout",(()=>{clearTimeout(v),f.textContent=x})),m.appendChild(f);const b=(e,t,n,o,s,r)=>{const a=document.createElement("span");return a.className=e,a.style.color=t,a.innerHTML=`${n}${o||0}&nbsp;&nbsp;`,a.title=s,a.style.cursor="pointer",a.addEventListener("click",(()=>ht(r))),a},w=b("best-speed","cyan","🚀",o.bestSpeed,"Best speed",`https://klavogonki.ru/u/#/${e}/stats/normal/`),S=b("rating-level","gold","⭐",o.ratingLevel,"Rating level",`https://klavogonki.ru/top/rating/today?s=${o.login}`),C=b("cars-count","lightblue","🚖",o.cars,"Cars count",`https://klavogonki.ru/u/#/${e}/car/`),E=b("friends-count","lightgreen","🤝",o.friends,"Friends count",`https://klavogonki.ru/u/#/${e}/friends/list/`),L=document.createElement("div");return L.className="user-metrics",L.style.marginTop="4px",L.style.gridColumn="span 2",L.append(w,S,C,E),s.append(i,m,L),{userElement:s,order:pt[o.rank]||10,bestSpeed:o.bestSpeed||0,registered:o.registered}};"cache"===localStorage.getItem("cachePanelSearchMode")&&(Object.keys(s).forEach((async e=>{const t=s[e],n=P(e,t);q.push(n)})),q.sort(((e,t)=>e.order!==t.order?e.order-t.order:t.bestSpeed-e.bestSpeed)),q.forEach((({userElement:e,registered:t})=>{const n=(e=>{const t=new Date(e);return A-t<=864e5})(t)?$:L;n.appendChild(e)}))),r.appendChild(a),r.appendChild(k),document.body.appendChild(r);const{scrollButtonsContainer:B,fullScrollUpButton:H,partialScrollUpButton:D,partialScrollDownButton:F,fullScrollDownButton:U}=me(k);function z(){const e=localStorage.getItem("lastClearTime"),t=localStorage.getItem("nextClearTime"),n=document.querySelector(".drop-time-expiration");if(e&&t&&n){const e=t-(new Date).getTime();e<=0?It(!0,qt):function(e,t){const n=String(Math.floor(t/36e5)).padStart(2,"0"),o=String(Math.floor(t%36e5/6e4)).padStart(2,"0"),s=String(Math.floor(t%6e4/1e3)).padStart(2,"0"),r=`${n}:${o}:${s}`,a=parseInt(s,10),l=5*Math.ceil(a/5),i=R[l]||R[0];e.textContent=`${r} ${i}`}(n,e)}}r.appendChild(B),[v,S,C,H,D,F,U].forEach((e=>{e.addEventListener("mouseover",(()=>{e.style.filter="brightness(0.8)"})),e.addEventListener("mouseout",(()=>{e.style.filter="brightness(1)"}))})),dt(r,"show"),ct("show");const R={0:"🕛",5:"🕐",10:"🕑",15:"🕒",20:"🕓",25:"🕔",30:"🕕",35:"🕖",40:"🕗",45:"🕘",50:"🕙",55:"🕚"};setInterval(z,1e3),z()}function vt(){const e=document.querySelector(".cached-users-panel");e&&(dt(e,"hide"),ct("hide"))}const xt=document.createElement("style");var bt;async function wt(e,t=!0){return new Promise((async(n,o)=>{let s=t&&JSON.parse(localStorage.getItem("fetchedUsers"))||{};const r=s[e];if(t&&function(e){return e&&"object"==typeof e&&["rank","login","registered","bestSpeed","ratingLevel","friends","cars","avatarTimestamp"].every((t=>void 0!==e?.[t]))}(r))n({rank:r.rank,login:r.login,registeredDate:r.registered,bestSpeed:r.bestSpeed,ratingLevel:r.ratingLevel,friends:r.friends,cars:r.cars,avatar:r.avatar,avatarTimestamp:r.avatarTimestamp});else try{const o=`https://klavogonki.ru/api/profile/get-summary?id=${e}`,r=`https://klavogonki.ru/api/profile/get-index-data?userId=${e}`,[l,i]=await Promise.all([fetch(o),fetch(r)]);if(!l.ok||!i.ok)throw new Error("Failed to fetch data from one of the APIs.");const c=await l.json(),d=await i.json();if(!(c?.user?.login&&c.title&&d?.stats?.registered))throw new Error("Invalid data format received from the API.");{const o=c.title,r=c.user.login,l=d.stats.registered.sec?(a=d.stats.registered.sec,new Date(1e3*a).toISOString().slice(0,19).replace("T"," ")):"Invalid Date",i=d.stats.best_speed||0,m=d.stats.rating_level||0,u=d.stats.friends_cnt||0,p=d.stats.cars_cnt||0,g=c.user?.avatar||null,y=function(e,t){return e.toString()+Math.floor(t/1e3).toString()}(c.user.avatar?.sec||0,c.user.avatar?.usec||0);t&&(s[e]={rank:o,login:r,registered:l,bestSpeed:i,ratingLevel:m,friends:u,cars:p,avatar:g,avatarTimestamp:y},localStorage.setItem("fetchedUsers",JSON.stringify(s))),n({rank:o,login:r,registeredDate:l,bestSpeed:i,ratingLevel:m,friends:u,cars:p,avatar:g,avatarTimestamp:y})}}catch(t){console.error(`Error fetching user profile data for ${e}:`,t),o(t)}var a}))}async function St(e){const t=await fetch(e);if(!t.ok)throw new Error(`Failed to fetch ${e}`);return t.json()}function Ct(e){const t={class:"unknown",icon:"❓",color:"#000000"},n={Экстракибер:{class:"extra",icon:"🚀",color:"#06B4E9"},Кибергонщик:{class:"cyber",icon:"🤖",color:"#5681ff"},Супермен:{class:"superman",icon:"👊",color:"#B543F5"},Маньяк:{class:"maniac",icon:"🔪",color:"#DA0543"},Гонщик:{class:"racer",icon:"⚡️️",color:"#FF8C00"},Профи:{class:"profi",icon:"️💼️",color:"#C1AA00"},Таксист:{class:"driver",icon:"🚖️",color:"#2DAB4F"},Любитель:{class:"amateur",icon:"🍆️",color:"#61B5B3"},Новичок:{class:"newbie",icon:"🐥",color:"#AFAFAF"}}[e]||t;return n.class===t.class&&console.log(`Class not found for status title: ${e}. Using default class: ${t.class}`),n}xt.classList.add("new-chat-user-list"),xt.innerHTML=`\n    #chat-general .userlist-content {\n      opacity: 0;\n    }\n\n    #chat-general .smile-tab {\n      background-color: ${bt=getComputedStyle(document.querySelector(".chat .messages")).backgroundColor,"#"==bt[0]?bt:"#"+bt.match(/\d+/g).map(Number).map((e=>e.toString(16).padStart(2,"0"))).join("")};\n      position: relative;\n      z-index: 1;\n    }\n\n    .chat-user-list {\n        display: flex;\n        flex-direction: column;\n        position: absolute;\n        top: 20px;\n        padding-top: 8px;\n        width: 200px;\n        height: 94%;\n        overflow-y: auto;\n        overflow-x: hidden;\n        background-color: ${(e=>"#"==e[0]?e:"#"+e.match(/\d+/g).map(Number).map((e=>e.toString(16).padStart(2,"0"))).join(""))(getComputedStyle(document.querySelector(".chat .messages")).backgroundColor)};\n    }\n\n    .chat-user-list [class^="rank-group"] {\n        display: flex;\n        flex-direction: column;\n    }\n\n    .chat-user-list [class^="user"] {\n        display: inline-flex;\n        margin: 2px 0;\n    }\n\n    .chat-user-list .avatar {\n        width: 24px;\n        height: 24px;\n        display: inline-flex;\n    }\n\n    .chat-user-list .avatar img,\n    .fetched-users .avatar img {\n        transition: transform 0.3s;\n        transform-origin: left;\n    }\n\n    .chat-user-list .avatar img:hover,\n    .fetched-users .avatar img:hover {\n        transform: scale(2);\n    }\n\n    .chat-user-list .name {\n        text-decoration: none;\n        display: inline-flex;\n        width: auto;\n        height: 24px;\n        line-height: 24px;\n        padding: 0 8px;\n        max-width: 124px;\n        overflow: hidden;\n        text-overflow: ellipsis;\n    }\n\n    .chat-user-list .name:hover {\n        text-decoration: underline;\n    }\n\n    .chat-user-list .profile,\n    .chat-user-list .tracked,\n    .chat-user-list .ignored,\n    .chat-user-list .moderator {\n        display: inline-flex;\n        width: 24px;\n        height: 24px;\n        justify-content: center;\n        align-items: center;\n    }\n\n    svg.feather-meh,\n    svg.feather-smile,\n    svg.feather-frown {\n        stroke: #A47C5E;\n    }\n\n    /* Common rotation animation */\n    @keyframes rotateProfileIconAnimation {\n        0% {\n            transform: rotate(0deg) scale(1);\n            transition-timing-function: ease-in-out;\n        }\n        50% {\n            transform: rotate(180deg) scale(1.2);\n            transition-timing-function: linear;\n        }\n        100% {\n            transform: rotate(360deg) scale(1);\n        }\n    }\n`,document.head.appendChild(xt);let kt=null;function Et(){let e;do{e=Lt[Math.floor(Math.random()*Lt.length)]}while(e===kt);return kt=e,e}const Lt=["😀","😁","😂","🤣","😃","😄","😅","😆","😉","😊","😋","😎","😏","😐","😑","😒","😓","😔","😕","😖","😗","😘","😙","😚","😜","😝","😛","🤑","🤗","🤔","🤐","🤨","😣","😥","😮","🤯","😳","😱","😨","😰","😢","🤪","😵","😲","🤤","😷","🤒","🤕","🤢","🤧","😇","🥳","🥺","😬","😴","😌","🤥","🥴","🥵","🥶","🤧","🤭","🤫","😠","😡","😳","😞","😟","😕","🐱","😺","😸","😹","😻","😼","😽","🙀","😿","😾","🐶","🐭","🐹","🐰","🦊","🐻","🐼","🐨","🐯","🦁","🐮","🐷","🐸","🐵","🙈","🙉","🙊","🐔","🦄"];let $t=JSON.parse(localStorage.getItem("fetchedUsers"))||{};function Tt(e,t,n,a,l){const i=$t[e]?.avatarTimestamp,c="00"!==i?`/storage/avatars/${e}_big.png?updated=${i}`:"",d=document.createElement("div"),m=Ct(t),u=m.class,p=m.color,g=m.icon;d.classList.add(`user${e}`,u);const y=document.createElement("div");if(y.classList.add("avatar"),"00"!==i){const e=document.createElement("img");e.src=c,y.appendChild(e)}else y.style.fontSize="1.8rem",y.innerHTML=Et();const h=document.createElement("a");h.classList.add("name"),h.title="Написать в приват",h.dataset.user=e,h.textContent=n,h.style.setProperty("color",p,"important");const f=document.createElement("a");f.classList.add("profile"),Be(f,`${g} ${t} - ${a}`),f.target="_blank",f.href=`/profile/${e}/`;let v=function(e,t,n){const o="http://www.w3.org/2000/svg",s=10,r=Math.random().toString(36).substring(2,22),a=n||0!==e?1:.6,l=document.createElementNS(o,"svg");if(Object.entries({width:20,height:20,viewBox:"0 0 20 20",xmlns:o}).forEach((([e,t])=>l.setAttribute(e,t))),l.classList.add("circularProgress"),n||0===e){if(!n){const e=document.createElementNS(o,"circle");Object.entries({cx:s,cy:s,r:8,fill:"none",stroke:t,"stroke-width":2}).forEach((([t,n])=>e.setAttribute(t,n))),e.classList.add("outerCircle"),l.appendChild(e)}const e=20/24*a,r=s-12*e,i=document.createElementNS(o,"g");i.setAttribute("transform",`translate(${r}, ${r}) scale(${e})`),i.classList.add("closeIconGroup");const c=document.createElementNS(o,"path");Object.entries({d:"M18.364 5.636a1 1 0 0 1 0 1.414L13.414 12l4.95 4.95a1 1 0 0 1-1.414 1.414L12 13.414l-4.95 4.95a1 1 0 0 1-1.414-1.414L10.586 12l-4.95-4.95a1 1 0 0 1 1.414-1.414L12 10.586l4.95-4.95a1 1 0 0 1 1.414 0z",fill:t}).forEach((([e,t])=>c.setAttribute(e,t))),i.appendChild(c),l.appendChild(i)}else{const n=document.createElementNS(o,"defs");n.classList.add("defs");const a=document.createElementNS(o,"clipPath");a.setAttribute("id",`clipInner-${r}`),a.classList.add("clipPath");const i=document.createElementNS(o,"rect");Object.entries({x:2,y:2,width:16,height:0,transform:"rotate(180, 10, 10)"}).forEach((([e,t])=>i.setAttribute(e,t))),i.classList.add("clipRect");const c=document.createElementNS(o,"animate");Object.entries({attributeName:"height",from:0,to:e/100*16,begin:"indefinite",dur:"1s",fill:"freeze",calcMode:"spline",keySplines:"0.4 0 0.2 1",keyTimes:"0;1"}).forEach((([e,t])=>c.setAttribute(e,t))),c.classList.add("animateProfileProgress"),i.appendChild(c),a.appendChild(i),n.appendChild(a),l.appendChild(n);const d=document.createElementNS(o,"circle");Object.entries({cx:s,cy:s,r:8,fill:"none",stroke:t,"stroke-width":2}).forEach((([e,t])=>d.setAttribute(e,t))),d.classList.add("outerCircle"),l.appendChild(d);const m=document.createElementNS(o,"circle");Object.entries({cx:s,cy:s,r:8,fill:t,"clip-path":`url(#clipInner-${r})`}).forEach((([e,t])=>m.setAttribute(e,t))),m.classList.add("innerCircle"),l.appendChild(m)}return l.outerHTML}(function(e){const t=100*Math.floor(e/100);return(e-t)/(t+100-t)*100}(a),p,l);f.innerHTML=v,setTimeout((()=>{const e=f.querySelector(".animateProfileProgress");e&&e.beginElement()}),10),f.addEventListener("click",(function(t){t.preventDefault(),ae?window.open(X+e,"_blank"):ht(X+e)}));const x=`${X}${J}/messages/${e}/`;if(h.addEventListener("click",(function(t){if(t.ctrlKey&&t.shiftKey){const e=window.open(x,"_blank");e&&e.focus()}else t.ctrlKey?ht(x):function(e){const t=`<${document.querySelector(`.name[data-user="${e}"]`).textContent}>`,n=document.querySelector(".messages .text");n.value=t,n.focus(),n.selectionEnd=n.value.length,console.log(`Setting private message to: ${t}`)}(e)})),d.appendChild(y),d.appendChild(h),d.appendChild(f),V.find((e=>e.name===n&&"thawed"===e.state))){const e=document.createElement("div");e.title="Tracked user",e.classList.add("tracked"),e.innerHTML=s,d.appendChild(e)}if(Q.includes(n)){const e=document.createElement("div");e.title="Ignored user",e.classList.add("ignored"),e.innerHTML=r,d.appendChild(e)}const b=document.querySelector(`.userlist-content ins.user${e} img[src*="moderator"]`),w=Z.includes(n);if(b||w){const e=document.createElement("div");e.classList.add("moderator"),e.innerHTML=o,d.appendChild(e)}return d}async function Mt(e,t){try{const n=document.querySelector(".userlist-content");let o=document.querySelector(".chat-user-list");if(!o){o=document.createElement("div"),o.classList.add("chat-user-list");const e=document.querySelector(".userlist");e&&e.appendChild(o)}const s={};["extra","cyber","superman","maniac","racer","profi","driver","amateur","newbie"].forEach((e=>{const t=o.querySelector(`.rank-group-${e}`);t?s[e]=t:(s[e]=document.createElement("div"),s[e].classList.add(`rank-group-${e}`),o.appendChild(s[e]))}));const r=new Set;for(const o of n.querySelectorAll("ins")){const n=o.querySelector(".name"),a=n.getAttribute("data-user"),l=n.textContent;if(!r.has(a))try{const{rank:n,login:i,registeredDate:c,bestSpeed:d,ratingLevel:m,friends:u,cars:p,avatarTimestamp:g}=await wt(a);$t[a]?($t[a].rank=n,$t[a].login=i,$t[a].registered=c,$t[a].bestSpeed=d,$t[a].ratingLevel=m,$t[a].friends=u,$t[a].cars=p,$t[a].avatarTimestamp=g):$t[a]={rank:n,login:i,registered:c,bestSpeed:d,ratingLevel:m,friends:u,cars:p,avatarTimestamp:g},e===l&&"enter"===t&&($t[a].visits=($t[a].visits||0)+1,$t[a].tracked=V.some((t=>t.name===e)));const{class:y}=Ct(n);if(!s[y].querySelector(`.user${a}`)){const e=Tt(a,n,l,d,o.classList.contains("revoked"));s[y].appendChild(e),Pt||En(e)}r.add(a)}catch(e){console.error(`Error fetching profile summary for user ${a}:`,e)}}o.querySelectorAll('.chat-user-list [class^="user"]').forEach((e=>{const t=e.querySelector(".name").getAttribute("data-user");r.has(t)||e.remove()})),Object.values(s).forEach((e=>[...e.children].sort(((e,t)=>($t[t.querySelector(".name")?.getAttribute("data-user")]?.bestSpeed||0)-($t[e.querySelector(".name")?.getAttribute("data-user")]?.bestSpeed||0))).forEach((t=>e.appendChild(t))))),localStorage.setItem("fetchedUsers",JSON.stringify($t)),function(){const e=document.querySelector(".cache-panel-load-button .cache-user-count");if(!e)return;const t=Object.keys(JSON.parse(localStorage.getItem("fetchedUsers"))||{}).length.toString();t!==e.textContent&&(e.textContent=t,Cn(e))}()}catch(e){console.error("Error refreshing user list:",e)}}let Nt=localStorage.getItem("cacheRefreshThresholdHours");Nt||(Nt=24,localStorage.setItem("cacheRefreshThresholdHours",Nt));let qt=function(e){const[t,n=0,o=0]=e.split(":").map(Number);return t+n/60+o/3600}(Nt);function It(e=!1,t=24){const n=localStorage.getItem("lastClearTime"),o=n?((new Date).getTime()-n)/36e5:1/0;if(e||o>=t){localStorage.removeItem("fetchedUsers"),$t={};const e=(new Date).getTime()+60*t*60*1e3;localStorage.setItem("lastClearTime",(new Date).getTime().toString()),localStorage.setItem("nextClearTime",e.toString())}}const At=document.querySelector(".userlist-content");let jt=new Map,Ot=0,Pt=!0,Bt=!1;const Ht=300,Dt=(e,t)=>{let n;return(...o)=>{clearTimeout(n),n=setTimeout((()=>e.apply(this,o)),t)}};function Ft(e,t){if(!e)return;const n=t.toString().length;e.textContent=t,e.style.fontSize=Math.max(24-2*(n-1),12)+"px"}const Ut=new MutationObserver(Dt((e=>{e.forEach((e=>{if("childList"===e.type){const o=document.querySelector("#voice, #beep, #silence"),s=o&&"silence"===o.id,r=document.querySelector("#chat-wrapper.chat-hidden"),a=document.querySelector(".chat-user-count");if(r)return a.style.filter="grayscale(100%)",void(a.textContent="0");const l=new Map(Array.from(At.children).map((e=>{const t=e.querySelector(".name"),n=t?.getAttribute("data-user"),o=t?.textContent?.trim();return n?[n,{userName:o}]:null})).filter(Boolean));if(Pt)return a&&0===Number(a.textContent)&&!Bt&&function(e,t){let n=0;const o=()=>{if(n<=e){const s=Math.min(n/(e||1),1);Ft(t,n++),t.style.filter=`grayscale(${100-100*s}%)`,setTimeout(o,20)}else Cn(t),Bt=!0};setTimeout(o,20)}(l.size,a),l.forEach(((e,t)=>jt.set(t,e))),void setTimeout((()=>{Pt=!1}),2e3);let i=[...l].filter((([e])=>!jt.has(e))).map((([e,t])=>({userId:e,...t}))),c=[...jt].filter((([e])=>!l.has(e))).map((([e,t])=>({userId:e,userName:t.userName})));jt=new Map(l);const d=jt.size;function m(e,o){const{userName:r,userId:a}=e,l=function(e){const t=V.find((t=>t.name===e));return t?t.gender:null}(r),i=V.some((e=>e.name===r&&"thawed"===e.state));(function(e,t,n){const o=V.some((t=>t.name===e&&"thawed"===t.state)),s=o&&Le("notifications","static"),r=Le("notifications","dynamic");if(!s&&!r)return;const a=$e();s&&o&&(De(e,t,a,n,"generalChat"),Qt()),r&&function(e,t,n,o){let s=document.querySelector(".dynamic-chat-notifications-container");s||(s=document.createElement("div"),s.classList.add("dynamic-chat-notifications-container"),Object.assign(s.style,{zIndex:"1000",width:"0",position:"fixed",display:"flex",flexDirection:"column",top:"0",bottom:"0",left:"0",right:"0",paddingTop:"160px"}),document.body.appendChild(s));const r=document.createElement("div");r.classList.add("dynamic-chat-notification");const a=document.createElement("span");a.classList.add("action-user"),a.textContent=e;const l=He(t),i=document.createElement("span");i.classList.add("action-time"),i.textContent=n,r.appendChild(a),r.appendChild(l),r.appendChild(i),r.dataset.username=e,r.dataset.time=n,r.style.cursor="default",r.style.whiteSpace="nowrap",r.style.position="relative",r.style.alignItems="center",r.style.width="fit-content",r.style.display="flex",r.style.marginBottom="0.2em",r.style.padding="8px 16px 8px 12px",r.style.left="0",r.style.transform="translateX(-100%)",r.style.opacity="1",r.style.transition="transform 0.3s cubic-bezier(0.83, 0, 0.17, 1), opacity 0.3s cubic-bezier(0.83, 0, 0.17, 1)",o?(r.style.color=Ce(100,50,50),r.style.backgroundColor=Ce(100,50,10),r.style.border=`1px solid ${Ce(100,50,25)}`):(r.style.color=Ce(0,50,70),r.style.backgroundColor=Ce(0,50,15),r.style.border=`1px solid ${Ce(0,50,40)}`),r.style.setProperty("border-radius","0 4px 4px 0","important"),s.appendChild(r),r.addEventListener("mouseover",(()=>{const e=Te(r.dataset.username,r.dataset.time);Be(r,e)})),setTimeout((()=>{r.style.transform="translateX(0)",setTimeout((()=>{r.style.transform="translateX(-100%)",setTimeout((()=>{s.removeChild(r)}),300)}),5e3)}),300)}(e,t,a,n)})(r,"enter"===o?t:n,"enter"===o),Mt(r,o),function(e,t){e&&t?($t[e]=$t[e]||{},$t[e].actionLog=$t[e].actionLog||[],$t[e].actionLog.push({type:t,timestamp:$e()})):console.error("Missing userId or actionType")}(a,o),!s&&i&&function(e,t,n){if(!Le("sound","presence"))return;const o=n||"Male",s=V.find((t=>t.name===e)),r="enter"===t?Se[o].enter:Se[o].leave;xe("enter"===t?pe:ge,fe),setTimeout((()=>we(`${s.pronunciation} ${r}`,K)),300)}(r,o,l)}d!==Ot&&Bt&&(Ft(a,d),a.style.filter=d>0?"none":"grayscale(100%)",Cn(a)),i.forEach((e=>m(e,"enter"))),c.forEach((e=>m(e,"leave"))),Ot=d}}))}),Ht));Ut.observe(At,{childList:!0}),document.querySelector(".mostright").addEventListener("click",(()=>{setTimeout((()=>{document.querySelector("#chat-wrapper.chat-hidden")?pn=!1:(io(),So(),pn=!1,setTimeout((()=>pn=!1),3e3))}),300)})),function(){const e=document.querySelector("#chat-fixed-placeholder");if("shouldShowPopupMessage"in localStorage){const t=JSON.parse(localStorage.getItem("shouldShowPopupMessage"));e.style.display=t?"none":"unset"}else e.style.display="none"}(),"shouldShowPopupMessage"in localStorage||localStorage.setItem("shouldShowPopupMessage",!1),document.addEventListener("keydown",(e=>{if(e.ctrlKey&&"Space"===e.code){const e=document.querySelector("#chat-fixed-placeholder"),t=e.hasAttribute("style"),n="unset"===e.style.display,o=document.querySelector(".popup-messages-container");if(t)if(n)e.style.display="none",localStorage.setItem("shouldShowPopupMessage",!0);else{e.style.display="unset",localStorage.setItem("shouldShowPopupMessage",!1);const{inputField:t}=Zn();t?t.focus():console.error("Input field not found. Cannot set focus.")}else e.style.display="none",localStorage.setItem("shouldShowPopupMessage",!0);o&&t&&n&&o.remove()}}));let Jt=null,zt=!1;function Rt(e){if(null===e)return e;const t=[...V.map((e=>e.name)),...G.map((e=>e.original))],n=new RegExp(`(${t.join("|")})`,"gu");return e.replace(n,(e=>{const t=G.find((t=>t.original===e));if(t)return t.replacement;const n=V.find((t=>t.name===e));return n?.pronunciation||e}))}function _t(e="generalMessages"){const t={generalMessages:{container:".messages-content div",messageElement:"p",exclude:[".time",".username"]},chatlogsMessages:{container:".chat-logs-container",messageElement:".message-text"},personalMessages:{container:".messages-container",messageElement:".message-text"}}[e];if(!t)return void console.error("Invalid container type");const n=document.querySelectorAll(t.container),o=new WeakSet;n.forEach((n=>{n.querySelectorAll(t.messageElement).forEach((n=>{[...n.querySelectorAll(".private"),...n.querySelectorAll(".system-message"),n].forEach((n=>{const s=document.createTreeWalker(n,NodeFilter.SHOW_TEXT,{acceptNode:n=>{if(o.has(n))return NodeFilter.FILTER_SKIP;const s=n.parentElement;return s.closest(".mention, .time, .username")||"generalMessages"===e&&s.closest(t.exclude.join(","))?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT}},!1),r=[];let a;for(;a=s.nextNode();)r.push(a);r.forEach((e=>{o.has(e)||(function(e){const t=e.textContent.match(/[\s]+|[^\s\wа-яА-ЯёЁ]+|[\wа-яА-ЯёЁ]+/g);if(!t)return;const n=document.createDocumentFragment();t.forEach((e=>{if(Y.map((e=>e.toLowerCase())).includes(e.toLowerCase())){const t=document.createElement("span");t.className="mention",t.textContent=e,Object.assign(t.style,{display:"inline-flex",color:"#83cf40",fontFamily:"Roboto Mono, monospace",fontWeight:"bold"}),n.appendChild(t)}else n.appendChild(document.createTextNode(e))})),e.parentNode.replaceChild(n,e)}(e),o.add(e))}))}))}))}))}function Kt(e){const[t,n,o]=e.match(/\d+/g).map(Number),{h:s,s:r,l:a}=((e,t,n)=>{e/=255,t/=255,n/=255;const o=Math.max(e,t,n),s=Math.min(e,t,n);let r,a,l=(o+s)/2;if(o===s)r=a=0;else{const i=o-s;a=l<.5?i/(o+s):i/(2-o-s),r=(o===e?(t-n)/i+(t<n?6:0):o===t?(n-e)/i+2:(e-t)/i+4)/6}return r=Math.round(360*r),a=Math.min(Math.round(100*a),90),l=Math.round(100*l),r>215&&r<280&&(r=r<255?215:280),{h:r,s:a,l}})(t,n,o),l=((e,t,n)=>{let o,s,r;if(n/=100,0==(t/=100))o=s=r=255*n;else{const a=n<.5?n*(1+t):n+t-n*t,l=2*n-a,i=(e,t,n)=>(n<0&&(n+=1),n>1&&(n-=1),n<1/6?e+6*(t-e)*n:n<.5?t:n<2/3?e+(t-e)*(2/3-n)*6:e);o=Math.round(255*i(l,a,e/360+1/3)),s=Math.round(255*i(l,a,e/360)),r=Math.round(255*i(l,a,e/360-1/3))}return`rgb(${o}, ${s}, ${r})`})(s,r,a<50?50:a);return l}function Wt(){const e=document.querySelector(".messages-content div p:last-of-type");if(!e)return null;const t=e=>Array.from(e.childNodes).map((e=>e.nodeType===Node.TEXT_NODE&&e.textContent.trim()?e.textContent.trim():"IMG"===e.nodeName&&e.getAttribute("title")?e.getAttribute("title"):"A"===e.nodeName&&e.getAttribute("href")?e.getAttribute("href"):"")).filter(Boolean);let n=t(e).join(" ").trim(),o="common";const s=e.querySelector(".room.private");if(s&&s.textContent.includes("[шепчет вам]")){const s=e.querySelector("span.private");s&&(n=t(s).join(" ").trim(),o="private")}const r=e.querySelector(".system-message");if(r){let e=t(r).join(" ").trim();e=e.replace(/<Клавобот>\s*/g,""),n=e,o="system"}"common"===o&&function(e){const t=e.toLowerCase();return Y.some((e=>t.includes(e.toLowerCase())))}(n)&&(o="mention");const a=JSON.parse(localStorage.getItem("personalMessages"))||{},l=e.querySelector(".time")?.textContent||"N/A",i=e.querySelector(".username span[data-user]"),c=i?i.getAttribute("data-user"):null,d=i?i.textContent:"SYSTEM",m=Kt(i?i.parentElement.style.color:"rgb(180,180,180)"),u=`${l}_${d}`;("mention"===o||"private"===o)&&!Q.includes(d)&&(a[u]={time:l,date:(new Date).toLocaleDateString("en-CA"),username:d,usernameColor:m,message:n,type:o,userId:c},localStorage.setItem("personalMessages",JSON.stringify(a)));const p=e.querySelector(".username"),g=p?p.textContent.replace(/[<>]/g,""):"SYSTEM";_t();let y="mention"===o||"private"===o?`${Rt(g)} обращается: `:g!==Jt?`${Rt(g)} пишет: `:"";return Jt=g,{messageText:y+Rt(n),usernameText:g}}let Xt=!1;const Vt=new Set;function Yt(e){Vt.has(e)||(Vt.add(e),Xt||(Xt=!0,async function(){for(let e of Vt)await we(e,K),Vt.delete(e);Xt=!1}()))}let Gt=!0;const Zt=600;function Qt(e="generalMessages"){const t={generalMessages:".messages-content",chatlogsMessages:".chat-logs-container",personalMessages:".messages-container-wrapper"}[e];if(!t)return;const n=document.querySelector(t);n&&(Gt?(n.scrollTop=n.scrollHeight,Gt=!1):n.scrollHeight-n.scrollTop-n.clientHeight<=Zt&&(n.scrollTop=n.scrollHeight))}async function en(e,t){const{top:n,height:o}=t.getBoundingClientRect(),{top:s,height:r}=e.getBoundingClientRect(),a=n-(s+r/2)+o/2;e.scrollBy({top:a,behavior:"smooth"}),await new Promise((e=>setTimeout(e,500))),e.style.scrollBehavior="auto",En(t)}function tn(){const e=document.getElementById("chat-content").querySelectorAll(".messages-content div p");let t=null,n=!0,o="14px";for(let s=0;s<e.length;s++){const r=e[s],a=r.querySelector("span.username");if(r.querySelector(".system-message"))r.style.marginTop=o,r.style.marginBottom=o;else if(a){const l=a.querySelector("span[data-user]");if(!l)continue;let i=l.textContent;if(i=i.replace(/</g,"").replace(/>/g,""),null===t||i!==t?n||(r.style.marginTop=o):n||r.style.removeProperty("margin-bottom"),s<e.length-1){const t=e[s+1].querySelector("span.username");if(t){const e=t.querySelector("span[data-user]");if(!e)continue;i!==e.textContent&&(r.style.marginBottom=o)}}t=i,n=!1}}}function nn(e,t){const[n,o]=e.length>=t.length?[e,t]:[t,e],s=n.length;return 0===s?1:(s-function(e,t){e=e.toLowerCase(),t=t.toLowerCase();const n=Array(t.length+1).fill(0).map(((e,t)=>t));for(let o=1;o<=e.length;o++){let s=n[0];n[0]=o;for(let r=1;r<=t.length;r++){const a=n[r];n[r]=e.charAt(o-1)===t.charAt(r-1)?s:Math.min(Math.min(a,s),n[r-1])+1,s=a}}return n[t.length]}(n,o))/s}tn();let on={};function sn(e){document.querySelectorAll(`.messages-content span[data-user="${e}"]`).forEach((e=>{const t=e.closest("p");t&&t.remove()}))}let rn=null;function an(e,t){on[e].thresholdMaxTries>=10&&(on[e].banned=!0,console.log(t(),"color: pink"),console.log(`%c${on[e].userName} cannot send messages anymore`,"color: pink"))}function ln(){const e=(new Date).getTime(),t=document.querySelector(".messages-content p:last-child");if(t){const n=t.querySelector("span[data-user]"),o=n?n.getAttribute("data-user"):null;on[o]||(on[o]={messagesCount:0,thresholdMaxTries:0,time:e,userName:n?n.textContent:"Unknown User",previousTime:null,firstInteraction:!0,banned:!1});const s=e-on[o].time;function r(){return`%cID: ${o}, Name: ${on[o].userName}, Time Difference: ${function(e){const t=["hour","minute","second","millisecond"];return[Math.floor(e/36e5),Math.floor(e/6e4%60),Math.floor(e/1e3%60),e%1e3].map(((e,n)=>e>0?`${e} ${t[n]}${e>1?"s":""}`:"")).filter(Boolean).join(" ")}(s)}, Messages Count: ${on[o].messagesCount}, Spam Tries: ${on[o].thresholdMaxTries}, Banned: ${on[o].banned}`}(function(e){const t=new RegExp("[0-9a-zA-Zа-яА-ЯёЁ\\s!@#$%^&*()-_=+[\\]{}|;:'\",.<>/?`~\\u00A9\\u2122\\u00AE\\u00AB\\u00BB\\u00B1\\u00D7\\u00F7\\u00B0\\u2260\\u2264\\u2265\\u221E\\u20AC\\u00A3\\u00A5\\u00A7\\u2022\\u2026\\u2212\\u2013\\u2014\\u2190\\u2192\\u2191\\u2193\\u00BD\\u2153\\u2154\\u2211\\u00B4\\uD83C-\\uDBFF\\uDC00-\\uDFFF]+","gu"),n=e.match(t);return!(!n||n.join("")!==e)||(rn=e.replace(t,""),!1)})(t.textContent)||on[o].banned||(on[o].thresholdMaxTries++,console.log(`%c${on[o].userName} has sent a message with not allowed characters ${rn}.\n          Threshold: ${on[o].thresholdMaxTries}.`,"color: orange;"),an(o,r)),on[o].firstInteraction?(console.log(`%c${on[o].userName} posted the first message for the current chat session.`,"color: yellow"),on[o].firstInteraction=!1):on[o].banned?sn(o):s<400?(on[o].messagesCount++,on[o].messagesCount>1?(sn(o),on[o].thresholdMaxTries++,an(o,r),on[o].banned||console.log(r(),"color: red")):console.log(r(),"color: green")):(on[o].previousTime=on[o].time,on[o].time=e,on[o].messagesCount=1,console.log(r(),"color: green"))}}const cn=document.createElement("style");cn.textContent="\n    .popup-messages-container {\n      display: flex;\n      flex-direction: column;\n      justify-content: flex-end;\n      align-items: start;\n      user-select: none;\n      pointer-events: none;\n      position: fixed;\n      left: 0;\n      right: 0;\n      top: 50px;\n      bottom: 0;\n    }\n\n    .popup-chat-message {\n      display: flex;\n      align-items: center;\n      background-color: hsl(100, 50%, 10%);\n      position: relative;\n      max-width: 70vw;\n      border-radius: 0.2em !important;\n      color: hsl(100, 50%, 50%);\n      border: 1px solid hsl(100, 50%, 25%);\n      padding: 4px;\n      margin: 6px 15vw;\n      opacity: 0;\n      transform: translateY(20px);\n      transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;\n      animation: fadeIn 0.3s ease-in-out forwards;\n    }\n\n    @keyframes fadeIn {\n      from {\n        opacity: 0;\n        transform: translateY(20px);\n      }\n      to {\n        opacity: 1;\n        transform: translateY(0);\n      }\n    }\n\n    .popup-chat-message.fade-out {\n      animation: fadeOut 0.3s ease-in-out forwards;\n    }\n\n    @keyframes fadeOut {\n      from {\n        opacity: 1;\n        transform: translateY(0);\n      }\n      to {\n        opacity: 0;\n        transform: translateY(-20px);\n      }\n    }\n\n    .popup-chat-message > div {\n      padding: 2px;\n      display: flex;\n      font-family: 'Montserrat', sans-serif;\n    }\n\n    .popup-chat-message .time,\n    .popup-chat-message .time-icon {\n      opacity: 0.7;\n    }\n",cn.classList.add("popup-chat-message-styles"),document.head.appendChild(cn);const dn={};function mn(){if("true"!==localStorage.getItem("shouldShowPopupMessage"))return;const e=document.querySelector(".messages-content p:last-of-type");if(e){const t=e.querySelector(".time"),n=e.querySelector(".username"),o=Array.from(e.childNodes).map((e=>{if(e.nodeType===Node.TEXT_NODE)return{type:"text",value:e.nodeValue.replace(/ /g," ")};if(e.nodeType===Node.ELEMENT_NODE){if("a"===e.tagName.toLowerCase()&&e.classList.contains("private"))return{type:"text",value:"📢 "};if("span"===e.tagName.toLowerCase()&&e.classList.contains("private"))return{type:"text",value:e.textContent.replace(/ /g," ")};if("img"===e.tagName.toLowerCase())return{type:"img",title:e.getAttribute("title")};if("a"===e.tagName.toLowerCase())return{type:"anchor",href:e.getAttribute("href")}}})).filter(Boolean),s=t.textContent.replace(/[\[\]]/g,""),r=n.textContent.replace(/[<>]/g,"");let c=dn[r];c||(c=15*Math.floor(24*Math.random()),dn[r]=c);let d=document.querySelector(".popup-messages-container");if(d||(d=document.createElement("div"),d.classList.add("popup-messages-container"),document.body.appendChild(d)),d.childElementCount>=10){const e=d.firstChild;e.classList.add("fade-out"),setTimeout((()=>{d.removeChild(e)}),300)}const m=document.createElement("div");m.classList.add("popup-chat-message"),m.style.filter=`hue-rotate(${c}deg)`;const u=document.createElement("div");u.classList.add("time-icon"),u.innerHTML=a;const p=document.createElement("div");p.classList.add("time"),p.textContent=s;const g=document.createElement("div");g.classList.add("user-icon"),g.innerHTML=i;const y=document.createElement("div");y.classList.add("username"),y.textContent=r;const h=document.createElement("div");h.classList.add("action-icon"),h.innerHTML=l;const f=document.createElement("div");f.classList.add("message"),m.appendChild(u),m.appendChild(p),m.appendChild(g),m.appendChild(y),m.appendChild(h),m.appendChild(f),o.forEach((e=>{const t=document.createElement("div");"text"===e.type?t.textContent=e.value:"img"===e.type?t.innerHTML=`&nbsp;${e.title}&nbsp;`:"anchor"===e.type&&(t.innerHTML=`&nbsp;${e.href}&nbsp;`),f.appendChild(t)})),d.appendChild(m)}}function un(e){return function(e){const t={А:"A",Б:"B",В:"V",Г:"G",Д:"D",Е:"E",Ё:"Yo",Ж:"Zh",З:"Z",И:"I",Й:"Y",К:"K",Л:"L",М:"M",Н:"N",О:"O",П:"P",Р:"R",С:"S",Т:"T",У:"U",Ф:"F",Х:"Kh",Ц:"Ts",Ч:"Ch",Ш:"Sh",Щ:"Shch",Ъ:"y",Ы:"Y",Ь:"i",Э:"E",Ю:"Yu",Я:"Ya",а:"a",б:"b",в:"v",г:"g",д:"d",е:"e",ё:"yo",ж:"zh",з:"z",и:"i",й:"y",к:"k",л:"l",м:"m",н:"n",о:"o",п:"p",р:"r",с:"s",т:"t",у:"u",ф:"f",х:"kh",ц:"ts",ч:"ch",ш:"sh",щ:"shch",ъ:"y",ы:"y",ь:"i",э:"e",ю:"yu",я:"ya"};return e.split("").map((e=>t[e]||e)).join("")}(e)}let pn=!1;const gn=new Map;function yn(e){return["Клавобот","Пользователь","заблокирован"].every((t=>e.includes(t)))}function hn(e,t){if(e)if("one"===t){const t=e.querySelector("span[data-user]");if(!t)return;const n=Kt(getComputedStyle(e).color);e.style.setProperty("color",n,"important"),t.style.setProperty("filter","invert(0)","important")}else"all"===t?Array.from(e).forEach((e=>{if(!e)return;const t=e.querySelector("span[data-user]");if(!t)return;const n=Kt(getComputedStyle(e).color);e.style.setProperty("color",n,"important"),t.style.setProperty("filter","invert(0)","important")})):console.error("Invalid mode. Use 'one' or 'all'.")}const fn=new MutationObserver((e=>{if(pn){for(let t of e)if("childList"===t.type)for(let e of t.addedNodes)if(e.nodeType===Node.ELEMENT_NODE&&"P"===e.tagName){const t=e.querySelector(".username");t&&hn(t,"one");const n=localStorage.getItem("previousMessageText"),o=Wt(),s=o?.messageText||null,r=o?.usernameText||null;gn.set(r,gn.get(r)||[]);const a=gn.get(r);if(a.some((e=>nn(s,e)>.8)))e.style.filter="opacity(0.3) blur(1px)";else{a.push(s),gn.set(r,a);let e=JSON.parse(localStorage.getItem("sessionChatMessages"))||{};e[r]=e[r]||[],e[r].push(s),a.length>5&&(gn.delete(r),delete e[r]),localStorage.setItem("sessionChatMessages",JSON.stringify(e))}const l=un(r);if(yn(s)&&(console.log("Ban message detected:",s),new Audio("https://github.com/VimiummuimiV/Sounds/raw/refs/heads/main/Mario_Game_Over.mp3").play()),r&&Q.includes(r)){e.classList.add("ignored-user",l),e.style.display="none";continue}const i=document.querySelector("#voice, #beep, #silence"),c=i&&"voice"===i.id,d=i&&"beep"===i.id,m=document.querySelector("#every-message, #mention-message"),u=m&&"every-message"===m.id,p=m&&"mention-message"===m.id,g="[шепчет вам]",y=e.querySelector(".room.private"),h=y&&y.textContent.includes(g);c&&pn&&s&&s!==n&&(localStorage.setItem("previousMessageText",s),r&&!r.includes(S)&&(u?(console.log("Triggered Voice: Every message mode"),Yt(s)):p&&zt?(console.log("Triggered Voice: Mention message mode"),Yt(s)):h?(console.log("Triggered Voice: Private message"),Yt(s)):console.log("No matching condition for Voice Mode"))),d&&pn&&s&&s!==n&&(localStorage.setItem("previousMessageText",s),r&&!r.includes(S))&&(u?(console.log("Triggered Beep: Every message mode"),xe(zt?he:ye,fe)):p&&zt?(console.log("Triggered Beep: Mention message mode"),xe(he,fe)):h?(console.log("Triggered Beep: Private message"),xe(he,fe)):console.log("No matching condition for Beep Mode"),zt&&(zt=!1)),pn&&(yo(),Ye("generalMessages"),tt("generalMessages"),st("generalMessages"),tn(),Qt(),ln(),mn(),Un())}}else pn=!0,localStorage.getItem("sessionChatMessages")&&localStorage.removeItem("sessionChatMessages"),hn(document.querySelectorAll(".username"),"all")})),vn=document.querySelector(".messages-content div");let xn,bn,wn,Sn;function Cn(e){e.classList.add("pulse-effect"),setTimeout((()=>{e.classList.remove("pulse-effect")}),500)}function kn(e,t=0,n=0){const o=[{transform:`translate(${t}%, calc(${n}%)) scale(1)`},{transform:`translate(${t}%, calc(${n}% - 60%)) scale(1.1)`},{transform:`translate(${t}%, calc(${n}% + 15%)) scale(1)`},{transform:`translate(${t}%, calc(${n}% - 20%)) scale(1.05)`},{transform:`translate(${t}%, calc(${n}% + 8%)) scale(1)`},{transform:`translate(${t}%, calc(${n}% - 10%)) scale(1.05)`},{transform:`translate(${t}%, calc(${n}% + 4%)) scale(1)`},{transform:`translate(${t}%, calc(${n}%)) scale(1)`}];return e.animate(o,{duration:500,easing:"ease",iterations:1}).finished}function En(e){e.classList.add("shake-effect"),setTimeout((()=>{e.classList.remove("shake-effect")}),500)}function Ln(e){Object.assign(e.style,{display:"flex",justifyContent:"center",alignItems:"center",width:"48px",height:"48px",cursor:"pointer",margin:"4px",backgroundColor:"#212226",border:"1px solid #45474b"})}function $n(){switch(xn.id){case"silence":bn.innerHTML=c;break;case"beep":bn.innerHTML=d;break;case"voice":bn.innerHTML=m}}function Tn(){return{speed:(K-0)/2.5*100+"%",pitch:(W-0)/2*100+"%"}}function Mn(e){e.style.position="absolute",e.style.top="65px",e.style.right="70px",e.style.opacity=0,e.style.transition="opacity 0.3s ease",e.style.fontFamily="Orbitron, sans-serif"}fn.observe(vn,{childList:!0,subtree:!0}),function(){xn=document.createElement("div");const e=_.messageSettings.messageNotificationState||"silence";xn.classList.add("sound-switcher-button"),xn.id=e,Ln(xn);const t=_.messageSettings.messageNotificationTitle||"Do not disturb";xn.title=t,bn=document.createElement("span"),bn.classList.add("sound-switcher-icon"),xn.appendChild(bn),at.appendChild(xn)}(),xn.addEventListener("click",(function(e){if(!ae&&!le){let e=document.querySelector(".current-voice-speed"),t=document.querySelector(".current-voice-pitch");switch(e&&e.remove(),t&&t.remove(),Cn(this),this.id){case"silence":this.id="beep",this.title="Notify with beep signal",_.messageSettings.messageNotificationState="beep",_.messageSettings.messageNotificationTitle="Notify with beep signal";break;case"beep":this.id="voice",this.title="Notify with voice API",_.messageSettings.messageNotificationState="voice",_.messageSettings.messageNotificationTitle="Notify with voice API";break;case"voice":this.id="silence",this.title="Do not disturb",_.messageSettings.messageNotificationState="silence",_.messageSettings.messageNotificationTitle="Do not disturb"}localStorage.setItem("KG_Chat_Empowerment",JSON.stringify(_)),$n()}})),$n();let Nn=null,qn=null;function In(e,t){const n=parseFloat(_.voiceSettings[e]),[o,s]="voiceSpeed"===e?[0,2.5]:[0,2],r=n+t,a=Math.min(s,Math.max(o,r));return n!==a&&(function(e,t){const n=parseFloat(t.toFixed(1));_.voiceSettings[e]=n,"voiceSpeed"===e?K=n:"voicePitch"===e&&(W=n),localStorage.setItem("KG_Chat_Empowerment",JSON.stringify(_)),function(){let e=document.querySelector(".voice-settings"),t=document.querySelector(".current-voice-speed"),n=document.querySelector(".current-voice-pitch");if(ae){e||(e=document.createElement("div"),e.classList.add("voice-settings"),xn.appendChild(e),Mn(e),e.offsetWidth,e.style.opacity="1"),n&&n.remove(),t||(t=document.createElement("span"),t.classList.add("current-voice-speed"),e.appendChild(t));let o=e.querySelector(".current-voice-speed .voice-value-info");o||(o=document.createElement("span"),o.classList.add("voice-value-info"),e.querySelector(".current-voice-speed").appendChild(o),o.style.display="flex",o.style.width="100%",o.style.justifyContent="center",o.style.marginBottom="6px",o.style.color="hsl(100, 50%, 50%)"),o&&(o.innerHTML=K<=0||K>=2.5?g:`SPEED ${Number(K).toFixed(1)}`);let s=e.querySelector(".current-voice-speed .voice-progress");if(!s){s=document.createElement("span"),s.classList.add("voice-progress");let t=document.createElement("span");t.classList.add("voice-progress-fill"),s.appendChild(t),e.querySelector(".current-voice-speed").appendChild(s)}s.querySelector(".voice-progress-fill").style.width=Tn().speed;const r={display:"block",width:"120px",height:"12px",backgroundColor:"hsl(90, 60%, 30%)"},a={display:"block",height:"100%",backgroundColor:"hsl(90, 60%, 50%)"};for(let e in r)s.style[e]=r[e];for(let e in a)s.querySelector(".voice-progress-fill").style[e]=a[e];e.timeoutId&&clearTimeout(e.timeoutId),e.timeoutId=setTimeout((()=>{e.style.opacity="0",setTimeout((()=>{e.remove()}),500)}),2e3)}else if(le){e||(e=document.createElement("div"),e.classList.add("voice-settings"),xn.appendChild(e),Mn(e),e.offsetWidth,e.style.opacity="1"),t&&t.remove(),n||(n=document.createElement("span"),n.classList.add("current-voice-pitch"),e.appendChild(n));let o=e.querySelector(".current-voice-pitch .voice-value-info");o||(o=document.createElement("span"),o.classList.add("voice-value-info"),e.querySelector(".current-voice-pitch").appendChild(o),o.style.display="flex",o.style.width="100%",o.style.justifyContent="center",o.style.marginBottom="6px",o.style.color="hsl(180, 60%, 50%)"),o&&(o.innerHTML=W<=0||W>=2?g:`PITCH ${W.toFixed(1)}`);let s=e.querySelector(".current-voice-pitch .voice-progress");if(!s){s=document.createElement("span"),s.classList.add("voice-progress");let t=document.createElement("span");t.classList.add("voice-progress-fill"),s.appendChild(t),e.querySelector(".current-voice-pitch").appendChild(s)}s.querySelector(".voice-progress-fill").style.width=Tn().pitch;const r={display:"block",width:"120px",height:"12px",backgroundColor:"hsl(180, 60%, 30%)"},a={display:"block",height:"100%",backgroundColor:"hsl(180, 60%, 50%)"};for(let e in r)s.style[e]=r[e];for(let e in a)s.querySelector(".voice-progress-fill").style[e]=a[e];e.timeoutId&&clearTimeout(e.timeoutId),e.timeoutId=setTimeout((()=>{e.style.opacity="0",setTimeout((()=>{e.remove()}),500)}),2e3)}else e&&e.remove()}()}(e,a),t>0?a<s:a>o)}function An(){switch(wn.id){case"every-message":Sn.innerHTML=u;break;case"mention-message":Sn.innerHTML=p}}function jn(e,t){const n=document.createElement("div");return n.classList.add(e),n.style.display="flex",n.style.position="absolute",n.style.justifyContent="center",n.style.alignItems="center",n.style.height="20px",n.style.padding="0 4px",n.style.setProperty("border-radius","2px","important"),n.style.backgroundColor=t,n.style.color="rgb(2, 2, 2)",n.style.fontSize="12px",n.style.fontFamily="Roboto",n.style.fontWeight="bold",n.style.bottom="0",n}async function On(e,t,n){const o=document.querySelector(".messages-content");if(!o)return null;const s=e=>e.replace(/[\[\]]/g,"").split(":").reduce(((e,t,n)=>e+Number(t)*60**(2-n)),0),r=s(e),a=e=>Array.from(o.querySelectorAll("p")).find((n=>{const o=n.querySelector(".time"),r=n.querySelector(".username span[data-user]");if(o&&r){const n=s(o.textContent.trim()),a=r.textContent.trim();return e(n)&&a===t}return!1}));let l=a((e=>e===r));return l||(l=a((e=>Math.abs(e-r)<=2))),l&&n&&await en(o,l),l||!1}function Pn(e){const t=180- -(new Date).getTimezoneOffset(),[n,o,s]=e.split(":").map(Number);let r=60*n+o+t;r=(r%1440+1440)%1440;const a=r%60;return`${Math.floor(r/60).toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`}function Bn(e,t="single"){const n=e.querySelector(".message-time").textContent,o=e.querySelector(".message-username").textContent;let s=JSON.parse(localStorage.getItem("personalMessagesBackup"))||{};0===Object.keys(s).length&&(s={...JSON.parse(localStorage.getItem("personalMessages"))||{}},localStorage.setItem("personalMessagesBackup",JSON.stringify(s)));let r={...s};if("all"===t)document.querySelectorAll(".message-item").forEach((e=>{const t=e.querySelector(".message-username").textContent;if(t===o){e.remove();const n=e.querySelector(".message-time").textContent;delete r[`[${n}]_${t}`]}}));else if("from"===t){const t=Array.from(document.querySelectorAll(".message-item"));for(let n=t.indexOf(e);n<t.length;n++){const e=t[n],s=e.querySelector(".message-username").textContent;if(s===o){e.remove();const t=e.querySelector(".message-time").textContent;delete r[`[${t}]_${s}`]}}}else{const t=`[${n}]_${o}`;r[t]&&(delete r[t],e.remove())}localStorage.setItem("personalMessagesBackup",JSON.stringify(r));const a=document.querySelector(".personal-messages-button .total-message-count");a&&(a.textContent=Object.keys(r).length)}function Hn(){const e=Object.keys(JSON.parse(localStorage.getItem("personalMessages")||"{}")).length;document.querySelector(".personal-messages-button .total-message-count").textContent=e}async function Dn(){const e=document.querySelector(".cached-messages-panel");if(e)return e.remove(),void ct("hide");let t=!0,n=!1;Hn(),localStorage.getItem("personalMessagesBackup")&&localStorage.removeItem("personalMessagesBackup"),ut();const o=document.querySelector(".personal-messages-button .new-message-count");function s(){const e=localStorage.getItem("personalMessages");return JSON.parse(e)||{}}o&&(o.textContent="0"),o.style.visibility="hidden",localStorage.removeItem("newMessagesCount");let r=s();const a=document.createElement("div");a.className="cached-messages-panel popup-panel",a.style.opacity="0",a.style.backgroundColor="#1b1b1b",a.style.setProperty("border-radius","0.6em","important"),a.style.position="fixed",a.style.top="100px",a.style.left="50%",a.style.transform="translateX(-50%)",a.style.width="50vw",a.style.height="80vh",a.style.zIndex="999",a.style.minWidth="1000px",a.style.display="grid",a.style.gridTemplateColumns="1fr",a.style.gridTemplateRows="min-content",a.style.gridTemplateAreas='\n      "header header"\n      "messages scroll"';const l=document.createElement("div");l.className="panel-header",l.style.display="flex",l.style.flexDirection="row",l.style.justifyContent="flex-end",l.style.padding="0.6em",l.style.gridArea="header";const i=document.createElement("div");i.className="search-for-personal-messages",i.style.width="100%",i.style.margin="0 0.5em 0 0",i.style.display="flex";const c=document.createElement("input");c.className="personal-messages-search-input",c.type="text",c.style.outline="none",c.style.width="100%",c.style.padding="10px",c.style.fontSize="1em",c.style.fontFamily="Montserrat",c.style.color="bisque",c.style.setProperty("border-radius","0.2em","important"),c.style.boxSizing="border-box",c.style.backgroundColor="#111",c.style.border="1px solid #222",i.appendChild(c);const d=document.createElement("div");function m(e,t,n="0 0.5em",o="flex"){e.style.backgroundColor=t,e.style.width="48px",e.style.height="48px",e.style.display=o,e.style.justifyContent="center",e.style.alignItems="center",e.style.cursor="pointer",e.style.setProperty("border-radius","0.2em","important"),e.style.margin=n,e.style.filter="brightness(1)",e.style.transition="filter 0.3s ease, opacity 0.3s ease"}d.className="panel-control-buttons",d.style.display="flex";const u=document.createElement("div");u.className="save-messages-button",u.innerHTML=H,u.title="Save messages",u.style.opacity="0",m(u,"#2f6b63","0 0.5em","none"),u.addEventListener("click",(()=>{const e=localStorage.getItem("personalMessagesBackup"),n=localStorage.getItem("personalMessages"),o=e&&n;o&&o&&n!==e&&!t&&window.confirm("Do you want to apply changes?")&&(localStorage.setItem("personalMessages",e),localStorage.removeItem("personalMessagesBackup"),u.style.setProperty("display","none","important"),u.style.opacity="0",u.addEventListener("transitionend",(function(){u.style.display="none"})))}));const p=document.createElement("div");p.className="import-messages-button",p.innerHTML=P,p.title="Import messages",m(p,"#502f6b"),p.addEventListener("click",(()=>{n=!0;const e=document.createElement("input");e.type="file",e.accept=".json",e.addEventListener("change",(e=>{const t=e.target.files[0];if(t){const e=new FileReader;e.onload=async()=>{try{const t=JSON.parse(e.result),n={...JSON.parse(localStorage.getItem("personalMessages")||"{}"),...t},o=Object.fromEntries(Object.entries(n).sort((([,e],[,t])=>{const n=e.time.replace(/[[\]]/g,""),o=t.time.replace(/[[\]]/g,""),s=`${e.date} ${n}`,r=`${t.date} ${o}`;return new Date(s)-new Date(r)})));localStorage.setItem("personalMessages",JSON.stringify(o)),Hn();const r=s();await T(r)}catch(e){alert("Failed to import messages. The file may be corrupted.")}},e.readAsText(t)}})),e.click()}));const g=document.createElement("div");g.className="export-messages-button",g.innerHTML=B,g.title="Export messages",m(g,"#2f4c6b"),g.addEventListener("click",(()=>{const e=localStorage.getItem("personalMessages");if(e&&"{}"!==e){const t=new Intl.DateTimeFormat("en-CA").format(new Date),n=JSON.parse(e),o=JSON.stringify(n,null,2),s=new Blob([o],{type:"application/json"}),r=document.createElement("a");r.href=URL.createObjectURL(s),r.download=`Personal_Messages_${t}.json`,r.click()}else alert("No messages to export.")}));const y=document.createElement("div");y.className="copy-personal-messages-button",y.innerHTML=N,y.title="Copy Personal Messages",m(y,"steelblue"),y.addEventListener("click",(()=>{kn(y,0,0);const e=Array.from(document.querySelector(".messages-container").children).filter((e=>{const t=window.getComputedStyle(e);return"hidden"!==t.contentVisibility&&"none"!==t.display})).map((e=>e.classList.contains("date-item")?e.textContent.trim():[e.querySelector(".message-time"),e.querySelector(".message-username"),e.querySelector(".message-text")].map((e=>e?.textContent.trim())).filter(Boolean).join(" "))).filter(Boolean).join(" \n");e.trim()?navigator.clipboard.writeText(e).then((()=>kn(y,0,0))).catch(console.error):alert("No messages to copy.")}));const h=document.createElement("div");h.className="clear-cache-button",h.title="Clear personal messages",h.innerHTML=j,m(h,"brown"),h.addEventListener("click",(()=>{n=!0;const e=JSON.parse(localStorage.getItem("personalMessages")||"{}");if(0===Object.keys(e).length)return void alert("No messages to delete.");v.innerHTML=null,localStorage.setItem("personalMessages",JSON.stringify({})),dt(a,"hide"),ct("hide");const t=document.querySelector(".personal-messages-button .total-message-count");t&&(t.textContent="0")}));const f=document.createElement("div");f.className="close-panel-button",f.title="Close panel",f.innerHTML=w,m(f,"darkolivegreen","0 0 0 0.5em"),f.addEventListener("click",(()=>{dt(a,"hide"),ct("hide")})),l.appendChild(i),d.appendChild(u),d.appendChild(p),d.appendChild(g),d.appendChild(y),d.appendChild(h),d.appendChild(f),l.appendChild(d),a.appendChild(l);const v=document.createElement("div");v.className="messages-container",v.style.overflowY="auto",v.style.height="calc(100% - 0.5em)",v.style.padding="1em",v.style.gridArea="messages";let x=null,b=0,S=100,C=!1,k=null;const E=[],L={private:"coral",mention:"darkseagreen"},$={private:"coral",mention:"lightsteelblue",default:"slategray"};async function T(e){v.children.length&&v.replaceChildren(),Object.entries(e).forEach((([,{time:e,date:t,username:n,usernameColor:o,message:s,type:r,userId:l}])=>{if(k!==t){const e=document.createElement("div");e.className="date-item",e.textContent=t===z?"Today ⏳":`${t} 📅`,e.dataset.date=t,e.style.position="relative",e.style.font="1em Montserrat",e.style.color="burlywood",e.style.backgroundColor="rgba(222, 184, 135, 0.1)",e.style.width="fit-content",e.style.margin="2em 1em 1em",e.style.padding="0.4em 0.8em",e.style.textAlign="center",e.style.setProperty("border-radius","0.4em","important"),e.style.left="50%",e.style.transform="translateX(-50%)",v.appendChild(e),k=t}const i=document.createElement("div");i.className="message-item",i.style.padding="0.2em",n!==x&&(i.style.marginTop="0.6em",x=n);const c=e.replace(/[\[\]]/g,"").trim(),d=document.createElement("span");if(d.className="message-time",d.textContent=c,d.title=`Moscow Time: ${Pn(c)}`,d.style.margin="0px 0.4em",d.style.height="fit-content",d.style.cursor="pointer",d.style.transition="color 0.2s ease",d.style.color=L[r]||"slategray","mention"===r||"private"===r){const e="mention"===r?"lightgreen":"peachpuff";d.addEventListener("mouseover",(()=>{d.style.color=e})),d.addEventListener("mouseout",(()=>{d.style.color=L[r]})),d.addEventListener("click",(e=>{if(e.ctrlKey)Bn(i,"from");else if("mention"===r){const e=`https://klavogonki.ru/chatlogs/${t}.html#${Pn(c)}`;window.open(e,"_blank","noopener,noreferrer")}}))}const m=document.createElement("span");m.className="message-username",m.textContent=n,m.style.color=o,m.style.display="inline-flex",m.style.cursor="pointer",m.style.margin="0px 0.4em",m.style.height="fit-content",m.addEventListener("click",(e=>{if(e.ctrlKey)Bn(i,"all");else if(l){const e=`https://klavogonki.ru/u/#/${l}/`;window.open(e,"_blank","noopener,noreferrer")}else En(m)}));const u=document.createElement("span");u.className="message-text",u.style.cursor="pointer",u.style.margin="0px 0.4em",u.style.height="fit-content",u.innerHTML=s.replace(/:(?=\w*[a-zA-Z])(\w+):/g,((e,t)=>`<img src="/img/smilies/${t}.gif" alt=":${t}:" title=":${t}:" class="smile">`)).replace(/(https?:\/\/[^\s]+)/gi,(e=>`<a href="${e}" target="_blank" rel="noopener noreferrer">${e}</a>`)),u.addEventListener("click",(async function(t){if(t.ctrlKey)Bn(i,"single");else if(await On(e,n,!0))dt(a,"hide"),ct("hide");else{let e=u.parentElement.previousElementSibling;for(;e&&!e.classList.contains("date-item");)e=e.previousElementSibling;if(e){await Wn(e.dataset.date);const t=Pn(c);requestAnimationFrame((async()=>{setTimeout((async()=>{const e=await async function(e,t){const n=document.querySelector(".chat-logs-container");if(!n)return null;const o=e=>e.replace(/[\[\]]/g,"").split(":").reduce(((e,t,n)=>e+Number(t)*60**(2-n)),0),s=o(e),r=e=>Array.from(n.querySelectorAll(".message-item")).find((n=>{const s=n.querySelector(".message-time"),r=n.querySelector(".message-username");if(s&&r){const n=o(s.textContent.trim()),a=r.textContent.trim();return e(n)&&a===t}return!1}));let a=r((e=>e===s));return a||(a=r((e=>Math.abs(e-s)<=2))),a&&await en(n,a),a||!1}(t,n);e||(dt(document.querySelector(".chat-logs-panel"),"hide"),Dn())}),500)}))}}}));const p={messageTextElement:u,time:e,username:n,type:r};E.push(p),i.appendChild(d),i.appendChild(m),i.appendChild(u),v.appendChild(i)})),requestAnimationFrame((()=>{Ye("personalMessages"),tt("personalMessages"),st("personalMessages"),_t("personalMessages"),v.scrollTop=v.scrollHeight,new MutationObserver((e=>{n||e.find((e=>"childList"===e.type&&e.removedNodes.length>0))&&"0"===u.style.opacity&&(t=!1,u.style.display="flex",u.offsetHeight,u.style.opacity="1")})).observe(v,{childList:!0,subtree:!0}),setTimeout((()=>{n=!1}),500)})),E.reverse().forEach((async({messageTextElement:e,time:t,username:n,type:o})=>{b<S&&(C=await On(t,n,!1),b++,b>=S&&(C=!1,console.log("Reached maximum ping checks, resetting pingMessages."))),e.style.color=C&&"mention"===o?"lightgreen":C&&"private"===o?"lemonchiffon":$[o]||"slategray"}))}await T(r),a.appendChild(v),document.body.appendChild(a);const{scrollButtonsContainer:M,fullScrollUpButton:q,partialScrollUpButton:I,partialScrollDownButton:A,fullScrollDownButton:O}=me(v);a.appendChild(M),[u,p,g,y,h,f,q,I,A,O].forEach((e=>{e.addEventListener("mouseover",(()=>{e.style.filter="brightness(0.8)"})),e.addEventListener("mouseout",(()=>{e.style.filter="brightness(1)"}))})),dt(a,"show"),ct("show"),c.addEventListener("click",(()=>ae&&(c.value=""))),c.addEventListener("input",(()=>{const e=c.value.toLowerCase().replace(/_/g," ");v.querySelectorAll(".date-item").forEach((t=>{let n=!1,o=t.nextElementSibling;for(;o&&!o.classList.contains("date-item");){const t=(o.querySelector(".message-time")?.textContent.toLowerCase().replace(/_/g," ")+" "+o.querySelector(".message-username")?.textContent.toLowerCase().replace(/_/g," ")+" "+o.querySelector(".message-text")?.textContent.toLowerCase().replace(/_/g," ")).includes(e);o.style.contentVisibility=t?"visible":"hidden",o.style.fontSize=t?"":"0",n=n||t,o=o.nextElementSibling}t.style.display=n?"":"none"}))})),requestAnimationFrame((function(){c.focus()})),mt.handlePersonalMessagesKeydown=e=>{"Escape"===e.key&&(dt(a,"hide"),ct("hide"),document.removeEventListener("keydown",mt.handlePersonalMessagesKeydown))},document.addEventListener("keydown",mt.handlePersonalMessagesKeydown)}xn.addEventListener("mousedown",(function(e){e.preventDefault();const t=function(e){const t=0===e.button,n=e.ctrlKey||e.metaKey,o=e.altKey;if(!n&&!o)return null;const s=n?"voiceSpeed":"voicePitch",r=t?-.1:.1,a=_.voiceSettings[s],[l,i]="voiceSpeed"===s?[0,2.5]:[0,2];return r<0&&a<=l||r>0&&a>=i?null:{prop:s,step:r}}(e);if(!t)return;const{prop:n,step:o}=t;In(n,o),Nn=setTimeout((()=>{qn=setInterval((()=>{In(n,o)||clearInterval(qn)}),100)}),500);const s=()=>{clearTimeout(Nn),clearInterval(qn),xn.removeEventListener("mouseup",s),xn.removeEventListener("mouseleave",s)};xn.addEventListener("mouseup",s),xn.addEventListener("mouseleave",s)})),xn.addEventListener("contextmenu",(e=>e.preventDefault())),function(){wn=document.createElement("div");const e=_.messageSettings.messageModeState||"every-message";wn.classList.add("message-mode-button"),wn.id=e,Ln(wn);const t=_.messageSettings.messageModeTitle||"Notify about every message";wn.title=t,Sn=document.createElement("span"),Sn.classList.add("message-mode-icon"),wn.appendChild(Sn),at.appendChild(wn)}(),wn.addEventListener("click",(function(e){if(!ae||!le){switch(Cn(this),this.id){case"every-message":this.id="mention-message",this.title="Notify about mention message",_.messageSettings.messageModeState="mention-message",_.messageSettings.messageModeTitle="Notify about mention message";break;case"mention-message":this.id="every-message",this.title="Notify about every message",_.messageSettings.messageModeState="every-message",_.messageSettings.messageModeTitle="Notify about every message"}localStorage.setItem("KG_Chat_Empowerment",JSON.stringify(_)),An()}})),An(),function(){const e=document.createElement("div");e.classList.add("cache-panel-load-button"),Ln(e),e.style.position="relative",e.style.zIndex="3",e.innerHTML=y;const t=document.createElement("div");t.classList.add("cache-user-count"),t.style.display="flex",t.style.position="absolute",t.style.justifyContent="center",t.style.alignItems="center",t.style.left="0",t.style.bottom="0",t.style.transform="translate(-50%, 50%)",t.style.zIndex="1",t.style.height="20px",t.style.padding="0 4px",t.style.setProperty("border-radius","2px","important"),t.style.backgroundColor="#9db380",t.style.color="rgb(2, 2, 2)",t.style.fontSize="12px",t.style.fontFamily="Roboto",t.style.fontWeight="bold";const n=JSON.parse(localStorage.getItem("fetchedUsers"))||{},o=Object.keys(n).length;t.textContent=o,e.appendChild(t),e.title="Show Cache Panel",e.addEventListener("click",(function(){Cn(e),ft()})),at.appendChild(e)}(),function(){const e=document.createElement("div");e.classList.add("personal-messages-button"),Ln(e),e.style.position="relative",e.style.zIndex="2",e.innerHTML=h;const t=jn("total-message-count","#fa8072"),n=JSON.parse(localStorage.getItem("personalMessages"))||{};t.textContent=Object.keys(n).length,t.style.left="0",t.style.transform="translate(-50%, 50%)",e.appendChild(t);const o=jn("new-message-count","#ffd700");let s=Number(localStorage.getItem("newMessagesCount"))||(localStorage.setItem("newMessagesCount","0"),0);o.textContent=s,o.style.visibility=s>0?"visible":"hidden",o.style.right="0",o.style.transform="translate(50%, 50%)",e.appendChild(o),e.title="Show Personal Messages",e.addEventListener("click",(function(){Cn(e),Dn(),Object.keys(JSON.parse(localStorage.getItem("personalMessages"))||{}).length>0&&(localStorage.setItem("newMessagesCount","0"),s=0,o.textContent=s)})),at.appendChild(e)}();let Fn=localStorage.personalMessages&&Object.keys(JSON.parse(localStorage.personalMessages)).length||0;function Un(){const e=document.querySelector(".personal-messages-button .total-message-count"),t=document.querySelector(".personal-messages-button .new-message-count");if(!e||!t)return;const n=JSON.parse(localStorage.getItem("personalMessages"))||{},o=Object.keys(n).length;let s=Number(localStorage.getItem("newMessagesCount"))||0;o>Fn&&(s++,localStorage.setItem("newMessagesCount",s),Cn(t),kn(t,50,50)),e.textContent=o,t.textContent=s,t.style.visibility=s>0?"visible":"hidden",o!==Fn&&Cn(e),Fn=o}!function(){const e=document.createElement("div");e.classList.add("chat-logs-button"),Ln(e),e.style.position="relative",e.style.zIndex="1",e.innerHTML=f,e.title="Show Chat Logs",e.addEventListener("click",(async function(){Cn(e),await Wn()})),at.appendChild(e)}();const Jn=async(e,t)=>{t&&(t.innerHTML="");const n=`https://klavogonki.ru/chatlogs/${e}.html?rand=${Math.floor(Math.random()*10**20)}`;try{const e=await fetch(n);if(!e.ok)throw new Error("Network response was not ok");const t=await e.text(),o=1024e3,s=t.length>o?t.slice(0,o):t,r=(e=>[...(new DOMParser).parseFromString(e,"text/html").querySelectorAll(".ts")].map((e=>{const t=e.nextElementSibling,n=t?.nextSibling,o=e=>e?[...e.childNodes].reduce(((e,t)=>{if(t.nodeType===Node.TEXT_NODE)e+=t.textContent;else if(t.nodeType===Node.ELEMENT_NODE)if("A"===t.tagName)e+=t.getAttribute("href");else if("BR"===t.tagName)return e;return e}),"").trim():"";if(t?.classList.contains("mn")&&n){let s="";if(n.nodeType===Node.ELEMENT_NODE)s=o(n);else if(n.nodeType===Node.TEXT_NODE){const e=t.nextElementSibling;s=e&&"A"===e.tagName?`${n.textContent.trim()} ${e.getAttribute("href")}`:n.textContent.trim()}return s||(s=o(t.nextSibling)),{time:e.textContent.trim().replace(/[\[\]]/g,""),username:t.textContent.trim().replace(/<|>/g,""),message:s||null}}const s=e.nextElementSibling;if(s&&s.classList.contains("mne")){const t=s.textContent.trim();return{time:e.textContent.trim().replace(/[\[\]]/g,""),username:"SYSTEM",message:t||null}}return null})).filter(Boolean))(s),a=t.length>o,l=[];let i=null;for(const e of r){const t=e.message!==i?.message,n=e.username!==i?.username;(t||n)&&(l.push(e),i=e)}return{chatlogs:l.filter((e=>!Q.includes(e.username))),url:n,size:s.length,info:a,error:null}}catch(e){return{chatlogs:[],url:n,size:0,error:e.message}}},zn="2012-02-12";let Rn={media:!1,mention:!1};const _n=()=>{Rn={media:!1,mention:!1}};async function Kn(e){const t="mention"===e;Rn={media:!("media"!==e||Rn.media),mention:!!t&&!Rn.mention},document.querySelectorAll(".message-item").forEach((e=>{const t=e.querySelector(".media"),n=e.querySelector(".mention");Rn.media?(e.style.contentVisibility=t?"visible":"hidden",e.style.fontSize=t?"":"0"):Rn.mention?(e.style.contentVisibility=n?"visible":"hidden",e.style.fontSize=n?"":"0"):(e.style.contentVisibility="visible",e.style.fontSize="")}))}async function Wn(e){const t=document.querySelector(".chat-logs-panel");if(t)return t.remove(),void ct("hide");ut();const n=document.createElement("div");n.className="chat-logs-panel popup-panel",n.style.opacity="0",n.style.backgroundColor="#1b1b1b",n.style.setProperty("border-radius","0.6em","important"),n.style.position="fixed",n.style.top="100px",n.style.left="50%",n.style.transform="translateX(-50%)",n.style.width="80vw",n.style.height="80vh",n.style.zIndex="999",n.style.minWidth="1000px",n.style.display="grid",n.style.gridTemplateColumns="1fr",n.style.gridTemplateRows="min-content",n.style.gridTemplateAreas='\n      "header header header"\n      "messages scroll users"';const o=document.createElement("div");o.className="panel-header",o.style.display="flex",o.style.flexDirection="row",o.style.gridArea="header",o.style.justifyContent="flex-end",o.style.padding="0.6em";const s=document.createElement("div");s.className="panel-control-buttons",s.style.display="flex";const r=document.createElement("div");r.className="search-for-chatlogs-messages",r.style.width="100%",r.style.margin="0 0.5em 0 0",r.style.display="flex";const a=document.createElement("input");function l(){requestAnimationFrame((function(){a.focus()}))}function i(e,t,n="0 0.5em"){e.style.backgroundColor=t,e.style.width="48px",e.style.height="48px",e.style.display="flex",e.style.justifyContent="center",e.style.alignItems="center",e.style.cursor="pointer",e.style.setProperty("border-radius","0.2em","important"),e.style.margin=n,e.style.filter="brightness(1)",e.style.transition="filter 0.3s ease"}a.className="chatlogs-search-input",a.type="text",a.style.outline="none",a.style.height="48px",a.style.width="100%",a.style.padding="10px",a.style.fontSize="1em",a.style.fontFamily="Montserrat",a.style.setProperty("color","bisque","important"),a.style.setProperty("border-radius","0.2em","important"),a.style.boxSizing="border-box",a.style.backgroundColor="#111",a.style.border="1px solid #222",r.appendChild(a),o.appendChild(r),a.addEventListener("input",(()=>Q(a.value))),a.addEventListener("click",(e=>{e.ctrlKey&&(a.value="",Q(a.value))})),a.addEventListener("keydown",(async e=>{const t=a.value;if("Enter"===e.key){let e=t;/^\d{8}$/.test(t)?(e=6===t.length?"20"+t:t,e=e.replace(/(\d{4})(\d{2})(\d{2})/,"$1-$2-$3")):/^\d{6}$/.test(t)&&(e="20"+t.replace(/(\d{2})(\d{2})(\d{2})/,"$1-$2-$3")),/^\d{2,4}[:\-]\d{2}[:\-]\d{2}$/.test(e.replace(/:/g,"-"))&&!isNaN(new Date(e.replace(/:/g,"-")).getTime())?(await Y(e),d(m)):alert("Please enter a valid date.\n\nValid formats include:\n1. yyyy-mm-dd\n2. yyyy:mm:dd\n3. yy-mm-dd\n4. yy:mm:dd\n5. yyyymmdd\n6. yymmdd\n\n"),a.value=""}})),l();const c=document.createElement("div");function d(e){"none"===e.style.display&&(e.style.display="flex")}c.className="date-panel-button",c.innerHTML=M,i(c,"steelblue"),c.style.margin="0 0.5em",c.addEventListener("click",(()=>{var e;(e=m).style.display="none"===e.style.display?"flex":"none"}));const m=document.createElement("input");m.type="date",m.className="chatlogs-date-input",m.style.backgroundColor="#111",m.style.color="bisque",m.style.border="1px solid #222",m.style.width="fit-content",m.style.height="48px",m.style.padding="10px",m.style.fontSize="1em",m.style.fontFamily="Montserrat",m.style.display="none",m.style.setProperty("border-radius","0.2em","important"),m.style.boxSizing="border-box",m.style.margin="0 0.5em",s.appendChild(c),s.appendChild(m);const u=document.createElement("div");function p(e,t){e.style.display="flex",e.style.position="absolute",e.style.justifyContent="center",e.style.alignItems="center",e.style.padding="2px 4px",e.style.setProperty("border-radius","2px","important"),e.style.fontSize="12px",e.style.fontFamily="Roboto",e.style.fontWeight="bold",e.style.bottom="0px",e.style.left="0px",e.style.transform="translate(-50%, 50%)",e.style.backgroundColor=t,e.style.color="#020202",e.style.pointerEvents="none",e.style.userSelect="none"}u.className="toggle-mention-messages",u.innerHTML=h,u.title="Toggle Mention Messages",i(u,"saddlebrown"),u.addEventListener("click",(async()=>{await Kn("mention")}));const g=document.createElement("div");g.className="toggle-mention-messages-counter",g.textContent="0",p(g,"#ffa07a"),u.appendChild(g),s.appendChild(u);const y=document.createElement("div");y.className="toggle-media-messages",y.innerHTML=v,y.title="Toggle Media Messages",i(y,"darkslategray"),y.addEventListener("click",(async()=>{await Kn("media")}));const f=document.createElement("div");f.className="toggle-media-messages-counter",f.textContent="0",p(f,"#71c4c4"),y.appendChild(f),s.appendChild(y);const x=document.createElement("div");x.className="copy-current-chatlogs-url",x.innerHTML=N,x.title="Copy Chat Logs Url",i(x,"steelblue");const b=e=>{const t=e.match(/(\d{4}-\d{2}-\d{2})/);return t?t[1]:null};function S(e,t){t&&(t.replaceChildren(),e.forEach((({url:n,title:o})=>{const s=b(n),r=document.createElement("div");r.classList.add("saved-chatlog-url-wrapper");const a=document.createElement("a");a.classList.add("saved-chatlog-url"),a.textContent=s,a.href=n,a.style.setProperty("color","darkseagreen","important"),a.style.textDecoration="none",a.style.display="inline-flex",a.style.padding="0.5em",a.addEventListener("click",(async t=>{if(t.preventDefault(),t.ctrlKey){const n=t.target.href,o=e.filter((e=>e.url!==n));o.length!==e.length&&(e=o,localStorage.setItem("savedChatlogs",JSON.stringify(e)),t.target.closest(".saved-chatlog-url-wrapper").remove())}else await Y(s)}));const l=document.createElement("span");l.classList.add("saved-chatlog-url-title"),l.textContent=o||"➕",l.style.color="lightsteelblue",l.style.padding="0.5em",l.addEventListener("click",(()=>{const t=prompt("Enter a new title for this chat log:",l.textContent);if(null!==t&&t!==l.textContent){l.textContent=t;const o=e.findIndex((e=>e.url===n));-1!==o&&(e[o].title=t,localStorage.setItem("savedChatlogs",JSON.stringify(e)))}})),r.appendChild(a),r.appendChild(l),t.appendChild(r)})))}x.addEventListener("click",(e=>{let t=document.querySelector(".saved-chatlog-container");!t&&!e.shiftKey&&kn(x,0,0),!t||e.ctrlKey||t.contains(e.target)||t.remove();let n=JSON.parse(localStorage.getItem("savedChatlogs"))||[];if(e.ctrlKey&&!e.target.closest(".saved-chatlog-url")){const e=b(V);if(!e)return;const o=prompt("Enter a title for this chat log:","➕");n.some((t=>b(t.url)===e))||(n.push({url:V,title:o||"➕"}),n.sort(((e,t)=>{const n=b(e.url),o=b(t.url);return new Date(n)-new Date(o)})),localStorage.setItem("savedChatlogs",JSON.stringify(n))),S(n,t)}else e.shiftKey?n.length>0&&!t&&(t=document.createElement("div"),t.classList.add("saved-chatlog-container"),t.style.display="flex",t.style.flexDirection="column",t.style.overflowY="auto",t.style.backgroundColor="rgb(30, 40, 45)",t.style.setProperty("border","1px solid rgb(60, 70, 80)","important"),t.style.setProperty("border-radius","0.2em","important"),t.style.position="absolute",t.style.padding="0.5em",t.style.height="fit-content",t.style.width="max-content",t.style.maxHeight=`calc(${H.offsetHeight}px - 0.5em)`,t.style.top="calc(50px + 1em)",t.style.right="0",S(n,t),x.appendChild(t)):navigator.clipboard.writeText(V).catch((e=>console.error("Failed to copy: ",e)))})),s.appendChild(x);const C=localStorage.getItem("shouldShowActiveUsers")||(localStorage.setItem("shouldShowActiveUsers","shown"),"shown"),k=document.createElement("div");function E(e){k.innerHTML="shown"===e?T:$,k.title="shown"===e?"Hide User List":"Show User List"}k.className="toggle-active-users",E(C),i(k,"#144e9d"),k.title="shown"===C?"Hide User List":"Show User List",k.addEventListener("click",(function(){const e="shown"===localStorage.getItem("shouldShowActiveUsers")?"hidden":"shown";if(localStorage.setItem("shouldShowActiveUsers",e),E(e),"shown"===e)G(X,n);else{const e=n.querySelector(".active-users");e&&n.removeChild(e)}})),s.appendChild(k);const L=document.createElement("div");L.className="chevron-left-button",L.title="Previous Day",L.innerHTML=q,i(L,"darkcyan");const j=document.createElement("div");j.className="chevron-right-button",j.title="Next Day",j.innerHTML=I,i(j,"darkcyan");const O=document.createElement("div");function P(){return m.value?new Date(m.value):new Date}O.className="shuffle-button",O.title="Random Date",O.innerHTML=A,i(O,"darkslateblue"),L.addEventListener("click",(async()=>{const e=P();e.setDate(e.getDate()-1),await Y(e),d(m),l(),_n()})),j.addEventListener("click",(async()=>{const e=P();e.setDate(e.getDate()+1),await Y(e),d(m),l(),_n()})),O.addEventListener("click",(async()=>{const e=function(){const e=new Date(zn),t=new Date-e,n=Math.floor(Math.random()*t),o=new Date(e.getTime()+n);return new Intl.DateTimeFormat("en-CA").format(o)}();await Y(e),d(m),l(),_n()})),s.appendChild(L),s.appendChild(j),s.appendChild(O);const B=document.createElement("div");B.className="close-panel-button",B.title="Close panel",B.innerHTML=w,i(B,"darkolivegreen","0 0 0 0.5em"),B.addEventListener("click",(()=>{dt(n,"hide"),ct("hide")})),s.appendChild(B),o.appendChild(s);const H=document.createElement("div");H.className="chat-logs-container",H.style.overflowY="auto",H.style.height="calc(100% - 0.5em)",H.style.padding="1em",H.style.display="flex",H.style.gridArea="messages",H.style.flexDirection="column",n.appendChild(o),n.appendChild(H);const{scrollButtonsContainer:D,fullScrollUpButton:F,partialScrollUpButton:U,partialScrollDownButton:J,fullScrollDownButton:R}=me(H);function _(e,t){return t&&e.target.closest(`.${t}`)}n.appendChild(D),[{element:F},{element:R},{element:U},{element:J},{element:u},{element:y},{element:x,exclusion:"saved-chatlog-container"},{element:k},{element:c},{element:L},{element:j},{element:O},{element:B}].forEach((e=>{const{element:t,exclusion:n}=e;t.addEventListener("mouseover",(e=>{_(e,n)||(t.style.filter="brightness(0.8)")})),t.addEventListener("mouseout",(e=>{_(e,n)&&e.relatedTarget?.closest(`.${n}`)||(t.style.filter="brightness(1)")}))})),document.body.appendChild(n),dt(n,"show"),ct("show");const K={};let W=null;const X=new Map;let V="";const Y=async e=>{const t=new Intl.DateTimeFormat("en-CA").format(new Date((e=>/^\d{4}:\d{2}:\d{2}$/.test(e)?e.replace(/:/g,"-"):e)(e)));if(t<zn||t>z)return void alert(t<zn?`The selected date cannot be earlier than ${zn}.`:"You cannot load a future date.");var o;o=t,m.value=o,c.title=`Current date: ${o}`;const{chatlogs:s,url:r,size:l,info:i,error:d}=await Jn(t,H),u=(l/1024).toFixed(2);a.placeholder=d?`Error: ${d}`:i?`Limit reached: ${u} KB`:i||`Size: ${u} KB`,V=r,X.clear(),s.forEach((async({time:t,username:n,message:o})=>{X.set(n,(X.get(n)||0)+1);const s=document.createElement("div");s.classList.add("message-item"),s.style.padding="0.2em",s.style.display="inline-flex",s.style.cursor="pointer",s.style.alignItems="start",s.addEventListener("click",(async e=>{e.target.closest("a")||(Rn&&await Kn(),a.value.length>0&&(a.value=""),await en(H,s))}));const r=document.createElement("span");r.className="message-time",r.textContent=t,r.style.color="darkseagreen",r.style.margin="0 0.4em",r.style.cursor="pointer",r.style.transition="color 0.2s ease",r.style.height="fit-content",r.addEventListener("mouseover",(()=>{r.style.color="lightgreen"})),r.addEventListener("mouseout",(()=>{r.style.color="darkseagreen"})),r.addEventListener("click",(function(){const n=`https://klavogonki.ru/chatlogs/${e}.html#${t}`;window.open(n,"_blank","noopener,noreferrer")}));const l=document.createElement("span");l.className="message-username",l.textContent=n,l.style.cursor="pointer",l.style.margin="0 0.4em",l.style.height="fit-content",l.addEventListener("click",(async()=>{const e=await async function(e){const t=JSON.parse(localStorage.getItem("userIdsCache")||"{}");if(t[e])return t[e];try{const n=await async function(e){const t=`https://klavogonki.ru/api/profile/search-users?query=${e}`,n=await St(t);if(!n.all?.length)throw new Error(`User ${e} not found.`);const o=n.all.find((t=>t.login===e));if(!o)throw new Error(`Exact match for user ${e} not found.`);return o.id}(e);if(n)return t[e]=n,localStorage.setItem("userIdsCache",JSON.stringify(t)),n}catch(t){console.error(`Error fetching user ID for ${e}:`,t)}return null}(n);if(e){const t=`https://klavogonki.ru/u/#/${e}/`;window.open(t,"_blank","noopener,noreferrer")}else En(l)}));let i=K[n];i||(i=15*Math.floor(14*Math.random()),K[n]=i),l.style.color=`hsl(${i}, 80%, 50%)`;const c=document.createElement("span");c.className="message-text",c.style.color="lightsteelblue",c.style.margin="0 0.4em",c.style.overflowWrap="anywhere",c.style.height="fit-content",c.innerHTML=o.replace(/:(?=\w*[a-zA-Z])(\w+):/g,((e,t)=>`<img src="/img/smilies/${t}.gif" alt=":${t}:" title=":${t}:" class="smile">`)).replace(/(https?:\/\/[^\s]+)/gi,(e=>`<a href="${e}" target="_blank" rel="noopener noreferrer">${e}</a>`)),s.style.marginTop=W!==n?"0.6em":"",W=n,s.appendChild(r),s.appendChild(l),s.appendChild(c),H.appendChild(s)})),G(X,n),requestAnimationFrame((()=>{Ye("chatlogsMessages"),tt("chatlogsMessages"),st("chatlogsMessages"),_t("chatlogsMessages"),H.scrollTop=H.scrollHeight,f.textContent=document.querySelectorAll(".chat-logs-container .media").length,g.textContent=document.querySelectorAll(".chat-logs-container .mention").length,H.childElementCount>0&&(a.placeholder+=` | Total messages: ${H.childElementCount}`),a.value.length>0&&Q(a.value)}))};function G(e,t,n){if("shown"===localStorage.getItem("shouldShowActiveUsers")){let n=t.querySelector(".active-users");n||(n=document.createElement("div"),n.className="active-users",n.style.padding="1em",n.style.height="calc(100% - 1em)",n.style.width="fit-content",n.style.overflowY="auto",n.style.overflowX="hidden",n.style.gridArea="users",n.style.display="flex",n.style.flexDirection="column",t.appendChild(n));const o=Array.from(e.entries()).sort((([,e],[,t])=>t-e));n.innerHTML="",o.forEach((([e,t])=>{const o=document.createElement("div");o.className="active-user-item",o.style.display="flex",o.style.height="fit-content",o.style.alignItems="center",o.style.justifyContent="left",o.style.margin="0.2em 0",o.style.cursor="pointer",o.style.transition="filter 0.15s",o.addEventListener("mouseover",(()=>o.style.filter="brightness(0.8)")),o.addEventListener("mouseout",(()=>o.style.filter="brightness(1)")),o.addEventListener("click",(()=>{const t=a.value.trim(),n=ae?`, ${e}`:e;a.value=t===e?"":ae&&!t.includes(e)?t+n:e,Q(a.value)}));const s=document.createElement("span");s.className="active-user-name",s.textContent=e,s.style.padding="0.4em";const r=K[e]||0;s.style.color=`hsl(${r}, 80%, 50%)`;const l=document.createElement("span");l.className="active-user-messages-count",l.textContent=t,l.style.padding="0.4em",l.style.color=`hsl(${r}, 80%, 50%)`,l.style.backgroundColor=`hsla(${r}, 80%, 50%, 0.2)`,l.style.setProperty("border-radius","0.2em","important"),o.appendChild(l),o.appendChild(s),n.appendChild(o)}))}}const Z=e||z;function Q(e){if(/^[\d-:]+$/.test(e.trim()))return;function t(e){return e.replace(/[_-]/g," ").toLowerCase()}const n=t(e).trim(),o=Array.from(document.querySelectorAll(".chat-logs-container > .message-item")),s=function(e){return e.map((e=>{const t=e.querySelector(".message-username"),n=t?t.textContent.toLowerCase().trim():"",o=e.querySelector(".message-text");return{username:n,messageText:o?o.textContent.toLowerCase().trim():""}}))}(o),r=!n,a=n.split(",").map((e=>e.trim())).filter(Boolean),l=a.filter((e=>s.some((n=>t(n.username)===e)))).length>=2;o.forEach(((e,o)=>{const i=e.closest(".message-item"),c=s[o];let d=!1;const m=t(c.username),u=t(c.messageText);d=!!r||(l?a.some((e=>m===e)):m.includes(n)||u.includes(n)),i.style.contentVisibility=d?"visible":"hidden",i.style.fontSize=d?"":"0"}))}await Y(Z),e&&d(m),m.max=z,m.min=zn,m.value=Z,c.title=`Current date: ${Z}`,m.addEventListener("change",(async e=>{const t=e.target.value;await Y(t),c.title=`Current date: ${t}`})),mt.handleChatLogsKeydown=e=>{"Escape"===e.key&&(dt(n,"hide"),ct("hide"),document.removeEventListener("keydown",mt.handleChatLogsKeydown))},document.addEventListener("keydown",mt.handleChatLogsKeydown)}async function Xn(e){const t=e.target.files[0];if(t){const e=new FileReader;return new Promise(((n,o)=>{e.onload=function(e){const t=e.target.result;try{Gn(JSON.parse(t)),n()}catch(e){console.error("Error parsing JSON data:",e.message),console.error("Invalid JSON:",t),alert("Failed to parse JSON data. Please check the format and try again."),o(e)}},e.onerror=function(e){console.error("Error reading file:",e.target.error),o(e.target.error)},e.readAsText(t)}))}}function Vn(e){if(!e||"object"!=typeof e)return console.error("Invalid settings data for download."),void alert("Cannot export settings. Please try again.");try{const t="  ",n="    ",o=e.usersToTrack.map((e=>`${n}${JSON.stringify(e)}`)).join(",\n"),s=e.usernameReplacements?.map((e=>`${n}${JSON.stringify(e)}`)).join(",\n")||"",r=e.toggle.map((e=>`${n}${JSON.stringify(e)}`)).join(",\n"),a=`{\n${t}"usersToTrack": [\n${o}\n${t}],\n${t}"mentionKeywords": [\n${e.mentionKeywords.map((e=>`${n}"${e}"`)).join(",\n")}\n${t}],\n${t}"usernameReplacements": [\n${s}\n${t}],\n${t}"moderator": [\n${e.moderator.map((e=>`${n}"${e}"`)).join(",\n")}\n${t}],\n${t}"ignored": [\n${e.ignored.map((e=>`${n}"${e}"`)).join(",\n")}\n${t}],\n${t}"toggle": [\n${r}\n${t}]\n}`,l=`KG_Chat_Empowerment_Settings_${new Intl.DateTimeFormat("en-CA").format(new Date)}.json`,i=new Blob([a],{type:"application/json"}),c=URL.createObjectURL(i),d=document.createElement("a");d.href=c,d.download=l,document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(c)}catch(e){console.error("Error exporting settings:",e),alert("Failed to export settings. Please try again.")}}function Yn(){return{usersToTrack:JSON.parse(localStorage.getItem("usersToTrack"))||[],mentionKeywords:JSON.parse(localStorage.getItem("mentionKeywords"))||[],usernameReplacements:JSON.parse(localStorage.getItem("usernameReplacements"))||[],moderator:JSON.parse(localStorage.getItem("moderator"))||[],ignored:JSON.parse(localStorage.getItem("ignored"))||[],toggle:JSON.parse(localStorage.getItem("toggle"))||[]}}function Gn({usersToTrack:e=[],mentionKeywords:t=[],usernameReplacements:n=[],moderator:o=[],ignored:s=[],toggle:r=[]}){V=Array.isArray(e)?e:V,Y=Array.isArray(t)?t:Y,G=Array.isArray(n)?n:G,Z=Array.isArray(o)?o:Z,Q=Array.isArray(s)?s:Q,ee=Array.isArray(r)?r:ee,localStorage.setItem("usersToTrack",JSON.stringify(V)),localStorage.setItem("mentionKeywords",JSON.stringify(Y)),localStorage.setItem("usernameReplacements",JSON.stringify(G)),localStorage.setItem("moderator",JSON.stringify(Z)),localStorage.setItem("ignored",JSON.stringify(Q)),localStorage.setItem("toggle",JSON.stringify(ee)),console.log("Uploaded settings applied:",{usersToTrack:V,mentionKeywords:Y,usernameReplacements:G,moderator:Z,ignored:Q,toggle:ee})}function Zn(){const e=window.location.href;let t,n;if(e.includes("gamelist"))t=document.querySelector("#chat-general .text"),n=document.querySelector("#chat-general .messages");else{if(!e.includes("gmid"))return console.error("No matching room type found in the URL."),null;t=document.querySelector('[id^="chat-game"] .text'),n=document.querySelector('[id^="chat-game"] .messages')}return{inputField:t,lengthPopupContainer:n}}!function(){const e=document.createElement("div");e.classList.add("settings-button"),e.title="Show Settings Panel",Ln(e),e.style.position="relative",e.innerHTML=b;const t=document.createElement("input");t.type="file",t.accept=".json",t.style.display="none",t.addEventListener("change",Xn),e.addEventListener("click",(n=>{Cn(e),le&&Vn(Yn()),ae&&t.click(),le||ae||function(){const e=document.querySelector(".settings-panel");if(e)return e.remove(),void ct("hide");ut();const t=document.createElement("div");t.className="settings-panel popup-panel",t.style.opacity="0",t.style.backgroundColor="#1b1b1b",t.style.setProperty("border-radius","0.6em","important"),t.style.position="fixed",t.style.top="100px",t.style.left="50%",t.style.transform="translateX(-50%)",t.style.width="50vw",t.style.height="80vh",t.style.zIndex="999",t.style.minWidth="1000px",t.style.display="grid",t.style.gridTemplateColumns="1fr",t.style.gridTemplateRows="min-content",t.style.gridTemplateAreas='\n      "header header"\n      "settings scroll"',mt.handleSettingsKeydown=e=>{"Escape"===e.key&&(dt(t,"hide"),ct("hide"),document.removeEventListener("keydown",mt.handleSettingsKeydown))},document.addEventListener("keydown",mt.handleSettingsKeydown);const n=document.createElement("div");function o(e,t,n="0 0.5em"){e.style.backgroundColor=t,e.style.width="48px",e.style.height="48px",e.style.display="flex",e.style.justifyContent="center",e.style.alignItems="center",e.style.cursor="pointer",e.style.setProperty("border-radius","0.2em","important"),e.style.margin=n,e.style.filter="brightness(1)",e.style.transition="filter 0.3s ease, opacity 0.3s ease"}n.className="panel-header",n.style.display="flex",n.style.flexDirection="row",n.style.justifyContent="flex-end",n.style.padding="0.6em",n.style.gridArea="header";const s=document.createElement("div");s.className="close-panel-button",s.innerHTML=w,s.title="Close panel",o(s,"darkolivegreen","0 0 0 0.5em"),s.addEventListener("click",(()=>{dt(t,"hide"),ct("hide")}));const r=document.createElement("div");r.className="clear-cache-button",r.innerHTML=j,r.title="Clear settings",o(r,"brown"),r.addEventListener("click",(()=>{c()}));const a=document.createElement("div");a.className="import-settings-button",a.innerHTML=P,a.title="Import settings",o(a,"#502f6b");const l=document.createElement("div");l.className="save-settings-button",l.innerHTML=H,l.title="Save settings",l.style.opacity="0",o(l,"#2f6b63");const i=document.createElement("input");function c(){[".settings-tracked-container",".settings-mention-container",".settings-replacement-container",".settings-moderator-container",".settings-ignored-container",".settings-toggle-container"].forEach((e=>{const t=document.querySelector(e);t&&t.replaceChildren();const n=t.querySelector(".add-setting-button");n&&t.appendChild(n)}))}i.type="file",i.accept=".json",i.style.display="none",i.addEventListener("change",(async e=>{await Xn(e),c(),k()})),a.addEventListener("click",(()=>{i.click()})),a.appendChild(i);const d=document.createElement("div");d.className="export-settings-button",d.innerHTML=B,d.title="Export settings",o(d,"#2f4c6b"),d.addEventListener("click",(function(){Vn(Yn())})),n.appendChild(l),n.appendChild(a),n.appendChild(d),n.appendChild(r),n.appendChild(s),t.appendChild(n),t.appendChild(n);const m=document.createElement("div");function u(e,t,n,o){e.style.stroke=t,e.style.width="30px",e.style.height="30px",e.style.display="flex",e.style.justifyContent="center",e.style.alignItems="center",e.style.backgroundColor=n,e.style.setProperty("border-radius","0.2em","important"),e.style.cursor="pointer",e.style.transition="filter 0.3s",e.addEventListener("mouseover",(()=>e.style.filter="brightness(0.8)")),e.addEventListener("mouseout",(()=>e.style.filter="brightness(1)")),o?(e.style.filter="grayscale(1)",e.style.pointerEvents="none",e.style.opacity="0.5"):e.style.filter="grayscale(0)"}function p(e){e.style.height="30px",e.style.maxWidth="120px",e.style.minWidth="105px",e.style.padding="0.4em",e.style.font="1em Montserrat",e.style.fontFamily="Montserrat",e.style.setProperty("color","bisque","important"),e.style.setProperty("border-radius","0.2em","important"),e.style.boxSizing="border-box",e.style.setProperty("background-color","rgb(17,17,17)","important"),e.style.setProperty("border","1px solid rgb(34,34,34)","important"),Array.from(e.options).forEach((e=>{e.style.height="30px",e.style.setProperty("background-color","rgb(17,17,17)","important"),e.style.setProperty("color","bisque","important"),e.style.fontFamily="Montserrat"}))}function g(e,t){e.addEventListener("click",(()=>{const n=e.classList.toggle("assigned-frozen-config");e.classList.toggle("assigned-thawed-config"),e.style.opacity=n?"1":"0.3",function(e,t){const n=localStorage.getItem("usersToTrack");if(n){const o=JSON.parse(n).map((n=>n.name===e?{...n,state:t}:n));localStorage.setItem("usersToTrack",JSON.stringify(o))}}(t,n?"frozen":"thawed")}))}function y(e,t="inline-flex"){const n=document.createElement("div");return n.className=`${e}-item`,n.style.display=t,n.style.gap="0.5em",n.style.padding="0.25em",n}function h(e,t="",n=""){const o=document.createElement("input");return o.className=`${e}-field`,o.value=t,o.placeholder=n,function(e){e.style.height="30px",e.style.maxWidth="200px",e.style.minWidth="150px",e.style.padding="0.4em",e.style.font="1em Montserrat",e.style.fontFamily="Montserrat",e.style.color="bisque",e.style.setProperty("border-radius","0.2em","important"),e.style.boxSizing="border-box",e.style.backgroundColor="rgb(17,17,17)",e.style.border="1px solid rgb(34,34,34)"}(o),o}function f(e,t){const n=document.createElement("div");return n.className=`remove-${e}-word`,n.innerHTML=D,function(e,t){e.addEventListener("click",(()=>{t.remove()}))}(n,t),u(n,"#ee9090","#6b2f2f",!1),n}function v(e){const t=y("tracked","flex"),n=h("tracked-username",e.name,"Username"),o=h("tracked-pronunciation",e.pronunciation,"Pronunciation"),s=f("tracked",t),r=function(e="thawed",t){const n=document.createElement("div");return n.className=`assigned-${e}-config`,n.style.opacity="thawed"===e?"0.3":"1",n.innerHTML=F,g(n,t),u(n,"lightsteelblue","steelblue",!1),n}("frozen"===e.state?"frozen":"thawed",e.name),a=document.createElement("select");return a.className="tracked-gender-select",[{value:"Male",emoji:"👨"},{value:"Female",emoji:"👩"}].forEach((({value:t,emoji:n})=>{const o=document.createElement("option");o.value=t,o.textContent=`${n} ${t}`,e.gender===t&&(o.selected=!0),a.appendChild(o)})),p(a),t.appendChild(n),t.appendChild(a),t.appendChild(o),t.appendChild(s),t.appendChild(r),t}function x(e){const t=y("mention"),n=h("mention",e,"Mention Keyword"),o=f("mention",t);return t.appendChild(n),t.appendChild(o),t}function b(e={original:"",replacement:""}){const t=y("replacement"),n=h("replacement-original",e.original,"Original username"),o=h("replacement",e.replacement,"Replacement name"),s=f("replacement",t);return t.appendChild(n),t.appendChild(o),t.appendChild(s),t}function S(e){const t=y("moderator"),n=h("moderator",e,"Moderator Name"),o=f("moderator",t);return t.appendChild(n),t.appendChild(o),t}function C(e){const t=y("ignored"),n=h("ignored",e,"Ignored User"),o=f("ignored",t);return t.appendChild(n),t.appendChild(o),t}function k(){const e={usersToTrack:".settings-tracked-container",mentionKeywords:".settings-mention-container",usernameReplacements:".settings-replacement-container",moderator:".settings-moderator-container",ignored:".settings-ignored-container"},t={usersToTrack:{name:"tracked",createItem:v},mentionKeywords:{name:"mention",createItem:x},usernameReplacements:{name:"replacement",createItem:b},moderator:{name:"moderator",createItem:S},ignored:{name:"ignored",createItem:C}},n=Yn();Object.entries(n).forEach((([n,o])=>{const s=document.querySelector(e[n]);if(!s)return;s.style.width="100%",s.style.display="flex",s.style.flexWrap="wrap",s.style.alignItems="start",s.style.flexDirection="column","mentionKeywords"!==n&&"moderator"!==n&&"ignored"!==n||(s.style.flexDirection="row");const r=s.querySelector(".add-button");for(;s.firstChild&&s.firstChild!==r;)s.removeChild(s.firstChild);o.forEach((e=>s.appendChild(t[n].createItem(e))));const a=function(e,t){const n=e.split("-")[1],o=document.querySelector(`.add-${n}-item`);o&&o.remove();const s=document.createElement("div");return s.className=`add-button add-setting-button add-${n}-item`,s.innerHTML=U,u(s,"#d190ee","#502f6b",!1),s.style.margin="0.4em",s.addEventListener("click",(()=>{const o=document.querySelector(e),r=o.querySelectorAll(`.${n}-item`),a=r.length>0?r[r.length-1]:null,l=a?a.querySelectorAll("input"):[],i=Array.from(l).some((e=>0===e.value.trim().length));if(a&&i)alert("Please fill in the previous item before adding a new one.");else{const e=t(t===v?{name:"",pronunciation:""}:"");e instanceof HTMLElement?o.insertBefore(e,s):console.error("Invalid item created.")}})),s}(e[n],t[n].createItem);if(s.appendChild(a),null===s.closest(".settings-spoiler")){const e=s.parentNode;if(e){const o=Array.from(e.childNodes).indexOf(s);e.removeChild(s);const r=function(e,t={}){const n=document.createElement("div");n.classList.add("settings-spoiler");const o=document.createElement("button");return o.textContent=t.showText||"Show Content",e.style.display="none",(s=o).style.position="relative",s.style.font="1em Montserrat",s.style.color="lightgreen",s.style.backgroundColor="rgba(222, 184, 135, 0.1)",s.style.margin="0 0 3em 0",s.style.padding="0.4em 0.8em",s.style.setProperty("border-radius","0.4em","important"),s.style.left="50%",s.style.transform="translateX(-50%)",s.style.cursor="pointer",s.style.transition="background-color 0.3s ease",s.style.border="none",s.addEventListener("mouseenter",(()=>{s.style.backgroundColor="rgba(222, 184, 135, 0.25)"})),s.addEventListener("mouseleave",(()=>{s.style.backgroundColor="rgba(222, 184, 135, 0.1)"})),o.addEventListener("click",(()=>{const n="none"===e.style.display;e.style.display=n?"flex":"none",o.textContent=n?t.hideText||"Hide Content":t.showText||"Show Content"})),n.appendChild(o),n.appendChild(e),n;var s}(s,{showText:`Show ${t[n].name} settings`,hideText:`Hide ${t[n].name} settings`});r.classList.add("settings-spoiler-wrapper"),o>=e.childNodes.length?e.appendChild(r):e.insertBefore(r,e.childNodes[o])}}}));const o=JSON.parse(localStorage.getItem("toggle"))||[],s=document.querySelector(".settings-toggle-container");[{name:"showChatStaticNotifications",description:"👀 Show chat static notifications",image:"https://i.imgur.com/oUPSi9I.jpeg"},{name:"showGlobalDynamicNotifications",description:"👀 Show global dynamic notifications",image:"https://i.imgur.com/8ffCdUG.jpeg"},{name:"enabledBeepOnChatJoinLeave",description:"🔊 Play a beep sound and speak feedback when the user enters or leaves the chat",image:"https://i.imgur.com/6PXFIES.jpeg"},{name:"switchToGoogleTTSEngine",description:"🔊 Switch to google TTS engine if available",image:"https://i.imgur.com/0H94LII.jpeg"}].forEach((e=>{const t=o.find((t=>t.name===e.name)),n=t?t.option:"yes",r=function(e,t,n){const o=y("toggle","flex");o.style.alignItems="center";const s=document.createElement("select");s.className="toggle-select";const r=document.createElement("span");return r.className="toggle-description",r.innerText=e.description,r.setAttribute("data-toggle-name",t),r.style.cursor="pointer",r.style.color="burlywood",r.style.transition="color 0.15s ease-in-out",r.addEventListener("click",(()=>{e.image&&window.open(e.image,"_blank")})),r.addEventListener("mouseover",(function(){r.style.color="lightgoldenrodyellow"})),r.addEventListener("mouseout",(function(){r.style.color="burlywood"})),[{value:"yes",emoji:"✔️"},{value:"no",emoji:"❌"}].forEach((({value:e,emoji:t})=>{const n=document.createElement("option");n.value=e,n.textContent=`${t} ${e}`,s.appendChild(n)})),s.value=n,p(s),o.appendChild(s),o.appendChild(r),o}(e,e.name,n);s.appendChild(r)}))}m.className="settings-content-container",m.style.overflowY="auto",m.style.height="calc(100% - 0.5em)",m.style.padding="1em",m.style.gridArea="settings",[{type:"tracked",emoji:"👀"},{type:"mention",emoji:"📢"},{type:"replacement",emoji:"♻️"},{type:"moderator",emoji:"⚔️"},{type:"ignored",emoji:"🛑"},{type:"toggle",emoji:"🔘"}].forEach((({type:e,emoji:t})=>{const n=document.createElement("div");var o;n.className=`settings-${e}-description`,(o=n).style.position="relative",o.style.font="1em Montserrat",o.style.color="burlywood",o.style.backgroundColor="rgba(222, 184, 135, 0.1)",o.style.width="fit-content",o.style.margin="0 0 1em",o.style.padding="0.4em 0.8em",o.style.setProperty("border-radius","0.4em","important"),o.style.left="50%",o.style.transform="translateX(-50%)";const s=document.createElement("div");s.className=`settings-${e}-container`,n.textContent=`${e.charAt(0).toUpperCase()}${e.slice(1).toLowerCase()} ${t}`,m.appendChild(n),m.appendChild(s)})),t.appendChild(m);const{scrollButtonsContainer:E,fullScrollUpButton:L,partialScrollUpButton:$,partialScrollDownButton:T,fullScrollDownButton:M}=me(m);t.appendChild(E),[r,s,a,d,L,$,T,M].forEach((e=>{e.addEventListener("mouseover",(()=>{e.style.filter="brightness(0.8)"})),e.addEventListener("mouseout",(()=>{e.style.filter="brightness(1)"}))})),document.body.appendChild(t),k(),function(e){const t=document.querySelector(".settings-content-container");if(!t)return console.error("Container not found.");const n=()=>e.style.opacity="0",o=Yn(),s=()=>{const s={usersToTrack:[],mentionKeywords:[],usernameReplacements:[],moderator:[],ignored:[],toggle:[]};t.querySelectorAll(".settings-tracked-container .tracked-item").forEach((e=>{const t=e.querySelector(".tracked-username-field"),n=e.querySelector(".tracked-gender-select"),o=e.querySelector(".tracked-pronunciation-field"),r=e.querySelector(".assigned-thawed-config, .assigned-frozen-config"),a=t?t.value.trim():"",l=n?n.value.trim():"",i=o?o.value.trim():"",c=r.classList.contains("assigned-frozen-config")?"frozen":"thawed";s.usersToTrack.push({name:a,gender:l,pronunciation:i,state:c})}));const r=new Set(s.usersToTrack.map((e=>e.name.toLowerCase())));return t.querySelectorAll(".settings-mention-container .mention-item").forEach((e=>{const t=e.querySelector(".mention-field"),n=t?t.value.trim():"";s.mentionKeywords.push(n)})),t.querySelectorAll(".settings-replacement-container .replacement-item").forEach((e=>{const t=e.querySelector(".replacement-original-field"),n=e.querySelector(".replacement-field"),o=t?t.value.trim():"",a=n?n.value.trim():"";if(r.has(o.toLowerCase()))return t.classList.add("input-error"),void En(t);t.classList.remove("input-error"),s.usernameReplacements.push({original:o,replacement:a})})),t.querySelectorAll(".settings-moderator-container .moderator-item").forEach((e=>{const t=e.querySelector(".moderator-field"),n=t?t.value.trim():"";s.moderator.push(n)})),t.querySelectorAll(".settings-ignored-container .ignored-item").forEach((e=>{const t=e.querySelector(".ignored-field"),n=t?t.value.trim():"";s.ignored.push(n)})),t.querySelectorAll(".settings-toggle-container .toggle-item").forEach((e=>{const t=e.querySelector(".toggle-description"),n=e.querySelector(".toggle-select"),o=n?n.value.trim():"no",r=t.getAttribute("data-toggle-name");r&&s.toggle.push({name:r,option:o})})),JSON.stringify(o)!==JSON.stringify(s)?e.style.opacity="1":n(),s};e.addEventListener("click",(()=>{const e=s();Gn(e),Object.assign(o,e),n()})),t.querySelectorAll("input, select").forEach((e=>{e.addEventListener("input",s)})),new MutationObserver(Dt((e=>{e.forEach((e=>{"childList"===e.type&&(e.addedNodes.forEach((e=>{var t;e.nodeType===Node.ELEMENT_NODE&&("INPUT"===(t=e).tagName||"SELECT"===t.tagName?t.addEventListener("input",s):t.querySelectorAll("input, select").forEach((e=>{e.addEventListener("input",s)})))})),e.removedNodes.forEach((e=>{e.nodeType===Node.ELEMENT_NODE&&s()})))}))}),300)).observe(t,{childList:!0,subtree:!0})}(l),dt(t,"show"),ct("show")}()})),e.appendChild(t),at.appendChild(e)}();const{inputField:Qn,lengthPopupContainer:eo}=Zn(),to=document.createElement("div");to.className="length-field-popup",eo.appendChild(to);const no=document.createElement("canvas").getContext("2d");let oo,so=!1,ro=0;function ao(e){let t;t=e>ro?`${e} 🡆`:e<ro?`🡄 ${e}`:`${e}`,to.textContent=t,function(e){if(!to)return void console.error("lengthPopup is not defined");let t;if(0===e)t="hsl(200, 20%, 50%)";else if(e>=1&&e<=90)t="hsl(120, 100%, 40%)";else if(e>90&&e<=100){const n=(e-90)/10;t=`hsl(${Math.round(120+-60*n)}, 100%, 40%)`}else if(e>100&&e<=190)t="hsl(60, 100%, 50%)";else if(e>190&&e<=200){const n=(e-190)/10;t=`hsl(${Math.round(60+-30*n)}, 100%, 50%)`}else if(e>200&&e<=250)t="hsl(40, 100%, 50%)";else if(e>250&&e<=300){const n=(e-250)/50;t=`hsl(${Math.round(40+-40*n)}, 100%, 70%)`}else t="hsl(0, 100%, 70%)";to.style.color=t}(e),ro=e}function lo(e){so!==e&&(to.classList.toggle("bounce-in",e),to.classList.toggle("bounce-out",!e),so=e,e||setTimeout((()=>to.classList.remove("bounce-out")),500))}function io(){yo(),vo(),fo()}function co(e){e.style.setProperty("background-color","hsla(0, 50%, 30%, .5)","important"),e.style.setProperty("box-shadow","inset 0px 0px 0px 1px rgb(191, 64, 64)","important"),e.style.setProperty("background-clip","padding-box","important")}Qn.addEventListener("input",(()=>{clearTimeout(oo),ao(Qn.value.length),function(e){const t=getComputedStyle(Qn);no.font=`${t.fontWeight} ${t.fontSize} ${t.fontFamily}`;const n=no.measureText(e).width,o=Qn.offsetLeft+n+5,s=Qn.offsetLeft+Qn.offsetWidth-to.offsetWidth;to.style.left=`${Math.min(o,s)}px`}(Qn.value),lo(!0),oo=setTimeout((()=>lo(!1)),1e3)})),Qn.addEventListener("keydown",(e=>{"Enter"===e.key&&(ao(0),Object.assign(to.style,{left:"0px",color:"hsl(200, 20%, 50%)"}),lo(!0),oo=setTimeout((()=>lo(!1)),1e3))}));const mo=new Set;let uo,po=!1,go=!1;function yo(){const e=document.querySelectorAll(".messages-content div p");let t=null;e.forEach((e=>{e.hasAttribute("id")&&"contextmenu"===e.getAttribute("id")||(e.addEventListener("mousedown",(n=>{if(go=2===n.button,go){po=!0,clearTimeout(t);const n=ho(e);mo.has(n)||(mo.add(n),console.log("Added new message inside the selectedMessages Set:",n)),co(e)}})),e.addEventListener("mouseup",(e=>{go=2===e.button,go&&(po=!1)})),e.addEventListener("mouseover",(t=>{if(po&&go){const t=ho(e);mo.has(t)||(mo.add(t),console.log("Added new message inside the selectedMessages Set:",t)),co(e)}})),e.setAttribute("id","contextmenu"),e.addEventListener("contextmenu",(n=>{n.preventDefault(),co(e);const o=document.querySelector(".delete-message");o&&o.remove();const s=document.createElement("button");function r(){t=setTimeout((()=>{s.matches(":hover")||(s.remove(),document.querySelectorAll(".messages-content div p").forEach((e=>{e.style.removeProperty("background-color"),e.style.removeProperty("box-shadow"),e.style.removeProperty("background-clip")})),mo.clear())}),1e3)}s.innerText="Delete",s.classList.add("delete-message"),s.addEventListener("click",(()=>{!function(){const e=[...mo],t=document.querySelectorAll(".messages-content div p");e.forEach((e=>{const n=Array.from(t).find((t=>ho(t)===e));if(n){const t=JSON.parse(localStorage.getItem("deletedChatMessagesContent")||"[]");t.includes(e)||t.push(e),localStorage.setItem("deletedChatMessagesContent",JSON.stringify(t)),mo.delete(e)}})),fo()}(),s.remove(),vo(),mo.clear()})),function(e,t){e.style.position="fixed",e.style.top=`${t.clientY}px`,e.style.left=`${t.clientX}px`,e.style.zIndex=999,e.style.padding="8px 16px",e.style.backgroundColor="hsl(0, 50%, 20%)",e.style.color="hsl(0, 60%, 70%)",e.style.border="1px solid hsl(0, 50%, 35%)",e.style.transition="all 0.3s",e.style.filter="brightness(1)",e.addEventListener("mouseenter",(()=>{e.style.filter="brightness(1.5)"})),e.addEventListener("mouseleave",(()=>{e.style.filter="brightness(1)"}))}(s,n),s.addEventListener("mouseenter",(()=>{s.style.filter="brightness(1.5)"})),s.addEventListener("mouseleave",(()=>{s.style.filter="brightness(1)"})),document.body.appendChild(s),r(),s.addEventListener("mouseleave",(()=>{r()})),s.addEventListener("mouseenter",(()=>{clearTimeout(t)}))})))}))}function ho(e){const t=e.querySelector(".time"),n=e.querySelector(".username");return[t?t.textContent.trim():"",n?` ${n.textContent.trim()} `:"",...Array.from(e.childNodes).filter((e=>e!==t&&e!==n)).map((e=>e.nodeType===Node.TEXT_NODE?e.textContent:"A"===e.tagName?e.getAttribute("href").trim():"IMG"===e.tagName?e.title.trim():"IFRAME"===e.tagName?e.getAttribute("src").trim():""))].join("")}function fo(){const e=JSON.parse(localStorage.getItem("deletedChatMessagesContent")||"[]");if(0===e.length)return;const t=document.querySelectorAll(".messages-content div p"),n=new Set(e),o=Array.from(t).map((e=>ho(e))),s=e.filter((e=>o.includes(e)));t.forEach((e=>{n.has(ho(e))&&(e.style.display="none")})),localStorage.setItem("deletedChatMessagesContent",JSON.stringify(s))}function vo(){if(JSON.parse(localStorage.getItem("deletedChatMessagesContent")||"[]").length>0&&(uo=document.getElementById("toggleButton"),null===uo)){uo=document.createElement("button"),uo.id="toggleButton",uo.addEventListener("click",xo),uo.style.position="absolute",uo.style.top="0",uo.style.right="0",uo.style.padding="8px 16px",uo.innerText="Hidden",function(e){e.style.backgroundColor="hsl(0, 20%, 10%)",e.style.color="hsl(0, 50%, 50%)",e.style.border="1px solid hsl(0, 50%, 50%)"}(uo),uo.style.transition="filter 300ms",uo.style.filter="hue-rotate(0) brightness(1)";let e=uo.textContent;uo.addEventListener("mouseenter",(()=>{ae?(e=uo.textContent,uo.textContent="Restore",uo.style.filter="hue-rotate(180deg) brightness(2)"):uo.style.filter="hue-rotate(0) brightness(2)"})),uo.addEventListener("mouseleave",(()=>{const t="Restore"===uo.textContent;(ae||!ae&&t)&&(uo.textContent=e),uo.style.filter="hue-rotate(0) brightness(1)"})),vn.appendChild(uo)}}function xo(){const e=document.querySelectorAll(".messages-content div p"),t=JSON.parse(localStorage.getItem("deletedChatMessagesContent")||"[]");if(ae&&(localStorage.setItem("deletedChatMessagesContent",JSON.stringify([])),e.forEach((e=>{e.style.display="block",e.style.removeProperty("background-color"),e.style.removeProperty("box-shadow"),e.style.removeProperty("background-clip")})),uo.remove()),!ae){if(0===t.length)return void(uo.style.display="none");uo.style.display="block",e.forEach((e=>{const n=ho(e);t.includes(n)&&("Hidden"===uo.innerText||"Show"===uo.innerText?"none"===e.style.display&&(e.style.display="block",e.style.setProperty("background-color","hsla(0, 50%, 30%, .5)","important"),e.style.setProperty("box-shadow","inset 0px 0px 0px 1px rgb(191, 64, 64)","important"),e.style.setProperty("background-clip","padding-box","important")):"Hide"===uo.innerText&&"block"===e.style.display&&(e.style.display="none",e.style.removeProperty("background-color"),e.style.removeProperty("box-shadow"),e.style.removeProperty("background-clip")))})),"Hide"===uo.innerText?(uo.innerText="Show",function(e){e.style.backgroundColor="hsl(90, 20%, 10%)",e.style.color="hsl(90, 50%, 50%)",e.style.border="1px solid hsl(90, 50%, 50%)"}(uo)):(uo.innerText="Hide",function(e){e.style.backgroundColor="hsl(50, 20%, 10%)",e.style.color="hsl(50, 50%, 50%)",e.style.border="1px solid hsl(50, 50%, 50%)"}(uo))}}if(window.location.href.includes("gamelist")){const Eo=5e3,Lo=1e3,$o="Вы не можете отправлять сообщения",To="Связь с сервером потеряна",Mo=()=>({chatField:document.querySelector(".chat .text"),chatSend:document.querySelector(".chat .send")});function No(e){if(!e)return null;const t=e.value;return t.includes($o)?$o:t.includes(To)?To:null}function qo(e,t,n){if(t.disabled){const o=No(t);o===$o?(t.disabled=n.disabled=!1,n.style.setProperty("background-color","rgb(160, 35, 35)","important"),n.style.setProperty("background-image",`url("data:image/svg+xml,${encodeURIComponent(x)}")`,"important"),n.style.setProperty("background-repeat","no-repeat","important"),n.style.setProperty("background-position","center","important"),n.style.setProperty("color","transparent","important"),t.value=null,console.log("Chat field was blocked, re-enabled.")):o===To&&(console.log("Lost connection, reloading..."),setTimeout((()=>{window.location.reload()}),e))}}const Io=new MutationObserver((()=>{const{chatField:e,chatSend:t}=Mo();qo(Eo,e,t)})),{chatField:Ao}=Mo();Ao&&Io.observe(Ao,{attributes:!0,attributeFilter:["disabled"]}),document.addEventListener("visibilitychange",(()=>{if("visible"===document.visibilityState){const{chatField:e,chatSend:t}=Mo();qo(Lo,e,t)}}))}let bo=document.querySelectorAll(".general"),wo=document.querySelectorAll(".game");function So(){const e=document.querySelector("#chat-wrapper.chat-hidden"),t=window.location.href;let n;t.includes("gamelist")?n=document.querySelector("#chat-general .text"):t.includes("gmid")&&(n=document.querySelector('[id^="chat-game"] .text')),!e&&n&&n.focus()}function Co(e){console.log("Clicked element:",e.target);let t=e.target.classList.contains("general")?"general":"game";localStorage.setItem("activeChatTab",t)}bo.forEach((function(e){e.addEventListener("click",Co)})),wo.forEach((function(e){e.addEventListener("click",Co)})),document.addEventListener("keydown",(function(e){"Tab"===e.key&&(function(){const e=document.querySelector("#chat-wrapper.chat-hidden");let t=document.querySelectorAll(".general.c, .general.c.active"),n=document.querySelectorAll(".game.c, .game.c.active"),o=Array.from(t).find((function(e){return"none"!==window.getComputedStyle(e).display&&!e.classList.contains("active")})),s=Array.from(n).find((function(e){return"none"!==window.getComputedStyle(e).display&&!e.classList.contains("active")}));if(!e&&(o||s)){let e;o?o.click():s&&s.click(),o?e=document.querySelector("#chat-general .text"):s&&(e=document.querySelector('[id^="chat-game"] .text')),e&&e.focus()}}(),e.preventDefault())}));let ko=new MutationObserver((()=>{const e=document.querySelector(".messages-content div"),t=document.querySelectorAll(".messages-content div p");document.contains(e)&&t.length>=20&&(ko.disconnect(),document.querySelectorAll(".messages-content p").forEach((e=>{const t=e.querySelector(".username"),n=t?.textContent?.replace(/[<>]/g,"")||null;if(n&&Q.includes(n)){const t=un(n);e.classList.add("ignored-user",t),e.style.display="none"}})),Ye("generalMessages"),tt("generalMessages"),st("generalMessages"),function(){let e,t=localStorage.getItem("activeChatTab");if("general"===t){let t=Array.from(bo).find((function(e){return"none"!==window.getComputedStyle(e).display&&!e.classList.contains("active")}));t&&(t.click(),e=document.querySelector("#chat-general .text"))}else if("game"===t){let t=Array.from(wo).find((function(e){return"none"!==window.getComputedStyle(e).display&&!e.classList.contains("active")}));t&&(t.click(),e=document.querySelector('[id^="chat-game"] .text'))}e&&e.focus()}(),function(){const e=document.querySelector("#chat-general .text");e&&(e.value=localStorage.getItem("inputBackup")||"",e.addEventListener("input",Dt((()=>{getChatSystemMessage(e)||localStorage.setItem("inputBackup",e.value)}),250)),e.addEventListener("keydown",(e=>{"Enter"===e.key&&localStorage.removeItem("inputBackup")})))}(),_t(),tn(),Qt(),It(!1,qt),Mt(),So(),io(),function(){const e=document.querySelector(".text");e.setAttribute("maxlength","1000"),e.addEventListener("paste",(t=>{t.preventDefault();const n=t.clipboardData.getData("text");let o=n;nt(n)&&(o=ot(n));const s=e.selectionStart,r=e.selectionEnd;e.value=e.value.slice(0,s)+o+e.value.slice(r),e.setSelectionRange(s+o.length,s+o.length)})),e.addEventListener("keydown",(t=>{const n=e.value;"Enter"===t.key&&(n.length>300?(t.preventDefault(),async function(e){const t=function(e){const t=e.split(" "),n=[];let o="";return t.forEach((e=>{(o+e).length>300?(n.push(o.trim()),o=e+" "):o+=e+" "})),o&&n.push(o.trim()),n}(e),n=document.querySelector(".text"),o=document.querySelector(".send"),s=e.length>300;s&&(n.disabled=!0);for(let e=0;e<t.length;e++){const s=t[e];if(n.value=s,console.log(`Sending piece ${e+1}: "${s}" (Length: ${s.length})`),o.click(),e<t.length-1){const e=Math.floor(500*Math.random())+500;console.log(`Waiting for ${e} ms before sending the next piece.`),await new Promise((t=>setTimeout(t,e)))}}s&&(n.disabled=!1)}(n),console.log(`Long message processed: "${n}"`),e.value=""):console.log(`Short message processed: "${n}"`))}))}())}));ko.observe(document,{childList:!0,subtree:!0})}()})();