// ==UserScript==
// @name         KG_Chat_Empowerment
// @namespace    klavogonki
// @version      1.0.0
// @description  Enhance the chat abilities
// @author       Patcher
// @match        *://klavogonki.ru/g*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=klavogonki.ru
// @updateURL    https://raw.githubusercontent.com/VimiummuimiV/KG_Goddies/refs/heads/master/KG_Chat_Empowerment.js
// @downloadURL  https://raw.githubusercontent.com/VimiummuimiV/KG_Goddies/refs/heads/master/KG_Chat_Empowerment.js
// @grant        none
// ==/UserScript==

(()=>{"use strict";var e={56:(e,t,n)=>{e.exports=function(e){var t=n.nc;t&&e.setAttribute("nonce",t)}},72:e=>{var t=[];function n(e){for(var n=-1,o=0;o<t.length;o++)if(t[o].identifier===e){n=o;break}return n}function o(e,o){for(var r={},a=[],i=0;i<e.length;i++){var l=e[i],c=o.base?l[0]+o.base:l[0],d=r[c]||0,u="".concat(c," ").concat(d);r[c]=d+1;var m=n(u),p={css:l[1],media:l[2],sourceMap:l[3],supports:l[4],layer:l[5]};if(-1!==m)t[m].references++,t[m].updater(p);else{var g=s(p,o);o.byIndex=i,t.splice(i,0,{identifier:u,updater:g,references:1})}a.push(u)}return a}function s(e,t){var n=t.domAPI(t);n.update(e);return function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap&&t.supports===e.supports&&t.layer===e.layer)return;n.update(e=t)}else n.remove()}}e.exports=function(e,s){var r=o(e=e||[],s=s||{});return function(e){e=e||[];for(var a=0;a<r.length;a++){var i=n(r[a]);t[i].references--}for(var l=o(e,s),c=0;c<r.length;c++){var d=n(r[c]);0===t[d].references&&(t[d].updater(),t.splice(d,1))}r=l}}},113:e=>{e.exports=function(e,t){if(t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}},208:(e,t,n)=>{n.d(t,{A:()=>i});var o=n(601),s=n.n(o),r=n(314),a=n.n(r)()(s());a.push([e.id,'.empowerment-button {\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  width: 48px;\n  height: 48px;\n  cursor: pointer;\n  margin: 4px;\n  background-color: #212226;\n  border: 1px solid #45474b;\n}\n\n/* input error indication */\n.input-error {\n  transition: background-color 300ms ease-in-out;\n  background-color: #6b2f2f !important;\n}\n\n/* chat length popup on field type with dynamic movement horizontally */\n.length-field-popup {\n  position: absolute;\n  font: bold 12px Montserrat;\n  bottom: 40px;\n  transition: left 100ms ease-out;\n  height: 20px;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  padding: 2px 4px;\n  margin: 2px;\n  opacity: 0;\n}\n\n.bounce-in {\n  animation: bounceIn 500ms forwards;\n}\n\n@keyframes bounceIn {\n  0% {\n    transform: translateY(0);\n    opacity: 0;\n  }\n\n  50% {\n    transform: translateY(-10px);\n    opacity: 1;\n  }\n\n  100% {\n    transform: translateY(0);\n    opacity: 1;\n  }\n}\n\n.bounce-out {\n  animation: bounceOut 500ms forwards;\n}\n\n@keyframes bounceOut {\n  0% {\n    transform: translateY(0);\n    opacity: 1;\n  }\n\n  50% {\n    transform: translateY(-10px);\n    opacity: 1;\n  }\n\n  100% {\n    transform: translateY(0);\n    opacity: 0;\n  }\n}\n\n/* catalogs panel && personal messages panel messages anchors color */\n.chat-logs-panel .message-text a,\n.cached-messages-panel .message-text a {\n  color: burlywood !important;\n  transition: color 0.15s ease-in-out;\n}\n\n.chat-logs-panel .message-text a:hover,\n.cached-messages-panel .message-text a:hover {\n  color: lightgoldenrodyellow !important;\n}\n\n/* Empowerment panel */\n.empowerment-panel {\n  position: fixed;\n  top: 60px;\n  right: 12px;\n  padding: 6px;\n  z-index: 1000;\n}\n\n/* Chat user count element */\n.chat-user-count {\n  filter: grayscale(100%);\n  transition: 0.2s ease-in-out;\n  font-family: \'Orbitron\', sans-serif;\n  font-size: 24px;\n  color: #83cf40;\n  background-color: #2b4317;\n  width: 48px;\n  height: 48px;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  border: 1px solid #4b7328;\n  margin: 4px;\n}\n\n.pulse-effect {\n  animation: pulse 500ms ease-out;\n}\n\n@keyframes pulse {\n  0% {\n    filter: brightness(1);\n  }\n\n  50% {\n    filter: brightness(1.5);\n  }\n\n  100% {\n    filter: brightness(1);\n  }\n}\n\n.shake-effect {\n  animation: shake 500ms cubic-bezier(0.36, 0.07, 0.19, 0.97) both;\n}\n\n@keyframes shake {\n  0% {\n    transform: translateX(0);\n  }\n\n  10% {\n    transform: translateX(-4px);\n  }\n\n  20% {\n    transform: translateX(6px);\n  }\n\n  30% {\n    transform: translateX(-8px);\n  }\n\n  40% {\n    transform: translateX(8px);\n  }\n\n  50% {\n    transform: translateX(-6px);\n  }\n\n  60% {\n    transform: translateX(5px);\n  }\n\n  70% {\n    transform: translateX(-3px);\n  }\n\n  80% {\n    transform: translateX(2px);\n  }\n\n  90% {\n    transform: translateX(-1px);\n  }\n\n  100% {\n    transform: translateX(0);\n  }\n}\n\n.custom-tooltip-popup {\n  position: fixed;\n  background: rgb(22, 22, 22);\n  color: rgb(222, 222, 222);\n  padding: 0.5em;\n  z-index: 1200;\n  font-size: 0.9em;\n  pointer-events: none;\n  white-space: nowrap;\n  opacity: 0;\n  transition: opacity 0.1s;\n  display: none;\n  left: 0;\n  top: 0;\n  border: 1px solid rgb(60, 60, 60) !important;\n  border-radius: 4px !important;\n  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3) !important;\n}\n\n.static-chat-notification {\n  cursor: default;\n  white-space: nowrap;\n  padding: 8px;\n  display: inline-flex;\n  flex: auto;\n  justify-content: center;\n  margin: 4px;\n  font-size: 1em;\n  align-items: center;\n  border-radius: 4px !important;\n}\n\n.dynamic-chat-notifications-container {\n  z-index: 1000;\n  width: 0;\n  position: fixed;\n  display: flex;\n  flex-direction: column;\n  top: 0;\n  bottom: 0;\n  left: 0;\n  right: 0;\n  padding-top: 160px;\n}\n\n.dynamic-chat-notification {\n  cursor: default;\n  white-space: nowrap;\n  position: relative;\n  align-items: center;\n  width: fit-content;\n  display: flex;\n  margin-bottom: 0.2em;\n  padding: 8px 16px 8px 12px;\n  border-radius: 0 4px 4px 0 !important;\n  left: 0;\n  transform: translateX(-100%);\n  opacity: 1;\n  transition: transform 0.3s cubic-bezier(0.83, 0, 0.17, 1), opacity 0.3s cubic-bezier(0.83, 0, 0.17, 1);\n}\n\n/* For both (static and dynamic) notifications */\n.user-enter {\n  color: hsl(100, 50%, 50%) !important;\n  background-color: hsl(100, 50%, 10%) !important;\n  outline: 1px solid hsl(100, 50%, 25%) !important;\n}\n\n.user-left {\n  color: hsl(0, 50%, 70%) !important;\n  background-color: hsl(0, 50%, 15%) !important;\n  outline: 1px solid hsl(0, 50%, 40%) !important;\n}\n\n/* convertImageLinksToImage */\n.clickable-thumbnail {\n  opacity: 1;\n  transition: opacity 0.15s ease-in-out;\n  border: none;\n  width: 6vw;\n  min-width: 100px;\n  max-height: 200px;\n  height: auto;\n  cursor: pointer;\n  background-color: transparent;\n  padding: 2px;\n  margin: 6px;\n  overflow-y: auto;\n}\n\n.clickable-thumbnail:hover {\n  opacity: 0.8;\n}\n\n.clickable-thumbnail img {\n  max-height: 100%;\n  max-width: 100%;\n  background-color: transparent;\n}\n\n.scaled-thumbnail {\n  top: 50%;\n  left: 50%;\n  transform-origin: center center;\n  transform: translate(-50%, -50%) scale(1);\n  position: fixed;\n  opacity: 0;\n  z-index: 999;\n  transform-origin: center center;\n  max-height: 90vh;\n  max-width: 90vw;\n  cursor: pointer;\n}\n\n/* convertVideoLinksToPlayer */\n.video-wrapper {\n  display: flex;\n  width: fit-content;\n  flex-direction: column;\n  gap: 6px;\n  margin-bottom: 10px;\n}\n\n.video-container {\n  display: flex;\n  border: none;\n  height: 165px;\n}\n\n/* Dimming element */\n.dimming-background {\n  background: black;\n  top: 0;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  position: fixed;\n  opacity: 0;\n  z-index: 998;\n}\n\n/* loadProfileIntoIframe */\n.profile-iframe-container {\n  opacity: 0;\n  border: none;\n  display: flex;\n  position: fixed;\n  z-index: 999;\n  width: 75vw;\n  min-width: 1000px;\n  height: 80vh;\n  top: 48.5vh;\n  left: 50vw;\n  transform: translate(-50%, -50%);\n  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08) !important;\n  border-radius: 0.6em !important;\n}\n\n.scroll-buttons-container {\n  display: flex;\n  justify-content: center;\n  grid-area: scroll;\n  flex-direction: column;\n  height: calc(100% - 1em);\n  padding: 1em;\n}\n\n.scroll-buttons-container .scroll-button {\n  margin: 0.25em 0;\n  background-color: rgba(222, 222, 222, 0.1);\n}\n\n/* Common styles for all panel header buttons */\n.large-button {\n  width: 48px;\n  height: 48px;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  cursor: pointer;\n  border-radius: 0.2em !important;\n  filter: brightness(1);\n  transition: filter 0.3s ease, opacity 0.3s ease;\n}\n\n.large-button:hover {\n  filter: brightness(0.8);\n}\n\n.panel-control-buttons {\n  display: flex;\n}\n\n.panel-control-buttons>div:not(:first-child) {\n  margin-left: 0.5em;\n}\n\n/* Common background color for all panel header buttons */\n.panel-header-clear-button {\n  background-color: brown;\n}\n\n.panel-header-close-button {\n  background-color: darkolivegreen;\n}\n\n.panel-header-save-button {\n  display: none;\n  opacity: 0;\n  visibility: hidden;\n  background-color: #2f6b63;\n}\n\n.panel-header-import-button {\n  background-color: #502f6b;\n}\n\n.panel-header-export-button {\n  background-color: #2f4c6b;\n}\n\n.panel-header-copy-button,\n.panel-header-date-button {\n  background-color: steelblue;\n}\n\n.panel-header-toggle-button {\n  background-color: #144e9d;\n}\n\n.panel-header-toggle-media-messages {\n  background-color: darkslategray;\n}\n\n.toggle-mention-messages-button {\n  background-color: saddlebrown;\n}\n\n.panel-header-one-day-back-button,\n.panel-header-one-day-forward-button {\n  background-color: darkcyan;\n}\n\n.panel-header-shuffle-button {\n  background-color: darkslateblue;\n}\n\n/* New chat user list */\n#chat-general .userlist-content {\n  opacity: 0;\n}\n\n#chat-general .smile-tab {\n  position: relative;\n  z-index: 1;\n}\n\n.chat-user-list {\n  display: flex;\n  flex-direction: column;\n  position: absolute;\n  top: 20px;\n  padding-top: 8px;\n  width: 200px;\n  height: 94%;\n  overflow-y: auto;\n  overflow-x: hidden;\n}\n\n.chat-user-list [class^="rank-group"] {\n  display: flex;\n  flex-direction: column;\n}\n\n.chat-user-list [class^="user"] {\n  display: inline-flex;\n  margin: 2px 0;\n}\n\n.chat-user-list .avatar {\n  width: 24px;\n  height: 24px;\n  display: inline-flex;\n}\n\n.chat-user-list .avatar img,\n.fetched-users .avatar img {\n  transform-origin: left;\n  transition: transform 0.3s;\n}\n\n.chat-user-list .avatar img:hover,\n.fetched-users .avatar img:hover {\n  transform: scale(2);\n}\n\n.chat-user-list .name {\n  text-decoration: none;\n  display: inline-flex;\n  width: auto;\n  height: 24px;\n  line-height: 24px;\n  padding: 0 8px;\n  max-width: 124px;\n  overflow: hidden;\n  text-overflow: ellipsis;\n}\n\n.chat-user-list .name:hover {\n  text-decoration: underline;\n}\n\n.chat-user-list .profile,\n.chat-user-list .tracked,\n.chat-user-list .ignored,\n.chat-user-list .moderator {\n  display: inline-flex;\n  width: 24px;\n  height: 24px;\n  justify-content: center;\n  align-items: center;\n}\n\n/* Highlight for mention words */\n.mention {\n  display: inline-flex;\n  color: #83cf40;\n  font-family: Roboto Mono, monospace;\n  font-weight: bold;\n}\n\n/* Chat popup messages */\n.popup-messages-container {\n  display: flex;\n  flex-direction: column;\n  justify-content: flex-end;\n  align-items: start;\n  user-select: none;\n  pointer-events: none;\n  position: fixed;\n  left: 0;\n  right: 0;\n  top: 50px;\n  bottom: 0;\n}\n\n.popup-chat-message {\n  display: flex;\n  align-items: center;\n  background-color: hsl(100, 50%, 10%);\n  position: relative;\n  max-width: 70vw;\n  border-radius: 0.2em !important;\n  color: hsl(100, 50%, 50%);\n  border: 1px solid hsl(100, 50%, 25%);\n  padding: 4px;\n  margin: 6px 15vw;\n  opacity: 0;\n  transform: translateY(20px);\n  transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;\n  animation: fadeIn 0.3s ease-in-out forwards;\n}\n\n@keyframes fadeIn {\n  from {\n    opacity: 0;\n    transform: translateY(20px);\n  }\n\n  to {\n    opacity: 1;\n    transform: translateY(0);\n  }\n}\n\n.popup-chat-message.fade-out {\n  animation: fadeOut 0.3s ease-in-out forwards;\n}\n\n@keyframes fadeOut {\n  from {\n    opacity: 1;\n    transform: translateY(0);\n  }\n\n  to {\n    opacity: 0;\n    transform: translateY(-20px);\n  }\n}\n\n.popup-chat-message>div {\n  padding: 2px;\n  display: flex;\n  font-family: \'Montserrat\', sans-serif;\n}\n\n.popup-chat-message .time,\n.popup-chat-message .time-icon {\n  opacity: 0.7;\n}\n\n/* Empowerment voice settings (Ctrl + Alt) */\n.voice-settings {\n  position: absolute;\n  top: 65px;\n  right: 70px;\n  opacity: 0;\n  transition: opacity 0.3s ease;\n  font-family: Orbitron, sans-serif;\n}\n\n/* Basic styles for empowerment voice settings */\n.voice-value-info {\n  display: flex;\n  width: 100%;\n  justify-content: center;\n  margin-bottom: 6px;\n}\n\n/* voice speed */\n.voice-speed {\n  color: hsl(100, 50%, 50%);\n}\n\n.voice-speed-progress {\n  display: block;\n  width: 120px;\n  height: 12px;\n  background-color: hsl(90, 60%, 30%);\n}\n\n.voice-speed-progress-fill {\n  display: block;\n  height: 100%;\n  background-color: hsl(90, 60%, 50%);\n}\n\n/* voice pitch */\n.voice-pitch {\n  color: hsl(180, 60%, 50%);\n}\n\n.voice-pitch-progress {\n  display: block;\n  width: 120px;\n  height: 12px;\n  background-color: hsl(180, 60%, 30%);\n}\n\n.voice-pitch-progress-fill {\n  display: block;\n  height: 100%;\n  background-color: hsl(180, 60%, 50%);\n}\n\n/* showCachePanel */\n.cached-users-panel {\n  opacity: 0;\n  background-color: #1b1b1b;\n  border-radius: 0.6em !important;\n  position: fixed;\n  top: 100px;\n  left: 50%;\n  transform: translateX(-50%);\n  width: 80vw;\n  height: 80vh;\n  z-index: 999;\n  display: grid;\n  grid-template-columns: 1fr;\n  grid-template-rows: min-content;\n  grid-template-areas:\n    "header header"\n    "cache scroll";\n}\n\n.cached-users-panel .panel-header {\n  display: flex;\n  flex-direction: row;\n  justify-content: space-between;\n  padding: 0.6em;\n  grid-area: header;\n}\n\n.cached-users-panel .drop-time {\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  min-width: fit-content;\n}\n\n.cached-users-panel .drop-time-threshold-description {\n  padding: 0.6em;\n  color: #c6b209;\n}\n\n.cached-users-panel .drop-time-threshold {\n  padding: 0.6em;\n  color: lightcoral;\n  font-family: \'Roboto Mono\', monospace;\n  font-size: 1.1em;\n  font-weight: bold;\n  border-radius: 0.2em !important;\n  border: 1px solid rgba(240, 128, 128, 0.20);\n  background-color: rgba(240, 128, 128, 0.05);\n  transition: filter 0.3s;\n  filter: sepia(0);\n  cursor: pointer;\n}\n\n.cached-users-panel .drop-time-threshold:hover {\n  filter: sepia(1);\n}\n\n.cached-users-panel .drop-time-expiration-description {\n  padding: 0.6em;\n  color: #d0562c;\n}\n\n.cached-users-panel .drop-time-expiration {\n  padding: 0.6em;\n  color: antiquewhite;\n  font-family: \'Roboto Mono\', monospace;\n  font-size: 1.1em;\n}\n\n.cached-users-panel .search-for-cached-users {\n  width: 100%;\n  margin: 0 0.5em;\n  display: flex;\n}\n\n.cached-users-panel .cached-users-search-input {\n  outline: none;\n  width: 100%;\n  padding: 10px;\n  font-size: 1em;\n  font-family: \'Montserrat\';\n  color: bisque !important;\n  border-radius: 0.2em !important;\n  box-sizing: border-box;\n  background-color: #111;\n  border: 1px solid #222;\n}\n\n.cached-users-panel .error-message {\n  width: fit-content;\n  white-space: nowrap;\n  font-family: \'Montserrat\';\n  color: lightcoral;\n}\n\n.fetch-mode-button {\n  stroke: darkslateblue;\n  background-color: #b2a4f9;\n}\n\n.cache-mode-button {\n  stroke: #b2a4f9;\n  background-color: darkslateblue;\n}\n\n.cached-users-panel .fetched-users {\n  display: grid;\n  grid-template-rows: 1fr 1fr;\n  height: calc(100% - 0.5em);\n  overflow-y: auto;\n  grid-area: cache;\n}\n\n.cached-users-panel .users-container {\n  display: grid;\n  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));\n  gap: 12px;\n  padding: 1em;\n  height: fit-content;\n}\n\n/* Common styles for all descriptions */\n.cached-users-panel .description {\n  color: bisque;\n  font-family: Montserrat;\n  font-size: 1em;\n  margin: 0;\n  padding: 0.4em 0.2em;\n  grid-column: 1 / -1;\n  height: fit-content;\n}\n\n/* Common styles for user container elements in cached users panel */\n.cached-users-panel .user-item {\n  padding: 0.2em;\n  margin: 0.4em 0.2em;\n  display: grid;\n  grid-template-columns: auto 1fr;\n  align-items: center;\n  height: fit-content;\n}\n\n/* Common styles for the visits element */\n.cached-users-panel .visits {\n  margin-left: 8px;\n  padding: 4px 6px;\n  border-radius: 2px !important;\n  cursor: pointer;\n  white-space: pre;\n}\n\n/* Styling for tracked visits */\n.cached-users-panel .visits.tracked {\n  color: greenyellow;\n  background-color: darkgreen;\n  font-weight: bold;\n}\n\n/* Styling for untracked visits */\n.cached-users-panel .visits.untracked {\n  color: orange;\n  background-color: #111111;\n  font-weight: normal;\n}\n\n/* Common styles for the action log container */\n.cached-users-panel .action-log {\n  position: fixed;\n  opacity: 0;\n  padding: 8px;\n  gap: 4px;\n  top: 50%;\n  left: 50%;\n  transform: translate(-50%, -50%);\n  max-height: 85vh;\n  overflow-y: auto;\n  scrollbar-width: none;\n  overflow-x: hidden;\n  display: flex;\n  min-width: 30vw;\n  max-width: 50vw;\n  flex-wrap: wrap;\n  background-color: #111111;\n  border: 3px dashed #212121;\n  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08) !important;\n  border-radius: 0.2em !important;\n}\n\n.cached-users-panel .rank {\n  padding: 2px 0;\n}\n\n.cached-users-panel .registered {\n  color: cadetblue;\n  font-size: 12px;\n}\n\n.cached-users-panel .user-metrics {\n  margin-top: 4px;\n  grid-column: span 2;\n}\n\n.cached-users-panel .avatar {\n  font-size: 1.8rem;\n  margin-right: 8px;\n}\n\n.cached-users-panel .avatar img {\n  height: 24px;\n  width: 24px;\n}\n\n.cached-users-panel .login {\n  color: skyblue !important;\n  text-decoration: none;\n  font-family: \'Montserrat\', sans-serif;\n  transition: color 0.3s ease;\n}\n\n.cached-users-panel .login:hover {\n  color: cornsilk !important;\n}\n\n/* createCacheButton */\n.cache-user-count {\n  display: flex;\n  position: absolute;\n  justify-content: center;\n  align-items: center;\n  left: 0;\n  bottom: 0;\n  transform: translate(-50%, 50%);\n  z-index: 1;\n  height: 20px;\n  padding: 0 4px;\n  border-radius: 2px !important;\n  background-color: #9db380;\n  color: rgb(2, 2, 2);\n  font-size: 12px;\n  font-family: Roboto, sans-serif;\n  font-weight: bold;\n}\n\n/* createPersonalMessagesButton */\n.personal-messages-button {\n  position: relative;\n  z-index: 2;\n}\n\n.message-count {\n  display: flex;\n  position: absolute;\n  justify-content: center;\n  align-items: center;\n  height: 20px;\n  padding: 0 4px;\n  border-radius: 2px !important;\n  color: rgb(2, 2, 2);\n  font-size: 12px;\n  font-family: Roboto, sans-serif;\n  font-weight: bold;\n  bottom: 0;\n}\n\n.total-message-count {\n  left: 0;\n  transform: translate(-50%, 50%);\n  background-color: #fa8072;\n}\n\n.new-message-count {\n  right: 0;\n  transform: translate(50%, 50%);\n  background-color: #ffd700;\n}\n\n/* showPersonalMessagesPanel */\n.cached-messages-panel {\n  opacity: 0;\n  background-color: #1b1b1b;\n  border-radius: 0.6em !important;\n  position: fixed;\n  top: 100px;\n  left: 50%;\n  transform: translateX(-50%);\n  width: 50vw;\n  height: 80vh;\n  z-index: 999;\n  min-width: 1000px;\n  display: grid;\n  grid-template-columns: 1fr;\n  grid-template-rows: min-content;\n  grid-template-areas:\n    "header header"\n    "messages scroll";\n}\n\n.panel-header {\n  display: flex;\n  flex-direction: row;\n  justify-content: flex-end;\n  /* Aligns to the right */\n  padding: 0.6em;\n  grid-area: header;\n}\n\n.search-for-personal-messages {\n  width: 100%;\n  margin: 0 0.5em 0 0;\n  display: flex;\n}\n\n.personal-messages-search-input {\n  outline: none;\n  width: 100%;\n  padding: 10px;\n  font-size: 1em;\n  font-family: Montserrat, sans-serif;\n  color: bisque !important;\n  border-radius: 0.2em !important;\n  box-sizing: border-box;\n  background-color: #111;\n  border: 1px solid #222 !important;\n}\n\n.cached-messages-panel .messages-container {\n  overflow-y: auto;\n  height: calc(100% - 0.5em);\n  padding: 1em;\n  grid-area: messages;\n}\n\n.cached-messages-panel .date-item {\n  position: relative;\n  font: 1em Montserrat, sans-serif;\n  color: burlywood;\n  background-color: rgba(222, 184, 135, 0.1);\n  width: fit-content;\n  margin: 2em 1em 1em;\n  padding: 0.4em 0.8em;\n  text-align: center;\n  border-radius: 0.4em !important;\n  left: 50%;\n  transform: translateX(-50%);\n}\n\n.cached-messages-panel .message-item {\n  padding: 0.2em;\n}\n\n.cached-messages-panel .message-time {\n  margin: 0px 0.4em;\n  height: fit-content;\n  cursor: pointer;\n  transition: color 0.2s ease;\n}\n\n.cached-messages-panel .message-username {\n  display: inline-flex;\n  cursor: pointer;\n  margin: 0px 0.4em;\n  height: fit-content;\n}\n\n.cached-messages-panel .message-text {\n  cursor: pointer;\n  margin: 0px 0.4em;\n  height: fit-content;\n}\n\n/* createChatLogsButton */\n.chat-logs-button {\n  position: relative;\n  z-index: 1;\n}\n\n/* showChatLogsPanel */\n.chat-logs-panel {\n  opacity: 0;\n  background-color: #1b1b1b;\n  border-radius: 0.6em !important;\n  position: fixed;\n  top: 100px;\n  left: 50%;\n  transform: translateX(-50%);\n  width: 80vw;\n  height: 80vh;\n  z-index: 999;\n  min-width: 1000px;\n  display: grid;\n  grid-template-columns: 1fr;\n  grid-template-rows: min-content;\n  grid-template-areas:\n    "header header header"\n    "messages scroll users";\n}\n\n.chat-logs-panel .panel-header {\n  display: flex;\n  flex-direction: row;\n  grid-area: header;\n  justify-content: flex-end;\n  padding: 0.6em;\n}\n\n.chat-logs-panel .panel-control-buttons {\n  display: flex;\n}\n\n.chat-logs-panel .search-for-chatlogs-messages {\n  width: 100%;\n  margin: 0 0.5em 0 0;\n  display: flex;\n}\n\n.chat-logs-panel .chatlogs-search-input {\n  outline: none;\n  height: 48px;\n  width: 100%;\n  padding: 10px;\n  font-size: 1em;\n  font-family: Montserrat;\n  color: bisque !important;\n  border-radius: 0.2em !important;\n  box-sizing: border-box;\n  background-color: #111;\n  border: 1px solid #222 !important;\n}\n\n.chat-logs-panel .chatlogs-date-input {\n  background-color: #111;\n  color: bisque;\n  border: 1px solid #222;\n  width: fit-content;\n  height: 48px;\n  padding: 10px;\n  font-size: 1em;\n  font-family: Montserrat;\n  border-radius: 0.2em !important;\n  box-sizing: border-box;\n  margin: 0 0.5em;\n}\n\n.toggle-mention-messages-counter,\n.toggle-media-messages-counter {\n  display: flex;\n  position: absolute;\n  justify-content: center;\n  align-items: center;\n  padding: 2px 4px;\n  border-radius: 2px !important;\n  font-size: 12px;\n  font-family: Roboto;\n  font-weight: bold;\n  bottom: 0px;\n  left: 0px;\n  transform: translate(-50%, 50%);\n  color: #020202;\n  pointer-events: none;\n  user-select: none;\n}\n\n.toggle-mention-messages-counter {\n  background-color: #ffa07a;\n}\n\n.toggle-media-messages-counter {\n  background-color: #71c4c4;\n}\n\n.chat-logs-panel .saved-chatlog-url {\n  color: darkseagreen !important;\n  text-decoration: none;\n  display: inline-flex;\n  padding: 0.5em;\n}\n\n.chat-logs-panel .saved-chatlog-url-title {\n  color: lightsteelblue;\n  padding: 0.5em;\n}\n\n.saved-chatlog-container {\n  display: flex;\n  flex-direction: column;\n  overflow-y: auto;\n  background-color: rgb(30, 40, 45);\n  border: 1px solid rgb(60, 70, 80) !important;\n  border-radius: 0.2em !important;\n  position: absolute;\n  padding: 0.5em;\n  height: fit-content;\n  width: max-content;\n  max-height: 400px;\n  top: calc(50px + 1em);\n  right: 0;\n}\n\n.chat-logs-panel .chat-logs-container {\n  overflow-y: auto;\n  height: calc(100% - 0.5em);\n  padding: 1em;\n  display: flex;\n  grid-area: messages;\n  flex-direction: column;\n}\n\n.chat-logs-panel .message-item {\n  padding: 0.2em;\n  display: inline-flex;\n  cursor: pointer;\n  align-items: start;\n}\n\n.chat-logs-panel .message-time {\n  color: darkseagreen;\n  margin: 0 0.4em;\n  cursor: pointer;\n  transition: color 0.2s ease;\n  height: fit-content;\n}\n\n.chat-logs-panel .message-time:hover {\n  color: lightgreen;\n}\n\n.chat-logs-panel .message-username {\n  cursor: pointer;\n  margin: 0 0.4em;\n  height: fit-content;\n}\n\n.chat-logs-panel .message-text {\n  color: lightsteelblue;\n  margin: 0 0.4em;\n  overflow-wrap: anywhere;\n  height: fit-content;\n}\n\n.chat-logs-panel .active-users {\n  padding: 1em;\n  height: calc(100% - 1em);\n  width: fit-content;\n  overflow-y: auto;\n  overflow-x: hidden;\n  grid-area: users;\n  display: flex;\n  flex-direction: column;\n}\n\n.chat-logs-panel .active-user-item {\n  display: flex;\n  height: fit-content;\n  align-items: center;\n  justify-content: left;\n  margin: 0.2em 0;\n  cursor: pointer;\n  transition: filter 0.15s;\n}\n\n.chat-logs-panel .active-user-item:hover {\n  filter: brightness(0.8);\n}\n\n.chat-logs-panel .active-user-name {\n  padding: 0.4em;\n}\n\n.chat-logs-panel .active-user-messages-count {\n  padding: 0.4em;\n  border-radius: 0.2em !important;\n}\n\n/* showSettingsPanel */\n.settings-panel {\n  opacity: 0;\n  background-color: #1b1b1b;\n  border-radius: 0.6em !important;\n  position: fixed;\n  top: 100px;\n  left: 50%;\n  transform: translateX(-50%);\n  width: 50vw;\n  height: 80vh;\n  z-index: 999;\n  min-width: 1000px;\n  display: grid;\n  grid-template-columns: 1fr;\n  grid-template-rows: min-content;\n  grid-template-areas:\n    "header header"\n    "settings scroll";\n}\n\n.settings-panel .panel-header {\n  display: flex;\n  flex-direction: row;\n  justify-content: flex-end;\n  padding: 0.6em;\n  grid-area: header;\n}\n\n.settings-panel .settings-content-container {\n  overflow-y: auto;\n  height: calc(100% - 0.5em);\n  padding: 1em;\n  grid-area: settings;\n}\n\n.settings-panel .settings-description {\n  position: relative;\n  font: 1em Montserrat;\n  color: burlywood;\n  background-color: rgba(222, 184, 135, 0.1);\n  width: fit-content;\n  margin: 0 0 1em;\n  padding: 0.4em 0.8em;\n  border-radius: 0.4em !important;\n  left: 50%;\n  transform: translateX(-50%);\n}\n\n.settings-panel .settings-spoiler button {\n  position: relative;\n  font: 1em Montserrat;\n  color: lightgreen;\n  background-color: rgba(222, 184, 135, 0.1);\n  margin: 0 0 3em 0;\n  padding: 0.4em 0.8em;\n  border-radius: 0.4em !important;\n  left: 50%;\n  transform: translateX(-50%);\n  cursor: pointer;\n  transition: background-color 0.3s ease;\n  border: none;\n}\n\n.settings-panel .settings-spoiler button:hover {\n  background-color: rgba(222, 184, 135, 0.25);\n}\n\n.settings-panel .settings-field {\n  height: 30px;\n  max-width: 200px;\n  min-width: 150px;\n  padding: 0.4em;\n  font: 1em Montserrat;\n  font-family: Montserrat;\n  color: bisque;\n  border-radius: 0.2em !important;\n  box-sizing: border-box;\n  background-color: rgb(17, 17, 17);\n  border: 1px solid rgb(34, 34, 34);\n}\n\n.settings-panel .settings-button {\n  width: 30px;\n  height: 30px;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  border-radius: 0.2em !important;\n  cursor: pointer;\n  transition: filter 0.3s;\n  filter: brightness(1);\n}\n\n.settings-panel .settings-button:hover {\n  filter: brightness(0.8);\n}\n\n/* Disabled state */\n.settings-panel .settings-button.disabled {\n  filter: grayscale(1);\n  pointer-events: none;\n  opacity: 0.5;\n}\n\n.settings-panel .settings-button {\n  width: 30px;\n  height: 30px;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  border-radius: 0.2em !important;\n  cursor: pointer;\n  transition: filter 0.3s;\n}\n\n.settings-panel .remove-settings-button {\n  stroke: #ee9090;\n  background-color: #6b2f2f;\n}\n\n.settings-panel .assigned-settings-button {\n  stroke: lightsteelblue;\n  background-color: steelblue;\n}\n\n.settings-panel .add-settings-button {\n  stroke: #d190ee;\n  background-color: #502f6b;\n}\n\n.settings-panel .settings-container {\n  width: 100%;\n  display: flex;\n  flex-wrap: wrap;\n  align-items: start;\n  flex-direction: column;\n}\n\n/* toggleHiddenMessages */\n.toggle-button-hidden {\n  background-color: hsl(0, 20%, 10%);\n  color: hsl(0, 50%, 50%);\n  border: 1px solid hsl(0, 50%, 50%);\n}\n\n.toggle-button-show {\n  background-color: hsl(90, 20%, 10%);\n  color: hsl(90, 50%, 50%);\n  border: 1px solid hsl(90, 50%, 50%);\n}\n\n.toggle-button-hide {\n  background-color: hsl(50, 20%, 10%);\n  color: hsl(50, 50%, 50%);\n  border: 1px solid hsl(50, 50%, 50%);\n}',""]);const i=a},314:e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var n="",o=void 0!==t[5];return t[4]&&(n+="@supports (".concat(t[4],") {")),t[2]&&(n+="@media ".concat(t[2]," {")),o&&(n+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),n+=e(t),o&&(n+="}"),t[2]&&(n+="}"),t[4]&&(n+="}"),n})).join("")},t.i=function(e,n,o,s,r){"string"==typeof e&&(e=[[null,e,void 0]]);var a={};if(o)for(var i=0;i<this.length;i++){var l=this[i][0];null!=l&&(a[l]=!0)}for(var c=0;c<e.length;c++){var d=[].concat(e[c]);o&&a[d[0]]||(void 0!==r&&(void 0===d[5]||(d[1]="@layer".concat(d[5].length>0?" ".concat(d[5]):""," {").concat(d[1],"}")),d[5]=r),n&&(d[2]?(d[1]="@media ".concat(d[2]," {").concat(d[1],"}"),d[2]=n):d[2]=n),s&&(d[4]?(d[1]="@supports (".concat(d[4],") {").concat(d[1],"}"),d[4]=s):d[4]="".concat(s)),t.push(d))}},t}},540:e=>{e.exports=function(e){var t=document.createElement("style");return e.setAttributes(t,e.attributes),e.insert(t,e.options),t}},601:e=>{e.exports=function(e){return e[1]}},659:e=>{var t={};e.exports=function(e,n){var o=function(e){if(void 0===t[e]){var n=document.querySelector(e);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(e){n=null}t[e]=n}return t[e]}(e);if(!o)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");o.appendChild(n)}},825:e=>{e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var t=e.insertStyleElement(e);return{update:function(n){!function(e,t,n){var o="";n.supports&&(o+="@supports (".concat(n.supports,") {")),n.media&&(o+="@media ".concat(n.media," {"));var s=void 0!==n.layer;s&&(o+="@layer".concat(n.layer.length>0?" ".concat(n.layer):""," {")),o+=n.css,s&&(o+="}"),n.media&&(o+="}"),n.supports&&(o+="}");var r=n.sourceMap;r&&"undefined"!=typeof btoa&&(o+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(r))))," */")),t.styleTagTransform(o,e,t.options)}(t,e,n)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(t)}}}}},t={};function n(o){var s=t[o];if(void 0!==s)return s.exports;var r=t[o]={id:o,exports:{}};return e[o](r,r.exports,n),r.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var o in t)n.o(t,o)&&!n.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.nc=void 0;var o=n(72),s=n.n(o),r=n(825),a=n.n(r),i=n(659),l=n.n(i),c=n(56),d=n.n(c),u=n(540),m=n.n(u),p=n(113),g=n.n(p),h=n(208),f={};f.styleTagTransform=g(),f.setAttributes=d(),f.insert=l().bind(null,"head"),f.domAPI=a(),f.insertStyleElement=m();s()(h.A,f);h.A&&h.A.locals&&h.A.locals;const y="http://www.w3.org/2000/svg",v=`\n  <svg xmlns="${y}"\n      width="16"\n      height="16"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="currentColor"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="icon-enter icon-feather icon-log-in">\n    <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>\n    <polyline points="10 17 15 12 10 7"></polyline>\n    <line x1="15" y1="12" x2="3" y2="12"></line>\n  </svg>`,b=`\n  <svg xmlns="${y}"\n      width="16"\n      height="16"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="currentColor" stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="icon-leave icon-feather icon-log-out">\n    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>\n    <polyline points="16 17 21 12 16 7"></polyline>\n    <line x1="21" y1="12" x2="9" y2="12"></line>\n  </svg>`,x=`\n  <svg xmlns="${y}"\n      width="18"\n      height="18"\n      viewBox="0 0 24 24"\n      fill="url(#moderatorGradient)"  \x3c!-- Use a gradient fill --\x3e\n      stroke="none"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-shield">\n    \x3c!-- Define the gradient --\x3e\n    <defs>\n        <linearGradient id="moderatorGradient" x1="0%" y1="0%" x2="0%" y2="100%">\n            <stop offset="0%" style="stop-color: rgb(255, 215, 0); stop-opacity: 1" />\n            <stop offset="100%" style="stop-color: rgb(255, 140, 0); stop-opacity: 1" />\n        </linearGradient>\n    </defs>\n    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>\n  </svg>`,w=`\n  <svg xmlns="${y}"\n       width="16"\n       height="16"\n       viewBox="0 0 24 24"\n       fill="url(#trackedGradient)"  \x3c!-- Use a gradient fill --\x3e\n       class="feather feather-star">\n      \x3c!-- Define the gradient for the fill --\x3e\n    <defs>\n      <linearGradient id="trackedGradient" x1="0%" y1="0%" x2="0%" y2="100%">\n        <stop offset="0%" style="stop-color: rgb(135, 206, 250); stop-opacity: 1" />\n        <stop offset="100%" style="stop-color: rgb(0, 191, 255); stop-opacity: 1" />\n      </linearGradient>\n    </defs>\n    \x3c!-- Use the gradient for the fill --\x3e\n    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"\n      stroke="url(#trackedGradient)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round">\n    </polygon>\n  </svg>`,S=`\n  <svg xmlns="${y}"\n      width="16"\n      height="16"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(255, 160, 122)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-slash">\n    <circle cx="12" cy="12" r="10"></circle>\n    <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>\n  </svg>`,k=`\n  <svg xmlns="${y}"\n       width="16"\n       height="16"\n       viewBox="0 0 24 24"\n       fill="none"\n       stroke="currentColor"\n       stroke-width="2"\n       stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock">\n    <circle cx="12" cy="12" r="10"></circle>\n    <polyline points="12 6 12 12 16 14"></polyline>\n  </svg>`,E=`\n    <svg xmlns="${y}"\n        width="16"\n        height="16"\n        viewBox="0 0 24 24"\n        fill="none"\n        stroke="currentColor"\n        stroke-width="2"\n        stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right">\n      <polyline points="9 18 15 12 9 6"></polyline>\n    </svg>`,C=`\n  <svg xmlns="${y}"\n      width="16"\n      height="16"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="currentColor"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-user">\n    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>\n    <circle cx="12" cy="7" r="4"></circle>\n  </svg>`,L=`\n  <svg xmlns="${y}"\n      width="28"\n      height="28"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="hsl(355, 80%, 65%)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round">\n    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>\n    <line x1="23" y1="9" x2="17" y2="15"></line>\n    <line x1="17" y1="9" x2="23" y2="15"></line>\n  </svg>`,$=`\n  <svg xmlns="${y}"\n      width="28"\n      height="28"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="hsl(55, 80%, 65%)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round">\n    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>\n    <path d="M19.07 4.93a10 10 0 0 1 0 14.14" opacity="0.3"></path>\n    <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>\n  </svg>`,T=`\n  <svg xmlns="${y}"\n      width="28"\n      height="28"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="hsl(80, 80%, 40%)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round">\n    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>\n    <path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>\n    <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>\n  </svg>`,M=`\n  <svg xmlns="${y}"\n      width="28"\n      height="28"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="hsl(100, 50%, 50%)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round">\n    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>\n    <circle cx="9" cy="7" r="4"></circle>\n    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>\n    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>\n  </svg>`,N=`\n  <svg xmlns="${y}"\n      width="28"\n      height="28"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="hsl(180, 60%, 50%)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round">\n    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>\n    <circle cx="12" cy="7" r="4"></circle>\n  </svg>`,q=`\n  <svg xmlns="${y}"\n      width="16"\n      height="16"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="currentColor"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-slash">\n    <circle cx="12" cy="12" r="10"></circle>\n    <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>\n  </svg>`,I=`\n  <svg xmlns="${y}"\n      width="28"\n      height="28"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(180, 213, 131)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-database">\n    <ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>\n    <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path>\n    <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path>\n  </svg>`,A=`\n  <svg xmlns="${y}"\n      width="28"\n      height="28"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(255, 160, 122)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-mail">\n    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>\n    <polyline points="22,6 12,13 2,6"></polyline>\n  </svg>`,O=`\n  <svg xmlns="${y}"\n      width="28"\n      height="28"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(100, 149, 237)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-message-circle">\n      <path \n          d="M21 11.5 a8.38 8.38 0 0 1 -.9 3.8 a8.5 8.5 0 0 1 -7.6 4.7 a8.38 8.38 0 0 1 -3.8 -.9\n          L3 21 l1.9 -5.7 a8.38 8.38 0 0 1 -.9 -3.8 a8.5 8.5 0 0 1 4.7 -7.6\n          a8.38 8.38 0 0 1 3.8 -.9 h.5 a8.48 8.48 0 0 1 8 8 v.5 z">\n      </path>\n  </svg>`,j=`\n  <svg xmlns="${y}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(113, 196, 196)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-film">\n    <rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"></rect>\n    <line x1="7" y1="2" x2="7" y2="22"></line>\n    <line x1="17" y1="2" x2="17" y2="22"></line>\n    <line x1="2" y1="12" x2="22" y2="12"></line>\n    <line x1="2" y1="7" x2="7" y2="7"></line>\n    <line x1="2" y1="17" x2="7" y2="17"></line>\n    <line x1="17" y1="17" x2="22" y2="17"></line>\n    <line x1="17" y1="7" x2="22" y2="7"></line>\n  </svg>`,B=`\n  <svg xmlns="${y}"\n      width="16"\n      height="16"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(255, 100, 100)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-slash">\n    <circle cx="12" cy="12" r="10"></circle>\n    <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>\n  </svg>`,H=`\n  <svg xmlns="${y}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(255, 228, 196)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-sliders">\n    <line x1="4" y1="21" x2="4" y2="14"></line>\n    <line x1="4" y1="10" x2="4" y2="3"></line>\n    <line x1="12" y1="21" x2="12" y2="12"></line>\n    <line x1="12" y1="8" x2="12" y2="3"></line>\n    <line x1="20" y1="21" x2="20" y2="16"></line>\n    <line x1="20" y1="12" x2="20" y2="3"></line>\n    <line x1="1" y1="14" x2="7" y2="14"></line>\n    <line x1="9" y1="8" x2="15" y2="8"></line>\n    <line x1="17" y1="16" x2="23" y2="16"></line>\n  </svg>`,P=`\n  <svg xmlns="${y}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(144, 238, 144)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-x">\n    <line x1="18" y1="6" x2="6" y2="18"></line>\n    <line x1="6" y1="6" x2="18" y2="18"></line>\n  </svg>`,D="rgb(211, 211, 211)",F=`\n  <svg xmlns="${y}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="${D}"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevrons-up">\n    <polyline points="17 11 12 6 7 11"></polyline>\n    <polyline points="17 18 12 13 7 18"></polyline>\n  </svg>`,z=`\n  <svg xmlns="${y}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="${D}"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-up">\n    <polyline points="18 15 12 9 6 15"></polyline>\n  </svg>`,J=`\n  <svg xmlns="${y}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="${D}"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down">\n    <polyline points="6 9 12 15 18 9"></polyline>\n  </svg>`,U=`\n  <svg xmlns="${y}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="${D}"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevrons-down">\n    <polyline points="7 13 12 18 17 13"></polyline>\n    <polyline points="7 6 12 11 17 6"></polyline>\n  </svg>`,R=`\n  <svg xmlns="${y}"\n      width="24"\n      height="24"\n      viewBox="0 0 25 25"\n      fill="none"\n      stroke="rgb(137, 187, 255)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-toggle-right">\n    <rect x="1" y="5" width="22" height="14" rx="7" ry="7"></rect>\n    <circle cx="16" cy="12" r="3"></circle>\n  </svg>`,_=`\n  <svg xmlns="${y}"\n      width="24"\n      height="24"\n      viewBox="0 0 25 25"\n      fill="none"\n      stroke="rgb(137, 187, 255)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-toggle-left">\n    <rect x="1" y="5" width="22" height="14" rx="7" ry="7"></rect>\n    <circle cx="8" cy="12" r="3"></circle>\n  </svg>`,K=`\n  <svg xmlns="${y}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(176, 196, 222)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar">\n    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>\n    <line x1="16" y1="2" x2="16" y2="6"></line>\n    <line x1="8" y1="2" x2="8" y2="6"></line>\n    <line x1="3" y1="10" x2="21" y2="10"></line>\n  </svg>`,X=`\n  <svg xmlns="${y}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(176, 196, 222)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-clipboard">\n    <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>\n    <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>\n  </svg>`,V=`\n  <svg xmlns="${y}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(28, 229, 229)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-left">\n    <polyline points="15 18 9 12 15 6"></polyline>\n  </svg>`,G=`\n  <svg xmlns="${y}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(28, 229, 229)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right">\n      <polyline points="9 18 15 12 9 6"></polyline>\n  </svg>`,Y=`\n  <svg xmlns="${y}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(169, 155, 255)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-shuffle">\n    <polyline points="16 3 21 3 21 8"></polyline>\n    <line x1="4" y1="20" x2="21" y2="3"></line>\n    <polyline points="21 16 21 21 16 21"></polyline>\n    <line x1="15" y1="15" x2="21" y2="21"></line>\n    <line x1="4" y1="4" x2="9" y2="9"></line>\n  </svg>`,W=`\n  <svg xmlns="${y}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(255, 140, 0)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-trash-2">\n    <polyline points="3 6 5 6 21 6"></polyline>\n    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>\n    <line x1="10" y1="11" x2="10" y2="17"></line>\n    <line x1="14" y1="11" x2="14" y2="17"></line>\n  </svg>`,Z=`\n  <svg xmlns="${y}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="currentColor"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-users">\n    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>\n    <circle cx="9" cy="7" r="4"></circle>\n    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>\n    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>\n  </svg>`,Q=`\n  <svg xmlns="${y}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(209, 144, 238)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-download">\n    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>\n    <polyline points="7 10 12 15 17 10"></polyline>\n    <line x1="12" y1="15" x2="12" y2="3"></line>\n  </svg>`,ee=`\n  <svg xmlns="${y}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(144, 185, 238)"\n      stroke-width="2" stroke-linecap="round"\n      stroke-linejoin="round" class="feather feather-upload">\n    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>\n    <polyline points="17 8 12 3 7 8"></polyline>\n    <line x1="12" y1="3" x2="12" y2="15"></line>\n  </svg>`,te=`\n  <svg xmlns="${y}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(144, 238, 220)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-save">\n    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>\n    <polyline points="17 21 17 13 7 13 7 21"></polyline>\n    <polyline points="7 3 7 8 15 8"></polyline>\n  </svg>`,ne=`\n  <svg xmlns="${y}"\n      width="16"\n      height="16"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(238, 144, 144)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-trash">\n    <polyline points="3 6 5 6 21 6"></polyline>\n    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>\n  </svg>`,oe=`\n  <svg xmlns="${y}"\n      width="20"\n      height="20"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(176, 196, 222)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-snowflake">\n    <g id="snowflake">\n      <line x1="12.06" y1="2.74" x2="12.06" y2="12.06" />\n      <line x1="20.12" y1="7.4" x2="12.06" y2="12.06" />\n      <line x1="20.12" y1="16.71" x2="12.06" y2="12.06" />\n      <line x1="12.06" y1="21.37" x2="12.06" y2="12.06" />\n      <line x1="3.99" y1="16.71" x2="12.06" y2="12.06" />\n      <line x1="3.99" y1="7.4" x2="12.06" y2="12.06" />\n      <polyline points="8.96,4.67 12.06,7.77 15.16,4.67"/>\n      <polyline points="16.9,5.68 15.76,9.92 20,11.05"/>\n      <polyline points="20,13.06 15.76,14.2 16.9,18.43"/>\n      <polyline points="15.16,19.44 12.06,16.34 8.96,19.44"/>\n      <polyline points="7.21,18.43 8.35,14.2 4.11,13.06"/>\n      <polyline points="4.11,11.05 8.35,9.92 7.21,5.68"/>\n    </g>\n  </svg>`,se=`\n  <svg xmlns="${y}"\n      width="16"\n      height="16"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(209, 144, 238)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-plus">\n    <line x1="12" y1="5" x2="12" y2="19"></line>\n    <line x1="5" y1="12" x2="19" y2="12"></line>\n  </svg>`;!function(){const e=document.querySelector(".userpanel .user-block .user-dropdown .name span").textContent,t=document.querySelector("a.drop-btn.mail")?.href?.match(/\/u\/#\/(\d+)\/messages\//)?.[1],n=new Intl.DateTimeFormat("en-CA").format(new Date);function o(e,t){if(!document.querySelector(`.font-${e.replace(/\s/g,"-")}`)){const n=document.createElement("link");n.rel="stylesheet",n.href=`https://fonts.googleapis.com/css2?family=${e.replace(/\s/g,"+")}:wght@${t.join(";")}&display=swap`,n.classList.add(`font-${e.replace(/\s/g,"-")}`),document.head.appendChild(n)}}o("Montserrat",["100","200","300","400","500","600","700","800","900"]),o("Orbitron",["400","500","600","700","800","900"]),o("Roboto Mono",["100","200","300","400","500","600","700"]);const s=2.5;let r=JSON.parse(localStorage.getItem("KG_Chat_Empowerment"));r||(r={voiceSettings:{voiceSpeed:1.5,voicePitch:1},messageSettings:{}},localStorage.setItem("KG_Chat_Empowerment",JSON.stringify(r)));let a=null!==r.voiceSettings.voiceSpeed?r.voiceSettings.voiceSpeed:1.5,i=null!==r.voiceSettings.voicePitch?r.voiceSettings.voicePitch:1;const l="https://klavogonki.ru/u/#/";let c=[{name:"",gender:"Male",pronunciation:"",state:"thawed"}],d=[],u=[],m=[],p=[],g=[];const h=JSON.parse(localStorage.getItem("usersToTrack"))||[],f=JSON.parse(localStorage.getItem("mentionKeywords"))||[],y=JSON.parse(localStorage.getItem("usernameReplacements"))||[],D=JSON.parse(localStorage.getItem("moderator"))||[],re=JSON.parse(localStorage.getItem("ignored"))||[];c=h?.length?h:c,d=f?.length?f:d,u=y?.length?y:u,m=D?.length?D:m,p=re?.length?re:p,d.push(e);let ae=!1,ie=!1;function le({container:e,buttons:t}){const n=0===e.scrollTop,o=e.scrollTop+e.clientHeight>=e.scrollHeight-3;[t.fullScrollUpButton,t.partialScrollUpButton].forEach((e=>{e.style.opacity=n?"0.3":"1",e.style.pointerEvents=n?"none":"auto"})),[t.fullScrollDownButton,t.partialScrollDownButton].forEach((e=>{e.style.opacity=o?"0.3":"1",e.style.pointerEvents=o?"none":"auto"}))}function ce({container:e,scrollButtonsContainer:t}){e.scrollHeight>e.clientHeight?t.style.display="flex":t.style.display="none"}function de(e){const t=document.createElement("div");t.className="scroll-buttons-container";const n=document.createElement("div");n.innerHTML=F,n.title="Scroll Up (Full)",t.appendChild(n);const o=document.createElement("div");o.innerHTML=z,o.title="Scroll Up (Partial)",t.appendChild(o);const s=document.createElement("div");s.innerHTML=J,s.title="Scroll Down (Partial)",t.appendChild(s);const r=document.createElement("div");r.innerHTML=U,r.title="Scroll Down (Full)",t.appendChild(r);const a={fullScrollUpButton:n,partialScrollUpButton:o,partialScrollDownButton:s,fullScrollDownButton:r};function i(t,n){const o=n?e.scrollHeight:e.clientHeight;e.scrollBy({top:"up"===t?-o:o,behavior:"smooth"}),le({container:e,buttons:a})}return Object.values(a).forEach((e=>{e.classList.add("large-button","scroll-button"),t.appendChild(e)})),n.addEventListener("click",(()=>i("up",!0))),o.addEventListener("click",(()=>i("up",!1))),s.addEventListener("click",(()=>i("down",!1))),r.addEventListener("click",(()=>i("down",!0))),le({container:e,buttons:a}),ce({container:e,scrollButtonsContainer:t}),e.addEventListener("scroll",(()=>{le({container:e,buttons:a}),ce({container:e,scrollButtonsContainer:t})})),{scrollButtonsContainer:t}}["keydown","keyup"].forEach((e=>document.addEventListener(e,(t=>{return n=t.key,o="keydown"===e,"Control"===n&&(ae=o),void("Alt"===n&&(ie=o));var n,o})))),["blur","focus"].forEach((e=>document.addEventListener(e,(()=>{(ae||ie)&&(console.log(`${ae?"Ctrl ":""}${ie?"Alt ":""}key was true`),ae=ie=!1)}))));const ue=function(){const e=new AudioContext;return new Promise((t=>{e.onstatechange=function(){"running"===e.state&&t(e)}}))}(),me=[300,600],pe=[600,300],ge=[500],he=[600,800],fe=100;function ye(e,t){ue.then((n=>{for(let o=0;o<e.length;o++){const s=e[o];if(0===s)setTimeout((()=>{}),80);else{const e=n.createOscillator(),r=n.createGain();e.connect(r),e.frequency.value=s,e.type="sine";const a=n.createBiquadFilter();a.type="lowpass",a.frequency.value=250,e.connect(a);const i=n.createBiquadFilter();i.type="highpass",i.frequency.value=16e3,a.connect(i),r.connect(n.destination),r.gain.setValueAtTime(0,n.currentTime),r.gain.linearRampToValueAtTime(t,n.currentTime+.01),e.start(n.currentTime+o*fe/1e3),e.stop(n.currentTime+(o*fe+80)/1e3),r.gain.setValueAtTime(t,n.currentTime+(o*fe+70)/1e3),r.gain.linearRampToValueAtTime(0,n.currentTime+(o*fe+80)/1e3)}}}))}const ve=new Promise((e=>{const t=window.speechSynthesis;let n=t.getVoices();const o="Microsoft Pavel - Russian (Russia)",s="Microsoft Irina - Russian (Russia)";let r=n.find((e=>e.name===o)),a=n.find((e=>e.name===s));if(r&&a&&0!==n.length){const o=new SpeechSynthesisUtterance;o.lang="ru-RU",o.voice=a,e({synth:t,utterance:o,voices:n,pavelVoice:r,irinaVoice:a})}else t.addEventListener("voiceschanged",(()=>{if(n=t.getVoices(),r=n.find((e=>e.name===o)),a=n.find((e=>e.name===s)),r&&a){const o=new SpeechSynthesisUtterance;o.lang="ru-RU",o.voice=a,e({synth:t,utterance:o,voices:n,pavelVoice:r,irinaVoice:a})}}))}));async function be(e,t=t){const n=Le("sound","gTTS"),o=await async function(e){return e.replace(/[-_]/g," ").replace(/https?:\/\/(?:www\.)?([a-zA-Z0-9.-]+)(\/.*)?/g,((e,t)=>t)).replace(/\s(?=[?!,.:;@])/g,"").replace(/["#$%&'()*+\/<=>[\\\]^`{|}~]/g,"").split(" ").filter(Boolean).join(" ").trim()}(e);if(n){const e=(e=>e.split(/\s+/).reduce(((e,t)=>{const n=/[--0-9]/.test(t)?"ru":"en";return e.length&&e[e.length-1].lang===n?e[e.length-1].text+=" "+t:e.push({lang:n,text:t}),e}),[]))(o);try{for(const{lang:t,text:n}of e)await new Promise(((e,o)=>{fetch(`http://127.0.0.1:5000/speak?text=${encodeURIComponent(n)}&lang=${t}`).then((e=>{if(!e.ok)throw new Error(`HTTP ${e.status}`);return e.arrayBuffer()})).then((t=>{const n=new(window.AudioContext||window.webkitAudioContext),s=new Audio(URL.createObjectURL(new Blob([t],{type:"audio/mp3"}))),r=n.createMediaElementSource(s),a=n.createGain();a.gain.value=2,r.connect(a),a.connect(n.destination),s.onended=e,s.onerror=o,s.play()})).catch(o)}))}catch(e){console.error("Server TTS failed:",e)}}else await async function(e,t=t){const{synth:n,utterance:o,voice:s}=await ve;return Object.assign(o,{text:e,rate:t,volume:.8,pitch:i,voice:s}),new Promise((e=>{o.onend=e,n.speak(o)}))}(e,t)}const xe={Male:{enter:"",leave:""},Female:{enter:"",leave:""}};const we=document.querySelector("body"),Se=document.createElement("div");Se.classList.add("empowerment-panel");const ke=document.createElement("div");ke.classList.add("chat-user-count"),ke.title="Current Chat Users Count",ke.innerHTML="0",Se.appendChild(ke),we.appendChild(Se);const Ee=e=>new Promise((t=>setTimeout(t,e)));function Ce(e,t){const n=t.getBoundingClientRect(),o=e.getBoundingClientRect();return o.top>=n.top&&o.bottom<=n.bottom}function Le(e,t){const n=JSON.parse(localStorage.getItem("toggle"))||[],o={notifications:{static:"showChatStaticNotifications",dynamic:"showGlobalDynamicNotifications"},sound:{presence:"enableBeepOnChatJoinLeave",gTTS:"switchToGoogleTTSEngine"}}[e];return!(!o||!o[t])&&n.some((e=>e.name===o[t]&&"yes"===e.option))}function $e(){return(new Date).toLocaleTimeString("en-US",{hour12:!1,hour:"2-digit",minute:"2-digit",second:"2-digit"})}function Te(e,t){const n=Object.values(JSON.parse(localStorage.getItem("fetchedUsers")||"[]")).find((t=>t?.login===e));if(!n)return` User "${e}" not found`;const o=n.actionLog||[],s=o.find((e=>e.timestamp===t));if(!s)return`Action not found at ${t}`;const r=o.indexOf(s);if(0===r)return` ${e}'s first action`;const a=o.slice(0,r).reverse().find((e=>e.type!==s.type));if(!a)return` No valid previous action found for ${t}`;const i=function(e,t){const n=e=>e.split(":").reduce(((e,t,n)=>e+t*[3600,60,1][n]),0),o=Math.abs(n(t)-n(e));return[Math.floor(o/3600),Math.floor(o%3600/60),o%60].map((e=>e.toString().padStart(2,"0"))).join(":")}(a.timestamp,s.timestamp);return"leave"===s.type?` ${e} stayed in chat for ${i}`:` ${e} was absent for ${i}`}let Me=null,Ne=null,qe=null,Ie=!1,Ae=!1,Oe=null;const je=e=>{Me&&(Me.style.left=`${e.clientX+0}px`,Me.style.top=`${e.clientY+18}px`)},Be=()=>{Ie=!1,Oe=null,clearTimeout(qe),qe=null,clearTimeout(Ne),Ne=setTimeout((()=>{Me&&(Me.style.opacity="0",Ae=!1,setTimeout((()=>{!Ie&&Me&&(Me.style.display="none",document.removeEventListener("mousemove",je))}),50))}),100)};function He(e,t){if(e.classList.contains("events-included"))return;e.classList.add("events-included"),Me||=(()=>{const e=document.createElement("div");return e.classList.add("custom-tooltip-popup"),document.body.appendChild(e),e})();e.addEventListener("mouseenter",(n=>{Ie=!0,Oe=e,clearTimeout(qe),clearTimeout(Ne),Me.textContent=t,document.addEventListener("mousemove",je),je(n),Ae||(qe=setTimeout((()=>{Me.style.display="flex",Me.style.opacity="1",Ae=!0}),600))})),e.addEventListener("mouseleave",Be)}new MutationObserver((()=>{Oe&&!document.contains(Oe)&&Be()})).observe(document,{childList:!0,subtree:!0});function Pe(e){const t=document.createElement("div");return t.classList.add("action-icon"),t.style.margin="0 4px",t.style.setProperty("border","none","important"),t.innerHTML=e,t}function De(e,t,n,o,s){const r={generalChat:".messages-content div",cachePanel:".fetched-users .action-log"}[s];if(!r)return void console.error("Invalid or missing container. Please provide 'generalChat' or 'cachePanel'.");const a=document.querySelector(r);if(!a)return void console.error("Container not found in DOM.");a.classList.add("generalChat"===s?"static-chat-notifications-container":"static-cache-notifications-container");const i=document.createElement("div");i.classList.add("static-chat-notification"),"generalChat"===s&&i.addEventListener("dblclick",(()=>{!async function(e=40,t=600,n=140){const o=document.querySelector(".messages-content");if(!o)return;const s=o.style.scrollBehavior;o.style.scrollBehavior="smooth";const r=[...document.querySelectorAll(".static-chat-notification")].reverse();for(const s of r)!Ce(s,o)&&(o.scrollTop=s.offsetTop-o.offsetTop-o.clientHeight/2,await Ee(t)),Object.assign(s.style,{transition:[`opacity ${n/1e3}s cubic-bezier(.3,.1,1,.1)`,`transform ${n/1e3}s cubic-bezier(0,.7,.3,0.95)`].join(","),opacity:0,transformOrigin:"left",transform:"translateX(8em) skewX(-20deg)"}),await Ee(n),s.remove(),await Ee(e);o.scrollHeight-o.scrollTop<=o.clientHeight||(o.scrollTop=o.scrollHeight,await Ee(t)),o.style.scrollBehavior=s}()}));const l=document.createElement("span");l.classList.add("action-user"),l.textContent=e;const c=Pe(t),d=document.createElement("span");d.classList.add("action-time"),d.textContent=n,i.appendChild(l),i.appendChild(c),i.appendChild(d),i.dataset.username=e,i.dataset.time=n,o?i.classList.add("user-enter"):i.classList.add("user-left"),a.appendChild(i),i.addEventListener("mouseover",(()=>{const e=Te(i.dataset.username,i.dataset.time);He(i,e)}))}function Fe(e,t,n){const o=c.some((t=>t.name===e&&"thawed"===t.state)),s=o&&Le("notifications","static"),r=Le("notifications","dynamic");if(!s&&!r)return;const a=$e();s&&o&&(De(e,t,a,n,"generalChat"),Gt()),r&&function(e,t,n,o){let s=document.querySelector(".dynamic-chat-notifications-container");s||(s=document.createElement("div"),s.classList.add("dynamic-chat-notifications-container"),document.body.appendChild(s));const r=document.createElement("div");r.classList.add("dynamic-chat-notification");const a=document.createElement("span");a.classList.add("action-user"),a.textContent=e;const i=Pe(t),l=document.createElement("span");l.classList.add("action-time"),l.textContent=n,r.appendChild(a),r.appendChild(i),r.appendChild(l),r.dataset.username=e,r.dataset.time=n,o?r.classList.add("user-enter"):r.classList.add("user-left"),s.appendChild(r),r.addEventListener("mouseover",(()=>{const e=Te(r.dataset.username,r.dataset.time);He(r,e)})),setTimeout((()=>{r.style.transform="translateX(0)",setTimeout((()=>{r.style.transform="translateX(-100%)",setTimeout((()=>{s.removeChild(r)}),300)}),5e3)}),300)}(e,t,a,n)}let ze=null;const Je=[];let Ue=0;let Re=!1;const _e="",Ke="",Xe="",Ve=["jpg","jpeg","png","gif","webp"],Ge=["klavogonki.ru","youtube.com","youtu.be","imgur.com","pikabu.ru","userapi.com","ibb.co","yaplakal.com","freepik.com"];function Ye(e){try{const t=new URL(e),n=t.hostname.toLowerCase().split("."),o=n.length>2?n.slice(-2).join("."):t.hostname;return{isTrusted:Ge.includes(o),domain:o}}catch(t){return console.error("Error in isTrustedDomain:",t.message),{isTrusted:!1,domain:e}}}function We(e){const t=document.querySelector({generalMessages:".messages-content div",chatlogsMessages:".chat-logs-container",personalMessages:".messages-container-wrapper"}[e]);if(!t)return;const n=t.querySelectorAll("a:not(.skipped):not(.processed-image)");function o(t,n){const o=document.createElement("div");o.classList.add("clickable-thumbnail");const s=document.createElement("img");s.src=t.href,s.onload=()=>{o.appendChild(s),t.parentNode.insertBefore(o,t.nextSibling),Je.push({link:t,imgSrc:t.href}),Gt(e)},s.onerror=()=>{console.error("Failed to load image:",t.href),t.classList.add("skipped")},n?t.querySelector(".clickable-thumbnail")||t.addEventListener("click",(e=>{t.querySelector(".clickable-thumbnail")||(o.appendChild(s),t.parentNode.insertBefore(o,t.nextSibling))})):(o.appendChild(s),t.parentNode.insertBefore(o,t.nextSibling)),o.addEventListener("click",(e=>{e.stopPropagation(),ze=function(e){const t=document.createElement("img");t.src=e,t.classList.add("scaled-thumbnail"),document.body.appendChild(t);const n=e=>{lt(e,"hide"),document.querySelector(".popup-panel")||it("hide"),Qe()};Ze.unfocusedClick=function(e){t.contains(e.target)||(t.remove(),Qe())},document.addEventListener("click",Ze.unfocusedClick),Ze.keydown=function(e){"Escape"===e.code||"Space"===e.code?(e.preventDefault(),n(t)):"ArrowLeft"===e.code?et(-1):"ArrowRight"===e.code&&et(1)},document.addEventListener("keydown",Ze.keydown);let o=1,s=.1,r=!1,a=0,i=0,l=-50,c=-50;const d=5;return Ze.wheel=function(e){const n=e.deltaY;o+=(n<0?1:-1)*s*o,o=Math.max(o,1),t.style.transform=`translate(${l}%, ${c}%) scale(${o})`,e.preventDefault()},Ze.mousemove=function(e){if(r){const n=(e.clientX-a)/o*d,s=(e.clientY-i)/o*d;l+=n/t.clientWidth*100,c+=s/t.clientHeight*100,t.style.transform=`translate(${l}%, ${c}%) scale(${o})`,a=e.clientX,i=e.clientY}},Ze.mousedown=function(e){const{button:o,clientX:s,clientY:l,target:c,ctrlKey:d}=e;if((0===o||2===o)&&c!==t)return;let u=c.src;0===o?d?window.open(u,"_blank"):et(-1):2===o?(e.preventDefault(),d?(navigator.clipboard.writeText(u).catch(console.error),n(t)):et(1)):1===o&&(r=!0,[a,i]=[s,l])},Ze.mouseup=function(){r=!1},Ze.contextmenu=function(e){e.preventDefault()},function(){Object.entries(Ze).forEach((([e,t])=>{document.addEventListener(e,t)}))}(),t}(s.src),lt(ze,"show"),it("show")}))}n.length&&n.forEach((e=>{if(!e.href||!e.href.startsWith("http"))return;const{allowed:t,extension:n}=function(e){const t=e=>e.match(/\.([^?#.]+)(?:[?#]|$)/i)?.[1]?.toLowerCase()||"";try{const n=t(e);return{allowed:Ve.includes(n),extension:n}}catch(n){return console.error("Error in isAllowedImageExtension:",n.message),{allowed:!1,extension:t(String(e))}}}(e.href);if(!t)return;e.classList.add("media");const{isTrusted:s,domain:r}=Ye(e.href);e.title=ot(e.href)?st(e.href):e.href,s?(e.textContent=` Image (${n.toUpperCase()}) ${Ke} Hostname (${r})`,e.classList.add("processed-image"),o(e,!1)):(e.classList.add("skipped"),e.textContent=` Image (${n.toUpperCase()}) ${Ke} Hostname (${r}) ${Xe} Untrusted`,e.addEventListener("click",(t=>{e.classList.contains("processed-image")||(t.preventDefault(),e.classList.remove("skipped"),e.classList.add("processed-image"),o(e,!0))})))}))}const Ze={};function Qe(){Object.entries(Ze).forEach((([e,t])=>{document.removeEventListener(e,t)}))}function et(e){const t=Ue+e;if(t>=0&&t<Je.length){if(Re)return;Re=!0,ze&&(ze.src=Je[t].imgSrc),setTimeout((()=>{Re=!1}),50),Ue=t}}const tt=["mp4","webm","ogg","mov","avi"];function nt(e){const t={generalMessages:".messages-content div",chatlogsMessages:".chat-logs-container",personalMessages:".messages-container-wrapper"}[e];if(!t)return void console.error("Invalid container type specified");const n=document.querySelector(t);if(!n)return;const o=n.querySelectorAll("a:not(.skipped):not(.processed-video)");function s(t,n,o,s){const{youtubeMatch:r,videoType:a,videoId:i}=s,l=function(e){const t=e=>e.match(/\.([^?#.]+)(?:[?#]|$)/i)?.[1]?.toLowerCase()||"";try{const n=t(e);return{allowed:tt.includes(n),extension:n}}catch(n){return console.error("Error in isAllowedVideoExtension:",n.message),{allowed:!1,extension:t(String(e))}}}(n);if(!r&&!l.allowed)return;t.classList.add("processed-video");const c=document.createElement("div");c.classList.add("video-wrapper");let d=document.createElement(r?"iframe":"video");d.classList.add("video-container"),r?(t.textContent=`${_e} ${a} ${Ke} Hostname (${o})`,d.src=`https://www.youtube.com/embed/${i}`,d.allowFullscreen=!0):(t.textContent=`${_e} ${a} ${Ke} Hostname (${o})`,d.src=n,d.controls=!0),t.title=ot(n)?st(n):n,t.style.display="inline-flex",t.parentNode.insertBefore(c,t),c.append(t,d),Gt(e)}o.length&&o.forEach((e=>{const t=e.href;if(!t)return;const n=function(e){const t=e.match(/(?:shorts\/|live\/|watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/i);if(t){return{youtubeMatch:!0,videoId:t[1],videoType:e.includes("shorts/")?"Shorts":e.includes("live/")?"Live":e.includes("watch?v=")?"Watch":e.includes("youtu.be/")?"Share":"YouTube"}}const n=e.split(".").pop().toLowerCase();if(tt.includes(n))return{youtubeMatch:!1,videoType:`Video (${n.toUpperCase()})`};return!1}(t);if(!n)return;e.classList.add("media");const{isTrusted:o,domain:r}=Ye(t);if(!o)return e.classList.add("skipped"),e.textContent=`${_e} ${n.videoType} ${Ke} Hostname (${r}) ${Xe} Untrusted`,void e.addEventListener("click",(o=>{e.classList.contains("processed-video")||(o.preventDefault(),e.classList.remove("skipped"),s(e,t,r,n))}));s(e,t,r,n)}))}function ot(e){return/^https?:\/\//.test(e)&&/%[0-9A-Fa-f]{2}/.test(e)}function st(e){const[t]=e.split("#");return decodeURIComponent(t).replace(/ /g,"_")}function rt(e){document.querySelector({generalMessages:".messages-content div",chatlogsMessages:".chat-logs-container",personalMessages:".messages-container-wrapper"}[e])?.querySelectorAll("a:not(.media):not(.decoded)").forEach((e=>{try{if(ot(e.href)){let t=st(e.href);e.href=e.textContent=t,e.classList.add("decoded")}}catch(t){console.error("Error decoding link:",t,e.href)}}))}function at(e,t,n){e&&(e.offsetHeight,e.style.transition="opacity 0.3s",e.style.opacity="show"===t?n:"0","hide"===t&&e.addEventListener("transitionend",(()=>{"0"===e.style.opacity&&e.remove()}),{once:!0}))}function it(e){let t=document.querySelector(".dimming-background"),n=document.querySelector(".scaled-thumbnail");("hide"!==e||t)&&(t||(t=document.createElement("div"),t.classList.add("dimming-background"),document.body.appendChild(t),t.addEventListener("click",(function(){const e=document.querySelector(".popup-panel")||t.previousElementSibling;e&&at(e,"hide",0),it("hide"),n&&Qe()}))),at(t,e,.5),"hide"===e&&n&&(Qe(),lt(n,"hide")))}function lt(e,t){e&&(at(e,t,1),e.addEventListener("dblclick",(t=>{document.querySelector(".popup-panel")&&t.target.closest(".scaled-thumbnail")||it("hide"),lt(e,"hide")})))}let ct={};function dt(){Object.values(ct).forEach((e=>{document.removeEventListener("keydown",e)})),ct={};const e=document.querySelector(".popup-panel");e&&e.remove()}const ut={:1,:2,:3,:4,:5,:6,:7,:8,:9},mt={:"#06B4E9",:"#5681ff",:"#B543F5",:"#DA0543",:"#FF8C00",:"#C1AA00",:"#2DAB4F",:"#61B5B3",:"#AFAFAF"};let pt=null;const gt=e=>{const t=document.createElement("iframe");t.classList.add("profile-iframe-container"),t.src=e,document.body.appendChild(t),at(t,"show",1);const n=()=>{at(t,"hide",0),document.removeEventListener("keydown",o),document.removeEventListener("mousedown",o)},o=e=>{if("keydown"===e.type&&"Space"===e.code){if(pt)return void e.stopPropagation();e.preventDefault(),n()}"mousedown"!==e.type||t.contains(e.target)||n()};document.addEventListener("keydown",o),document.addEventListener("mousedown",o),t.onload=()=>{try{const e=t.contentWindow,s=e.document;s.addEventListener("focusin",(e=>{"TEXTAREA"===e.target.tagName&&(pt=e.target)})),s.addEventListener("focusout",(()=>{setTimeout((()=>{s.activeElement&&"TEXTAREA"===s.activeElement.tagName||(pt=null)}),0)})),e.addEventListener("keydown",o),e.addEventListener("dblclick",n),new MutationObserver(((e,t)=>{e.some((e=>[...e.removedNodes].some((e=>1===e.nodeType&&(e.classList.contains("dimming-background")||e.classList.contains("cached-users-panel"))))))&&(n(),t.disconnect())})).observe(document.body,{childList:!0,subtree:!0})}catch(e){console.warn("Unable to access iframe contents:",e)}}};function ht(){const e=document.querySelector(".cached-users-panel");if(e)return e.remove(),void it("hide");dt();const n=localStorage.getItem("fetchedUsers");let o=JSON.parse(n)||{};const s=document.createElement("div");s.className="cached-users-panel popup-panel",ct.handleCacheKeydown=e=>{"Escape"===e.key&&(lt(s,"hide"),it("hide"),document.removeEventListener("keydown",ct.handleCacheKeydown))},document.addEventListener("keydown",ct.handleCacheKeydown);const r=document.createElement("div");r.className="panel-header";const a=document.createElement("div");a.className="drop-time";const i=document.createElement("span");i.className="drop-time-threshold-description",i.textContent=" Threshold";const c=document.createElement("span");c.className="drop-time-threshold";const d=localStorage.getItem("cacheRefreshThresholdHours");c.innerHTML=d||"00:00:00",c.addEventListener("click",(function(){let e=!1;for(;!e;){const t=prompt("Enter a cache refresh time (e.g., HH, HH:mm, or HH:mm:ss):"),n=document.querySelector(".drop-time-threshold");if(null===t)e=!0;else if(/^([0-9]+|[01][0-9]|2[0-4])(:([0-5]?[0-9])(:([0-5]?[0-9]))?)?$/.test(t)){const o=t.split(":"),s=("0"+o[0]).slice(-2),r=("0"+(o[1]||"00")).slice(-2),a=("0"+(o[2]||"00")).slice(-2);n.textContent=`${s}:${r}:${a}`;const i=`${s}:${r}:${a}`;localStorage.setItem("cacheRefreshThresholdHours",i),localStorage.removeItem("fetchedUsers"),localStorage.removeItem("lastClearTime"),localStorage.removeItem("nextClearTime"),setTimeout((()=>location.reload()),1e3),e=!0}else alert("Invalid time format. Please enter a valid time in the format HH, HH:mm, or HH:mm:ss.")}}));const u=document.createElement("span");u.className="drop-time-expiration-description",u.textContent=" Countdown";const m=document.createElement("span");m.className="drop-time-expiration",a.appendChild(i),a.appendChild(c),a.appendChild(u),a.appendChild(m),r.appendChild(a);const p=document.createElement("div");p.className="search-for-cached-users";const g=document.createElement("input");g.className="cached-users-search-input",g.type="text",p.appendChild(g),g.addEventListener("click",(()=>ae&&(g.value=""))),g.addEventListener("keydown",(async e=>{const t=document.querySelector(".old-users"),n=document.querySelector(".new-users"),o=document.querySelector(".fetched-users");if("Backspace"===e.key&&0===e.target.value.length){t.style.display="grid",n.style.display="grid";const e=document.querySelector(".search-results");e&&o&&o.removeChild(e)}else if("Enter"===e.key){0===e.target.value.trim().length&&(e.preventDefault(),e.target.value="user ")}}));const h=async e=>{const t=document.querySelector(".old-users"),n=document.querySelector(".new-users"),o=document.querySelector(".fetched-users");if(e){t.style.display="none",n.style.display="none";let s=document.querySelector(".search-results");s?s.innerHTML=null:(s=L("search-results"),o.appendChild(s));const r=[];try{const t=await async function(e){const t=`https://klavogonki.ru/api/profile/search-users?query=${e}`,n=(await vt(t)).all;if(!n||0===n.length)throw new Error(`User ${e} not found.`);return n.map((e=>e.id))}(e);await Promise.all(t.map((async e=>{const t=await yt(e,!1),n={rank:t.rank,login:t.login,registered:t.registeredDate,bestSpeed:t.bestSpeed,ratingLevel:t.ratingLevel,friends:t.friends,cars:t.cars,avatarTimestamp:t.avatarTimestamp,avatar:t.avatar},o=j(e,n);o&&r.push(o)}))),r.sort(((e,t)=>e.order!==t.order?e.order-t.order:t.bestSpeed-e.bestSpeed)),r.forEach((({userElement:e})=>{s.appendChild(e)}));const n=M(`Search Results for: ${e}`,"search-results-description");s.prepend(n)}catch(e){console.error("Error fetching user profile:",e);const t=document.createElement("div");t.className="error-message",t.textContent=`Error fetching user profile: ${e.message}`,s.appendChild(t)}}};g.addEventListener("input",jt((e=>{const t=e.target.value.trim(),n=localStorage.getItem("cachePanelSearchMode"),o=t.startsWith("user ")?t.substring(5).trim():"fetch"===n?t:"";o&&h(o)}),Ot)),r.appendChild(p);const f=new MutationObserver((e=>{if(e.some((e=>"childList"===e.type&&e.addedNodes.length>0))){const e=document.querySelector(".cached-users-search-input"),t=Array.from(document.querySelectorAll(".fetched-users .login")),n=(e,t)=>{let n=0,o=0;for(const s of t.toLowerCase())o<e.length&&s===e[o].toLowerCase()&&(n+=2,o++);return o===e.length?n:0},o=e=>{t.forEach((t=>{t.closest(".user").style.display=!e||n(e,t.textContent)>0?"grid":"none"}))};e.focus(),e.addEventListener("input",(()=>o(e.value.trim()))),f.disconnect()}}));f.observe(r,{childList:!0,subtree:!0});const y=document.createElement("div");y.className="panel-control-buttons",y.style.display="flex";const x=document.createElement("div");x.className="large-button user-mode-button",x.innerHTML=Z;const w=localStorage.getItem("cachePanelSearchMode")||(localStorage.setItem("cachePanelSearchMode","cache"),"cache");function S(e){const t=x;t.classList.toggle("cache-mode-button","cache"===e),t.classList.toggle("fetch-mode-button","cache"!==e)}x.title=`Current active mode: ${w}`,S(w),x.addEventListener("click",(()=>{const e="cache"===localStorage.getItem("cachePanelSearchMode")?"fetch":"cache";localStorage.setItem("cachePanelSearchMode",e),S(e),x.title=`Current active mode: ${e}`})),y.appendChild(x);const k=document.createElement("div");k.className="large-button panel-header-clear-button",k.title="Clear cache",k.innerHTML=W,k.addEventListener("click",(()=>{ft(),Tt(!0,$t);const e=document.querySelector(".cache-panel-load-button .cache-user-count");e&&(e.textContent="0")})),y.appendChild(k);const E=document.createElement("div");E.className="large-button panel-header-close-button",E.title="Close panel",E.innerHTML=P,E.addEventListener("click",(()=>{ft()})),y.appendChild(E),r.appendChild(y);const C=document.createElement("div");function L(e){const t=document.createElement("div");return t.className="users-container",t.classList.add(e?"old-user":"new-user"),t}C.className="fetched-users";const $=L(!0),T=L(!1);function M(e,t){const n=document.createElement("span");return n.className=`description ${t}`,n.textContent=e,n}const N=M("Active Users","old-users-description"),q=M("New Registrations","new-users-description");$.appendChild(N),T.appendChild(q),C.appendChild($),C.appendChild(T);const I=[];let A=!0;const O=new Date,j=(e,n)=>{const o=document.createElement("div");o.className="user-item";const s=document.createElement("div");s.className="avatar";const r=kt[e]?.avatarTimestamp,a=`/storage/avatars/${e}_big.png`;if(r&&"00"!==r||n.avatar&&Object.keys(n.avatar).length>0){const e=`${a}?updated=${r}`,t=document.createElement("img");t.src=e,t.alt=`${n.login}'s avatar`,t.style.objectFit="cover",s.appendChild(t)}else s.innerHTML=wt();const i=document.createElement("div");i.className="user-data";const c=document.createElement("div");c.className="login-container";const d=document.createElement("a");d.className="login",d.textContent=n.login,d.href=`https://klavogonki.ru/profile/${e}`,c.appendChild(d);const u=l+e,m=`${l}${t}/messages/${e}/`;if(d.addEventListener("click",(function(e){if(e.preventDefault(),e.ctrlKey&&e.shiftKey){const e=window.open(m,"_blank");e&&e.focus()}else e.ctrlKey?gt(m):gt(u)})),void 0!==n.visits){const t=document.createElement("span");t.className="visits",t.classList.add(n.tracked?"tracked":"untracked"),t.textContent=n.visits,t.dataset.userId=e,function(e){const t=Number(e.textContent);if(isNaN(t))return console.warn("Invalid visits count!");const n=t<=10?"":t<=20?"":t<=30?"":"";e.textContent=`${n} ${t}`}(t),c.appendChild(t),t.addEventListener("click",(e=>{A=!0;const o=t.dataset.userId,s=kt[o],r=s?s.actionLog:null;if(s){let t=document.querySelector(".action-log");if(t?t.replaceChildren():(t=document.createElement("div"),t.className="action-log",C.appendChild(t),at(t,"show",1)),r&&A)for(let e=0;e<r.length&&A;e++){const t=r[e];if("object"!=typeof t||null===t)continue;const{type:o,timestamp:s}=t,a=n?.login||"Unknown User",i="enter"===o?v:b,l="enter"===o;(t=>{setTimeout((()=>{t&&De(a,i,s,l,"cachePanel")}),10*(e+1))})(A)}const o=e=>{t.contains(e.target)&&"Space"!==e.code||("Space"===e.code&&e.preventDefault(),at(t,"hide",0),A=!1,["click","keydown"].forEach((e=>document.removeEventListener(e,o))))};["click","keydown"].forEach((e=>document.addEventListener(e,o))),e.stopPropagation()}else console.error("User data not found")}))}i.appendChild(c);const p=document.createElement("div");p.className="rank",p.textContent=n.rank||"N/A",p.style.color=mt[n.rank]||"white",i.appendChild(p);const g=document.createElement("div");let h;g.className="registered",g.textContent=n.registered||"N/A";const f=g.textContent;g.addEventListener("mouseover",(()=>{clearTimeout(h),h=setTimeout((()=>{g.textContent=function(e){const t=Math.floor((new Date-new Date(e))/1e3),n=Math.floor(t/31536e3),o=Math.floor(t%31536e3/(30.44*24*60*60)),s=Math.floor(t%(30.44*24*60*60)/86400),r=Math.floor(t%86400/3600),a=Math.floor(t%3600/60),i=t%60,l=[];n>0?(l.push(`${n} year${n>1?"s":""}`),o>0&&l.push(`${o} month${o>1?"s":""}`)):o>1||1===o&&s>0?(l.push(`${o} month${o>1?"s":""}`),s>0&&l.push(`${s} day${s>1?"s":""}`)):s>0?(l.push(`${s} day${s>1?"s":""}`),r>0&&l.push(`${r} hour${r>1?"s":""}`),a>0&&l.push(`${a} minute${a>1?"s":""}`)):r>0?(l.push(`${r} hour${r>1?"s":""}`),a>0&&l.push(`${a} minute${a>1?"s":""}`)):a>0?(l.push(`${a} minute${a>1?"s":""}`),i>0&&l.push(`${i} second${i>1?"s":""}`)):l.push(`${i} second${i>1?"s":""}`);return l.filter(Boolean).join(" ")}(n.registered)}),300)})),g.addEventListener("mouseout",(()=>{clearTimeout(h),g.textContent=f})),i.appendChild(g);const y=(e,t,n,o,s,r)=>{const a=document.createElement("span");return a.className=e,a.style.color=t,a.innerHTML=`${n}${o||0}&nbsp;&nbsp;`,a.title=s,a.style.cursor="pointer",a.addEventListener("click",(()=>gt(r))),a},x=y("best-speed","cyan","",n.bestSpeed,"Best speed",`https://klavogonki.ru/u/#/${e}/stats/normal/`),w=y("rating-level","gold","",n.ratingLevel,"Rating level",`https://klavogonki.ru/top/rating/today?s=${n.login}`),S=y("cars-count","lightblue","",n.cars,"Cars count",`https://klavogonki.ru/u/#/${e}/car/`),k=y("friends-count","lightgreen","",n.friends,"Friends count",`https://klavogonki.ru/u/#/${e}/friends/list/`),E=document.createElement("div");return E.className="user-metrics",E.append(x,w,S,k),o.append(s,i,E),{userElement:o,order:ut[n.rank]||10,bestSpeed:n.bestSpeed||0,registered:n.registered}};"cache"===localStorage.getItem("cachePanelSearchMode")&&(Object.keys(o).forEach((async e=>{const t=o[e],n=j(e,t);I.push(n)})),I.sort(((e,t)=>e.order!==t.order?e.order-t.order:t.bestSpeed-e.bestSpeed)),I.forEach((({userElement:e,registered:t})=>{const n=(e=>{const t=new Date(e);return O-t<=864e5})(t)?T:$;n.appendChild(e)}))),s.appendChild(r),s.appendChild(C),document.body.appendChild(s);const{scrollButtonsContainer:B}=de(C);function H(){const e=localStorage.getItem("lastClearTime"),t=localStorage.getItem("nextClearTime"),n=document.querySelector(".drop-time-expiration");if(e&&t&&n){const e=t-(new Date).getTime();e<=0?Tt(!0,$t):function(e,t){const n=String(Math.floor(t/36e5)).padStart(2,"0"),o=String(Math.floor(t%36e5/6e4)).padStart(2,"0"),s=String(Math.floor(t%6e4/1e3)).padStart(2,"0"),r=`${n}:${o}:${s}`,a=parseInt(s,10),i=5*Math.ceil(a/5),l=D[i]||D[0];e.textContent=`${r} ${l}`}(n,e)}}s.appendChild(B),lt(s,"show"),it("show");const D={0:"",5:"",10:"",15:"",20:"",25:"",30:"",35:"",40:"",45:"",50:"",55:""};setInterval(H,1e3),H()}function ft(){const e=document.querySelector(".cached-users-panel");e&&(lt(e,"hide"),it("hide"))}async function yt(e,t=!0){return new Promise((async(n,o)=>{let s=t&&JSON.parse(localStorage.getItem("fetchedUsers"))||{};const r=s[e];if(t&&function(e){return e&&"object"==typeof e&&["rank","login","registered","bestSpeed","ratingLevel","friends","cars","avatarTimestamp"].every((t=>void 0!==e?.[t]))}(r))n({rank:r.rank,login:r.login,registeredDate:r.registered,bestSpeed:r.bestSpeed,ratingLevel:r.ratingLevel,friends:r.friends,cars:r.cars,avatar:r.avatar,avatarTimestamp:r.avatarTimestamp});else try{const o=`https://klavogonki.ru/api/profile/get-summary?id=${e}`,r=`https://klavogonki.ru/api/profile/get-index-data?userId=${e}`,[i,l]=await Promise.all([fetch(o),fetch(r)]);if(!i.ok||!l.ok)throw new Error("Failed to fetch data from one of the APIs.");const c=await i.json(),d=await l.json();if(!(c?.user?.login&&c.title&&d?.stats?.registered))throw new Error("Invalid data format received from the API.");{const o=c.title,r=c.user.login,i=d.stats.registered.sec?(a=d.stats.registered.sec,new Date(1e3*a).toISOString().slice(0,19).replace("T"," ")):"Invalid Date",l=d.stats.best_speed||0,u=d.stats.rating_level||0,m=d.stats.friends_cnt||0,p=d.stats.cars_cnt||0,g=c.user?.avatar||null,h=c.user.avatar?.sec||0,f=function(e,t){return e.toString()+Math.floor(t/1e3).toString()}(h,c.user.avatar?.usec||0);t&&(s[e]={rank:o,login:r,registered:i,bestSpeed:l,ratingLevel:u,friends:m,cars:p,avatar:g,avatarTimestamp:f},localStorage.setItem("fetchedUsers",JSON.stringify(s))),n({rank:o,login:r,registeredDate:i,bestSpeed:l,ratingLevel:u,friends:m,cars:p,avatar:g,avatarTimestamp:f})}}catch(t){console.error(`Error fetching user profile data for ${e}:`,t),o(t)}var a}))}async function vt(e){const t=await fetch(e);if(!t.ok)throw new Error(`Failed to fetch ${e}`);return t.json()}function bt(e){const t={class:"unknown",icon:"",color:"#000000"},n={:{class:"extra",icon:"",color:"#06B4E9"},:{class:"cyber",icon:"",color:"#5681ff"},:{class:"superman",icon:"",color:"#B543F5"},:{class:"maniac",icon:"",color:"#DA0543"},:{class:"racer",icon:"",color:"#FF8C00"},:{class:"profi",icon:"",color:"#C1AA00"},:{class:"driver",icon:"",color:"#2DAB4F"},:{class:"amateur",icon:"",color:"#61B5B3"},:{class:"newbie",icon:"",color:"#AFAFAF"}}[e]||t;return n.class===t.class&&console.log(`Class not found for status title: ${e}. Using default class: ${t.class}`),n}!function(){const e=document.createElement("style");e.classList.add("userlist-dynamic-background");const t=getComputedStyle(document.querySelector(".chat .messages")).backgroundColor,n=`\n    #chat-general .smile-tab {\n      background-color: ${t};\n    }\n    .chat-user-list {\n      background-color: ${t};\n    }\n  `;e.innerHTML=n,document.head.appendChild(e)}();let xt=null;function wt(){let e;do{e=St[Math.floor(Math.random()*St.length)]}while(e===xt);return xt=e,e}const St=["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""];let kt=JSON.parse(localStorage.getItem("fetchedUsers"))||{};function Et(e,n,o,s,r){const a=kt[e]?.avatarTimestamp,i="00"!==a?`/storage/avatars/${e}_big.png?updated=${a}`:"",d=document.createElement("div"),u=bt(n),g=u.class,h=u.color,f=u.icon;d.classList.add(`user${e}`,g);const y=document.createElement("div");if(y.classList.add("avatar"),"00"!==a){const e=document.createElement("img");e.src=i,y.appendChild(e)}else y.style.fontSize="1.8rem",y.innerHTML=wt();const v=document.createElement("a");v.classList.add("name"),v.title="  ",v.dataset.user=e,v.textContent=o,v.style.setProperty("color",h,"important");const b=document.createElement("a");b.classList.add("profile");He(b,`${f} ${n} - ${s}`),b.target="_blank",b.href=`/profile/${e}/`;let k=function(e,t,n){const o="http://www.w3.org/2000/svg",s=20,r=10,a=Math.random().toString(36).substring(2,22),i=n||0!==e?1:.6,l=document.createElementNS(o,"svg");if(Object.entries({width:s,height:s,viewBox:"0 0 20 20",xmlns:o}).forEach((([e,t])=>l.setAttribute(e,t))),l.classList.add("circularProgress"),n||0===e){if(!n){const e=document.createElementNS(o,"circle");Object.entries({cx:r,cy:r,r:8,fill:"none",stroke:t,"stroke-width":2}).forEach((([t,n])=>e.setAttribute(t,n))),e.classList.add("outerCircle"),l.appendChild(e)}const e=s/24*i,a=r-12*e,c=document.createElementNS(o,"g");c.setAttribute("transform",`translate(${a}, ${a}) scale(${e})`),c.classList.add("closeIconGroup");const d=document.createElementNS(o,"path");Object.entries({d:"M18.364 5.636a1 1 0 0 1 0 1.414L13.414 12l4.95 4.95a1 1 0 0 1-1.414 1.414L12 13.414l-4.95 4.95a1 1 0 0 1-1.414-1.414L10.586 12l-4.95-4.95a1 1 0 0 1 1.414-1.414L12 10.586l4.95-4.95a1 1 0 0 1 1.414 0z",fill:t}).forEach((([e,t])=>d.setAttribute(e,t))),c.appendChild(d),l.appendChild(c)}else{const n=document.createElementNS(o,"defs");n.classList.add("defs");const s=document.createElementNS(o,"clipPath");s.setAttribute("id",`clipInner-${a}`),s.classList.add("clipPath");const i=document.createElementNS(o,"rect");Object.entries({x:2,y:2,width:16,height:0,transform:"rotate(180, 10, 10)"}).forEach((([e,t])=>i.setAttribute(e,t))),i.classList.add("clipRect");const c=document.createElementNS(o,"animate");Object.entries({attributeName:"height",from:0,to:e/100*16,begin:"indefinite",dur:"1s",fill:"freeze",calcMode:"spline",keySplines:"0.4 0 0.2 1",keyTimes:"0;1"}).forEach((([e,t])=>c.setAttribute(e,t))),c.classList.add("animateProfileProgress"),i.appendChild(c),s.appendChild(i),n.appendChild(s),l.appendChild(n);const d=document.createElementNS(o,"circle");Object.entries({cx:r,cy:r,r:8,fill:"none",stroke:t,"stroke-width":2}).forEach((([e,t])=>d.setAttribute(e,t))),d.classList.add("outerCircle"),l.appendChild(d);const u=document.createElementNS(o,"circle");Object.entries({cx:r,cy:r,r:8,fill:t,"clip-path":`url(#clipInner-${a})`}).forEach((([e,t])=>u.setAttribute(e,t))),u.classList.add("innerCircle"),l.appendChild(u)}return l.outerHTML}(function(e){const t=100*Math.floor(e/100);return(e-t)/(t+100-t)*100}(s),h,r);b.innerHTML=k,setTimeout((()=>{const e=b.querySelector(".animateProfileProgress");e&&e.beginElement()}),10),b.addEventListener("click",(function(t){t.preventDefault(),ae?window.open(l+e,"_blank"):gt(l+e)}));const E=`${l}${t}/messages/${e}/`;v.addEventListener("click",(function(t){if(t.ctrlKey&&t.shiftKey){const e=window.open(E,"_blank");e&&e.focus()}else t.ctrlKey?gt(E):function(e){const t=`<${document.querySelector(`.name[data-user="${e}"]`).textContent}>`,n=document.querySelector(".messages .text");n.value=t,n.focus(),n.selectionEnd=n.value.length}(e)})),d.appendChild(y),d.appendChild(v),d.appendChild(b);if(c.find((e=>e.name===o&&"thawed"===e.state))){const e=document.createElement("div");e.title="Tracked user",e.classList.add("tracked"),e.innerHTML=w,d.appendChild(e)}if(p.includes(o)){const e=document.createElement("div");e.title="Ignored user",e.classList.add("ignored"),e.innerHTML=S,d.appendChild(e)}const C=document.querySelector(`.userlist-content ins.user${e} img[src*="moderator"]`),L=m.includes(o);if(C||L){const e=document.createElement("div");e.classList.add("moderator"),e.innerHTML=x,d.appendChild(e)}return d}async function Ct(e,t){try{const n=document.querySelector(".userlist-content");let o=document.querySelector(".chat-user-list");if(!o){o=document.createElement("div"),o.classList.add("chat-user-list");const e=document.querySelector(".userlist");e&&e.appendChild(o)}const s={};["extra","cyber","superman","maniac","racer","profi","driver","amateur","newbie"].forEach((e=>{const t=o.querySelector(`.rank-group-${e}`);t?s[e]=t:(s[e]=document.createElement("div"),s[e].classList.add(`rank-group-${e}`),o.appendChild(s[e]))}));const r=new Set;for(const o of n.querySelectorAll("ins")){const n=o.querySelector(".name"),a=n.getAttribute("data-user"),i=n.textContent;if(!r.has(a))try{const{rank:n,login:l,registeredDate:d,bestSpeed:u,ratingLevel:m,friends:p,cars:g,avatarTimestamp:h}=await yt(a);kt[a]?(kt[a].rank=n,kt[a].login=l,kt[a].registered=d,kt[a].bestSpeed=u,kt[a].ratingLevel=m,kt[a].friends=p,kt[a].cars=g,kt[a].avatarTimestamp=h):kt[a]={rank:n,login:l,registered:d,bestSpeed:u,ratingLevel:m,friends:p,cars:g,avatarTimestamp:h},e===i&&"enter"===t&&(kt[a].visits=(kt[a].visits||0)+1,kt[a].tracked=c.some((t=>t.name===e)));const{class:f}=bt(n);if(!s[f].querySelector(`.user${a}`)){const e=Et(a,n,i,u,o.classList.contains("revoked"));s[f].appendChild(e),It||vn(e)}r.add(a)}catch(e){console.error(`Error fetching profile summary for user ${a}:`,e)}}o.querySelectorAll('.chat-user-list [class^="user"]').forEach((e=>{const t=e.querySelector(".name").getAttribute("data-user");r.has(t)||e.remove()})),Object.values(s).forEach((e=>[...e.children].sort(((e,t)=>(kt[t.querySelector(".name")?.getAttribute("data-user")]?.bestSpeed||0)-(kt[e.querySelector(".name")?.getAttribute("data-user")]?.bestSpeed||0))).forEach((t=>e.appendChild(t))))),localStorage.setItem("fetchedUsers",JSON.stringify(kt)),function(){const e=document.querySelector(".cache-panel-load-button .cache-user-count");if(!e)return;const t=Object.keys(JSON.parse(localStorage.getItem("fetchedUsers"))||{}).length.toString();t!==e.textContent&&(e.textContent=t,fn(e))}()}catch(e){console.error("Error refreshing user list:",e)}}let Lt=localStorage.getItem("cacheRefreshThresholdHours");Lt||(Lt=24,localStorage.setItem("cacheRefreshThresholdHours",Lt));let $t=function(e){const[t,n=0,o=0]=e.split(":").map(Number);return t+n/60+o/3600}(Lt);function Tt(e=!1,t=24){const n=localStorage.getItem("lastClearTime"),o=n?((new Date).getTime()-n)/36e5:1/0;if(e||o>=t){localStorage.removeItem("fetchedUsers"),kt={};const e=(new Date).getTime()+60*t*60*1e3;localStorage.setItem("lastClearTime",(new Date).getTime().toString()),localStorage.setItem("nextClearTime",e.toString())}}const Mt=document.querySelector(".userlist-content");let Nt=new Map,qt=0,It=!0,At=!1;const Ot=300,jt=(e,t)=>{let n;return(...o)=>{clearTimeout(n),n=setTimeout((()=>e.apply(this,o)),t)}};function Bt(e,t){if(!e)return;const n=t.toString().length;e.textContent=t,e.style.fontSize=Math.max(24-2*(n-1),12)+"px"}const Ht=new MutationObserver(jt((e=>{e.forEach((e=>{if("childList"===e.type){const t=document.querySelector("#voice, #beep, #silence"),n=t&&"silence"===t.id,o=document.querySelector("#chat-wrapper.chat-hidden"),s=document.querySelector(".chat-user-count");if(o)return s.style.filter="grayscale(100%)",void(s.textContent="0");const r=new Map(Array.from(Mt.children).map((e=>{const t=e.querySelector(".name"),n=t?.getAttribute("data-user"),o=t?.textContent?.trim();return n?[n,{userName:o}]:null})).filter(Boolean));if(It)return s&&0===Number(s.textContent)&&!At&&function(e,t){let n=0;const o=()=>{if(n<=e){const s=Math.min(n/(e||1),1);Bt(t,n++),t.style.filter=`grayscale(${100-100*s}%)`,setTimeout(o,20)}else fn(t),At=!0};setTimeout(o,20)}(r.size,s),r.forEach(((e,t)=>Nt.set(t,e))),void setTimeout((()=>{It=!1}),2e3);let i=[...r].filter((([e])=>!Nt.has(e))).map((([e,t])=>({userId:e,...t}))),l=[...Nt].filter((([e])=>!r.has(e))).map((([e,t])=>({userId:e,userName:t.userName})));Nt=new Map(r);const d=Nt.size;function u(e,t){const{userName:o,userId:s}=e,r=function(e){const t=c.find((t=>t.name===e));return t?t.gender:null}(o),i=c.some((e=>e.name===o&&"thawed"===e.state));Fe(o,"enter"===t?v:b,"enter"===t),Ct(o,t),function(e,t){e&&t?(kt[e]=kt[e]||{},kt[e].actionLog=kt[e].actionLog||[],kt[e].actionLog.push({type:t,timestamp:$e()})):console.error("Missing userId or actionType")}(s,t),!n&&i&&function(e,t,n){if(!Le("sound","presence"))return;const o=n||"Male",s=c.find((t=>t.name===e)),r="enter"===t?xe[o].enter:xe[o].leave;ye("enter"===t?me:pe,.2),setTimeout((()=>be(`${s.pronunciation} ${r}`,a)),300)}(o,t,r)}d!==qt&&At&&(Bt(s,d),s.style.filter=d>0?"none":"grayscale(100%)",fn(s)),i.forEach((e=>u(e,"enter"))),l.forEach((e=>u(e,"leave"))),qt=d}}))}),Ot));Ht.observe(Mt,{childList:!0});document.querySelector(".mostright").addEventListener("click",(()=>{setTimeout((()=>{document.querySelector("#chat-wrapper.chat-hidden")?an=!1:(Qn(),vo(),an=!1,setTimeout((()=>an=!1),3e3))}),300)})),function(){const e=document.querySelector("#chat-fixed-placeholder");if("shouldShowPopupMessage"in localStorage){const t=JSON.parse(localStorage.getItem("shouldShowPopupMessage"));e.style.display=t?"none":"unset"}else e.style.display="none"}(),"shouldShowPopupMessage"in localStorage||localStorage.setItem("shouldShowPopupMessage",!1),document.addEventListener("keydown",(e=>{if(e.ctrlKey&&"Space"===e.code){const e=document.querySelector("#chat-fixed-placeholder"),t=e.hasAttribute("style"),n="unset"===e.style.display,o=document.querySelector(".popup-messages-container");if(t)if(n)e.style.display="none",localStorage.setItem("shouldShowPopupMessage",!0);else{e.style.display="unset",localStorage.setItem("shouldShowPopupMessage",!1);const{inputField:t}=Un();t?t.focus():console.error("Input field not found. Cannot set focus.")}else e.style.display="none",localStorage.setItem("shouldShowPopupMessage",!0);o&&t&&n&&o.remove()}}));let Pt=null,Dt=!1;function Ft(e){if(null===e)return e;const t=[...c.map((e=>e.name)),...u.map((e=>e.original))],n=new RegExp(`(${t.join("|")})`,"gu");return e.replace(n,(e=>{const t=u.find((t=>t.original===e));if(t)return t.replacement;const n=c.find((t=>t.name===e));return n?.pronunciation||e}))}function zt(e="generalMessages"){const t={generalMessages:{container:".messages-content div",messageElement:"p",exclude:[".time",".username"]},chatlogsMessages:{container:".chat-logs-container",messageElement:".message-text"},personalMessages:{container:".messages-container",messageElement:".message-text"}}[e];if(!t)return void console.error("Invalid container type");const n=document.querySelectorAll(t.container),o=new WeakSet;n.forEach((n=>{n.querySelectorAll(t.messageElement).forEach((n=>{[...n.querySelectorAll(".private"),...n.querySelectorAll(".system-message"),n].forEach((n=>{const s=document.createTreeWalker(n,NodeFilter.SHOW_TEXT,{acceptNode:n=>{if(o.has(n))return NodeFilter.FILTER_SKIP;const s=n.parentElement;return s.closest(".mention, .time, .username")||"generalMessages"===e&&s.closest(t.exclude.join(","))?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT}},!1),r=[];let a;for(;a=s.nextNode();)r.push(a);r.forEach((e=>{o.has(e)||(!function(e){const t=/[\s]+|[^\s\w--]+|[\w--]+/g,n=e.textContent.match(t);if(!n)return;const o=document.createDocumentFragment();n.forEach((e=>{if(d.map((e=>e.toLowerCase())).includes(e.toLowerCase())){const t=document.createElement("span");t.className="mention",t.textContent=e,o.appendChild(t)}else o.appendChild(document.createTextNode(e))})),e.parentNode.replaceChild(o,e)}(e),o.add(e))}))}))}))}))}function Jt(e){const[t,n,o]=e.match(/\d+/g).map(Number),{h:s,s:r,l:a}=((e,t,n)=>{e/=255,t/=255,n/=255;const o=Math.max(e,t,n),s=Math.min(e,t,n);let r,a,i=(o+s)/2;if(o===s)r=a=0;else{const l=o-s;a=i<.5?l/(o+s):l/(2-o-s),r=(o===e?(t-n)/l+(t<n?6:0):o===t?(n-e)/l+2:(e-t)/l+4)/6}return r=Math.round(360*r),a=Math.min(Math.round(100*a),90),i=Math.round(100*i),r>215&&r<280&&(r=r<255?215:280),{h:r,s:a,l:i}})(t,n,o),i=((e,t,n)=>{let o,s,r;if(n/=100,0==(t/=100))o=s=r=255*n;else{const a=n<.5?n*(1+t):n+t-n*t,i=2*n-a,l=(e,t,n)=>(n<0&&(n+=1),n>1&&(n-=1),n<1/6?e+6*(t-e)*n:n<.5?t:n<2/3?e+(t-e)*(2/3-n)*6:e);o=Math.round(255*l(i,a,e/360+1/3)),s=Math.round(255*l(i,a,e/360)),r=Math.round(255*l(i,a,e/360-1/3))}return`rgb(${o}, ${s}, ${r})`})(s,r,a<50?50:a);return i}async function Ut(){const e=document.querySelector(".messages-content div p:last-of-type");if(!e)return null;const t=async e=>Array.from(e.childNodes).map((e=>e.nodeType===Node.TEXT_NODE&&e.textContent.trim()?e.textContent.trim():"IMG"===e.nodeName&&e.getAttribute("title")?e.getAttribute("title"):"A"===e.nodeName&&e.getAttribute("href")?e.getAttribute("href"):"")).filter(Boolean);let n=(await t(e)).join(" ").trim(),o="common";const s=e.querySelector(".room.private");if(s&&s.textContent.includes("[ ")){const s=e.querySelector("span.private");s&&(n=(await t(s)).join(" ").trim(),o="private")}const r=e.querySelector(".system-message");if(r){let e=(await t(r)).join(" ").trim();e=e.replace(/<>\s*/g,""),n=e,o="system"}"common"===o&&function(e){const t=e.toLowerCase();return d.some((e=>t.includes(e.toLowerCase())))}(n)&&(o="mention");const a=JSON.parse(localStorage.getItem("personalMessages"))||{},i=e.querySelector(".time")?.textContent||"N/A",l=e.querySelector(".username span[data-user]"),c=l?l.getAttribute("data-user"):null,u=l?l.textContent:"SYSTEM",m=Jt(l?l.parentElement.style.color:"rgb(180,180,180)"),g=`${i}_${u}`;("mention"===o||"private"===o)&&!p.includes(u)&&(a[g]={time:i,date:(new Date).toLocaleDateString("en-CA"),username:u,usernameColor:m,message:n,type:o,userId:c},localStorage.setItem("personalMessages",JSON.stringify(a)));const h=e.querySelector(".username"),f=h?h.textContent.replace(/[<>]/g,""):"SYSTEM";zt();let y="mention"===o||"private"===o?`${Ft(f)} : `:f!==Pt?`${Ft(f)} : `:"";Pt=f;return{messageText:y+Ft(n),usernameText:f}}let Rt=!1;const _t=new Set;function Kt(e){_t.has(e)||(_t.add(e),Rt||(Rt=!0,async function(){for(let e of _t)await be(e,a),_t.delete(e);Rt=!1}()))}let Xt=!0;const Vt=600;function Gt(e="generalMessages"){const t={generalMessages:".messages-content",chatlogsMessages:".chat-logs-container",personalMessages:".messages-container-wrapper"}[e];if(!t)return;const n=document.querySelector(t);if(n)if(Xt)n.scrollTop=n.scrollHeight,Xt=!1;else{n.scrollHeight-n.scrollTop-n.clientHeight<=Vt&&(n.scrollTop=n.scrollHeight)}}async function Yt(e,t){const{top:n,height:o}=t.getBoundingClientRect(),{top:s,height:r}=e.getBoundingClientRect(),a=n-(s+r/2)+o/2;e.scrollBy({top:a,behavior:"smooth"}),await new Promise((e=>setTimeout(e,500))),e.style.scrollBehavior="auto",vn(t)}function Wt(){const e=document.getElementById("chat-content").querySelectorAll(".messages-content div p");let t=null,n=!0,o="14px";for(let s=0;s<e.length;s++){const r=e[s],a=r.querySelector("span.username");if(r.querySelector(".system-message"))r.style.marginTop=o,r.style.marginBottom=o;else if(a){const i=a.querySelector("span[data-user]");if(!i)continue;let l=i.textContent;l=l.replace(/</g,"").replace(/>/g,""),null===t||l!==t?n||(r.style.marginTop=o):n||r.style.removeProperty("margin-bottom");if(s<e.length-1){const t=e[s+1].querySelector("span.username");if(t){const e=t.querySelector("span[data-user]");if(!e)continue;l!==e.textContent&&(r.style.marginBottom=o)}}t=l,n=!1}}}Wt();let Zt={};function Qt(e){document.querySelectorAll(`.messages-content span[data-user="${e}"]`).forEach((e=>{const t=e.closest("p");t&&t.remove()}))}let en=null;function tn(e,t){Zt[e].thresholdMaxTries>=10&&(Zt[e].banned=!0,console.log(t(),"color: pink"),console.log(`%c${Zt[e].userName} cannot send messages anymore`,"color: pink"))}function nn(){const e=(new Date).getTime(),t=document.querySelector(".messages-content p:last-child");if(t){const n=t.querySelector("span[data-user]"),o=n?n.getAttribute("data-user"):null;Zt[o]||(Zt[o]={messagesCount:0,thresholdMaxTries:0,time:e,userName:n?n.textContent:"Unknown User",previousTime:null,firstInteraction:!0,banned:!1});const s=e-Zt[o].time;function r(){return`%cID: ${o}, Name: ${Zt[o].userName}, Time Difference: ${function(e){const t=["hour","minute","second","millisecond"];return[Math.floor(e/36e5),Math.floor(e/6e4%60),Math.floor(e/1e3%60),e%1e3].map(((e,n)=>e>0?`${e} ${t[n]}${e>1?"s":""}`:"")).filter(Boolean).join(" ")}(s)}, Messages Count: ${Zt[o].messagesCount}, Spam Tries: ${Zt[o].thresholdMaxTries}, Banned: ${Zt[o].banned}`}(function(e){const t=new RegExp("[0-9a-zA-Z--\\s!@#$%^&*()-_=+[\\]{}|;:'\",.<>/?`~\\u00A9\\u2122\\u00AE\\u00AB\\u00BB\\u00B1\\u00D7\\u00F7\\u00B0\\u2260\\u2264\\u2265\\u221E\\u20AC\\u00A3\\u00A5\\u00A7\\u2022\\u2026\\u2212\\u2013\\u2014\\u2190\\u2192\\u2191\\u2193\\u00BD\\u2153\\u2154\\u2211\\u00B4\\uD83C-\\uDBFF\\uDC00-\\uDFFF]+","gu"),n=e.match(t);return!(!n||n.join("")!==e)||(en=e.replace(t,""),!1)})(t.textContent)||Zt[o].banned||(Zt[o].thresholdMaxTries++,console.log(`%c${Zt[o].userName} has sent a message with not allowed characters ${en}.\n          Threshold: ${Zt[o].thresholdMaxTries}.`,"color: orange;"),tn(o,r)),Zt[o].firstInteraction?(console.log(`%c${Zt[o].userName} posted the first message for the current chat session.`,"color: yellow"),Zt[o].firstInteraction=!1):Zt[o].banned?Qt(o):s<400?(Zt[o].messagesCount++,Zt[o].messagesCount>1?(Qt(o),Zt[o].thresholdMaxTries++,tn(o,r),Zt[o].banned||console.log(r(),"color: red")):console.log(r(),"color: green")):(Zt[o].previousTime=Zt[o].time,Zt[o].time=e,Zt[o].messagesCount=1,console.log(r(),"color: green"))}}const on={};function sn(){if("true"!==localStorage.getItem("shouldShowPopupMessage"))return;const e=document.querySelector(".messages-content p:last-of-type");if(e){const t=e.querySelector(".time"),n=e.querySelector(".username"),o=Array.from(e.childNodes).map((e=>{if(e.nodeType===Node.TEXT_NODE)return{type:"text",value:e.nodeValue.replace(/ /g,"")};if(e.nodeType===Node.ELEMENT_NODE){if("a"===e.tagName.toLowerCase()&&e.classList.contains("private"))return{type:"text",value:""};if("span"===e.tagName.toLowerCase()&&e.classList.contains("private"))return{type:"text",value:e.textContent.replace(/ /g,"")};if("img"===e.tagName.toLowerCase())return{type:"img",title:e.getAttribute("title")};if("a"===e.tagName.toLowerCase())return{type:"anchor",href:e.getAttribute("href")}}})).filter(Boolean),s=t.textContent.replace(/[\[\]]/g,""),r=n.textContent.replace(/[<>]/g,"");let a=on[r];a||(a=15*Math.floor(24*Math.random()),on[r]=a);let i=document.querySelector(".popup-messages-container");if(i||(i=document.createElement("div"),i.classList.add("popup-messages-container"),document.body.appendChild(i)),i.childElementCount>=10){const e=i.firstChild;e.classList.add("fade-out"),setTimeout((()=>{i.removeChild(e)}),300)}const l=document.createElement("div");l.classList.add("popup-chat-message"),l.style.filter=`hue-rotate(${a}deg)`;const c=document.createElement("div");c.classList.add("time-icon"),c.innerHTML=k;const d=document.createElement("div");d.classList.add("time"),d.textContent=s;const u=document.createElement("div");u.classList.add("user-icon"),u.innerHTML=C;const m=document.createElement("div");m.classList.add("username"),m.textContent=r;const p=document.createElement("div");p.classList.add("action-icon"),p.innerHTML=E;const g=document.createElement("div");g.classList.add("message"),l.appendChild(c),l.appendChild(d),l.appendChild(u),l.appendChild(m),l.appendChild(p),l.appendChild(g),o.forEach((e=>{const t=document.createElement("div");"text"===e.type?t.textContent=e.value:"img"===e.type?t.innerHTML=`&nbsp;${e.title}&nbsp;`:"anchor"===e.type&&(t.innerHTML=`&nbsp;${e.href}&nbsp;`),g.appendChild(t)})),i.appendChild(l)}}function rn(e){return function(e){const t={:"A",:"B",:"V",:"G",:"D",:"E",:"Yo",:"Zh",:"Z",:"I",:"Y",:"K",:"L",:"M",:"N",:"O",:"P",:"R",:"S",:"T",:"U",:"F",:"Kh",:"Ts",:"Ch",:"Sh",:"Shch",:"y",:"Y",:"i",:"E",:"Yu",:"Ya",:"a",:"b",:"v",:"g",:"d",:"e",:"yo",:"zh",:"z",:"i",:"y",:"k",:"l",:"m",:"n",:"o",:"p",:"r",:"s",:"t",:"u",:"f",:"kh",:"ts",:"ch",:"sh",:"shch",:"y",:"y",:"i",:"e",:"yu",:"ya"};return e.split("").map((e=>t[e]||e)).join("")}(e)}let an=!1;function ln(e){return!!e&&["","",""].every((t=>e.includes(t)))}function cn(e,t){if(e)if("one"===t){const t=e.querySelector("span[data-user]");if(!t)return;const n=Jt(getComputedStyle(e).color);e.style.setProperty("color",n,"important"),t.style.setProperty("filter","invert(0)","important")}else"all"===t?Array.from(e).forEach((e=>{if(!e)return;const t=e.querySelector("span[data-user]");if(!t)return;const n=Jt(getComputedStyle(e).color);e.style.setProperty("color",n,"important"),t.style.setProperty("filter","invert(0)","important")})):console.error("Invalid mode. Use 'one' or 'all'.")}const dn=new MutationObserver((async t=>{if(an){for(let n of t)if("childList"===n.type)for(let t of n.addedNodes)if(t.nodeType===Node.ELEMENT_NODE&&"P"===t.tagName){const n=t.querySelector(".username");n&&cn(n,"one");const o=localStorage.getItem("previousMessageText"),s=await Ut(),r=s?.messageText||null,a=s?.usernameText||null;console.log(r);const i=rn(a);if(ln(r)&&(console.log("Ban message detected:",r),new Audio("https://github.com/VimiummuimiV/Sounds/raw/refs/heads/main/Mario_Game_Over.mp3").play()),a&&p.includes(a)){t.classList.add("ignored-user",i),t.style.display="none";continue}const l=document.querySelector("#voice, #beep, #silence"),c=l&&"voice"===l.id,d=l&&"beep"===l.id,u=document.querySelector("#every-message, #mention-message"),m=u&&"every-message"===u.id,g=u&&"mention-message"===u.id,h="[ ]",f=t.querySelector(".room.private"),y=f&&f.textContent.includes(h);if(c&&an&&r&&r!==o&&(localStorage.setItem("previousMessageText",r),a&&!a.includes(e))){(m||g&&Dt||y)&&Kt(r)}if(d&&an&&r&&r!==o&&(localStorage.setItem("previousMessageText",r),a&&!a.includes(e))){if(m||g&&Dt||y){ye(!m||Dt?he:ge,.2),Dt&&(Dt=!1)}}an&&(ro(),We("generalMessages"),nt("generalMessages"),rt("generalMessages"),Wt(),Gt(),nn(),sn(),qn())}}else{an=!0;cn(document.querySelectorAll(".username"),"all")}})),un=document.querySelector(".messages-content div");let mn,pn,gn,hn;function fn(e){e.classList.add("pulse-effect"),setTimeout((()=>{e.classList.remove("pulse-effect")}),500)}function yn(e,t=0,n=0){const o=[{transform:`translate(${t}%, calc(${n}%)) scale(1)`},{transform:`translate(${t}%, calc(${n}% - 60%)) scale(1.1)`},{transform:`translate(${t}%, calc(${n}% + 15%)) scale(1)`},{transform:`translate(${t}%, calc(${n}% - 20%)) scale(1.05)`},{transform:`translate(${t}%, calc(${n}% + 8%)) scale(1)`},{transform:`translate(${t}%, calc(${n}% - 10%)) scale(1.05)`},{transform:`translate(${t}%, calc(${n}% + 4%)) scale(1)`},{transform:`translate(${t}%, calc(${n}%)) scale(1)`}];return e.animate(o,{duration:500,easing:"ease",iterations:1}).finished}function vn(e){e.classList.add("shake-effect"),setTimeout((()=>{e.classList.remove("shake-effect")}),500)}function bn(){switch(mn.id){case"silence":pn.innerHTML=L;break;case"beep":pn.innerHTML=$;break;case"voice":pn.innerHTML=T}}function xn(){return{speed:`${(a-0)/2.5*100}%`,pitch:`${(i-0)/2*100}%`}}dn.observe(un,{childList:!0,subtree:!0}),function(){mn=document.createElement("div");const e=r.messageSettings.messageNotificationState||"silence";mn.classList.add("empowerment-button","sound-switcher-button"),mn.id=e;const t=r.messageSettings.messageNotificationTitle||"Do not disturb";mn.title=t,pn=document.createElement("span"),pn.classList.add("sound-switcher-icon"),mn.appendChild(pn),Se.appendChild(mn)}(),mn.addEventListener("click",(function(e){if(!ae&&!ie){let e=document.querySelector(".current-voice-speed"),t=document.querySelector(".current-voice-pitch");switch(e&&e.remove(),t&&t.remove(),fn(this),this.id){case"silence":this.id="beep",this.title="Notify with beep signal",r.messageSettings.messageNotificationState="beep",r.messageSettings.messageNotificationTitle="Notify with beep signal";break;case"beep":this.id="voice",this.title="Notify with voice API",r.messageSettings.messageNotificationState="voice",r.messageSettings.messageNotificationTitle="Notify with voice API";break;case"voice":this.id="silence",this.title="Do not disturb",r.messageSettings.messageNotificationState="silence",r.messageSettings.messageNotificationTitle="Do not disturb"}localStorage.setItem("KG_Chat_Empowerment",JSON.stringify(r)),bn()}})),bn();let wn=null,Sn=null;function kn(e,t){const n=parseFloat(r.voiceSettings[e]),[o,l]="voiceSpeed"===e?[0,s]:[0,2],c=n+t,d=Math.min(l,Math.max(o,c));return n!==d&&(function(e,t){const n=parseFloat(t.toFixed(1));r.voiceSettings[e]=n,"voiceSpeed"===e?a=n:"voicePitch"===e&&(i=n);localStorage.setItem("KG_Chat_Empowerment",JSON.stringify(r)),function(){let e=document.querySelector(".voice-settings"),t=document.querySelector(".current-voice-speed"),n=document.querySelector(".current-voice-pitch");if(ae){e||(e=document.createElement("div"),e.classList.add("voice-settings"),mn.appendChild(e),e.offsetWidth,e.style.opacity="1"),n&&n.remove(),t||(t=document.createElement("span"),t.classList.add("current-voice-speed"),e.appendChild(t));let o=e.querySelector(".current-voice-speed .voice-value-info");o||(o=document.createElement("span"),o.classList.add("voice-speed","voice-value-info"),e.querySelector(".current-voice-speed").appendChild(o)),o&&(o.innerHTML=a<=0||a>=s?q:`SPEED ${Number(a).toFixed(1)}`);let r=e.querySelector(".current-voice-speed .voice-speed-progress");if(!r){r=document.createElement("span"),r.classList.add("voice-speed-progress");let t=document.createElement("span");t.classList.add("voice-speed-progress-fill"),r.appendChild(t),e.querySelector(".current-voice-speed").appendChild(r)}r.querySelector(".voice-speed-progress-fill").style.width=xn().speed,e.timeoutId&&clearTimeout(e.timeoutId),e.timeoutId=setTimeout((()=>{e.style.opacity="0",setTimeout((()=>{e.remove()}),500)}),2e3)}else if(ie){e||(e=document.createElement("div"),e.classList.add("voice-settings"),mn.appendChild(e),e.offsetWidth,e.style.opacity="1"),t&&t.remove(),n||(n=document.createElement("span"),n.classList.add("current-voice-pitch"),e.appendChild(n));let o=e.querySelector(".current-voice-pitch .voice-value-info");o||(o=document.createElement("span"),o.classList.add("voice-pitch","voice-value-info"),e.querySelector(".current-voice-pitch").appendChild(o)),o&&(o.innerHTML=i<=0||i>=2?q:`PITCH ${i.toFixed(1)}`);let s=e.querySelector(".current-voice-pitch .voice-pitch-progress");if(!s){s=document.createElement("span"),s.classList.add("voice-pitch-progress");let t=document.createElement("span");t.classList.add("voice-pitch-progress-fill"),s.appendChild(t),e.querySelector(".current-voice-pitch").appendChild(s)}s.querySelector(".voice-pitch-progress-fill").style.width=xn().pitch,e.timeoutId&&clearTimeout(e.timeoutId),e.timeoutId=setTimeout((()=>{e.style.opacity="0",setTimeout((()=>{e.remove()}),500)}),2e3)}else e&&e.remove()}()}(e,d),t>0?d<l:d>o)}function En(){switch(gn.id){case"every-message":hn.innerHTML=M;break;case"mention-message":hn.innerHTML=N}}async function Cn(e,t,n){const o=document.querySelector(".messages-content");if(!o)return null;const s=e=>e.replace(/[\[\]]/g,"").split(":").reduce(((e,t,n)=>e+Number(t)*60**(2-n)),0),r=s(e),a=e=>Array.from(o.querySelectorAll("p")).find((n=>{const o=n.querySelector(".time"),r=n.querySelector(".username span[data-user]");if(o&&r){const n=s(o.textContent.trim()),a=r.textContent.trim();return e(n)&&a===t}return!1}));let i=a((e=>e===r));return i||(i=a((e=>Math.abs(e-r)<=2))),i&&n&&await Yt(o,i),i||!1}function Ln(e){const t=180- -(new Date).getTimezoneOffset(),[n,o,s]=e.split(":").map(Number);let r=60*n+o+t;r=(r%1440+1440)%1440;const a=r%60;return`${Math.floor(r/60).toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`}function $n(e,t="single"){const n=e.querySelector(".message-time").textContent,o=e.querySelector(".message-username").textContent;let s=JSON.parse(localStorage.getItem("personalMessagesBackup"))||{};if(0===Object.keys(s).length){s={...JSON.parse(localStorage.getItem("personalMessages"))||{}},localStorage.setItem("personalMessagesBackup",JSON.stringify(s))}let r={...s};if("all"===t)document.querySelectorAll(".message-item").forEach((e=>{const t=e.querySelector(".message-username").textContent;if(t===o){e.remove();const n=e.querySelector(".message-time").textContent;delete r[`[${n}]_${t}`]}}));else if("from"===t){const t=Array.from(document.querySelectorAll(".message-item"));for(let n=t.indexOf(e);n<t.length;n++){const e=t[n],s=e.querySelector(".message-username").textContent;if(s===o){e.remove();const t=e.querySelector(".message-time").textContent;delete r[`[${t}]_${s}`]}}}else{const t=`[${n}]_${o}`;r[t]&&(delete r[t],e.remove())}localStorage.setItem("personalMessagesBackup",JSON.stringify(r));const a=document.querySelector(".personal-messages-button .total-message-count");a&&(a.textContent=Object.keys(r).length)}function Tn(){const e=Object.keys(JSON.parse(localStorage.getItem("personalMessages")||"{}")).length;document.querySelector(".personal-messages-button .total-message-count").textContent=e}async function Mn(){const e=document.querySelector(".cached-messages-panel");if(e)return e.remove(),void it("hide");let t=!0,o=!1;Tn(),localStorage.getItem("personalMessagesBackup")&&localStorage.removeItem("personalMessagesBackup"),dt();const s=document.querySelector(".personal-messages-button .new-message-count");function r(){const e=localStorage.getItem("personalMessages");return JSON.parse(e)||{}}s&&(s.textContent="0"),s.style.visibility="hidden",localStorage.removeItem("newMessagesCount");let a=r();const i=document.createElement("div");i.className="cached-messages-panel popup-panel";const l=document.createElement("div");l.className="panel-header";const c=document.createElement("div");c.className="search-for-personal-messages";const d=document.createElement("input");d.className="personal-messages-search-input",d.type="search",c.appendChild(d);const u=document.createElement("div");u.className="panel-control-buttons";const m=document.createElement("div");m.className="large-button panel-header-save-button",m.innerHTML=te,m.title="Save messages",m.style.opacity="0",m.addEventListener("click",(()=>{const e=localStorage.getItem("personalMessagesBackup"),n=localStorage.getItem("personalMessages"),o=e&&n;if(o&&o&&n!==e&&!t){window.confirm("Do you want to apply changes?")&&(localStorage.setItem("personalMessages",e),localStorage.removeItem("personalMessagesBackup"),m.style.setProperty("display","none","important"),m.style.opacity="0",m.addEventListener("transitionend",(function(){m.style.display="none"})))}}));const p=document.createElement("div");p.className="large-button panel-header-import-button",p.innerHTML=Q,p.title="Import messages",p.addEventListener("click",(()=>{o=!0;const e=document.createElement("input");e.type="file",e.accept=".json",e.addEventListener("change",(e=>{const t=e.target.files[0];if(t){const e=new FileReader;e.onload=async()=>{try{const t=JSON.parse(e.result),n={...JSON.parse(localStorage.getItem("personalMessages")||"{}"),...t},o=Object.fromEntries(Object.entries(n).sort((([,e],[,t])=>{const n=e.time.replace(/[[\]]/g,""),o=t.time.replace(/[[\]]/g,""),s=`${e.date} ${n}`,r=`${t.date} ${o}`;return new Date(s)-new Date(r)})));localStorage.setItem("personalMessages",JSON.stringify(o)),Tn();const s=r();await $(s)}catch(e){alert("Failed to import messages. The file may be corrupted.")}},e.readAsText(t)}})),e.click()}));const g=document.createElement("div");g.className="large-button panel-header-export-button",g.innerHTML=ee,g.title="Export messages",g.addEventListener("click",(()=>{const e=localStorage.getItem("personalMessages");if(e&&"{}"!==e){const t=new Intl.DateTimeFormat("en-CA").format(new Date),n=JSON.parse(e),o=JSON.stringify(n,null,2),s=new Blob([o],{type:"application/json"}),r=document.createElement("a");r.href=URL.createObjectURL(s),r.download=`Personal_Messages_${t}.json`,r.click()}else alert("No messages to export.")}));const h=document.createElement("div");h.className="large-button panel-header-copy-button",h.innerHTML=X,h.title="Copy Personal Messages",h.addEventListener("click",(()=>{yn(h,0,0);const e=Array.from(document.querySelector(".messages-container").children).filter((e=>{const t=window.getComputedStyle(e);return"hidden"!==t.contentVisibility&&"none"!==t.display})).map((e=>e.classList.contains("date-item")?e.textContent.trim():[e.querySelector(".message-time"),e.querySelector(".message-username"),e.querySelector(".message-text")].map((e=>e?.textContent.trim())).filter(Boolean).join(" "))).filter(Boolean).join(" \n");e.trim()?navigator.clipboard.writeText(e).then((()=>yn(h,0,0))).catch(console.error):alert("No messages to copy.")}));const f=document.createElement("div");f.className="large-button panel-header-clear-button",f.title="Clear personal messages",f.innerHTML=W,f.addEventListener("click",(()=>{o=!0;const e=JSON.parse(localStorage.getItem("personalMessages")||"{}");if(0===Object.keys(e).length)return void alert("No messages to delete.");v.innerHTML=null,localStorage.setItem("personalMessages",JSON.stringify({})),lt(i,"hide"),it("hide");const t=document.querySelector(".personal-messages-button .total-message-count");t&&(t.textContent="0")}));const y=document.createElement("div");y.className="large-button panel-header-close-button",y.title="Close panel",y.innerHTML=P,y.addEventListener("click",(()=>{lt(i,"hide"),it("hide")})),l.appendChild(c),u.appendChild(m),u.appendChild(p),u.appendChild(g),u.appendChild(h),u.appendChild(f),u.appendChild(y),l.appendChild(u),i.appendChild(l);const v=document.createElement("div");v.className="messages-container";let b=null,x=0,w=100,S=!1,k=null;const E=[],C={private:"coral",mention:"darkseagreen"},L={private:"coral",mention:"lightsteelblue",default:"slategray"};async function $(e){v.children.length&&v.replaceChildren(),Object.entries(e).forEach((([,{time:e,date:t,username:o,usernameColor:s,message:r,type:a,userId:l}])=>{if(k!==t){const e=document.createElement("div");e.className="date-item",e.textContent=t===n?"Today ":`${t} `,e.dataset.date=t,v.appendChild(e),k=t}const c=document.createElement("div");c.className="message-item",o!==b&&(c.style.marginTop="0.6em",b=o);const d=e.replace(/[\[\]]/g,"").trim(),u=document.createElement("span");if(u.className="message-time",u.textContent=d,u.title=`Moscow Time: ${Ln(d)}`,u.style.color=C[a]||"slategray","mention"===a||"private"===a){const e="mention"===a?"lightgreen":"peachpuff";u.addEventListener("mouseover",(()=>{u.style.color=e})),u.addEventListener("mouseout",(()=>{u.style.color=C[a]})),u.addEventListener("click",(e=>{if(e.ctrlKey)$n(c,"from");else if("mention"===a){const e=`https://klavogonki.ru/chatlogs/${t}.html#${Ln(d)}`;window.open(e,"_blank","noopener,noreferrer")}}))}const m=document.createElement("span");m.className="message-username",m.textContent=o,m.style.color=s,m.addEventListener("click",(e=>{if(e.ctrlKey)$n(c,"all");else if(l){const e=`https://klavogonki.ru/u/#/${l}/`;window.open(e,"_blank","noopener,noreferrer")}else vn(m)}));const p=document.createElement("span");p.className="message-text",p.innerHTML=r.replace(/:(?=\w*[a-zA-Z])(\w+):/g,((e,t)=>`<img src="/img/smilies/${t}.gif" alt=":${t}:" title=":${t}:" class="smile">`)).replace(/(https?:\/\/[^\s]+)/gi,(e=>`<a href="${e}" target="_blank" rel="noopener noreferrer">${e}</a>`)),p.addEventListener("click",(async function(t){if(t.ctrlKey)return void $n(c,"single");if(await Cn(e,o,!0))lt(i,"hide"),it("hide");else{let e=p.parentElement.previousElementSibling;for(;e&&!e.classList.contains("date-item");)e=e.previousElementSibling;if(e){await Pn(e.dataset.date);const t=Ln(d);requestAnimationFrame((async()=>{setTimeout((async()=>{const e=await async function(e,t,n){const o=document.querySelector(".chat-logs-container");if(!o)return null;const s=e=>e.replace(/[\[\]]/g,"").split(":").reduce(((e,t,n)=>e+Number(t)*60**(2-n)),0),r=s(e),a=e=>Array.from(o.querySelectorAll(".message-item")).find((n=>{const o=n.querySelector(".message-time"),r=n.querySelector(".message-username");if(o&&r){const n=s(o.textContent.trim()),a=r.textContent.trim();return e(n)&&a===t}return!1}));let i=a((e=>e===r));return i||(i=a((e=>Math.abs(e-r)<=2))),i&&n&&await Yt(o,i),i||!1}(t,o,!0);if(!e){lt(document.querySelector(".chat-logs-panel"),"hide"),Mn()}}),500)}))}}}));const g={messageTextElement:p,time:e,username:o,type:a};E.push(g),c.appendChild(u),c.appendChild(m),c.appendChild(p),v.appendChild(c)})),requestAnimationFrame((()=>{We("personalMessages"),nt("personalMessages"),rt("personalMessages"),zt("personalMessages"),v.scrollTop=v.scrollHeight,new MutationObserver((e=>{o||e.find((e=>"childList"===e.type&&e.removedNodes.length>0))&&"0"===m.style.opacity&&(t=!1,m.style.visibility="visible",m.style.display="flex",m.offsetHeight,m.style.opacity="1",m.style.transition="opacity 0.5s ease")})).observe(v,{childList:!0,subtree:!0}),setTimeout((()=>{o=!1}),500)})),E.reverse().forEach((async({messageTextElement:e,time:t,username:n,type:o})=>{x<w&&(S=await Cn(t,n,!1),x++,x>=w&&(S=!1,console.log("Reached maximum ping checks, resetting pingMessages."))),e.style.color=S&&"mention"===o?"lightgreen":S&&"private"===o?"lemonchiffon":L[o]||"slategray"}))}await $(a),i.appendChild(v),document.body.appendChild(i);const{scrollButtonsContainer:T}=de(v);i.appendChild(T),lt(i,"show"),it("show"),d.addEventListener("click",(()=>ae&&(d.value=""))),d.addEventListener("input",(()=>{const e=d.value.toLowerCase().replace(/_/g," ");v.querySelectorAll(".date-item").forEach((t=>{let n=!1,o=t.nextElementSibling;for(;o&&!o.classList.contains("date-item");){const t=(o.querySelector(".message-time")?.textContent.toLowerCase().replace(/_/g," ")+" "+o.querySelector(".message-username")?.textContent.toLowerCase().replace(/_/g," ")+" "+o.querySelector(".message-text")?.textContent.toLowerCase().replace(/_/g," ")).includes(e);o.style.contentVisibility=t?"visible":"hidden",o.style.fontSize=t?"":"0",n=n||t,o=o.nextElementSibling}t.style.display=n?"":"none"}))})),requestAnimationFrame((function(){d.focus()})),ct.handlePersonalMessagesKeydown=e=>{"Escape"===e.key&&(lt(i,"hide"),it("hide"),document.removeEventListener("keydown",ct.handlePersonalMessagesKeydown))},document.addEventListener("keydown",ct.handlePersonalMessagesKeydown)}mn.addEventListener("mousedown",(function(e){e.preventDefault();const t=function(e){const t=0===e.button,n=e.ctrlKey||e.metaKey,o=e.altKey;if(!n&&!o)return null;const a=n?"voiceSpeed":"voicePitch",i=t?-.1:.1,l=r.voiceSettings[a],[c,d]="voiceSpeed"===a?[0,s]:[0,2];return i<0&&l<=c||i>0&&l>=d?null:{prop:a,step:i}}(e);if(!t)return;const{prop:n,step:o}=t;kn(n,o),wn=setTimeout((()=>{Sn=setInterval((()=>{kn(n,o)||clearInterval(Sn)}),100)}),500);const a=()=>{clearTimeout(wn),clearInterval(Sn),mn.removeEventListener("mouseup",a),mn.removeEventListener("mouseleave",a)};mn.addEventListener("mouseup",a),mn.addEventListener("mouseleave",a)})),mn.addEventListener("contextmenu",(e=>e.preventDefault())),function(){gn=document.createElement("div");const e=r.messageSettings.messageModeState||"every-message";gn.classList.add("empowerment-button","message-mode-button"),gn.id=e;const t=r.messageSettings.messageModeTitle||"Notify about every message";gn.title=t,hn=document.createElement("span"),hn.classList.add("message-mode-icon"),gn.appendChild(hn),Se.appendChild(gn)}(),gn.addEventListener("click",(function(e){if(!ae||!ie){switch(fn(this),this.id){case"every-message":this.id="mention-message",this.title="Notify about mention message",r.messageSettings.messageModeState="mention-message",r.messageSettings.messageModeTitle="Notify about mention message";break;case"mention-message":this.id="every-message",this.title="Notify about every message",r.messageSettings.messageModeState="every-message",r.messageSettings.messageModeTitle="Notify about every message"}localStorage.setItem("KG_Chat_Empowerment",JSON.stringify(r)),En()}})),En(),function(){const e=document.createElement("div");e.classList.add("empowerment-button","cache-panel-load-button"),e.style.position="relative",e.style.zIndex="3",e.innerHTML=I;const t=document.createElement("div");t.classList.add("cache-user-count");const n=JSON.parse(localStorage.getItem("fetchedUsers"))||{},o=Object.keys(n).length;t.textContent=o,e.appendChild(t),e.title="Show Cache Panel",e.addEventListener("click",(function(){fn(e),ht()})),Se.appendChild(e)}(),function(){const e=document.createElement("div");e.classList.add("empowerment-button","personal-messages-button"),e.innerHTML=A;const t=document.createElement("div");t.classList.add("message-count","total-message-count");const n=JSON.parse(localStorage.getItem("personalMessages"))||{};t.textContent=Object.keys(n).length,e.appendChild(t);const o=document.createElement("div");o.classList.add("message-count","new-message-count");let s=Number(localStorage.getItem("newMessagesCount"))||(localStorage.setItem("newMessagesCount","0"),0);o.textContent=s,o.style.visibility=s>0?"visible":"hidden",e.appendChild(o),e.title="Show Personal Messages",e.addEventListener("click",(function(){fn(e),Mn();Object.keys(JSON.parse(localStorage.getItem("personalMessages"))||{}).length>0&&(localStorage.setItem("newMessagesCount","0"),s=0,o.textContent=s)})),Se.appendChild(e)}();let Nn=localStorage.personalMessages&&Object.keys(JSON.parse(localStorage.personalMessages)).length||0;function qn(){const e=document.querySelector(".personal-messages-button .total-message-count"),t=document.querySelector(".personal-messages-button .new-message-count");if(!e||!t)return;const n=JSON.parse(localStorage.getItem("personalMessages"))||{},o=Object.keys(n).length;let s=Number(localStorage.getItem("newMessagesCount"))||0;o>Nn&&(s++,localStorage.setItem("newMessagesCount",s),fn(t),yn(t,50,50)),e.textContent=o,t.textContent=s,t.style.visibility=s>0?"visible":"hidden",o!==Nn&&fn(e),Nn=o}!function(){const e=document.createElement("div");e.classList.add("empowerment-button","chat-logs-button"),e.style.position="relative",e.style.zIndex="1",e.innerHTML=O,e.title="Show Chat Logs",e.addEventListener("click",(async function(){fn(e),await Pn()})),Se.appendChild(e)}();const In=async(e,t)=>{t&&(t.innerHTML="");const n=`https://klavogonki.ru/chatlogs/${e}.html?rand=${Math.floor(Math.random()*10**20)}`;try{const e=await fetch(n);if(!e.ok)throw new Error("Network response was not ok");const t=await e.text(),o=1024*1e3,s=t.length>o?t.slice(0,o):t,r=(e=>[...(new DOMParser).parseFromString(e,"text/html").querySelectorAll(".ts")].map((e=>{const t=e.nextElementSibling,n=t?.nextSibling,o=e=>e?[...e.childNodes].reduce(((e,t)=>{if(t.nodeType===Node.TEXT_NODE)e+=t.textContent;else if(t.nodeType===Node.ELEMENT_NODE)if("A"===t.tagName)e+=t.getAttribute("href");else if("BR"===t.tagName)return e;return e}),"").trim():"";if(t?.classList.contains("mn")&&n){let s="";if(n.nodeType===Node.ELEMENT_NODE)s=o(n);else if(n.nodeType===Node.TEXT_NODE){const e=t.nextElementSibling;s=e&&"A"===e.tagName?`${n.textContent.trim()} ${e.getAttribute("href")}`:n.textContent.trim()}return s||(s=o(t.nextSibling)),{time:e.textContent.trim().replace(/[\[\]]/g,""),username:t.textContent.trim().replace(/<|>/g,""),message:s||null}}const s=e.nextElementSibling;if(s&&s.classList.contains("mne")){const t=s.textContent.trim();return{time:e.textContent.trim().replace(/[\[\]]/g,""),username:"SYSTEM",message:t||null}}return null})).filter(Boolean))(s),a=t.length>o,i=[];let l=null;for(const e of r){const t=e.message!==l?.message,n=e.username!==l?.username;(t||n)&&(i.push(e),l=e)}return{chatlogs:i.filter((e=>!p.includes(e.username))),url:n,size:s.length,info:a,error:null}}catch(e){return{chatlogs:[],url:n,size:0,error:e.message}}},An="2012-02-12";async function On(e){const t=JSON.parse(localStorage.getItem("userIdsCache")||"{}");if(t[e])return t[e];try{const n=await async function(e){const t=`https://klavogonki.ru/api/profile/search-users?query=${e}`,n=await vt(t);if(!n.all?.length)throw new Error(`User ${e} not found.`);const o=n.all.find((t=>t.login===e));if(!o)throw new Error(`Exact match for user ${e} not found.`);return o.id}(e);if(n)return t[e]=n,localStorage.setItem("userIdsCache",JSON.stringify(t)),n}catch(t){console.error(`Error fetching user ID for ${e}:`,t)}return null}let jn={media:!1,mention:!1};const Bn=()=>{jn={media:!1,mention:!1}};async function Hn(e){const t="mention"===e;jn={media:!!("media"===e)&&!jn.media,mention:!!t&&!jn.mention},document.querySelectorAll(".message-item").forEach((e=>{const t=e.querySelector(".media"),n=e.querySelector(".mention");jn.media?(e.style.contentVisibility=t?"visible":"hidden",e.style.fontSize=t?"":"0"):jn.mention?(e.style.contentVisibility=n?"visible":"hidden",e.style.fontSize=n?"":"0"):(e.style.contentVisibility="visible",e.style.fontSize="")}))}async function Pn(e){const t=document.querySelector(".chat-logs-panel");if(t)return t.remove(),void it("hide");dt();const o=document.createElement("div");o.className="chat-logs-panel popup-panel";const s=document.createElement("div");s.className="panel-header";const r=document.createElement("div");r.className="panel-control-buttons";const a=document.createElement("div");a.className="search-for-chatlogs-messages";const i=document.createElement("input");function l(){requestAnimationFrame((function(){i.focus()}))}i.className="chatlogs-search-input",i.type="text",a.appendChild(i),s.appendChild(a),i.addEventListener("input",(()=>D(i.value))),i.addEventListener("click",(e=>{e.ctrlKey&&(i.value="",D(i.value))})),i.addEventListener("keydown",(async e=>{const t=i.value;if("Enter"===e.key){let e=t;/^\d{8}$/.test(t)?(e=6===t.length?"20"+t:t,e=e.replace(/(\d{4})(\d{2})(\d{2})/,"$1-$2-$3")):/^\d{6}$/.test(t)&&(e="20"+t.replace(/(\d{2})(\d{2})(\d{2})/,"$1-$2-$3"));/^\d{2,4}[:\-]\d{2}[:\-]\d{2}$/.test(e.replace(/:/g,"-"))&&!isNaN(new Date(e.replace(/:/g,"-")).getTime())?(await O(e),d(u)):alert("Please enter a valid date.\n\nValid formats include:\n1. yyyy-mm-dd\n2. yyyy:mm:dd\n3. yy-mm-dd\n4. yy:mm:dd\n5. yyyymmdd\n6. yymmdd\n\n"),i.value=""}})),l();const c=document.createElement("div");function d(e){"none"===e.style.display&&(e.style.display="flex")}c.className="large-button panel-header-date-button",c.innerHTML=K,c.addEventListener("click",(()=>{var e;(e=u).style.display="none"===e.style.display?"flex":"none"}));const u=document.createElement("input");u.type="date",u.className="chatlogs-date-input",u.style.display="none",r.appendChild(c),r.appendChild(u);const m=document.createElement("div");m.className="large-button toggle-mention-messages-button",m.innerHTML=A,m.title="Toggle Mention Messages",m.addEventListener("click",(async()=>{await Hn("mention")}));const p=document.createElement("div");p.className="toggle-mention-messages-counter",p.textContent="0",m.appendChild(p),r.appendChild(m);const g=document.createElement("div");g.className="large-button panel-header-toggle-media-messages",g.innerHTML=j,g.title="Toggle Media Messages",g.addEventListener("click",(async()=>{await Hn("media")}));const h=document.createElement("div");h.className="toggle-media-messages-counter",h.textContent="0",g.appendChild(h),r.appendChild(g);const f=document.createElement("div");f.className="large-button panel-header-copy-button",f.innerHTML=X,f.title="Copy Chat Logs Url";const y=e=>{const t=e.match(/(\d{4}-\d{2}-\d{2})/);return t?t[1]:null};function v(e,t){t&&(t.replaceChildren(),e.forEach((({url:n,title:o})=>{const s=y(n),r=document.createElement("div");r.classList.add("saved-chatlog-url-wrapper");const a=document.createElement("a");a.classList.add("saved-chatlog-url"),a.textContent=s,a.href=n,a.addEventListener("click",(async t=>{if(t.preventDefault(),t.ctrlKey){const n=t.target.href,o=e.filter((e=>e.url!==n));if(o.length!==e.length){e=o,localStorage.setItem("savedChatlogs",JSON.stringify(e));t.target.closest(".saved-chatlog-url-wrapper").remove()}}else await O(s)}));const i=document.createElement("span");i.classList.add("saved-chatlog-url-title"),i.textContent=o||"",i.addEventListener("click",(()=>{const t=prompt("Enter a new title for this chat log:",i.textContent);if(null!==t&&t!==i.textContent){i.textContent=t;const o=e.findIndex((e=>e.url===n));-1!==o&&(e[o].title=t,localStorage.setItem("savedChatlogs",JSON.stringify(e)))}})),r.appendChild(a),r.appendChild(i),t.appendChild(r)})))}f.addEventListener("click",(e=>{let t=document.querySelector(".saved-chatlog-container");!t&&!e.shiftKey&&yn(f,0,0),!t||e.ctrlKey||t.contains(e.target)||t.remove();let n=JSON.parse(localStorage.getItem("savedChatlogs"))||[];if(e.ctrlKey&&!e.target.closest(".saved-chatlog-url")){const e=y(I);if(!e)return;const o=prompt("Enter a title for this chat log:","");n.some((t=>y(t.url)===e))||(n.push({url:I,title:o||""}),n.sort(((e,t)=>{const n=y(e.url),o=y(t.url);return new Date(n)-new Date(o)})),localStorage.setItem("savedChatlogs",JSON.stringify(n))),v(n,t)}else e.shiftKey?n.length>0&&!t&&(t=document.createElement("div"),t.classList.add("saved-chatlog-container"),v(n,t),f.appendChild(t)):navigator.clipboard.writeText(I).catch((e=>console.error("Failed to copy: ",e)))})),r.appendChild(f);const b=localStorage.getItem("shouldShowActiveUsers")||(localStorage.setItem("shouldShowActiveUsers","shown"),"shown"),x=document.createElement("div");function w(e){x.innerHTML="shown"===e?_:R,x.title="shown"===e?"Hide User List":"Show User List"}x.className="large-button panel-header-toggle-button",w(b),x.title="shown"===b?"Hide User List":"Show User List",x.addEventListener("click",(function(){const e="shown"===localStorage.getItem("shouldShowActiveUsers")?"hidden":"shown";if(localStorage.setItem("shouldShowActiveUsers",e),w(e),"shown"===e)B(q,o);else{const e=o.querySelector(".active-users");e&&o.removeChild(e)}})),r.appendChild(x);const S=document.createElement("div");S.className="large-button panel-header-one-day-back-button",S.title="Previous Day",S.innerHTML=V;const k=document.createElement("div");k.className="large-button panel-header-one-day-forward-button",k.title="Next Day",k.innerHTML=G;const E=document.createElement("div");function C(){return u.value?new Date(u.value):new Date}E.className="large-button panel-header-shuffle-button",E.title="Random Date",E.innerHTML=Y;S.addEventListener("click",(async()=>{const e=C();e.setDate(e.getDate()-1),await O(e),d(u),l(),Bn()})),k.addEventListener("click",(async()=>{const e=C();e.setDate(e.getDate()+1),await O(e),d(u),l(),Bn()})),E.addEventListener("click",(async()=>{const e=function(){const e=new Date(An),t=new Date-e,n=Math.floor(Math.random()*t),o=new Date(e.getTime()+n);return new Intl.DateTimeFormat("en-CA").format(o)}();await O(e),d(u),l(),Bn()})),r.appendChild(S),r.appendChild(k),r.appendChild(E);const L=document.createElement("div");L.className="large-button panel-header-close-button",L.title="Close panel",L.innerHTML=P,L.addEventListener("click",(()=>{lt(o,"hide"),it("hide")})),r.appendChild(L),s.appendChild(r);const $=document.createElement("div");$.className="chat-logs-container",o.appendChild(s),o.appendChild($);const{scrollButtonsContainer:T}=de($);o.appendChild(T),document.body.appendChild(o),lt(o,"show"),it("show");const M={};let N=null;const q=new Map;let I="";const O=async e=>{const t=new Intl.DateTimeFormat("en-CA").format(new Date((e=>/^\d{4}:\d{2}:\d{2}$/.test(e)?e.replace(/:/g,"-"):e)(e)));if(t<An||t>n)return void alert(t<An?`The selected date cannot be earlier than ${An}.`:"You cannot load a future date.");var s;s=t,u.value=s,c.title=`Current date: ${s}`;const{chatlogs:r,url:a,size:l,info:d,error:m}=await In(t,$),g=(l/1024).toFixed(2);i.placeholder=m?`Error: ${m}`:d?`Limit reached: ${g} KB`:d||`Size: ${g} KB`,I=a,q.clear(),r.forEach((async({time:t,username:n,message:o})=>{q.set(n,(q.get(n)||0)+1);const s=document.createElement("div");s.classList.add("message-item"),s.addEventListener("click",(async e=>{e.target.closest("a")||(jn&&await Hn(),i.value.length>0&&(i.value=""),await Yt($,s))}));const r=document.createElement("span");r.className="message-time",r.textContent=t,r.addEventListener("click",(function(){const n=`https://klavogonki.ru/chatlogs/${e}.html#${t}`;window.open(n,"_blank","noopener,noreferrer")}));const a=document.createElement("span");a.className="message-username",a.textContent=n,a.addEventListener("click",(async()=>{const e=await On(n);if(e){const t=`https://klavogonki.ru/u/#/${e}/`;window.open(t,"_blank","noopener,noreferrer")}else vn(a)}));let l=M[n];l||(l=15*Math.floor(14*Math.random()),M[n]=l),a.style.color=`hsl(${l}, 80%, 50%)`;const c=document.createElement("span");c.className="message-text",c.innerHTML=o.replace(/:(?=\w*[a-zA-Z])(\w+):/g,((e,t)=>`<img src="/img/smilies/${t}.gif" alt=":${t}:" title=":${t}:" class="smile">`)).replace(/(https?:\/\/[^\s]+)/gi,(e=>`<a href="${e}" target="_blank" rel="noopener noreferrer">${e}</a>`)),s.style.marginTop=N!==n?"0.6em":"",N=n,s.appendChild(r),s.appendChild(a),s.appendChild(c),$.appendChild(s)})),B(q,o,i),requestAnimationFrame((()=>{We("chatlogsMessages"),nt("chatlogsMessages"),rt("chatlogsMessages"),zt("chatlogsMessages"),$.scrollTop=$.scrollHeight,h.textContent=document.querySelectorAll(".chat-logs-container .media").length,p.textContent=document.querySelectorAll(".chat-logs-container .mention").length,$.childElementCount>0&&(i.placeholder+=` | Total messages: ${$.childElementCount}`),i.value.length>0&&D(i.value)}))};function B(e,t,n){if("shown"===localStorage.getItem("shouldShowActiveUsers")){let n=t.querySelector(".active-users");n||(n=document.createElement("div"),n.className="active-users",t.appendChild(n));const o=Array.from(e.entries()).sort((([,e],[,t])=>t-e));n.innerHTML="",o.forEach((([e,t])=>{const o=document.createElement("div");o.className="active-user-item",o.addEventListener("click",(()=>{const t=i.value.trim(),n=ae?`, ${e}`:e;i.value=t===e?"":ae&&!t.includes(e)?t+n:e,D(i.value)}));const s=document.createElement("span");s.className="active-user-name",s.textContent=e;const r=M[e]||0;s.style.color=`hsl(${r}, 80%, 50%)`;const a=document.createElement("span");a.className="active-user-messages-count",a.textContent=t,a.style.color=`hsl(${r}, 80%, 50%)`,a.style.backgroundColor=`hsla(${r}, 80%, 50%, 0.2)`,o.appendChild(a),o.appendChild(s),n.appendChild(o)}))}}const H=e||n;function D(e){if(/^[\d-:]+$/.test(e.trim()))return;function t(e){return e.replace(/[_-]/g," ").toLowerCase()}const n=t(e).trim(),o=Array.from(document.querySelectorAll(".chat-logs-container > .message-item")),s=function(e){return e.map((e=>{const t=e.querySelector(".message-username"),n=t?t.textContent.toLowerCase().trim():"",o=e.querySelector(".message-text");return{username:n,messageText:o?o.textContent.toLowerCase().trim():""}}))}(o),r=!n,a=n.split(",").map((e=>e.trim())).filter(Boolean),i=a.filter((e=>s.some((n=>t(n.username)===e)))).length>=2;o.forEach(((e,o)=>{const l=e.closest(".message-item"),c=s[o];let d=!1;const u=t(c.username),m=t(c.messageText);d=!!r||(i?a.some((e=>u===e)):u.includes(n)||m.includes(n)),l.style.contentVisibility=d?"visible":"hidden",l.style.fontSize=d?"":"0"}))}await O(H),e&&d(u),u.max=n,u.min=An,u.value=H,c.title=`Current date: ${H}`,u.addEventListener("change",(async e=>{const t=e.target.value;await O(t),c.title=`Current date: ${t}`})),ct.handleChatLogsKeydown=e=>{"Escape"===e.key&&(lt(o,"hide"),it("hide"),document.removeEventListener("keydown",ct.handleChatLogsKeydown))},document.addEventListener("keydown",ct.handleChatLogsKeydown)}async function Dn(e){const t=e.target.files[0];if(t){const e=new FileReader;return new Promise(((n,o)=>{e.onload=function(e){const t=e.target.result;try{Jn(JSON.parse(t)),n()}catch(e){console.error("Error parsing JSON data:",e.message),console.error("Invalid JSON:",t),alert("Failed to parse JSON data. Please check the format and try again."),o(e)}},e.onerror=function(e){console.error("Error reading file:",e.target.error),o(e.target.error)},e.readAsText(t)}))}}function Fn(e){if(!e||"object"!=typeof e)return console.error("Invalid settings data for download."),void alert("Cannot export settings. Please try again.");try{const t="  ",n="    ",o=e.usersToTrack.map((e=>`${n}${JSON.stringify(e)}`)).join(",\n"),s=e.usernameReplacements?.map((e=>`${n}${JSON.stringify(e)}`)).join(",\n")||"",r=e.toggle.map((e=>`${n}${JSON.stringify(e)}`)).join(",\n"),a=`{\n${t}"usersToTrack": [\n${o}\n${t}],\n${t}"mentionKeywords": [\n${e.mentionKeywords.map((e=>`${n}"${e}"`)).join(",\n")}\n${t}],\n${t}"usernameReplacements": [\n${s}\n${t}],\n${t}"moderator": [\n${e.moderator.map((e=>`${n}"${e}"`)).join(",\n")}\n${t}],\n${t}"ignored": [\n${e.ignored.map((e=>`${n}"${e}"`)).join(",\n")}\n${t}],\n${t}"toggle": [\n${r}\n${t}]\n}`,i=`KG_Chat_Empowerment_Settings_${new Intl.DateTimeFormat("en-CA").format(new Date)}.json`,l=new Blob([a],{type:"application/json"}),c=URL.createObjectURL(l),d=document.createElement("a");d.href=c,d.download=i,document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(c)}catch(e){console.error("Error exporting settings:",e),alert("Failed to export settings. Please try again.")}}function zn(){return{usersToTrack:JSON.parse(localStorage.getItem("usersToTrack"))||[],mentionKeywords:JSON.parse(localStorage.getItem("mentionKeywords"))||[],usernameReplacements:JSON.parse(localStorage.getItem("usernameReplacements"))||[],moderator:JSON.parse(localStorage.getItem("moderator"))||[],ignored:JSON.parse(localStorage.getItem("ignored"))||[],toggle:JSON.parse(localStorage.getItem("toggle"))||[]}}function Jn({usersToTrack:e=[],mentionKeywords:t=[],usernameReplacements:n=[],moderator:o=[],ignored:s=[],toggle:r=[]}){c=Array.isArray(e)?e:c,d=Array.isArray(t)?t:d,u=Array.isArray(n)?n:u,m=Array.isArray(o)?o:m,p=Array.isArray(s)?s:p,g=Array.isArray(r)?r:g,localStorage.setItem("usersToTrack",JSON.stringify(c)),localStorage.setItem("mentionKeywords",JSON.stringify(d)),localStorage.setItem("usernameReplacements",JSON.stringify(u)),localStorage.setItem("moderator",JSON.stringify(m)),localStorage.setItem("ignored",JSON.stringify(p)),localStorage.setItem("toggle",JSON.stringify(g)),console.log("Uploaded settings applied:",{usersToTrack:c,mentionKeywords:d,usernameReplacements:u,moderator:m,ignored:p,toggle:g})}function Un(){const e=window.location.href;let t,n;if(e.includes("gamelist"))t=document.querySelector("#chat-general .text"),n=document.querySelector("#chat-general .messages");else{if(!e.includes("gmid"))return console.error("No matching room type found in the URL."),null;t=document.querySelector('[id^="chat-game"] .text'),n=document.querySelector('[id^="chat-game"] .messages')}return{inputField:t,lengthPopupContainer:n}}!function(){const e=document.createElement("div");e.classList.add("empowerment-button","settings-button"),e.title="Show Settings Panel",e.style.position="relative",e.innerHTML=H;const t=document.createElement("input");t.type="file",t.accept=".json",t.style.display="none",t.addEventListener("change",Dn),e.addEventListener("click",(n=>{fn(e),ie&&Fn(zn()),ae&&t.click(),ie||ae||function(){const e=document.querySelector(".settings-panel");if(e)return e.remove(),void it("hide");dt();const t=document.createElement("div");t.className="settings-panel popup-panel",ct.handleSettingsKeydown=e=>{"Escape"===e.key&&(lt(t,"hide"),it("hide"),document.removeEventListener("keydown",ct.handleSettingsKeydown))},document.addEventListener("keydown",ct.handleSettingsKeydown);const n=document.createElement("div");n.className="panel-header";const o=document.createElement("div");o.classList.add("panel-control-buttons");const s=document.createElement("div");s.className="large-button panel-header-close-button",s.innerHTML=P,s.title="Close panel",s.addEventListener("click",(()=>{lt(t,"hide"),it("hide")}));const r=document.createElement("div");r.className="large-button panel-header-clear-button",r.innerHTML=W,r.title="Clear settings",r.addEventListener("click",(()=>{d()}));const a=document.createElement("div");a.className="large-button panel-header-import-button",a.innerHTML=Q,a.title="Import settings";const i=document.createElement("div");function l(e){const t=document.querySelector(".settings-content-container");if(!t)return console.error("Container not found.");const n=()=>{e.style.visibility="visible",e.style.display="flex",setTimeout((()=>{e.style.opacity="1"}),10)},o=()=>{e.style.opacity="0",setTimeout((()=>{e.style.visibility="hidden",e.style.display="none"}),500)},s=zn(),r=()=>{const e={usersToTrack:[],mentionKeywords:[],usernameReplacements:[],moderator:[],ignored:[],toggle:[]};t.querySelectorAll(".settings-tracked-container .tracked-item").forEach((t=>{const n=t.querySelector(".tracked-username-field"),o=t.querySelector(".tracked-gender-select"),s=t.querySelector(".tracked-pronunciation-field"),r=t.querySelector(".assigned-thawed-config, .assigned-frozen-config"),a=n?n.value.trim():"",i=o?o.value.trim():"",l=s?s.value.trim():"",c=r.classList.contains("assigned-frozen-config")?"frozen":"thawed";e.usersToTrack.push({name:a,gender:i,pronunciation:l,state:c})}));const r=new Set(e.usersToTrack.map((e=>e.name.toLowerCase())));t.querySelectorAll(".settings-mention-container .mention-item").forEach((t=>{const n=t.querySelector(".mention-field"),o=n?n.value.trim():"";e.mentionKeywords.push(o)})),t.querySelectorAll(".settings-replacement-container .replacement-item").forEach((t=>{const n=t.querySelector(".replacement-original-field"),o=t.querySelector(".replacement-field"),s=n?n.value.trim():"",a=o?o.value.trim():"";if(r.has(s.toLowerCase()))return n.classList.add("input-error"),void vn(n);n.classList.remove("input-error"),e.usernameReplacements.push({original:s,replacement:a})})),t.querySelectorAll(".settings-moderator-container .moderator-item").forEach((t=>{const n=t.querySelector(".moderator-field"),o=n?n.value.trim():"";e.moderator.push(o)})),t.querySelectorAll(".settings-ignored-container .ignored-item").forEach((t=>{const n=t.querySelector(".ignored-field"),o=n?n.value.trim():"";e.ignored.push(o)})),t.querySelectorAll(".settings-toggle-container .toggle-item").forEach((t=>{const n=t.querySelector(".toggle-description"),o=t.querySelector(".toggle-select"),s=o?o.value.trim():"no",r=n.getAttribute("data-toggle-name");r&&e.toggle.push({name:r,option:s})}));return JSON.stringify(s)!==JSON.stringify(e)?n():o(),e};e.addEventListener("click",(()=>{const e=r();Jn(e),Object.assign(s,e),o()})),t.querySelectorAll("input, select").forEach((e=>{e.addEventListener("input",r)}));const a=e=>{"INPUT"===e.tagName||"SELECT"===e.tagName?e.addEventListener("input",r):e.querySelectorAll("input, select").forEach((e=>{e.addEventListener("input",r)}))};new MutationObserver(jt((e=>{e.forEach((e=>{"childList"===e.type&&(e.addedNodes.forEach((e=>{e.nodeType===Node.ELEMENT_NODE&&a(e)})),e.removedNodes.forEach((e=>{e.nodeType===Node.ELEMENT_NODE&&r()})))}))}),300)).observe(t,{childList:!0,subtree:!0})}i.className="large-button panel-header-save-button",i.innerHTML=te,i.title="Save settings";const c=document.createElement("input");function d(){[".settings-tracked-container",".settings-mention-container",".settings-replacement-container",".settings-moderator-container",".settings-ignored-container",".settings-toggle-container"].forEach((e=>{const t=document.querySelector(e);t&&t.replaceChildren();const n=t.querySelector(".add-settings-button");n&&t.appendChild(n)}))}c.type="file",c.accept=".json",c.style.display="none",c.addEventListener("change",(async e=>{await Dn(e),d(),T()})),a.addEventListener("click",(()=>{c.click()})),a.appendChild(c);const u=document.createElement("div");u.className="large-button panel-header-export-button",u.innerHTML=ee,u.title="Export settings",u.addEventListener("click",(function(){Fn(zn())})),o.appendChild(i),o.appendChild(a),o.appendChild(u),o.appendChild(r),o.appendChild(s),n.appendChild(o),t.appendChild(n);const m=document.createElement("div");m.className="settings-content-container";function p(e){e.style.height="30px",e.style.maxWidth="120px",e.style.minWidth="105px",e.style.padding="0.4em",e.style.font="1em Montserrat",e.style.fontFamily="Montserrat",e.style.setProperty("color","bisque","important"),e.style.setProperty("border-radius","0.2em","important"),e.style.boxSizing="border-box",e.style.setProperty("background-color","rgb(17,17,17)","important"),e.style.setProperty("border","1px solid rgb(34,34,34)","important"),Array.from(e.options).forEach((e=>{e.style.height="30px",e.style.setProperty("background-color","rgb(17,17,17)","important"),e.style.setProperty("color","bisque","important"),e.style.fontFamily="Montserrat"}))}function g(e,t){e.addEventListener("click",(()=>{t.remove()}))}function h(e,t){e.addEventListener("click",(()=>{const n=e.classList.toggle("assigned-frozen-config");e.classList.toggle("assigned-thawed-config"),e.style.opacity=n?"1":"0.3",x(t,n?"frozen":"thawed")}))}function f(e,t="inline-flex"){const n=document.createElement("div");return n.className=`${e}-item`,n.style.display=t,n.style.gap="0.5em",n.style.padding="0.25em",n}function y(e,t="",n=""){const o=document.createElement("input");return o.className=`settings-field ${e}-field`,o.value=t,o.placeholder=n,o}function v(e,t){const n=document.createElement("div");return n.className=`settings-button remove-settings-button remove-${e}-word`,n.innerHTML=ne,g(n,t),n}function b(e="thawed",t){const n=document.createElement("div");return n.className=`settings-button assigned-settings-button assigned-${e}-config`,n.style.opacity="thawed"===e?"0.3":"1",n.innerHTML=oe,h(n,t),n}function x(e,t){const n=localStorage.getItem("usersToTrack");if(n){const o=JSON.parse(n).map((n=>n.name===e?{...n,state:t}:n));localStorage.setItem("usersToTrack",JSON.stringify(o))}}function w(e,t={}){const n=document.createElement("div");n.classList.add("settings-spoiler");const o=document.createElement("button");return o.textContent=t.showText||"Show Content",e.style.display="none",o.addEventListener("click",(()=>{const n="none"===e.style.display;e.style.display=n?"flex":"none",o.textContent=n?t.hideText||"Hide Content":t.showText||"Show Content"})),n.appendChild(o),n.appendChild(e),n}function S(e){const t=f("tracked","flex"),n=y("tracked-username",e.name,"Username"),o=y("tracked-pronunciation",e.pronunciation,"Pronunciation"),s=v("tracked",t),r=b("frozen"===e.state?"frozen":"thawed",e.name),a=document.createElement("select");a.className="tracked-gender-select";return[{value:"Male",emoji:""},{value:"Female",emoji:""}].forEach((({value:t,emoji:n})=>{const o=document.createElement("option");o.value=t,o.textContent=`${n} ${t}`,e.gender===t&&(o.selected=!0),a.appendChild(o)})),p(a),t.appendChild(n),t.appendChild(a),t.appendChild(o),t.appendChild(s),t.appendChild(r),t}function k(e){const t=f("mention"),n=y("mention",e,"Mention Keyword"),o=v("mention",t);return t.appendChild(n),t.appendChild(o),t}function E(e={original:"",replacement:""}){const t=f("replacement"),n=y("replacement-original",e.original,"Original username"),o=y("replacement",e.replacement,"Replacement name"),s=v("replacement",t);return t.appendChild(n),t.appendChild(o),t.appendChild(s),t}function C(e){const t=f("moderator"),n=y("moderator",e,"Moderator Name"),o=v("moderator",t);return t.appendChild(n),t.appendChild(o),t}function L(e){const t=f("ignored"),n=y("ignored",e,"Ignored User"),o=v("ignored",t);return t.appendChild(n),t.appendChild(o),t}function $(e,t,n){const o=f("toggle","flex");o.style.alignItems="center";const s=document.createElement("select");s.className="toggle-select";const r=document.createElement("span");r.className="toggle-description",r.innerText=e.description,r.setAttribute("data-toggle-name",t),r.style.cursor="pointer",r.style.color="burlywood",r.style.transition="color 0.15s ease-in-out",r.addEventListener("click",(()=>{e.image&&window.open(e.image,"_blank")})),r.addEventListener("mouseover",(function(){r.style.color="lightgoldenrodyellow"})),r.addEventListener("mouseout",(function(){r.style.color="burlywood"}));return[{value:"yes",emoji:""},{value:"no",emoji:""}].forEach((({value:e,emoji:t})=>{const n=document.createElement("option");n.value=e,n.textContent=`${t} ${e}`,s.appendChild(n)})),s.value=n,p(s),o.appendChild(s),o.appendChild(r),o}function T(){const e={usersToTrack:".settings-tracked-container",mentionKeywords:".settings-mention-container",usernameReplacements:".settings-replacement-container",moderator:".settings-moderator-container",ignored:".settings-ignored-container"},t={usersToTrack:{name:"tracked",createItem:S},mentionKeywords:{name:"mention",createItem:k},usernameReplacements:{name:"replacement",createItem:E},moderator:{name:"moderator",createItem:C},ignored:{name:"ignored",createItem:L}},n=zn();Object.entries(n).forEach((([n,o])=>{const s=document.querySelector(e[n]);if(!s)return;s.classList.add("settings-container"),"mentionKeywords"!==n&&"moderator"!==n&&"ignored"!==n||(s.style.flexDirection="row");const r=s.querySelector(".add-settings-button");for(;s.firstChild&&s.firstChild!==r;)s.removeChild(s.firstChild);o.forEach((e=>s.appendChild(t[n].createItem(e))));const a=M(e[n],t[n].createItem);s.appendChild(a);if(!(null!==s.closest(".settings-spoiler"))){const e=s.parentNode;if(e){const o=Array.from(e.childNodes).indexOf(s);e.removeChild(s);const r=w(s,{showText:`Show ${t[n].name} settings`,hideText:`Hide ${t[n].name} settings`});r.classList.add("settings-spoiler-wrapper"),o>=e.childNodes.length?e.appendChild(r):e.insertBefore(r,e.childNodes[o])}}}));const o=JSON.parse(localStorage.getItem("toggle"))||[],s=document.querySelector(".settings-toggle-container");[{name:"showChatStaticNotifications",description:" Show chat static notifications",image:"https://i.imgur.com/oUPSi9I.jpeg"},{name:"showGlobalDynamicNotifications",description:" Show global dynamic notifications",image:"https://i.imgur.com/8ffCdUG.jpeg"},{name:"enabledBeepOnChatJoinLeave",description:" Play a beep sound and speak feedback when the user enters or leaves the chat",image:"https://i.imgur.com/6PXFIES.jpeg"},{name:"switchToGoogleTTSEngine",description:" Switch to google TTS engine if available",image:"https://i.imgur.com/0H94LII.jpeg"}].forEach((e=>{const t=o.find((t=>t.name===e.name)),n=t?t.option:"yes",r=$(e,e.name,n);s.appendChild(r)}))}function M(e,t){const n=e.split("-")[1],o=document.querySelector(`.add-${n}-item`);o&&o.remove();const s=document.createElement("div");return s.className=`settings-button add-settings-button add-${n}-item`,s.innerHTML=se,s.style.margin="0.4em",s.addEventListener("click",(()=>{const o=document.querySelector(e),r=o.querySelectorAll(`.${n}-item`),a=r.length>0?r[r.length-1]:null,i=a?a.querySelectorAll("input"):[],l=Array.from(i).some((e=>0===e.value.trim().length));if(!a||!l){const e=t(t===S?{name:"",pronunciation:""}:"");e instanceof HTMLElement?o.insertBefore(e,s):console.error("Invalid item created.")}else alert("Please fill in the previous item before adding a new one.")})),s}[{type:"tracked",emoji:""},{type:"mention",emoji:""},{type:"replacement",emoji:""},{type:"moderator",emoji:""},{type:"ignored",emoji:""},{type:"toggle",emoji:""}].forEach((({type:e,emoji:t})=>{const n=document.createElement("div");n.className=`settings-${e}-description settings-description`;const o=document.createElement("div");o.className=`settings-${e}-container`,n.textContent=`${e.charAt(0).toUpperCase()}${e.slice(1).toLowerCase()} ${t}`,m.appendChild(n),m.appendChild(o)})),t.appendChild(m);const{scrollButtonsContainer:N}=de(m);t.appendChild(N),document.body.appendChild(t),T(),l(i),lt(t,"show"),it("show")}()})),e.appendChild(t),Se.appendChild(e)}();const{inputField:Rn,lengthPopupContainer:_n}=Un(),Kn=document.createElement("div");Kn.className="length-field-popup",_n.appendChild(Kn);const Xn=document.createElement("canvas").getContext("2d");let Vn,Gn=!1,Yn=0;function Wn(e){let t;t=e>Yn?`${e} `:e<Yn?` ${e}`:`${e}`,Kn.textContent=t,function(e){if(!Kn)return void console.error("lengthPopup is not defined");let t;if(0===e)t="hsl(200, 20%, 50%)";else if(e>=1&&e<=90)t="hsl(120, 100%, 40%)";else if(e>90&&e<=100){const n=(e-90)/10;t=`hsl(${Math.round(120+-60*n)}, 100%, 40%)`}else if(e>100&&e<=190)t="hsl(60, 100%, 50%)";else if(e>190&&e<=200){const n=(e-190)/10;t=`hsl(${Math.round(60+-30*n)}, 100%, 50%)`}else if(e>200&&e<=250)t="hsl(40, 100%, 50%)";else if(e>250&&e<=300){const n=(e-250)/50;t=`hsl(${Math.round(40+-40*n)}, 100%, 70%)`}else t="hsl(0, 100%, 70%)";Kn.style.color=t}(e),Yn=e}function Zn(e){Gn!==e&&(Kn.classList.toggle("bounce-in",e),Kn.classList.toggle("bounce-out",!e),Gn=e,e||setTimeout((()=>Kn.classList.remove("bounce-out")),500))}function Qn(){ro(),lo(),io()}function eo(e){e.style.setProperty("background-color","hsla(0, 50%, 30%, .5)","important"),e.style.setProperty("box-shadow","inset 0px 0px 0px 1px rgb(191, 64, 64)","important"),e.style.setProperty("background-clip","padding-box","important")}Rn.addEventListener("input",(()=>{clearTimeout(Vn),Wn(Rn.value.length),function(e){const t=getComputedStyle(Rn);Xn.font=`${t.fontWeight} ${t.fontSize} ${t.fontFamily}`;const n=Xn.measureText(e).width,o=Rn.offsetLeft+n+5,s=Rn.offsetLeft+Rn.offsetWidth-Kn.offsetWidth;Kn.style.left=`${Math.min(o,s)}px`}(Rn.value),Zn(!0),Vn=setTimeout((()=>Zn(!1)),1e3)})),Rn.addEventListener("keydown",(e=>{"Enter"===e.key&&(Wn(0),Object.assign(Kn.style,{left:"0px",color:"hsl(200, 20%, 50%)"}),Zn(!0),Vn=setTimeout((()=>Zn(!1)),1e3))}));const to=new Set;let no,oo=!1,so=!1;function ro(){const e=document.querySelectorAll(".messages-content div p");let t=null;e.forEach((e=>{e.hasAttribute("id")&&"contextmenu"===e.getAttribute("id")||(e.addEventListener("mousedown",(n=>{if(so=2===n.button,so){oo=!0,clearTimeout(t);const n=ao(e);to.has(n)||(to.add(n),console.log("Added new message inside the selectedMessages Set:",n)),eo(e)}})),e.addEventListener("mouseup",(e=>{so=2===e.button,so&&(oo=!1)})),e.addEventListener("mouseover",(t=>{if(oo&&so){const t=ao(e);to.has(t)||(to.add(t),console.log("Added new message inside the selectedMessages Set:",t)),eo(e)}})),e.setAttribute("id","contextmenu"),e.addEventListener("contextmenu",(n=>{n.preventDefault(),eo(e);const o=document.querySelector(".delete-message");o&&o.remove();const s=document.createElement("button");function r(){t=setTimeout((()=>{s.matches(":hover")||(s.remove(),document.querySelectorAll(".messages-content div p").forEach((e=>{e.style.removeProperty("background-color"),e.style.removeProperty("box-shadow"),e.style.removeProperty("background-clip")})),to.clear())}),1e3)}s.innerText="Delete",s.classList.add("delete-message"),s.addEventListener("click",(()=>{!function(){const e=[...to],t=document.querySelectorAll(".messages-content div p");e.forEach((e=>{const n=Array.from(t).find((t=>ao(t)===e));if(n){const t=JSON.parse(localStorage.getItem("deletedChatMessagesContent")||"[]");t.includes(e)||t.push(e),localStorage.setItem("deletedChatMessagesContent",JSON.stringify(t)),to.delete(e)}})),io()}(),s.remove(),lo(),to.clear()})),function(e,t){e.style.position="fixed",e.style.top=`${t.clientY}px`,e.style.left=`${t.clientX}px`,e.style.zIndex=999,e.style.padding="8px 16px",e.style.backgroundColor="hsl(0, 50%, 20%)",e.style.color="hsl(0, 60%, 70%)",e.style.border="1px solid hsl(0, 50%, 35%)",e.style.transition="all 0.3s",e.style.filter="brightness(1)",e.addEventListener("mouseenter",(()=>{e.style.filter="brightness(1.5)"})),e.addEventListener("mouseleave",(()=>{e.style.filter="brightness(1)"}))}(s,n),s.addEventListener("mouseenter",(()=>{s.style.filter="brightness(1.5)"})),s.addEventListener("mouseleave",(()=>{s.style.filter="brightness(1)"})),document.body.appendChild(s),r(),s.addEventListener("mouseleave",(()=>{r()})),s.addEventListener("mouseenter",(()=>{clearTimeout(t)}))})))}))}function ao(e){const t=e.querySelector(".time"),n=e.querySelector(".username");return[t?t.textContent.trim():"",n?` ${n.textContent.trim()} `:"",...Array.from(e.childNodes).filter((e=>e!==t&&e!==n)).map((e=>e.nodeType===Node.TEXT_NODE?e.textContent:"A"===e.tagName?e.getAttribute("href").trim():"IMG"===e.tagName?e.title.trim():"IFRAME"===e.tagName?e.getAttribute("src").trim():""))].join("")}function io(){const e=JSON.parse(localStorage.getItem("deletedChatMessagesContent")||"[]");if(0===e.length)return;const t=document.querySelectorAll(".messages-content div p"),n=new Set(e),o=Array.from(t).map((e=>ao(e))),s=e.filter((e=>o.includes(e)));t.forEach((e=>{n.has(ao(e))&&(e.style.display="none")})),localStorage.setItem("deletedChatMessagesContent",JSON.stringify(s))}function lo(){if(JSON.parse(localStorage.getItem("deletedChatMessagesContent")||"[]").length>0&&(no=document.getElementById("toggleButton"),null===no)){no=document.createElement("button"),no.id="toggleButton",no.classList.add("toggle-button-hidden"),no.addEventListener("click",co),no.style.position="absolute",no.style.top="0",no.style.right="0",no.style.padding="8px 16px",no.innerText="Hidden",no.style.transition="filter 300ms",no.style.filter="hue-rotate(0) brightness(1)";let e=no.textContent;no.addEventListener("mouseenter",(()=>{ae?(e=no.textContent,no.textContent="Restore",no.style.filter="hue-rotate(180deg) brightness(2)"):no.style.filter="hue-rotate(0) brightness(2)"})),no.addEventListener("mouseleave",(()=>{const t="Restore"===no.textContent;(ae||!ae&&t)&&(no.textContent=e),no.style.filter="hue-rotate(0) brightness(1)"})),un.appendChild(no)}}function co(){const e=document.querySelectorAll(".messages-content div p"),t=JSON.parse(localStorage.getItem("deletedChatMessagesContent")||"[]");if(ae&&(localStorage.setItem("deletedChatMessagesContent",JSON.stringify([])),e.forEach((e=>{e.style.display="block",e.style.removeProperty("background-color"),e.style.removeProperty("box-shadow"),e.style.removeProperty("background-clip")})),no.remove()),!ae){if(0===t.length)return void(no.style.display="none");no.style.display="block",e.forEach((e=>{const n=ao(e);t.includes(n)&&("Hidden"===no.innerText||"Show"===no.innerText?"none"===e.style.display&&(e.style.display="block",e.style.setProperty("background-color","hsla(0, 50%, 30%, .5)","important"),e.style.setProperty("box-shadow","inset 0px 0px 0px 1px rgb(191, 64, 64)","important"),e.style.setProperty("background-clip","padding-box","important")):"Hide"===no.innerText&&"block"===e.style.display&&(e.style.display="none",e.style.removeProperty("background-color"),e.style.removeProperty("box-shadow"),e.style.removeProperty("background-clip")))})),"Hide"===no.innerText?(no.innerText="Show",no.className="toggle-button-show"):(no.innerText="Hide",no.className="toggle-button-hide")}}const uo=()=>({chatField:document.querySelector(".chat .text"),chatSend:document.querySelector(".chat .send")});function mo(e){if(!e)return null;const t=e.value;return t.includes(po)?po:t.includes(go)?go:null}const po="    ",go="   ";if(ho="gamelist",window.location.href.includes(ho)){function So(e,t,n){if(t.disabled){const o=mo(t);o===po?(t.disabled=n.disabled=!1,n.style.setProperty("background-color","rgb(160, 35, 35)","important"),n.style.setProperty("background-image",`url("data:image/svg+xml,${encodeURIComponent(B)}")`,"important"),n.style.setProperty("background-repeat","no-repeat","important"),n.style.setProperty("background-position","center","important"),n.style.setProperty("color","transparent","important"),t.value=null,console.log("Chat field was blocked, re-enabled.")):o===go&&(console.log("Lost connection, reloading..."),setTimeout((()=>{window.location.reload()}),e))}}const ko=new MutationObserver((()=>{const{chatField:e,chatSend:t}=uo();So(5e3,e,t)})),{chatField:Eo}=uo();Eo&&ko.observe(Eo,{attributes:!0,attributeFilter:["disabled"]}),document.addEventListener("visibilitychange",(()=>{if("visible"===document.visibilityState){const{chatField:e,chatSend:t}=uo();So(1e3,e,t)}}))}var ho;let fo=document.querySelectorAll(".general"),yo=document.querySelectorAll(".game");function vo(){const e=document.querySelector("#chat-wrapper.chat-hidden"),t=window.location.href;let n;t.includes("gamelist")?n=document.querySelector("#chat-general .text"):t.includes("gmid")&&(n=document.querySelector('[id^="chat-game"] .text')),!e&&n&&n.focus()}function bo(e){console.log("Clicked element:",e.target);let t=e.target.classList.contains("general")?"general":"game";localStorage.setItem("activeChatTab",t)}function xo(){const e=document.querySelector(".text");e.setAttribute("maxlength","1000"),e.addEventListener("paste",(t=>{t.preventDefault();const n=t.clipboardData.getData("text");let o=n;ot(n)&&(o=st(n));const s=e.selectionStart,r=e.selectionEnd;e.value=e.value.slice(0,s)+o+e.value.slice(r),e.setSelectionRange(s+o.length,s+o.length)})),e.addEventListener("keydown",(t=>{const n=e.value;"Enter"===t.key&&(n.length>300?(t.preventDefault(),async function(e){const t=function(e){const t=e.split(" "),n=[];let o="";return t.forEach((e=>{(o+e).length>300?(n.push(o.trim()),o=e+" "):o+=e+" "})),o&&n.push(o.trim()),n}(e),n=document.querySelector(".text"),o=document.querySelector(".send"),s=e.length>300;s&&(n.disabled=!0);for(let e=0;e<t.length;e++){const s=t[e];if(n.value=s,console.log(`Sending piece ${e+1}: "${s}" (Length: ${s.length})`),o.click(),e<t.length-1){const e=Math.floor(500*Math.random())+500;console.log(`Waiting for ${e} ms before sending the next piece.`),await new Promise((t=>setTimeout(t,e)))}}s&&(n.disabled=!1)}(n),console.log(`Long message processed: "${n}"`),e.value=""):console.log(`Short message processed: "${n}"`))}))}fo.forEach((function(e){e.addEventListener("click",bo)})),yo.forEach((function(e){e.addEventListener("click",bo)})),document.addEventListener("keydown",(function(e){"Tab"===e.key&&(!function(){const e=document.querySelector("#chat-wrapper.chat-hidden");let t=document.querySelectorAll(".general.c, .general.c.active"),n=document.querySelectorAll(".game.c, .game.c.active"),o=Array.from(t).find((function(e){return"none"!==window.getComputedStyle(e).display&&!e.classList.contains("active")})),s=Array.from(n).find((function(e){return"none"!==window.getComputedStyle(e).display&&!e.classList.contains("active")}));if(!e&&(o||s)){let e;o?o.click():s&&s.click(),o?e=document.querySelector("#chat-general .text"):s&&(e=document.querySelector('[id^="chat-game"] .text')),e&&e.focus()}}(),e.preventDefault())}));let wo=new MutationObserver((()=>{const e=document.querySelector(".messages-content div"),t=document.querySelectorAll(".messages-content div p");document.contains(e)&&t.length>=20&&(wo.disconnect(),document.querySelectorAll(".messages-content p").forEach((e=>{const t=e.querySelector(".username"),n=t?.textContent?.replace(/[<>]/g,"")||null;if(n&&p.includes(n)){const t=rn(n);e.classList.add("ignored-user",t),e.style.display="none"}})),We("generalMessages"),nt("generalMessages"),rt("generalMessages"),function(){let e,t=localStorage.getItem("activeChatTab");if("general"===t){let t=Array.from(fo).find((function(e){return"none"!==window.getComputedStyle(e).display&&!e.classList.contains("active")}));t&&(t.click(),e=document.querySelector("#chat-general .text"))}else if("game"===t){let t=Array.from(yo).find((function(e){return"none"!==window.getComputedStyle(e).display&&!e.classList.contains("active")}));t&&(t.click(),e=document.querySelector('[id^="chat-game"] .text'))}e&&e.focus()}(),function(e){const t=document.querySelector(e);t&&(t.value=localStorage.getItem("inputBackup")||"",t.addEventListener("input",jt((()=>{mo(t)||localStorage.setItem("inputBackup",t.value)}),250)),t.addEventListener("keydown",(e=>{"Enter"===e.key&&localStorage.removeItem("inputBackup")})))}("#chat-general .text"),zt(),Wt(),Gt(),Tt(!1,$t),Ct(),vo(),Qn(),xo())}));wo.observe(document,{childList:!0,subtree:!0})}()})();