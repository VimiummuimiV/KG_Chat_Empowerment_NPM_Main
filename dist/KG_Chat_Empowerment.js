// ==UserScript==
// @name         KG_Chat_Empowerment
// @namespace    klavogonki
// @version      1.1.1 
// @description  Enhance the chat abilities
// @author       Patcher
// @match        *://klavogonki.ru/g*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=klavogonki.ru
// @grant        none
// ==/UserScript==

(()=>{"use strict";var e={11:(e,t,n)=>{n.d(t,{A:()=>i});var o=n(601),s=n.n(o),a=n(314),r=n.n(a)()(s());r.push([e.id,'.empowerment-button{display:flex;justify-content:center;align-items:center;width:48px;height:48px;cursor:pointer;background-color:#212226;border:1px solid #45474b}.input-error{transition:background-color 300ms ease-in-out;background-color:#6b2f2f !important}.popup-panel .date-item{position:relative;font:1em Montserrat,sans-serif;color:#deb887;background-color:rgba(222,184,135,.1);width:fit-content;margin:2em 1em 1em;padding:.4em .8em;text-align:center;border-radius:.4em !important;left:50%;transform:translateX(-50%)}.popup-panel .search-messages-info,.popup-panel .search-messages-date,.popup-panel .no-messages-info{padding:.5em;border-radius:.4em !important;width:fit-content;margin:.5em}.popup-panel .search-messages-info{color:hsl(80,60%,70%);background:hsla(80,60%,70%,.1)}.popup-panel .search-messages-date{color:hsl(40,60%,70%);background:hsla(40,60%,70%,.1)}.popup-panel .no-messages-info{color:hsl(0,60%,70%);background:hsla(0,60%,70%,.1)}.popup-panel .search-match{color:#90ee90;text-decoration:underline}.length-field-popup{position:absolute;font:bold 12px Montserrat;bottom:40px;transition:left 100ms ease-out;height:20px;display:flex;align-items:center;justify-content:center;padding:2px 4px;margin:2px;opacity:0;border:none !important}.bounce-in{animation:bounceIn 500ms forwards}@keyframes bounceIn{0%{transform:translateY(0);opacity:0}50%{transform:translateY(-10px);opacity:1}100%{transform:translateY(0);opacity:1}}.bounce-out{animation:bounceOut 500ms forwards}@keyframes bounceOut{0%{transform:translateY(0);opacity:1}50%{transform:translateY(-10px);opacity:1}100%{transform:translateY(0);opacity:0}}.userlist .avatar,.user-item .avatar{width:24px;height:24px;display:inline-flex}.userlist .avatar img,.user-item .avatar img{border-radius:.2em !important;transform-origin:left;transition:transform .15s}.userlist .avatar img:hover,.user-item .avatar img:hover{transform:scale(2);z-index:2}.chat-logs-panel .message-text a,.cached-messages-panel .message-text a{color:#deb887 !important;transition:color .15s ease-in-out}.chat-logs-panel .message-text a:hover,.cached-messages-panel .message-text a:hover{color:#fafad2 !important}.empowerment-panel{position:fixed;top:50%;transform:translateY(-100%);right:15px;display:flex;flex-direction:column;z-index:1000;gap:.2em}.participant-count{filter:grayscale(100%);transition:.2s ease-in-out;font-family:"Orbitron",sans-serif;font-size:24px;color:#83cf40;background-color:#2b4317;width:48px;height:48px;display:flex;justify-content:center;align-items:center;border:1px solid #4b7328;cursor:default}.pulse-effect{animation:pulse 500ms ease-out}@keyframes pulse{0%{filter:brightness(1)}50%{filter:brightness(1.5)}100%{filter:brightness(1)}}.shake-effect{animation:shake 500ms cubic-bezier(0.36, 0.07, 0.19, 0.97) both}@keyframes shake{0%{transform:translateX(0)}10%{transform:translateX(-4px)}20%{transform:translateX(6px)}30%{transform:translateX(-8px)}40%{transform:translateX(8px)}50%{transform:translateX(-6px)}60%{transform:translateX(5px)}70%{transform:translateX(-3px)}80%{transform:translateX(2px)}90%{transform:translateX(-1px)}100%{transform:translateX(0)}}.custom-tooltip-popup{position:fixed;background:#161616;color:#dedede;padding:.5em;z-index:1200;font-size:.9em;pointer-events:none;white-space:nowrap;opacity:0;transition:opacity .1s;display:none;flex-direction:column;left:0;top:0;border:1px solid #3c3c3c !important;border-radius:4px !important;box-shadow:0 2px 5px rgba(0,0,0,.3) !important}.custom-tooltip-popup .tooltip-item{display:inline-flex !important;align-items:center !important}.custom-tooltip-popup .tooltip-action{font-weight:500 !important;color:hsl(100,50%,50%) !important}.static-chat-notification{cursor:default;white-space:nowrap;padding:8px;display:inline-flex;flex:0 auto;justify-content:center;margin:4px;font-size:1em;align-items:center;border-radius:4px !important}.dynamic-chat-notifications-container{z-index:1000;width:0;position:fixed;display:flex;flex-direction:column;top:0;bottom:0;left:0;right:0;padding-top:160px}.dynamic-chat-notification{cursor:default;white-space:nowrap;position:relative;align-items:center;width:fit-content;display:flex;margin-bottom:.2em;padding:8px 16px 8px 12px;border-radius:0 4px 4px 0 !important;left:0;transform:translateX(-100%);opacity:1;transition:transform .3s cubic-bezier(0.83, 0, 0.17, 1),opacity .3s cubic-bezier(0.83, 0, 0.17, 1)}.user-enter{color:hsl(100,50%,50%) !important;background-color:hsl(100,50%,10%) !important;border:1px solid hsl(100,50%,25%) !important}.user-left{color:hsl(0,50%,70%) !important;background-color:hsl(0,50%,15%) !important;border:1px solid #933 !important}.clickable-thumbnail{display:flex !important;opacity:1;transition:opacity .15s ease-in-out;border:none !important;max-width:150px;max-height:150px;cursor:pointer;background-color:rgba(0,0,0,0);margin:6px;overflow:hidden !important}.clickable-thumbnail img{max-height:100%;max-width:100%;background-color:rgba(0,0,0,0);object-fit:contain}.clickable-thumbnail:hover{opacity:.8}.scaled-thumbnail{top:50%;left:50%;transform-origin:center center;transform:translate(-50%, -50%) scale(1);position:fixed;opacity:0;z-index:1000;transform-origin:center center;max-height:90vh;max-width:90vw;cursor:pointer;border-radius:.6em !important;box-shadow:0 4px 6px rgba(0,0,0,.3),0 1px 3px rgba(0,0,0,.28) !important}.video-wrapper{display:flex;flex-direction:column}.video-wrapper .processed-video{margin-bottom:.2em !important}.video-wrapper .youtube-info{display:flex;flex-direction:column;margin-bottom:.2em;font-family:"Montserrat",sans-serift;font-size:.9em;color:#8ede87;font-weight:500;white-space:break-spaces}.video-container,.youtube-thumb{border-radius:.4em !important;display:flex;border:none;height:200px !important;width:356px !important}.youtube-thumb{cursor:pointer !important;object-fit:cover !important}.dimming-background{background:#000;top:0;left:0;right:0;bottom:0;position:fixed;opacity:0;z-index:998}.profile-iframe-container{opacity:0;border:none;display:flex;position:fixed;z-index:1001;width:75vw;min-width:1000px;height:80vh;top:48.5vh;left:50vw;transform:translate(-50%, -50%);box-shadow:0 4px 6px rgba(0,0,0,.1),0 1px 3px rgba(0,0,0,.08) !important;border-radius:.6em !important}.scroll-buttons-container{display:flex;justify-content:center;grid-area:scroll;flex-direction:column;height:calc(100% - 1em);padding:1em}.scroll-buttons-container .scroll-button{margin:.25em 0;background-color:rgba(222,222,222,.1)}.large-button{width:48px;height:48px;display:flex;justify-content:center;align-items:center;cursor:pointer;border-radius:.2em !important;filter:brightness(1);transition:filter .3s ease,opacity .3s ease}.large-button:hover{filter:brightness(0.8)}.panel-control-buttons{display:flex}.panel-control-buttons>div:not(:first-child){margin-left:.5em}.panel-header-parse-button{background-color:hsl(150,40%,25%)}.panel-header-clear-button{background-color:brown}.panel-header-close-button{background-color:#556b2f}.panel-header-save-button{display:none;opacity:0;visibility:hidden;background-color:#2f6b63}.panel-header-import-button{background-color:#502f6b}.panel-header-export-button{background-color:#2f4c6b}.panel-header-copy-button,.panel-header-date-button{background-color:#4682b4}.panel-header-toggle-button{background-color:#144e9d}.panel-header-toggle-media-messages-button{background-color:#2f4f4f !important}.panel-header-toggle-media-messages-button svg{stroke:#71c4c4 !important}.panel-header-toggle-media-messages-button.active{background-color:#71c4c4 !important}.panel-header-toggle-media-messages-button.active svg{stroke:#2f4f4f !important}.panel-header-toggle-mention-messages-button{background-color:#8b4513 !important}.panel-header-toggle-mention-messages-button svg{stroke:#ffa07a !important}.panel-header-toggle-mention-messages-button.active{background-color:#ffa07a !important}.panel-header-toggle-mention-messages-button.active svg{stroke:#8b4513 !important}.panel-header-one-day-back-button,.panel-header-one-day-forward-button{background-color:#008b8b}.panel-header-shuffle-button{background-color:hsl(250,40%,40%)}.panel-header-shuffle-button.today{background-color:hsl(50,100%,15%)}#chat-general .userlist-content{opacity:0}#chat-general .smile-tab{position:relative;z-index:1}.chat-user-list{display:flex;flex-direction:column;position:absolute;top:20px;padding-top:8px;width:200px;height:94%;overflow-y:auto;overflow-x:hidden}.chat-user-list [class^=rank-group]{display:flex;flex-direction:column}.chat-user-list [class^=user]{display:inline-flex;margin:2px 0}.chat-user-list .name{text-decoration:none;display:inline-flex;width:auto;height:24px;line-height:24px;padding:0 8px;max-width:124px;overflow:hidden;text-overflow:ellipsis}.chat-user-list .name:hover{text-decoration:underline}.chat-user-list .profile,.chat-user-list .tracked,.chat-user-list .ignored,.chat-user-list .moderator{display:inline-flex;width:24px;height:24px;justify-content:center;align-items:center}.mention{display:inline-flex;color:#83cf40;font-family:Roboto Mono,monospace;font-weight:bold}.popup-messages-container{display:flex;flex-direction:column;justify-content:flex-end;align-items:start;user-select:none;pointer-events:none;position:fixed;left:0;right:0;top:50px;bottom:0}.popup-chat-message{display:flex;align-items:center;background-color:hsl(100,50%,10%);position:relative;max-width:70vw;border-radius:.2em !important;color:hsl(100,50%,50%);border:1px solid hsl(100,50%,25%);padding:4px;margin:6px 15vw;opacity:0;transform:translateY(20px);transition:opacity .3s ease-in-out,transform .3s ease-in-out;animation:fadeIn .3s ease-in-out forwards}.popup-chat-message>div{padding:2px;display:flex;font-family:"Montserrat",sans-serif}.popup-chat-message .time,.popup-chat-message .time-icon{opacity:.7}.popup-chat-message.fade-out{animation:fadeOut .3s ease-in-out forwards}@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}@keyframes fadeOut{from{opacity:1;transform:translateY(0)}to{opacity:0;transform:translateY(-20px)}}.voice-settings{position:absolute;top:65px;right:70px;opacity:0;transition:opacity .3s ease;font-family:Orbitron,sans-serif}.voice-settings .voice-value-info{display:flex;width:100%;justify-content:center;margin-bottom:6px}.voice-settings .voice-speed{color:hsl(100,50%,50%)}.voice-settings .voice-speed-progress{display:block;width:120px;height:12px;background-color:hsl(90,60%,30%)}.voice-settings .voice-speed-progress .voice-speed-progress-fill{display:block;height:100%;background-color:hsl(90,60%,50%)}.voice-settings .voice-pitch{color:#3cc}.voice-settings .voice-pitch-progress{display:block;width:120px;height:12px;background-color:hsl(180,60%,30%)}.voice-settings .voice-pitch-progress .voice-pitch-progress-fill{display:block;height:100%;background-color:#3cc}@media(max-width: 991px){.scroll-buttons-container{position:absolute !important;right:.5em !important;justify-content:end !important}}@media(max-width: 630px){.scroll-buttons-container{display:none !important}}',""]);const i=r},53:(e,t,n)=>{n.d(t,{A:()=>i});var o=n(601),s=n.n(o),a=n(314),r=n.n(a)()(s());r.push([e.id,"/* toggleHiddenMessages */\n.toggle-button-hidden {\n  background-color: hsl(0, 20%, 10%);\n  color: hsl(0, 50%, 50%);\n  border: 1px solid hsl(0, 50%, 50%);\n}\n\n.toggle-button-show {\n  background-color: hsl(90, 20%, 10%);\n  color: hsl(90, 50%, 50%);\n  border: 1px solid hsl(90, 50%, 50%);\n}\n\n.toggle-button-hide {\n  background-color: hsl(50, 20%, 10%);\n  color: hsl(50, 50%, 50%);\n  border: 1px solid hsl(50, 50%, 50%);\n}\n\n/* Chat messages manual remover */\n/* Delete button base styles */\n.delete-btn {\n  z-index: 999;\n  padding: 8px 16px;\n  background-color: hsl(0, 50%, 20%);\n  color: hsl(0, 60%, 70%);\n  border: 1px solid hsl(0, 50%, 35%);\n  transition: all 0.3s;\n  cursor: pointer;\n  filter: brightness(1);\n  border-radius: 0.2em !important;\n}\n\n.delete-btn:hover {\n  filter: brightness(1.5);\n}\n\n/* Common styles for all selected messages */\n.selected-message {\n  background-clip: padding-box !important;\n}\n\n/* message-mode */\n.selected-message.message-mode {\n  background-color: hsla(0, 50%, 50%, 0.2) !important;\n  box-shadow: inset 0px 0px 0px 1px hsl(0, 50%, 50%, 0.4) !important;\n}\n\n/* username-mode */\n.selected-message.username-mode {\n  background-color: hsla(145, 50%, 30%, 0.2) !important;\n  box-shadow: inset 0px 0px 0px 1px hsl(145, 50%, 50%, 0.4) !important;\n}\n\n/* time-mode */\n.selected-message.time-mode {\n  background-color: hsla(200, 50%, 30%, 0.2) !important;\n  box-shadow: inset 0px 0px 0px 1px hsl(200, 50%, 50%, 0.4) !important;\n}\n\n.shown-message {\n  background-color: hsla(30, 60%, 30%, 0.2) !important;\n  box-shadow: inset 0px 0px 0px 1px hsl(30, 60%, 50%, 0.4) !important;\n  background-clip: padding-box !important;\n}\n\n.hidden-message {\n  display: none;\n}\n\n/* Toggle button base styles */\n.toggle-button {\n  font: bold 0.9em 'Montserrat', sans-serif;\n  position: absolute;\n  top: 0;\n  right: 2em;\n  padding: 8px 16px;\n  transition: filter 0.3s;\n  border-radius: 0 0 0.2em 0.2em !important;\n  border-top: none;\n  min-width: 4em;\n}\n\n.toggle-button.toggle-hidden {\n  background: linear-gradient(to top, hsl(0, 50%, 20%), hsl(0, 50%, 25%));\n  color: hsl(0, 60%, 70%);\n  border-left: 1px solid hsl(0, 50%, 35%);\n  border-right: 1px solid hsl(0, 50%, 35%);\n  border-bottom: 1px solid hsl(0, 50%, 35%);\n}\n\n.toggle-button.toggle-shown {\n  background: linear-gradient(to top, hsl(30, 50%, 20%), hsl(30, 50%, 25%));\n  color: hsl(30, 60%, 70%);\n  border-left: 1px solid hsl(30, 50%, 35%);\n  border-right: 1px solid hsl(30, 50%, 35%);\n  border-bottom: 1px solid hsl(30, 50%, 35%);\n}\n\n.toggle-button:hover {\n  filter: brightness(1.5);\n}",""]);const i=r},56:(e,t,n)=>{e.exports=function(e){var t=n.nc;t&&e.setAttribute("nonce",t)}},72:e=>{var t=[];function n(e){for(var n=-1,o=0;o<t.length;o++)if(t[o].identifier===e){n=o;break}return n}function o(e,o){for(var a={},r=[],i=0;i<e.length;i++){var l=e[i],c=o.base?l[0]+o.base:l[0],d=a[c]||0,u="".concat(c," ").concat(d);a[c]=d+1;var m=n(u),p={css:l[1],media:l[2],sourceMap:l[3],supports:l[4],layer:l[5]};if(-1!==m)t[m].references++,t[m].updater(p);else{var g=s(p,o);o.byIndex=i,t.splice(i,0,{identifier:u,updater:g,references:1})}r.push(u)}return r}function s(e,t){var n=t.domAPI(t);n.update(e);return function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap&&t.supports===e.supports&&t.layer===e.layer)return;n.update(e=t)}else n.remove()}}e.exports=function(e,s){var a=o(e=e||[],s=s||{});return function(e){e=e||[];for(var r=0;r<a.length;r++){var i=n(a[r]);t[i].references--}for(var l=o(e,s),c=0;c<a.length;c++){var d=n(a[c]);0===t[d].references&&(t[d].updater(),t.splice(d,1))}a=l}}},113:e=>{e.exports=function(e,t){if(t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}},314:e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var n="",o=void 0!==t[5];return t[4]&&(n+="@supports (".concat(t[4],") {")),t[2]&&(n+="@media ".concat(t[2]," {")),o&&(n+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),n+=e(t),o&&(n+="}"),t[2]&&(n+="}"),t[4]&&(n+="}"),n})).join("")},t.i=function(e,n,o,s,a){"string"==typeof e&&(e=[[null,e,void 0]]);var r={};if(o)for(var i=0;i<this.length;i++){var l=this[i][0];null!=l&&(r[l]=!0)}for(var c=0;c<e.length;c++){var d=[].concat(e[c]);o&&r[d[0]]||(void 0!==a&&(void 0===d[5]||(d[1]="@layer".concat(d[5].length>0?" ".concat(d[5]):""," {").concat(d[1],"}")),d[5]=a),n&&(d[2]?(d[1]="@media ".concat(d[2]," {").concat(d[1],"}"),d[2]=n):d[2]=n),s&&(d[4]?(d[1]="@supports (".concat(d[4],") {").concat(d[1],"}"),d[4]=s):d[4]="".concat(s)),t.push(d))}},t}},540:e=>{e.exports=function(e){var t=document.createElement("style");return e.setAttributes(t,e.attributes),e.insert(t,e.options),t}},601:e=>{e.exports=function(e){return e[1]}},629:(e,t,n)=>{n.d(t,{A:()=>i});var o=n(601),s=n.n(o),a=n(314),r=n.n(a)()(s());r.push([e.id,'.settings-panel{opacity:0;background-color:#1b1b1b;border-radius:.6em !important;position:fixed;top:100px;left:50%;transform:translateX(-50%);width:50vw;height:80vh;z-index:1000;min-width:1000px;display:grid;grid-template-columns:1fr;grid-template-rows:min-content;grid-template-areas:"header header" "settings scroll"}.settings-panel .panel-header{display:flex;flex-direction:row;justify-content:flex-end;padding:.6em;grid-area:header}.settings-panel .settings-content-container{overflow-y:auto;height:calc(100% - .5em);padding:1em;grid-area:settings}.settings-panel .settings-description{position:relative;font:1em Montserrat;color:#deb887;background-color:rgba(222,184,135,.1);width:fit-content;margin:0 0 1em;padding:.4em .8em;border-radius:.4em !important;left:50%;transform:translateX(-50%)}.settings-panel .settings-spoiler button{display:inline-flex !important;width:230px !important;position:relative;font:1em Montserrat;color:#90ee90;background-color:rgba(222,184,135,.1);margin:0 0 3em 0;padding:.4em .8em;border-radius:.4em !important;left:50%;transform:translateX(-50%);cursor:pointer;transition:background-color .3s ease;border:none}.settings-panel .settings-spoiler button:hover{background-color:rgba(222,184,135,.25)}.settings-panel .settings-field{height:30px;max-width:200px;min-width:150px;padding:.4em;font:1em Montserrat;font-family:Montserrat;color:bisque;border-radius:.2em !important;box-sizing:border-box;background-color:#111;border:1px solid #222}.settings-panel .settings-button{width:30px;height:30px;display:flex;justify-content:center;align-items:center;border-radius:.2em !important;cursor:pointer;transition:filter .3s;filter:brightness(1)}.settings-panel .settings-button:hover{filter:brightness(0.8)}.settings-panel .settings-button.disabled{filter:grayscale(1);pointer-events:none;opacity:.5}.settings-panel select{height:30px;min-width:105px;max-width:120px;padding:.4em;font:1em Montserrat,sans-serif;color:bisque !important;border-radius:.2em !important;box-sizing:border-box;background-color:#111 !important;border:1px solid #222 !important}.settings-panel option{height:30px;background-color:#111 !important;color:bisque !important;font-family:"Montserrat",sans-serif}.settings-panel .remove-settings-button{stroke:#ee9090;background-color:#6b2f2f}.settings-panel .assigned-settings-button{stroke:#b0c4de;background-color:#4682b4}.settings-panel .add-settings-button{stroke:#d190ee;background-color:#502f6b}.settings-panel .toggle-item{display:inline-flex;align-items:center;gap:1em}.settings-panel .toggle-description{cursor:pointer;color:#deb887;transition:color .15s ease-in-out}.settings-panel .toggle-description:hover{color:#fafad2}.settings-panel .settings-container{width:100%;gap:.4em;display:inline-flex;flex-wrap:wrap;align-items:start;margin-bottom:4em}.settings-panel .settings-toggle-container{flex-direction:column}.settings-panel [class$=item]{display:inline-flex;gap:.4em}@media(max-width: 1199px){.settings-panel{width:90vw;height:85vh;min-width:unset}.settings-panel .settings-field,.settings-panel select{max-width:180px}}@media(max-width: 991px){.settings-panel{width:95vw;height:90vh;grid-template-columns:1fr;grid-template-rows:min-content auto;grid-template-areas:"header" "settings"}.settings-panel .panel-header{flex-wrap:wrap}.settings-panel .settings-field,.settings-panel select{max-width:160px;min-width:120px}.settings-panel .settings-container{flex-direction:column;align-items:flex-start}}@media(max-width: 576px){.settings-panel{width:100vw;height:100vh;top:0;left:0;transform:none;border-radius:0 !important}.settings-panel .settings-description,.settings-panel .toggle-description{font-size:.9em}.settings-panel .settings-container{flex-direction:column;gap:.2em;margin-bottom:2em}.settings-panel .toggle-item{gap:.5em}.settings-panel [class$=item]{gap:.2em}}',""]);const i=r},659:e=>{var t={};e.exports=function(e,n){var o=function(e){if(void 0===t[e]){var n=document.querySelector(e);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(e){n=null}t[e]=n}return t[e]}(e);if(!o)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");o.appendChild(n)}},805:(e,t,n)=>{n.d(t,{A:()=>i});var o=n(601),s=n.n(o),a=n(314),r=n.n(a)()(s());r.push([e.id,'.chat-logs-button{position:relative;z-index:1}.chat-logs-panel{opacity:0;background-color:#1b1b1b;border-radius:.6em !important;position:fixed;top:100px;left:50%;transform:translateX(-50%);width:80vw;height:80vh;z-index:1000;min-width:1000px;display:grid;grid-template-columns:1fr;grid-template-rows:min-content;grid-template-areas:"header header header" "messages scroll users"}.chat-logs-panel .panel-header{display:flex;flex-direction:row;grid-area:header;justify-content:flex-end;padding:.6em}.chat-logs-panel .panel-control-buttons{display:flex}.chat-logs-panel .search-for-chatlogs-messages{width:100%;margin:0 .5em 0 0;display:flex}.chat-logs-panel .chatlogs-search-input{outline:none;height:48px;width:100%;padding:10px;font-size:1em;font-family:Montserrat;color:bisque !important;border-radius:.2em !important;box-sizing:border-box;background-color:#111;border:1px solid #222 !important}.chat-logs-panel .chatlogs-date-input{background-color:#111;color:bisque;border:1px solid #222;width:fit-content;height:48px;padding:10px;font-size:1em;font-family:Montserrat;border-radius:.2em !important;box-sizing:border-box;margin:0 .5em}.chat-logs-panel .chat-logs-container{overflow-y:auto;overflow-x:hidden;height:calc(100% - .5em);padding:1em;display:flex;grid-area:messages;flex-direction:column}.chat-logs-panel .message-item{padding:.2em;display:inline-flex;cursor:pointer;align-items:start}.chat-logs-panel .message-time{color:#8fbc8f;margin:0 .4em;cursor:pointer;transition:color .2s ease;height:fit-content}.chat-logs-panel .message-time:hover{color:#90ee90}.chat-logs-panel .message-username{cursor:pointer;margin:0 .4em;height:fit-content}.chat-logs-panel .message-text{color:#b0c4de;margin:0 .4em;overflow-wrap:anywhere;height:fit-content}.chat-logs-panel .active-users{padding:1em;height:calc(100% - 1em);width:fit-content;overflow-y:auto;overflow-x:hidden;grid-area:users;display:flex;flex-direction:column}.chat-logs-panel .active-users .active-user-item{display:flex;height:fit-content;align-items:center;justify-content:left;margin:.2em 0;cursor:pointer;transition:filter .15s}.chat-logs-panel .active-users .active-user-item:hover{filter:brightness(0.8)}.chat-logs-panel .active-users .active-user-item .active-user-name{padding:.4em}.chat-logs-panel .active-users .active-user-item .active-user-messages-count{padding:.4em;border-radius:.2em !important}.chat-logs-panel .saved-chatlog-url{color:#8fbc8f !important;text-decoration:none;display:inline-flex;padding:.5em}.chat-logs-panel .saved-chatlog-url-title{color:#b0c4de;padding:.5em}.chat-logs-panel .saved-chatlog-container{display:flex;flex-direction:column;overflow-y:auto;background-color:#1e282d;border:1px solid #3c4650 !important;border-radius:.2em !important;position:absolute;padding:.5em;height:fit-content;width:max-content;max-height:400px;top:calc(50px + 1em);right:0}@media(max-width: 1199px){.chat-logs-panel{width:90vw;height:85vh;min-width:unset}.chat-logs-panel .active-users{width:200px}}@media(max-width: 991px){.chat-logs-panel{width:95vw;height:90vh;grid-template-columns:1fr;grid-template-rows:min-content auto auto;grid-template-areas:"header" "messages" "users"}.chat-logs-panel .active-users{width:100%;height:auto;max-height:200px;overflow-y:auto}.chat-logs-panel .panel-header{flex-direction:column;align-items:flex-start}.chat-logs-panel .search-for-chatlogs-messages{width:100%;margin-bottom:.5em}.chat-logs-panel .panel-control-buttons{width:100%;justify-content:center}.chat-logs-panel .active-users,.chat-logs-panel .panel-header-toggle-button{display:none !important}}@media(max-width: 576px){.chat-logs-panel{width:100vw;height:100vh;top:0;left:0;transform:none;border-radius:0 !important}.chat-logs-panel .panel-header{padding:.5em}.chat-logs-panel .active-users{display:none}.chat-logs-panel .message-item{padding:.1em}.chat-logs-panel .message-time,.chat-logs-panel .message-username,.chat-logs-panel .message-text{margin:0 .2em;font-size:.9em}.chat-logs-panel .video-container,.chat-logs-panel .youtube-thumb{transform-origin:top left;transform:scale(0.8)}.chat-logs-panel .toggle-mention-messages-counter,.chat-logs-panel .toggle-media-messages-counter{font-size:10px}.chat-logs-panel .saved-chatlog-container{max-height:300px}}.toggle-mention-messages-counter,.toggle-media-messages-counter{display:flex;position:absolute;justify-content:center;align-items:center;padding:2px 4px;border-radius:2px !important;font-size:12px;font-family:Roboto;font-weight:bold;bottom:0px;left:0px;transform:translate(-50%, 50%);color:#020202;pointer-events:none;user-select:none}.toggle-mention-messages-counter{background-color:#ffa07a;box-shadow:0 0 4px rgba(0,0,0,.5) !important}.toggle-media-messages-counter{background-color:#71c4c4;box-shadow:0 0 4px rgba(0,0,0,.5) !important}',""]);const i=r},807:(e,t,n)=>{n.d(t,{A:()=>i});var o=n(601),s=n.n(o),a=n(314),r=n.n(a)()(s());r.push([e.id,'.personal-messages-button{position:relative;z-index:2}.personal-messages-button .message-count{display:flex;position:absolute;justify-content:center;align-items:center;height:20px;padding:0 4px;border-radius:2px !important;color:#020202;font-size:12px;font-family:Roboto,sans-serif;font-weight:bold;bottom:0}.personal-messages-button .total-message-count{left:0;transform:translate(-50%, 50%);background-color:salmon}.personal-messages-button .new-message-count{right:0;transform:translate(50%, 50%);background-color:gold}.cached-messages-panel{opacity:0;background-color:#1b1b1b;border-radius:.6em !important;position:fixed;top:100px;left:50%;transform:translateX(-50%);width:50vw;height:80vh;z-index:1000;min-width:1000px;display:grid;grid-template-columns:1fr;grid-template-rows:min-content;grid-template-areas:"header header" "messages scroll"}.cached-messages-panel .panel-header{display:flex;flex-direction:row;justify-content:flex-end;padding:.6em;grid-area:header}.cached-messages-panel .search-for-personal-messages{width:100%;margin:0 .5em 0 0;display:flex}.cached-messages-panel .personal-messages-search-input{outline:none;height:48px;width:100%;padding:10px;font-size:1em;font-family:Montserrat,sans-serif;color:bisque !important;border-radius:.2em !important;box-sizing:border-box;background-color:#111;border:1px solid #222 !important}.cached-messages-panel .messages-container{overflow-y:auto;height:calc(100% - .5em);padding:1em;grid-area:messages}.cached-messages-panel .message-item{padding:.2em}.cached-messages-panel .message-time{display:inline-flex;margin:0px .4em;height:fit-content;cursor:pointer;transition:color .2s ease}.cached-messages-panel .message-username{display:inline-flex;cursor:pointer;margin:0px .4em;height:fit-content}.cached-messages-panel .message-text{cursor:pointer;margin:0px .4em;height:fit-content}@media(max-width: 1199px){.cached-messages-panel{width:90vw;height:85vh;min-width:unset}}@media(max-width: 991px){.cached-messages-panel{width:95vw;height:90vh;grid-template-columns:1fr;grid-template-rows:min-content auto;grid-template-areas:"header" "messages"}.cached-messages-panel .panel-header{flex-direction:column;align-items:flex-start}.cached-messages-panel .search-for-personal-messages{width:100%;margin-right:0;margin-bottom:.5em}.cached-messages-panel .panel-control-buttons{width:100%;justify-content:center}}@media(max-width: 630px){.cached-messages-panel .panel-header-date-button,.cached-messages-panel .chatlogs-date-input{display:none !important}}@media(max-width: 576px){.cached-messages-panel{width:100vw;height:100vh;top:0;left:0;transform:none;border-radius:0 !important}.cached-messages-panel .panel-header{padding:.5em}.cached-messages-panel .message-item{padding:.1em}.cached-messages-panel .message-time,.cached-messages-panel .message-username,.cached-messages-panel .message-text{margin:0 .2em;font-size:.9em}.cached-messages-panel .video-container,.cached-messages-panel .youtube-thumb{transform-origin:top left;transform:scale(0.8)}.cached-messages-panel .message-count{font-size:10px;height:16px;padding:0 3px}}',""]);const i=r},825:e=>{e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var t=e.insertStyleElement(e);return{update:function(n){!function(e,t,n){var o="";n.supports&&(o+="@supports (".concat(n.supports,") {")),n.media&&(o+="@media ".concat(n.media," {"));var s=void 0!==n.layer;s&&(o+="@layer".concat(n.layer.length>0?" ".concat(n.layer):""," {")),o+=n.css,s&&(o+="}"),n.media&&(o+="}"),n.supports&&(o+="}");var a=n.sourceMap;a&&"undefined"!=typeof btoa&&(o+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(a))))," */")),t.styleTagTransform(o,e,t.options)}(t,e,n)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(t)}}}}},t={};function n(o){var s=t[o];if(void 0!==s)return s.exports;var a=t[o]={id:o,exports:{}};return e[o](a,a.exports,n),a.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var o in t)n.o(t,o)&&!n.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.nc=void 0;n.d({},{f:()=>Rs});var o=n(72),s=n.n(o),a=n(825),r=n.n(a),i=n(659),l=n.n(i),c=n(56),d=n.n(c),u=n(540),m=n.n(u),p=n(113),g=n.n(p),h=n(11),f={};f.styleTagTransform=g(),f.setAttributes=d(),f.insert=l().bind(null,"head"),f.domAPI=r(),f.insertStyleElement=m();s()(h.A,f);h.A&&h.A.locals&&h.A.locals;const y="https://klavogonki.ru/u/#/",v=document.querySelector(".userpanel .user-block .user-dropdown .name span").textContent,b=document.querySelector("a.drop-btn.mail")?.href?.match(/\/u\/#\/(\d+)\/messages\//)?.[1],x=new Intl.DateTimeFormat("en-CA").format(new Date),w="2012-12-02",S=2.5,C=["😀","😁","😂","🤣","😃","😄","😅","😆","😉","😊","😋","😎","😏","😐","😑","😒","😓","😔","😕","😖","😗","😘","😙","😚","😜","😝","😛","🤑","🤗","🤔","🤐","🤨","😣","😥","😮","🤯","😳","😱","😨","😰","😢","🤪","😵","😲","🤤","😷","🤒","🤕","🤢","🤧","😇","🥳","🥺","😬","😴","😌","🤥","🥴","🥵","🥶","🤧","🤭","🤫","😠","😡","😳","😞","😟","😕","🐱","😺","😸","😹","😻","😼","😽","🙀","😿","😾","🐶","🐭","🐹","🐰","🦊","🐻","🐼","🐨","🐯","🦁","🐮","🐷","🐸","🐵","🙈","🙉","🙊","🐔","🦄"];let k={bigImageEvents:{},panelsEvents:{},fetchedUsers:JSON.parse(localStorage.getItem("fetchedUsers"))||{}};const E=function(e){const[t,n=0,o=0]=e.split(":").map(Number);return t+n/60+o/3600}(localStorage.getItem("cacheRefreshThresholdHours")||(localStorage.setItem("cacheRefreshThresholdHours",24),24)),$=["klavogonki.ru","youtube.com","youtu.be","imgur.com","pikabu.ru","userapi.com","ibb.co","yaplakal.com","freepik.com","fastpic.org"];function L(e){const[t,n,o]=e.match(/\d+/g).map(Number),{h:s,s:a,l:r}=function(e,t,n){e/=255,t/=255,n/=255;const o=Math.max(e,t,n),s=Math.min(e,t,n);let a,r,i=(o+s)/2;if(o===s)a=r=0;else{const l=o-s;r=i<.5?l/(o+s):l/(2-o-s),a=(o===e?(t-n)/l+(t<n?6:0):o===t?(n-e)/l+2:(e-t)/l+4)/6}return a=Math.round(360*a),r=Math.min(Math.round(100*r),90),i=Math.round(100*i),a>215&&a<280&&(a=a<255?215:280),{h:a,s:r,l:i}}(t,n,o),i=function(e,t,n){let o,s,a;if(n/=100,0==(t/=100))o=s=a=255*n;else{const r=n<.5?n*(1+t):n+t-n*t,i=2*n-r,l=(e,t,n)=>(n<0&&(n+=1),n>1&&(n-=1),n<1/6?e+6*(t-e)*n:n<.5?t:n<2/3?e+(t-e)*(2/3-n)*6:e);o=Math.round(255*l(i,r,e/360+1/3)),s=Math.round(255*l(i,r,e/360)),a=Math.round(255*l(i,r,e/360-1/3))}return`rgb(${o}, ${s}, ${a})`}(s,a,r<50?50:r);return i}function T(e,t=0,n=0){const o=[{transform:`translate(${t}%, calc(${n}%)) scale(1)`},{transform:`translate(${t}%, calc(${n}% - 60%)) scale(1.1)`},{transform:`translate(${t}%, calc(${n}% + 15%)) scale(1)`},{transform:`translate(${t}%, calc(${n}% - 20%)) scale(1.05)`},{transform:`translate(${t}%, calc(${n}% + 8%)) scale(1)`},{transform:`translate(${t}%, calc(${n}% - 10%)) scale(1.05)`},{transform:`translate(${t}%, calc(${n}% + 4%)) scale(1)`},{transform:`translate(${t}%, calc(${n}%)) scale(1)`}];return e.animate(o,{duration:500,easing:"ease",iterations:1}).finished}function M(e){e.classList.add("shake-effect"),setTimeout((()=>{e.classList.remove("shake-effect")}),500)}function N(e){e.classList.add("pulse-effect"),setTimeout((()=>{e.classList.remove("pulse-effect")}),500)}let{panelsEvents:q,bigImageEvents:A,fetchedUsers:I}=k;const j=e=>window.location.href.includes(e);function O(){Object.entries(A).forEach((([e,t])=>{document.removeEventListener(e,t)}))}function B(){Object.values(q).forEach((e=>{document.removeEventListener("keydown",e)})),Object.keys(q).forEach((e=>delete q[e]));const e=document.querySelector(".popup-panel");e&&e.remove()}const D=(e,t=300)=>{let n;return function(...o){clearTimeout(n),n=setTimeout((()=>e.apply(this,o)),t)}};let H=null;function P(e,t){const n=(JSON.parse(localStorage.getItem("toggle"))||[]).find((n=>n.category===e&&n.type===t));return!n||"yes"===n.option}function F(){return(new Date).toLocaleTimeString("en-US",{hour12:!1,hour:"2-digit",minute:"2-digit",second:"2-digit"})}const U=e=>{try{const{hostname:t}=new URL(e),n=t.toLowerCase().split(".").slice(-2).join(".");return{isTrusted:$.includes(n),domain:n}}catch(t){return console.error("Error in isTrustedDomain:",t.message),{isTrusted:!1,domain:e}}};let z=localStorage.personalMessages&&Object.keys(JSON.parse(localStorage.personalMessages)).length||0;function _(){const e=document.querySelector(".personal-messages-button .total-message-count"),t=document.querySelector(".personal-messages-button .new-message-count");if(!e||!t)return;const n=JSON.parse(localStorage.getItem("personalMessages"))||{},o=Object.keys(n).length;let s=Number(localStorage.getItem("newMessagesCount"))||0;o>z&&(s++,localStorage.setItem("newMessagesCount",s),N(t),T(t,50,50)),e.textContent=o,t.textContent=s,t.style.visibility=s>0?"visible":"hidden",o!==z&&N(e),z=o}function R(e){return!!e&&["Клавобот","Пользователь","заблокирован"].every((t=>e.includes(t)))}function J(e,t){if(e)if("one"===t){const t=e.querySelector("span[data-user]");if(!t)return;const n=L(getComputedStyle(e).color);e.style.setProperty("color",n,"important"),t.style.setProperty("filter","invert(0)","important")}else"all"===t?Array.from(e).forEach((e=>{if(!e)return;const t=e.querySelector("span[data-user]");if(!t)return;const n=L(getComputedStyle(e).color);e.style.setProperty("color",n,"important"),t.style.setProperty("filter","invert(0)","important")})):console.error("Invalid mode. Use 'one' or 'all'.")}function K(e,t,n){const o=`https://klavogonki.ru/chatlogs/${e}.html#${t}`;navigator.clipboard&&navigator.clipboard.writeText(o).then((()=>{M(n),function(){if(window.getSelection){const e=window.getSelection();e&&e.removeAllRanges&&e.removeAllRanges()}}()}))}function V(){return window.getSelection().toString().length>0}function X(e){let t="";for(const n of e.childNodes)n.nodeType===Node.TEXT_NODE?t+=n.textContent:n.nodeType===Node.ELEMENT_NODE&&("IMG"===n.tagName?t+=n.title||n.alt||"":t+=X(n));return t.trim()}function Y(){try{const e=(JSON.parse(localStorage.getItem("toggle"))||[]).find((e=>"ui"===e.category&&"language"===e.type));return e?.option||"en"}catch{return"en"}}var G=n(629),W={};W.styleTagTransform=g(),W.setAttributes=d(),W.insert=l().bind(null,"head"),W.domAPI=r(),W.insertStyleElement=m();s()(G.A,W);G.A&&G.A.locals&&G.A.locals;const Z="http://www.w3.org/2000/svg",Q=`\n  <svg xmlns="${Z}"\n      width="16"\n      height="16"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="currentColor"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="icon-enter icon-feather icon-log-in">\n    <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>\n    <polyline points="10 17 15 12 10 7"></polyline>\n    <line x1="15" y1="12" x2="3" y2="12"></line>\n  </svg>`,ee=`\n  <svg xmlns="${Z}"\n      width="16"\n      height="16"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="currentColor" stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="icon-leave icon-feather icon-log-out">\n    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>\n    <polyline points="16 17 21 12 16 7"></polyline>\n    <line x1="21" y1="12" x2="9" y2="12"></line>\n  </svg>`,te=`\n  <svg xmlns="${Z}"\n      width="18"\n      height="18"\n      viewBox="0 0 24 24"\n      fill="url(#moderatorGradient)"  \x3c!-- Use a gradient fill --\x3e\n      stroke="none"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-shield">\n    \x3c!-- Define the gradient --\x3e\n    <defs>\n        <linearGradient id="moderatorGradient" x1="0%" y1="0%" x2="0%" y2="100%">\n            <stop offset="0%" style="stop-color: rgb(255, 215, 0); stop-opacity: 1" />\n            <stop offset="100%" style="stop-color: rgb(255, 140, 0); stop-opacity: 1" />\n        </linearGradient>\n    </defs>\n    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>\n  </svg>`,ne=`\n  <svg xmlns="${Z}"\n       width="16"\n       height="16"\n       viewBox="0 0 24 24"\n       fill="url(#trackedGradient)"  \x3c!-- Use a gradient fill --\x3e\n       class="feather feather-star">\n      \x3c!-- Define the gradient for the fill --\x3e\n    <defs>\n      <linearGradient id="trackedGradient" x1="0%" y1="0%" x2="0%" y2="100%">\n        <stop offset="0%" style="stop-color: rgb(135, 206, 250); stop-opacity: 1" />\n        <stop offset="100%" style="stop-color: rgb(0, 191, 255); stop-opacity: 1" />\n      </linearGradient>\n    </defs>\n    \x3c!-- Use the gradient for the fill --\x3e\n    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"\n      stroke="url(#trackedGradient)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round">\n    </polygon>\n  </svg>`,oe=`\n  <svg xmlns="${Z}"\n      width="16"\n      height="16"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(255, 160, 122)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-slash">\n    <circle cx="12" cy="12" r="10"></circle>\n    <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>\n  </svg>`,se=`\n  <svg xmlns="${Z}"\n      width="28"\n      height="28"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="hsl(355, 80%, 65%)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round">\n    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>\n    <line x1="23" y1="9" x2="17" y2="15"></line>\n    <line x1="17" y1="9" x2="23" y2="15"></line>\n  </svg>`,ae=`\n  <svg xmlns="${Z}"\n      width="28"\n      height="28"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="hsl(55, 80%, 65%)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round">\n    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>\n    <path d="M19.07 4.93a10 10 0 0 1 0 14.14" opacity="0.3"></path>\n    <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>\n  </svg>`,re=`\n  <svg xmlns="${Z}"\n      width="28"\n      height="28"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="hsl(80, 80%, 40%)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round">\n    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>\n    <path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>\n    <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>\n  </svg>`,ie=`\n  <svg xmlns="${Z}"\n      width="28"\n      height="28"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="hsl(100, 50%, 50%)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round">\n    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>\n    <circle cx="9" cy="7" r="4"></circle>\n    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>\n    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>\n  </svg>`,le=`\n  <svg xmlns="${Z}"\n      width="28"\n      height="28"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="hsl(180, 60%, 50%)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round">\n    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>\n    <circle cx="12" cy="7" r="4"></circle>\n  </svg>`,ce=`\n  <svg xmlns="${Z}"\n      width="16"\n      height="16"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="currentColor"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-slash">\n    <circle cx="12" cy="12" r="10"></circle>\n    <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>\n  </svg>`,de=`\n  <svg xmlns="${Z}"\n      width="28"\n      height="28"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(255, 160, 122)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-mail">\n    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>\n    <polyline points="22,6 12,13 2,6"></polyline>\n  </svg>`,ue=`\n  <svg xmlns="${Z}"\n      width="28"\n      height="28"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(100, 149, 237)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-message-circle">\n      <path \n          d="M21 11.5 a8.38 8.38 0 0 1 -.9 3.8 a8.5 8.5 0 0 1 -7.6 4.7 a8.38 8.38 0 0 1 -3.8 -.9\n          L3 21 l1.9 -5.7 a8.38 8.38 0 0 1 -.9 -3.8 a8.5 8.5 0 0 1 4.7 -7.6\n          a8.38 8.38 0 0 1 3.8 -.9 h.5 a8.48 8.48 0 0 1 8 8 v.5 z">\n      </path>\n  </svg>`,me=`\n  <svg xmlns="${Z}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="currentColor"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-film">\n    <rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"></rect>\n    <line x1="7" y1="2" x2="7" y2="22"></line>\n    <line x1="17" y1="2" x2="17" y2="22"></line>\n    <line x1="2" y1="12" x2="22" y2="12"></line>\n    <line x1="2" y1="7" x2="7" y2="7"></line>\n    <line x1="2" y1="17" x2="7" y2="17"></line>\n    <line x1="17" y1="17" x2="22" y2="17"></line>\n    <line x1="17" y1="7" x2="22" y2="7"></line>\n  </svg>`,pe=`\n  <svg xmlns="${Z}"\n      width="16"\n      height="16"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(255, 100, 100)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-slash">\n    <circle cx="12" cy="12" r="10"></circle>\n    <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>\n  </svg>`,ge=`\n  <svg xmlns="${Z}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(255, 228, 196)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-sliders">\n    <line x1="4" y1="21" x2="4" y2="14"></line>\n    <line x1="4" y1="10" x2="4" y2="3"></line>\n    <line x1="12" y1="21" x2="12" y2="12"></line>\n    <line x1="12" y1="8" x2="12" y2="3"></line>\n    <line x1="20" y1="21" x2="20" y2="16"></line>\n    <line x1="20" y1="12" x2="20" y2="3"></line>\n    <line x1="1" y1="14" x2="7" y2="14"></line>\n    <line x1="9" y1="8" x2="15" y2="8"></line>\n    <line x1="17" y1="16" x2="23" y2="16"></line>\n  </svg>`,he=`\n  <svg xmlns="${Z}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(144, 238, 144)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-x">\n    <line x1="18" y1="6" x2="6" y2="18"></line>\n    <line x1="6" y1="6" x2="18" y2="18"></line>\n  </svg>`,fe="rgb(211, 211, 211)",ye=`\n  <svg xmlns="${Z}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="${fe}"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevrons-up">\n    <polyline points="17 11 12 6 7 11"></polyline>\n    <polyline points="17 18 12 13 7 18"></polyline>\n  </svg>`,ve=`\n  <svg xmlns="${Z}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="${fe}"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-up">\n    <polyline points="18 15 12 9 6 15"></polyline>\n  </svg>`,be=`\n  <svg xmlns="${Z}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="${fe}"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down">\n    <polyline points="6 9 12 15 18 9"></polyline>\n  </svg>`,xe=`\n  <svg xmlns="${Z}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="${fe}"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevrons-down">\n    <polyline points="7 13 12 18 17 13"></polyline>\n    <polyline points="7 6 12 11 17 6"></polyline>\n  </svg>`,we=`\n  <svg xmlns="${Z}"\n      width="24"\n      height="24"\n      viewBox="0 0 25 25"\n      fill="none"\n      stroke="rgb(137, 187, 255)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-toggle-right">\n    <rect x="1" y="5" width="22" height="14" rx="7" ry="7"></rect>\n    <circle cx="16" cy="12" r="3"></circle>\n  </svg>`,Se=`\n  <svg xmlns="${Z}"\n      width="24"\n      height="24"\n      viewBox="0 0 25 25"\n      fill="none"\n      stroke="rgb(137, 187, 255)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-toggle-left">\n    <rect x="1" y="5" width="22" height="14" rx="7" ry="7"></rect>\n    <circle cx="8" cy="12" r="3"></circle>\n  </svg>`,Ce=`\n  <svg xmlns="${Z}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(176, 196, 222)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar">\n    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>\n    <line x1="16" y1="2" x2="16" y2="6"></line>\n    <line x1="8" y1="2" x2="8" y2="6"></line>\n    <line x1="3" y1="10" x2="21" y2="10"></line>\n  </svg>`,ke=`\n  <svg xmlns="${Z}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(176, 196, 222)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-clipboard">\n    <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>\n    <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>\n  </svg>`,Ee=`\n  <svg xmlns="${Z}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(28, 229, 229)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-left">\n    <polyline points="15 18 9 12 15 6"></polyline>\n  </svg>`,$e=`\n  <svg xmlns="${Z}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(28, 229, 229)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right">\n      <polyline points="9 18 15 12 9 6"></polyline>\n  </svg>`,Le=`\n  <svg xmlns="${Z}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="hsl(250, 40%, 80%)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-shuffle">\n    <polyline points="16 3 21 3 21 8"></polyline>\n    <line x1="4" y1="20" x2="21" y2="3"></line>\n    <polyline points="21 16 21 21 16 21"></polyline>\n    <line x1="15" y1="15" x2="21" y2="21"></line>\n    <line x1="4" y1="4" x2="9" y2="9"></line>\n  </svg>`,Te=`\n  <svg xmlns="${Z}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="hsl(50, 100%, 50%)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun">\n    <circle cx="12" cy="12" r="5"></circle>\n    <line x1="12" y1="1" x2="12" y2="3"></line>\n    <line x1="12" y1="21" x2="12" y2="23"></line>\n    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>\n    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>\n    <line x1="1" y1="12" x2="3" y2="12"></line>\n    <line x1="21" y1="12" x2="23" y2="12"></line>\n    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>\n    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>\n  </svg>`,Me=`\n  <svg xmlns="${Z}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(255, 140, 0)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-trash-2">\n    <polyline points="3 6 5 6 21 6"></polyline>\n    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>\n    <line x1="10" y1="11" x2="10" y2="17"></line>\n    <line x1="14" y1="11" x2="14" y2="17"></line>\n  </svg>`,Ne=`\n  <svg xmlns="${Z}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(209, 144, 238)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-download">\n    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>\n    <polyline points="7 10 12 15 17 10"></polyline>\n    <line x1="12" y1="15" x2="12" y2="3"></line>\n  </svg>`,qe=`\n  <svg xmlns="${Z}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(144, 185, 238)"\n      stroke-width="2" stroke-linecap="round"\n      stroke-linejoin="round" class="feather feather-upload">\n    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>\n    <polyline points="17 8 12 3 7 8"></polyline>\n    <line x1="12" y1="3" x2="12" y2="15"></line>\n  </svg>`,Ae=`\n  <svg xmlns="${Z}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(144, 238, 220)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-save">\n    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>\n    <polyline points="17 21 17 13 7 13 7 21"></polyline>\n    <polyline points="7 3 7 8 15 8"></polyline>\n  </svg>`,Ie=`\n  <svg xmlns="${Z}"\n      width="16"\n      height="16"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(238, 144, 144)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-trash">\n    <polyline points="3 6 5 6 21 6"></polyline>\n    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>\n  </svg>`,je=`\n  <svg xmlns="${Z}"\n      width="20"\n      height="20"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(176, 196, 222)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-snowflake">\n    <g id="snowflake">\n      <line x1="12.06" y1="2.74" x2="12.06" y2="12.06" />\n      <line x1="20.12" y1="7.4" x2="12.06" y2="12.06" />\n      <line x1="20.12" y1="16.71" x2="12.06" y2="12.06" />\n      <line x1="12.06" y1="21.37" x2="12.06" y2="12.06" />\n      <line x1="3.99" y1="16.71" x2="12.06" y2="12.06" />\n      <line x1="3.99" y1="7.4" x2="12.06" y2="12.06" />\n      <polyline points="8.96,4.67 12.06,7.77 15.16,4.67"/>\n      <polyline points="16.9,5.68 15.76,9.92 20,11.05"/>\n      <polyline points="20,13.06 15.76,14.2 16.9,18.43"/>\n      <polyline points="15.16,19.44 12.06,16.34 8.96,19.44"/>\n      <polyline points="7.21,18.43 8.35,14.2 4.11,13.06"/>\n      <polyline points="4.11,11.05 8.35,9.92 7.21,5.68"/>\n    </g>\n  </svg>`,Oe=`\n  <svg xmlns="${Z}"\n      width="16"\n      height="16"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="rgb(209, 144, 238)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-plus">\n    <line x1="12" y1="5" x2="12" y2="19"></line>\n    <line x1="5" y1="12" x2="19" y2="12"></line>\n  </svg>`,Be=`\n  <svg xmlns="${Z}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="hsl(150, 70%, 60%)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-play">\n    <polygon points="5 3 19 12 5 21 5 3"></polygon>\n  </svg>`,De=`\n  <svg xmlns="${Z}"\n      width="24"\n      height="24"\n      viewBox="0 0 24 24"\n      fill="none"\n      stroke="hsl(150, 70%, 60%)"\n      stroke-width="2"\n      stroke-linecap="round" stroke-linejoin="round" class="feather feather-pause">\n    <rect x="6" y="4" width="4" height="16"></rect>\n    <rect x="14" y="4" width="4" height="16"></rect>\n  </svg>`;let He=null,Pe=null,Fe=null,Ue=!1,ze=!1,_e=null;const Re=(e,t)=>{if(!He)return;let n=e+10;const o=He.offsetWidth,s=window.innerWidth;n=Math.min(Math.max(n,10),s-o-10),He.style.left=`${n}px`,He.style.top=`${t+18}px`},Je=e=>He&&Re(e.clientX,e.clientY),Ke=()=>{Ue=!1,_e=null,clearTimeout(Fe),clearTimeout(Pe),Pe=setTimeout((()=>{He&&(He.style.opacity="0",ze=!1,setTimeout((()=>{!Ue&&He&&(He.style.display="none",He.textContent="",document.removeEventListener("mousemove",Je))}),50))}),100)};new MutationObserver((()=>{_e&&!document.contains(_e)&&Ke()})).observe(document,{childList:!0,subtree:!0});const Ve=new WeakMap;function Xe(e){if("object"==typeof e&&null!==e&&!Array.isArray(e)){return e[Y()]||e.en||Object.values(e)[0]}return e}function Ye(e,t){return e.replace(/\$\{([^}]+)\}/g,((e,n)=>t.hasAttribute&&t.hasAttribute(n)?t.getAttribute(n):n in t?t[n]:"text"===n||"textContent"===n?t.textContent||"":e))}function Ge(e,t,n=!1){if(null!=t)if(He||=(()=>{const e=document.createElement("div");return e.classList.add("custom-tooltip-popup"),e.style.display="none",e.style.opacity="0",document.body.appendChild(e),e})(),n){const n=e,o=t,s=arguments[2];Ve.has(o)||Ve.set(o,new Set);const a=Ve.get(o);if(!a.has(n)){a.add(n);const e=e=>{const t=e.target.closest(n);if(!t)return;Ue=!0,_e=t,clearTimeout(Pe),clearTimeout(Fe);let o=s;"function"==typeof o&&(o=o(t)),o=Xe(o),"string"==typeof o&&(o=Ye(o,t)),He.innerHTML=We(o),He.style.display="flex",He.style.opacity="0",He.offsetHeight,Re(e.clientX,e.clientY),document.addEventListener("mousemove",Je),Fe=setTimeout((()=>{He.style.opacity="1",ze=!0}),600)},t=e=>{e.target.closest(n)&&(Ke(),document.removeEventListener("mousemove",Je))},r=e=>{e.target.closest(n)&&Ke()};o.addEventListener("mouseenter",e,!0),o.addEventListener("mouseleave",t,!0),o.addEventListener("click",r,!0)}}else{let n=t;"function"==typeof n&&(n=n(e)),n=Xe(n),"string"==typeof n&&(n=Ye(n,e)),e._tooltipContent=n,e._tooltipInitialized||(e._tooltipInitialized=!0,e.addEventListener("mouseenter",(t=>{Ue=!0,_e=e,clearTimeout(Pe),clearTimeout(Fe),He.innerHTML=We(e._tooltipContent),He.style.display="flex",He.style.opacity="0",He.offsetHeight,Re(t.clientX,t.clientY),document.addEventListener("mousemove",Je),Fe=setTimeout((()=>{He.style.opacity="1",ze=!0}),600)})),e.addEventListener("mouseleave",(()=>{Ke(),document.removeEventListener("mousemove",Je)})),e.addEventListener("click",Ke))}}function We(e){const t=/\[([^\]]+)\]([^\[]*)/g;let n,o="",s=0;for(;null!==(n=t.exec(e));)n.index>s&&(o+=e.slice(s,n.index)),o+=`\n    <div class="tooltip-item">\n      <span class="tooltip-action">${n[1]}</span>&nbsp;\n      <span class="tooltip-message">${n[2].trim()}</span>\n    </div>`,s=t.lastIndex;return s<e.length&&(o+=e.slice(s)),o}let Ze=!1,Qe=!1;function et(e,t,n){e&&(e.offsetHeight,e.style.transition="opacity 0.3s",e.style.opacity="show"===t?n:"0","hide"===t&&e.addEventListener("transitionend",(()=>{"0"===e.style.opacity&&e.remove()}),{once:!0}))}function tt(e,t){e&&(et(e,t,1),e.addEventListener("dblclick",(t=>{const n=document.querySelector(".popup-panel");(t.target===e||t.target.parentElement===e||t.target.parentElement&&t.target.parentElement.parentElement===e)&&(n&&t.target.closest(".scaled-thumbnail")||nt("hide"),et(e,"hide",1))})))}function nt(e){const t=document.querySelector(".chat-logs-panel");"hide"===e&&t&&window.chatlogsParserState&&"function"==typeof window.chatlogsParserState.isRunning&&window.chatlogsParserState.isRunning()&&("function"==typeof window.stopChatlogsParser&&window.stopChatlogsParser(),delete window.chatlogsParserState,delete window.stopChatlogsParser);let n=document.querySelector(".dimming-background"),o=document.querySelector(".scaled-thumbnail");("hide"!==e||n)&&(n||(n=document.createElement("div"),n.classList.add("dimming-background"),document.body.appendChild(n),n.addEventListener("click",(function(){const e=document.querySelector(".popup-panel")||n.previousElementSibling;e&&et(e,"hide",0),nt("hide"),o&&removeBigImageEventListeners()}))),et(n,e,.5),"hide"===e&&o&&(removeBigImageEventListeners(),tt(o,"hide")))}function ot({container:e,buttons:t}){const n=0===e.scrollTop,o=e.scrollTop+e.clientHeight>=e.scrollHeight-3;[t.fullScrollUpButton,t.partialScrollUpButton].forEach((e=>{e.style.opacity=n?"0.3":"1",e.style.pointerEvents=n?"none":"auto"})),[t.fullScrollDownButton,t.partialScrollDownButton].forEach((e=>{e.style.opacity=o?"0.3":"1",e.style.pointerEvents=o?"none":"auto"}))}function st({container:e,scrollButtonsContainer:t}){e.scrollHeight>e.clientHeight?t.style.display="flex":t.style.display="none"}function at(e){const t=document.createElement("div");t.className="scroll-buttons-container";const n=document.createElement("div");n.innerHTML=ye,Ge(n,{en:"Scroll Up (Full)",ru:"Прокрутить вверх (всё)"});const o=document.createElement("div");o.innerHTML=ve,Ge(o,{en:"Scroll Up (Partial)",ru:"Прокрутить вверх (частично)"});const s=document.createElement("div");s.innerHTML=be,Ge(s,{en:"Scroll Down (Partial)",ru:"Прокрутить вниз (частично)"});const a=document.createElement("div");a.innerHTML=xe,Ge(a,{en:"Scroll Down (Full)",ru:"Прокрутить вниз (всё)"});const r={fullScrollUpButton:n,partialScrollUpButton:o,partialScrollDownButton:s,fullScrollDownButton:a};function i(t,n){const o=n?e.scrollHeight:e.clientHeight;e.scrollBy({top:"up"===t?-o:o,behavior:"smooth"}),ot({container:e,buttons:r})}Object.values(r).forEach((e=>{e.classList.add("large-button","scroll-button"),t.appendChild(e)})),n.addEventListener("click",(()=>i("up",!0))),o.addEventListener("click",(()=>i("up",!1))),s.addEventListener("click",(()=>i("down",!1))),a.addEventListener("click",(()=>i("down",!0))),ot({container:e,buttons:r}),st({container:e,scrollButtonsContainer:t});const l=()=>{st({container:e,scrollButtonsContainer:t}),ot({container:e,buttons:r})};e.addEventListener("scroll",l);const c=new ResizeObserver(l);c.observe(e);const d=new MutationObserver(l);d.observe(e,{childList:!0,subtree:!0,characterData:!0,attributes:!0});return{scrollButtonsContainer:t,cleanup:()=>{c.disconnect(),d.disconnect(),e.removeEventListener("scroll",l)}}}["keydown","keyup"].forEach((e=>document.addEventListener(e,(t=>{return n=t.key,o="keydown"===e,"Control"===n&&(Ze=o),void("Alt"===n&&(Qe=o));var n,o})))),["blur","focus"].forEach((e=>document.addEventListener(e,(()=>{(Ze||Qe)&&(console.log(`${Ze?"Ctrl ":""}${Qe?"Alt ":""}key was true`),Ze=!1,Qe=!1)}))));let{panelsEvents:rt}=k;const it=localStorage.getItem("KG_Chat_Empowerment"),lt=it?JSON.parse(it):{voiceSettings:{voiceSpeed:1.5,voicePitch:1},messageSettings:{}};function ct(e,t){e.addEventListener("click",(()=>{const n=e.classList.toggle("assigned-frozen-config");e.classList.toggle("assigned-thawed-config"),e.style.opacity=n?"1":"0.3",function(e,t){const n=localStorage.getItem("usersToTrack");if(n){const o=JSON.parse(n).map((n=>n.name===e?{...n,state:t}:n));localStorage.setItem("usersToTrack",JSON.stringify(o))}}(t,n?"frozen":"thawed")}))}function dt(e){const t=document.createElement("div");return t.className=`${e}-item`,t}function ut(e,t="",n=""){const o=document.createElement("input");return o.className=`settings-field ${e}-field`,o.value=t,o.placeholder=n,o}function mt(e,t){const n=document.createElement("div");return n.className=`settings-button remove-settings-button remove-${e}-word`,n.innerHTML=Ie,function(e,t){e.addEventListener("click",(()=>{t.remove()}))}(n,t),n}it||localStorage.setItem("KG_Chat_Empowerment",JSON.stringify(lt));const pt={spoiler:{tracked:{en:{show:"Show tracked",hide:"Hide tracked"},ru:{show:"Показать отслеживаемых",hide:"Скрыть отслеживаемых"}},mention:{en:{show:"Show mentions",hide:"Hide mentions"},ru:{show:"Показать ключевые слова",hide:"Скрыть ключевые слова"}},replacement:{en:{show:"Show replacements",hide:"Hide replacements"},ru:{show:"Показать замены",hide:"Скрыть замены"}},moderator:{en:{show:"Show moderators",hide:"Hide moderators"},ru:{show:"Показать модераторов",hide:"Скрыть модераторов"}},ignored:{en:{show:"Show ignored",hide:"Hide ignored"},ru:{show:"Показать игнорируемых",hide:"Скрыть игнорируемых"}},toggle:{en:{show:"Show toggles",hide:"Hide toggles"},ru:{show:"Показать переключатели",hide:"Скрыть переключатели"}}},toggleDescriptions:{static:{en:"Show chat static notifications",ru:"Показывать статические уведомления чата"},dynamic:{en:"Show global dynamic notifications",ru:"Показывать глобальные динамические уведомления"},presence:{en:"Play a beep sound and speak feedback when the user enters or leaves the chat",ru:"Воспроизводить звук и озвучивать, когда пользователь входит или выходит из чата"},gTTS:{en:"Switch to google TTS engine if available",ru:"Переключиться на Google TTS, если доступно"},counter:{en:"Create participants counter",ru:"Создать счетчик участников"},language:{en:"Interface language",ru:"Язык интерфейса"}}};function gt(e){const t=dt("tracked"),n=ut("tracked-username",e.name,"Username"),o=ut("tracked-pronunciation",e.pronunciation,"Pronunciation"),s=mt("tracked",t),a=function(e="thawed",t){const n=document.createElement("div");return n.className=`settings-button assigned-settings-button assigned-${e}-config`,n.style.opacity="thawed"===e?"0.3":"1",n.innerHTML=je,ct(n,t),n}("frozen"===e.state?"frozen":"thawed",e.name),r=document.createElement("select");r.className="tracked-gender-select";return[{value:"Male",emoji:"👨"},{value:"Female",emoji:"👩"}].forEach((({value:t,emoji:n})=>{const o=document.createElement("option");o.value=t,o.textContent=`${n} ${t}`,e.gender===t&&(o.selected=!0),r.appendChild(o)})),t.appendChild(n),t.appendChild(r),t.appendChild(o),t.appendChild(s),t.appendChild(a),t}function ht(e,t){const n=dt("toggle"),o=Y();if("language"===e.type){const s=document.createElement("select");s.className="language-toggle-select",(e.languages||[]).forEach((e=>{const t=document.createElement("option");t.value=e.value,t.textContent=e.label,s.appendChild(t)})),s.value=t;const a=document.createElement("span");return a.className="toggle-description",a.textContent=`${e.emoji} ${pt.toggleDescriptions.language[o]}`,n.appendChild(s),n.appendChild(a),n}const s=document.createElement("select");s.className="toggle-select";const a=document.createElement("span");a.className="toggle-description",a.dataset.category=e.category,a.dataset.type=e.type,a.textContent=`${e.emoji} ${pt.toggleDescriptions[e.type][o]}`,a.style.cursor="pointer",a.style.transition="color 0.15s ease-in-out",a.addEventListener("click",(()=>{e.image&&window.open(e.image,"_blank")}));return[{value:"yes",emoji:"✔️"},{value:"no",emoji:"❌"}].forEach((({value:e,emoji:t})=>{const n=document.createElement("option");n.value=e,n.textContent=`${t} ${e}`,s.appendChild(n)})),s.value=t,n.appendChild(s),n.appendChild(a),n}const ft=[{type:"tracked",emoji:"👀",key:"usersToTrack",selector:".settings-tracked-container",creator:gt},{type:"mention",emoji:"📢",key:"mentionKeywords",selector:".settings-mention-container",creator:function(e){const t=dt("mention"),n=ut("mention",e,"Mention Keyword"),o=mt("mention",t);return t.appendChild(n),t.appendChild(o),t}},{type:"replacement",emoji:"♻️",key:"usernameReplacements",selector:".settings-replacement-container",creator:function(e={original:"",replacement:""}){const t=dt("replacement"),n=ut("replacement-original",e.original,"Original username"),o=ut("replacement",e.replacement,"Replacement name"),s=mt("replacement",t);return t.appendChild(n),t.appendChild(o),t.appendChild(s),t}},{type:"moderator",emoji:"⚔️",key:"moderator",selector:".settings-moderator-container",creator:function(e){const t=dt("moderator"),n=ut("moderator",e,"Moderator Name"),o=mt("moderator",t);return t.appendChild(n),t.appendChild(o),t}},{type:"ignored",emoji:"🛑",key:"ignored",selector:".settings-ignored-container",creator:function(e){const t=dt("ignored"),n=ut("ignored",e,"Ignored User"),o=mt("ignored",t);return t.appendChild(n),t.appendChild(o),t}},{type:"toggle",emoji:"🔘",key:"toggle",selector:".settings-toggle-container",creator:ht}],yt=[{emoji:"👀",description:"Show chat static notifications",image:"https://i.imgur.com/oUPSi9I.jpeg",category:"notifications",type:"static"},{emoji:"👀",description:"Show global dynamic notifications",image:"https://i.imgur.com/8ffCdUG.jpeg",category:"notifications",type:"dynamic"},{emoji:"🔊",description:"Play a beep sound and speak feedback when the user enters or leaves the chat",image:"https://i.imgur.com/6PXFIES.jpeg",category:"sound",type:"presence"},{emoji:"🔊",description:"Switch to google TTS engine if available",image:"https://i.imgur.com/0H94LII.jpeg",category:"sound",type:"gTTS"},{emoji:"📦️",description:"Create participants counter",image:"https://i.imgur.com/rqIVAgH.jpeg",category:"elements",type:"counter"},{emoji:"🌐",description:"Interface language",image:"",category:"ui",type:"language",languages:[{value:"en",label:"🇬🇧 English"},{value:"ru",label:"🇷🇺 Русский"}]}],vt=Object.fromEntries(ft.map((e=>[e.key,[]])));ft.forEach((e=>{const t=e.key,n=JSON.parse(localStorage.getItem(t))||[];n.length&&vt[t].splice(0,vt[t].length,...n)}));const bt=ft.find((e=>"mention"===e.type));async function xt(e){const t=e.target.files[0];if(t){const e=new FileReader;return new Promise(((n,o)=>{e.onload=function(e){const t=e.target.result;try{kt(JSON.parse(t)),n()}catch(e){console.error("Error parsing JSON data:",e.message),console.error("Invalid JSON:",t),alert("Failed to parse JSON data. Please check the format and try again."),o(e)}},e.onerror=function(e){console.error("Error reading file:",e.target.error),o(e.target.error)},e.readAsText(t)}))}}function wt(e){if(!e||"object"!=typeof e)return console.error("Invalid settings data for download."),void alert("Cannot export settings. Please try again.");try{const t="  ",n="    ";let o="{\n";ft.forEach(((s,a)=>{const r=s.key,i=e[r];let l="";l=Array.isArray(i)?`[\n${i.map((e=>`${n}${JSON.stringify(e)}`)).join(",\n")}\n${t}]`:JSON.stringify(i),o+=`${t}"${r}": ${l}`,a<ft.length-1?o+=",\n":o+="\n"})),o+="}";const s=`KG_Chat_Empowerment_Settings_${new Intl.DateTimeFormat("en-CA").format(new Date)}.json`,a=new Blob([o],{type:"application/json"}),r=URL.createObjectURL(a),i=document.createElement("a");i.href=r,i.download=s,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(r)}catch(e){console.error("Error exporting settings:",e),alert("Failed to export settings. Please try again.")}}function St(){return Object.fromEntries(ft.map((e=>[e.key,JSON.parse(localStorage.getItem(e.key))||[]])))}function Ct(e){const t=document.createElement("div");t.classList.add("empowerment-button","settings-button"),Ge(t,{en:"Open Settings",ru:"Открыть настройки"}),t.style.position="relative",t.innerHTML=ge;const n=document.createElement("input");n.type="file",n.accept=".json",n.style.display="none",n.addEventListener("change",xt),t.addEventListener("click",(e=>{N(t),Qe&&wt(St()),Ze&&n.click(),Qe||Ze||function(){const e=document.querySelector(".settings-panel");if(e)return e.remove(),void nt("hide");B();const t=document.createElement("div");t.className="settings-panel popup-panel",rt.handleSettingsKeydown=e=>{"Escape"===e.key&&(tt(t,"hide"),nt("hide"),document.removeEventListener("keydown",rt.handleSettingsKeydown))},document.addEventListener("keydown",rt.handleSettingsKeydown);const n=document.createElement("div");n.className="panel-header";const o=document.createElement("div");o.classList.add("panel-control-buttons");const s=document.createElement("div");s.className="large-button panel-header-close-button",s.innerHTML=he,Ge(s,{en:"Close panel",ru:"Закрыть панель"}),s.addEventListener("click",(()=>{tt(t,"hide"),nt("hide")}));const a=document.createElement("div");a.className="large-button panel-header-clear-button",a.innerHTML=Me,Ge(a,{en:"Clear settings",ru:"Очистить настройки"}),a.addEventListener("click",(()=>{d()}));const r=document.createElement("div");r.className="large-button panel-header-import-button",r.innerHTML=Ne,Ge(r,{en:"Import settings",ru:"Импортировать настройки"});const i=document.createElement("div");function l(e){const t=document.querySelector(".settings-content-container");if(!t)return console.error("Container not found.");const n=()=>{e.style.visibility="visible",e.style.display="flex",setTimeout((()=>{e.style.opacity="1"}),10)},o=()=>{e.style.opacity="0",setTimeout((()=>{e.style.visibility="hidden",e.style.display="none"}),300)},s=St(),a=()=>{const e={};ft.forEach((t=>{e[t.key]=[]})),t.querySelectorAll(".settings-tracked-container .tracked-item").forEach((t=>{const n=t.querySelector(".tracked-username-field"),o=t.querySelector(".tracked-gender-select"),s=t.querySelector(".tracked-pronunciation-field"),a=t.querySelector(".assigned-thawed-config, .assigned-frozen-config"),r=n?n.value.trim():"",i=o?o.value.trim():"",l=s?s.value.trim():"",c=a.classList.contains("assigned-frozen-config")?"frozen":"thawed";e.usersToTrack.push({name:r,gender:i,pronunciation:l,state:c})}));const a=new Set(e.usersToTrack.map((e=>e.name.toLowerCase())));t.querySelectorAll(".settings-mention-container .mention-item").forEach((t=>{const n=t.querySelector(".mention-field"),o=n?n.value.trim():"";e.mentionKeywords.push(o)})),t.querySelectorAll(".settings-replacement-container .replacement-item").forEach((t=>{const n=t.querySelector(".replacement-original-field"),o=t.querySelector(".replacement-field"),s=n?n.value.trim():"",r=o?o.value.trim():"";if(a.has(s.toLowerCase()))return n.classList.add("input-error"),void M(n);n.classList.remove("input-error"),e.usernameReplacements.push({original:s,replacement:r})})),t.querySelectorAll(".settings-moderator-container .moderator-item").forEach((t=>{const n=t.querySelector(".moderator-field"),o=n?n.value.trim():"";e.moderator.push(o)})),t.querySelectorAll(".settings-ignored-container .ignored-item").forEach((t=>{const n=t.querySelector(".ignored-field"),o=n?n.value.trim():"";e.ignored.push(o)})),t.querySelectorAll(".settings-toggle-container .toggle-item").forEach((t=>{const n=t.querySelector("select");if(n.classList.contains("language-toggle-select"))e.toggle.push({category:"ui",type:"language",option:n.value});else if(n.classList.contains("toggle-select")){const o=t.querySelector(".toggle-description"),s=n.value.trim()||"no";e.toggle.push({category:o.dataset.category,type:o.dataset.type,option:s})}}));if(!e.toggle.some((e=>"language"===e.type))){const t=s.toggle?.find((e=>"language"===e.type));t&&e.toggle.push(t)}return JSON.stringify(s)!==JSON.stringify(e)?n():o(),e};e.addEventListener("click",(()=>{const e=a();kt(e),Object.assign(s,e),o()})),t.querySelectorAll("input, select").forEach((e=>{e.addEventListener("input",a)}));const r=e=>{"INPUT"===e.tagName||"SELECT"===e.tagName?e.addEventListener("input",a):e.querySelectorAll("input, select").forEach((e=>{e.addEventListener("input",a)}))};new MutationObserver(D((e=>{e.forEach((e=>{"childList"===e.type&&(e.addedNodes.forEach((e=>{e.nodeType===Node.ELEMENT_NODE&&r(e)})),e.removedNodes.forEach((e=>{e.nodeType===Node.ELEMENT_NODE&&a()})))}))}),300)).observe(t,{childList:!0,subtree:!0})}i.className="large-button panel-header-save-button",i.innerHTML=Ae,Ge(i,{en:"Save settings",ru:"Сохранить настройки"});const c=document.createElement("input");function d(){ft.forEach((e=>{const t=document.querySelector(e.selector);if(t){const e=t.querySelector(".add-settings-button");t.replaceChildren(),e&&t.appendChild(e)}}))}c.type="file",c.accept=".json",c.style.display="none",c.addEventListener("change",(async e=>{await xt(e),d(),p()})),r.addEventListener("click",(()=>{c.click()})),r.appendChild(c);const u=document.createElement("div");u.className="large-button panel-header-export-button",u.innerHTML=qe,Ge(u,{en:"Export settings",ru:"Экспортировать настройки"}),u.addEventListener("click",(function(){wt(St())})),o.appendChild(i),o.appendChild(r),o.appendChild(u),o.appendChild(a),o.appendChild(s),n.appendChild(o),t.appendChild(n);const m=document.createElement("div");function p(){const e=St(),t=document.querySelector(".settings-content-container");t.innerHTML="",ft.forEach((n=>{const{key:o,creator:s,type:a}=n,r=document.createElement("div");if(r.className=`settings-${a}-container`,r.classList.add("settings-container"),"toggle"!==a){(e[o]||[]).forEach((e=>r.appendChild(s(e))));const t=g(`.settings-${a}-container`,s);r.appendChild(t)}else{const e=JSON.parse(localStorage.getItem(o))||[];yt.forEach((t=>{const n=e.find((e=>e.category===t.category&&e.type===t.type));let o="yes";if("language"===t.type){const t=e.find((e=>"ui"===e.category&&"language"===e.type));o=t?t.option:"en"}else o=n?n.option:"yes";const s=ht(t,o);r.appendChild(s)}))}const i=function(e,t={}){const n=document.createElement("div");n.classList.add("settings-spoiler");const o=document.createElement("button"),s=t.type,a=Y(),r=ft.find((e=>e.type===s)),i=r&&r.emoji?r.emoji+" ":"",l=pt.spoiler[s]||pt.spoiler.toggle;return o.textContent=t.showText||i+l[a].show,e.style.display="none",o.addEventListener("click",(()=>{const n="none"===e.style.display;o.textContent=n?t.hideText||i+l[a].hide:t.showText||i+l[a].show,e.style.display=n?"flex":"none"})),n.appendChild(o),n.appendChild(e),n}(r,{type:a,showText:void 0,hideText:void 0});t.appendChild(i)}))}function g(e,t){const n=e.split("-")[1],o=document.querySelector(`.add-${n}-item`);o&&o.remove();const s=document.createElement("div");return s.className=`settings-button add-settings-button add-${n}-item`,s.innerHTML=Oe,s.addEventListener("click",(()=>{const o=document.querySelector(e),a=o.querySelectorAll(`.${n}-item`),r=a.length>0?a[a.length-1]:null,i=r?r.querySelectorAll("input"):[],l=Array.from(i).some((e=>0===e.value.trim().length));if(!r||!l){const e=t(t===gt?{name:"",pronunciation:""}:"");e instanceof HTMLElement?o.insertBefore(e,s):console.error("Invalid item created.")}else alert("Please fill in the previous item before adding a new one.")})),s}m.className="settings-content-container",ft.forEach((({type:e})=>{const t=document.createElement("div");t.className=`settings-${e}-container`,m.appendChild(t)})),t.appendChild(m);const{scrollButtonsContainer:h}=at(m);t.appendChild(h),document.body.appendChild(t),p(),l(i),tt(t,"show"),nt("show")}()})),t.appendChild(n),e.appendChild(t)}function kt(e){ft.forEach((t=>{Array.isArray(e[t.key])&&(vt[t.key]=e[t.key])})),ft.forEach((e=>{localStorage.setItem(e.key,JSON.stringify(vt[e.key]))})),console.log("Uploaded settings applied:",vt)}void 0!==v&&v&&bt&&vt[bt.key].push(v);const{ignored:Et,mentionKeywords:$t,usernameReplacements:Lt,usersToTrack:Tt}=vt;function Mt(e){if(null===e)return e;const t=[...Tt.map((e=>e.name)),...Lt.map((e=>e.original))],n=new RegExp(`(${t.join("|")})`,"gu");return e.replace(n,(e=>{const t=Lt.find((t=>t.original===e));if(t)return t.replacement;const n=Tt.find((t=>t.name===e));return n?.pronunciation||e}))}function Nt(e="generalMessages"){const t={generalMessages:{container:".messages-content div",messageElement:"p",exclude:[".time",".username"]},chatlogsMessages:{container:".chat-logs-container",messageElement:".message-text"},personalMessages:{container:".messages-container",messageElement:".message-text"}}[e];if(!t)return void console.error("Invalid container type");const n=document.querySelectorAll(t.container),o=new WeakSet;n.forEach((n=>{n.querySelectorAll(t.messageElement).forEach((n=>{[...n.querySelectorAll(".private"),...n.querySelectorAll(".system-message"),n].forEach((n=>{const s=document.createTreeWalker(n,NodeFilter.SHOW_TEXT,{acceptNode:n=>{if(o.has(n))return NodeFilter.FILTER_SKIP;const s=n.parentElement;return s.closest(".mention, .time, .username")||"generalMessages"===e&&s.closest(t.exclude.join(","))?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT}},!1),a=[];let r;for(;r=s.nextNode();)a.push(r);a.forEach((e=>{o.has(e)||(!function(e){const t=/[\s]+|[^\s\wа-яА-ЯёЁ]+|[\wа-яА-ЯёЁ]+/g,n=e.textContent.match(t);if(!n)return;const o=document.createDocumentFragment();n.forEach((e=>{if($t.map((e=>e.toLowerCase())).includes(e.toLowerCase())){const t=document.createElement("span");t.className="mention",t.textContent=e,o.appendChild(t)}else o.appendChild(document.createTextNode(e))})),e.parentNode.replaceChild(o,e)}(e),o.add(e))}))}))}))}))}let qt=null;async function At(){const e=document.querySelector(".messages-content div p:last-of-type");if(!e)return null;const t=async e=>Array.from(e.childNodes).map((e=>e.nodeType===Node.TEXT_NODE&&e.textContent.trim()?e.textContent.trim():"IMG"===e.nodeName&&e.getAttribute("title")?e.getAttribute("title"):"A"===e.nodeName&&e.getAttribute("href")?e.getAttribute("href"):"")).filter(Boolean);let n=(await t(e)).join(" ").trim(),o="common";const s=e.querySelector(".room.private");if(s&&s.textContent.includes("[шепчет ")){const s=e.querySelector("span.private");s&&(n=(await t(s)).join(" ").trim(),o="private")}const a=e.querySelector(".system-message");if(a){let e=(await t(a)).join(" ").trim();e=e.replace(/<Клавобот>\s*/g,""),n=e,o="system"}"common"===o&&function(e){const t=e.toLowerCase();return $t.some((e=>t.includes(e.toLowerCase())))}(n)&&(o="mention");const r=JSON.parse(localStorage.getItem("personalMessages"))||{},i=e.querySelector(".time")?.textContent||"N/A",l=e.querySelector(".username span[data-user]"),c=l?l.getAttribute("data-user"):null,d=l?l.textContent:"SYSTEM",u=L(l?l.parentElement.style.color:"rgb(180,180,180)"),m=`${i}_${d}`;("mention"===o||"private"===o)&&!Et.includes(d)&&(r[m]={time:i,date:(new Date).toLocaleDateString("en-CA"),username:d,usernameColor:u,message:n,type:o,userId:c},localStorage.setItem("personalMessages",JSON.stringify(r)));const p=e.querySelector(".username"),g=p?p.textContent.replace(/[<>]/g,""):"SYSTEM";Nt();let h="mention"===o||"private"===o?`${Mt(g)} обращается: `:g!==qt?`${Mt(g)} пишет: `:"";qt=g;return{messageText:h+Mt(n),usernameText:g}}function It(e){return/^https?:\/\//.test(e)&&/%[0-9A-Fa-f]{2}/.test(e)}function jt(e){const[t]=e.split("#");return decodeURIComponent(t).replace(/ /g,"_")}function Ot(e){document.querySelector({generalMessages:".messages-content div",chatlogsMessages:".chat-logs-container",personalMessages:".messages-container-wrapper"}[e])?.querySelectorAll("a:not(.media):not(.decoded)").forEach((e=>{try{if(It(e.href)){let t=jt(e.href);e.href=e.textContent=t,e.classList.add("decoded")}}catch(t){console.error("Error decoding link:",t,e.href)}}))}let{fetchedUsers:Bt}=k;function Dt(e=!1,t=24){const n=localStorage.getItem("lastClearTime"),o=n?((new Date).getTime()-n)/36e5:1/0;if(e||o>=t){localStorage.removeItem("fetchedUsers"),Object.keys(Bt).forEach((e=>delete Bt[e]));const e=(new Date).getTime()+60*t*60*1e3;localStorage.setItem("lastClearTime",(new Date).getTime().toString()),localStorage.setItem("nextClearTime",e.toString())}}const Ht=()=>{const e=localStorage.getItem("activeChatTab")||"game",t=window.location.href.includes("gmid"),n=t&&"game"===e?'[id^="chat-game"] .text':"#chat-general .text",o=t&&"game"===e?'[id^="chat-game"] .send':"#chat-general .send",s=t&&"game"===e?'[id^="chat-game"] .messages':"#chat-general .messages",a={game:document.querySelector('[id^="chat-game"] .userlist-content'),general:document.querySelector("#chat-general .userlist-content")},r=document.querySelector(t?"game"===e?".game.c":".general.c":"general"===e?".general.c":".game.c"),i=document.querySelector(t?document.querySelector(".game.c.active")?".general.c":".game.c":document.querySelector(".general.c.active")?".game.c":".general.c"),l=document.querySelectorAll(".messages-content p"),c=document.querySelector(s);return{chatField:document.querySelector(n),chatSend:document.querySelector(o),activeChatTab:r,nextChatTab:i,chatHidden:document.querySelector("#chat-wrapper.chat-hidden"),allMessages:l,messagesContainer:c,userList:a}},{ignored:Pt}=vt;function Ft(e){return function(e){const t={А:"A",Б:"B",В:"V",Г:"G",Д:"D",Е:"E",Ё:"Yo",Ж:"Zh",З:"Z",И:"I",Й:"Y",К:"K",Л:"L",М:"M",Н:"N",О:"O",П:"P",Р:"R",С:"S",Т:"T",У:"U",Ф:"F",Х:"Kh",Ц:"Ts",Ч:"Ch",Ш:"Sh",Щ:"Shch",Ъ:"y",Ы:"Y",Ь:"i",Э:"E",Ю:"Yu",Я:"Ya",а:"a",б:"b",в:"v",г:"g",д:"d",е:"e",ё:"yo",ж:"zh",з:"z",и:"i",й:"y",к:"k",л:"l",м:"m",н:"n",о:"o",п:"p",р:"r",с:"s",т:"t",у:"u",ф:"f",х:"kh",ц:"ts",ч:"ch",ш:"sh",щ:"shch",ъ:"y",ы:"y",ь:"i",э:"e",ю:"yu",я:"ya"};return e.split("").map((e=>t[e]||e)).join("")}(e)}const Ut="Вы не можете отправлять сообщения",zt="Связь с сервером потеряна";function _t(e){if(!e)return null;const t=e.value;return t.includes(Ut)?Ut:t.includes(zt)?zt:null}function Rt(){const e=document.getElementById("chat-content").querySelectorAll(".messages-content div p"),t="14px",n=Array.from(e).map((e=>({element:e,isSystem:!!e.querySelector(".system-message"),username:(()=>{const t=e.querySelector("span.username span[data-user]");return t?t.textContent.replace(/[<>]/g,""):null})()})));let o=null,s=!1;n.forEach(((e,a)=>{const{element:r,isSystem:i,username:l}=e;if(r.style.marginTop="",r.style.marginBottom="",i)return r.style.marginTop=t,void(r.style.marginBottom=t);if(!l)return;s&&l!==o&&(r.style.marginTop=t);const c=n[a+1];c&&!c.isSystem&&c.username!==l&&(r.style.marginBottom=t),o=l,s=!0}))}if(j("gamelist")){function Js(e,t,n){if(t.disabled){const o=_t(t);o===Ut?(t.disabled=n.disabled=!1,n.style.setProperty("background-color","rgb(160, 35, 35)","important"),n.style.setProperty("background-image",`url("data:image/svg+xml,${encodeURIComponent(pe)}")`,"important"),n.style.setProperty("background-repeat","no-repeat","important"),n.style.setProperty("background-position","center","important"),n.style.setProperty("color","transparent","important"),t.value=null,console.log("Chat field was blocked, re-enabled.")):o===zt&&(console.log("Lost connection, reloading..."),setTimeout((()=>{window.location.reload()}),e))}}const Ks=new MutationObserver((()=>{const{chatField:e,chatSend:t}=Ht();Js(5e3,e,t)})),{chatField:Vs}=Ht();Vs&&Ks.observe(Vs,{attributes:!0,attributeFilter:["disabled"]}),document.addEventListener("visibilitychange",(()=>{if("visible"===document.visibilityState){const{chatField:e,chatSend:t}=Ht();Js(1e3,e,t)}}))}function Jt(){const{chatHidden:e,chatField:t}=Ht();!e&&t&&t.focus()}function Kt(e){console.log("Clicked element:",e.target);const t=e.target.classList.contains("general")?"general":"game";localStorage.setItem("activeChatTab",t)}[...document.querySelectorAll(".general.c, .game.c")].forEach((e=>e.addEventListener("click",Kt))),document.addEventListener("keydown",(e=>{"Tab"===e.key&&(!function(){const{nextChatTab:e,chatField:t,chatHidden:n}=Ht();!n&&e&&(e.click(),t?.focus())}(),e.preventDefault())}));const Vt=document.querySelector(".mostright");function Xt(){const{chatField:e}=Ht();e.setAttribute("maxlength","1000"),e.addEventListener("paste",(t=>{t.preventDefault();const n=t.clipboardData.getData("text");let o=n;It(n)&&(o=jt(n));const s=e.selectionStart,a=e.selectionEnd;e.value=e.value.slice(0,s)+o+e.value.slice(a),e.setSelectionRange(s+o.length,s+o.length)})),e.addEventListener("keydown",(t=>{const n=e.value;"Enter"===t.key&&(n.length>300?(t.preventDefault(),async function(e){const t=e.split(" ").reduce(((e,t)=>{const n=e[e.length-1];return(n+" "+t).trim().length>300?[...e,t]:[...e.slice(0,-1),(n+" "+t).trim()]}),[""]),{chatField:n,chatSend:o}=Ht(),s=e.length>300;s&&(n.disabled=!0);for(let e=0;e<t.length;e++){const s=t[e];if(n.value=s,console.log(`Sending piece ${e+1}: "${s}" (Length: ${s.length})`),o.click(),e<t.length-1){const e=Math.floor(500*Math.random())+500;console.log(`Waiting for ${e} ms before sending the next piece.`),await new Promise((t=>setTimeout(t,e)))}}s&&(n.disabled=!1)}(n),console.log(`Long message processed: "${n}"`),e.value=""):console.log(`Short message processed: "${n}"`))}))}function Yt(e="generalMessages",t=600){const n={generalMessages:".messages-content",chatlogsMessages:".chat-logs-container",personalMessages:".messages-container-wrapper"}[e];if(!n)return;const o=document.querySelector(n);if(o)if(void 0===Yt.firstTime&&(Yt.firstTime=!0),Yt.firstTime)o.scrollTop=o.scrollHeight,Yt.firstTime=!1;else{o.scrollHeight-o.scrollTop-o.clientHeight<=t&&(o.scrollTop=o.scrollHeight)}}async function Gt(e,t){const{top:n,height:o}=t.getBoundingClientRect(),{top:s,height:a}=e.getBoundingClientRect(),r=n-(s+a/2)+o/2;e.scrollBy({top:r,behavior:"smooth"}),await new Promise((e=>setTimeout(e,500))),e.style.scrollBehavior="auto",M(t)}(j("gmid")||j("gamelist"))&&Vt.addEventListener("click",(()=>{setTimeout((()=>{document.querySelector("#chat-wrapper.chat-hidden")?(localStorage.setItem("shouldShowPopupMessage","true"),isInitializedChat=!1):(pruneDeletedMessages(),Jt(),isInitializedChat=!1,setTimeout((()=>isInitializedChat=!1),3e3),localStorage.setItem("shouldShowPopupMessage","false"))}),300)})),(j("gmid")||j("gamelist"))&&document.addEventListener("keydown",(e=>{if(e.ctrlKey&&"Space"===e.code){const e=document.querySelector("#chat-fixed-placeholder"),t="none"===e.style.display;e.style.display=t?"unset":"none",localStorage.setItem("shouldShowPopupMessage",!t),t?Ht().chatField?.focus():document.querySelector(".popup-messages-container")?.remove()}}));const Wt=[{family:"Montserrat",weights:["100","200","300","400","500","600","700","800","900"]},{family:"Orbitron",weights:["400","500","600","700","800","900"]},{family:"Roboto Mono",weights:["100","200","300","400","500","600","700"]}];async function Zt(){try{Wt.forEach((e=>{!function(e,t){if(!document.querySelector(`.font-${e.replace(/\s/g,"-")}`)){const n=document.createElement("link");n.rel="stylesheet",n.href=`https://fonts.googleapis.com/css2?family=${e.replace(/\s/g,"+")}:wght@${t.join(";")}&display=swap`,n.classList.add(`font-${e.replace(/\s/g,"-")}`),document.head.appendChild(n)}}(e.family,e.weights)}))}catch(e){console.error("Font loading failed:",e)}}function Qt(e){if(!e||!e.sec)return null;return new Date(1e3*e.sec).toISOString().split("T")[0]}function en(e,t){return null!=e&&null!=t?e.toString()+Math.floor(t/1e3).toString():null}async function tn(e){const t=await fetch(e);if(!t.ok)throw new Error(`Failed to fetch ${e}`);return t.json()}async function nn(e){try{const t=`https://klavogonki.ru/api/profile/search-users?query=${e}`,n=await tn(t);if(!n.all?.length)return null;const o=n.all.find((t=>t.login===e));return o?o.id:null}catch(e){return console.error("Error getting user ID:",e),null}}const on=new Set(["bio","bioText","bioOldText","bioEditedDate","stats","registered","achievesCount","totalRaces","bestSpeed","ratingLevel","friendsCount","vocsCount","carsCount","achieves","allIndexData"]),sn=new Set(["usernamesHistory","currentLogin","userId","level","status","title","car","isOnline","avatar","blocked","isFriend","publicPrefs","allUserData"]);async function an(e,t){try{const n=await nn(e);if(!n)throw new Error(`User with username "${e}" not found`);return await rn(n,t)}catch(n){return console.error(`Error getting ${t} for user ${e}:`,n),null}}async function rn(e,t){try{if(on.has(t)){const n=await async function(e){try{const t=`https://klavogonki.ru/api/profile/get-index-data?userId=${e}`;return await tn(t)}catch(e){throw console.error("Error getting user index data:",e),e}}(e);return ln(n,t,"index")}if(sn.has(t)){const n=await async function(e){try{const t=`https://klavogonki.ru/api/profile/get-summary?id=${e}`;return await tn(t)}catch(e){throw console.error("Error getting user summary:",e),e}}(e);return ln(n,t,"summary")}throw new Error(`Unknown data type: ${t}`)}catch(n){return console.error(`Error getting ${t} for user ID ${e}:`,n),null}}function ln(e,t,n){if(!e)return null;if("summary"===n){const n={...e.user||{},...e};switch(t){case"usernamesHistory":return Array.isArray(n.history)?n.history.map((e=>e.login)):[];case"currentLogin":return n.login||null;case"userId":return n.id||null;case"level":return n.level||null;case"status":return n.status||null;case"title":return n.title||(n.status?.title??null);case"car":return n.car||null;case"isOnline":return n.is_online??!1;case"avatar":return n.avatar||null;case"avatarTimestamp":{const e=n.avatar;return e&&"number"==typeof e.sec&&"number"==typeof e.usec?en(e.sec,e.usec):null}case"blocked":return n.blocked??null;case"isFriend":return n.is_friend??!1;case"publicPrefs":return n.public_prefs||null;case"allUserData":return n;default:return null}}if("index"===n)switch(t){case"bio":return e.bio||null;case"bioText":return e.bio?.text||null;case"bioOldText":return e.bio?.old_text||null;case"bioEditedDate":return e.bio?.edited_date||null;case"stats":return e.stats||null;case"registered":return Qt(e.stats?.registered);case"achievesCount":return e.stats?.achieves_cnt||null;case"totalRaces":return e.stats?.total_num_races||null;case"bestSpeed":return e.stats?.best_speed||null;case"ratingLevel":return e.stats?.rating_level||null;case"friendsCount":return e.stats?.friends_cnt||null;case"vocsCount":return e.stats?.vocs_cnt||null;case"carsCount":return e.stats?.cars_cnt||null;case"achieves":return e.achieves||null;case"allIndexData":return e;default:return null}return null}async function cn(e,t=!0){return new Promise((async(n,o)=>{let s=t&&JSON.parse(localStorage.getItem("fetchedUsers"))||{};const a=s[e];if(t&&function(e){return e&&"object"==typeof e&&["rank","login","registered","bestSpeed","ratingLevel","friends","cars","avatarTimestamp"].every((t=>void 0!==e?.[t]))}(a))n({rank:a.rank,login:a.login,registeredDate:a.registered,bestSpeed:a.bestSpeed,ratingLevel:a.ratingLevel,friends:a.friends,cars:a.cars,avatar:a.avatar,avatarTimestamp:a.avatarTimestamp});else try{const[o,a]=await Promise.all([rn(e,"allUserData"),rn(e,"allIndexData")]);if(!o||!a)throw new Error("Invalid data format received from the API.");const r=o.title||(o.status?.title??null),i=o.login||null,l=Qt(a.stats?.registered),c=a.stats?.best_speed||0,d=a.stats?.rating_level||0,u=a.stats?.friends_cnt||0,m=a.stats?.cars_cnt||0,p=o.avatar||null,g=p?.sec||0,h=p?.usec||0,f=null!=g&&null!=h?en(g,h):null;if(!(i&&r&&l))throw new Error("Invalid data format received from the API.");t&&(s[e]={rank:r,login:i,registered:l,bestSpeed:c,ratingLevel:d,friends:u,cars:m,avatar:p,avatarTimestamp:f},localStorage.setItem("fetchedUsers",JSON.stringify(s))),n({rank:r,login:i,registeredDate:l,bestSpeed:c,ratingLevel:d,friends:u,cars:m,avatar:p,avatarTimestamp:f})}catch(t){console.error(`Error fetching user profile data for ${e}:`,t),o(t)}}))}const dn=e=>{let t=document.querySelector(".profile-iframe-container");if(t)return void(t.src=e);t=document.createElement("iframe"),t.classList.add("profile-iframe-container"),t.src=e,document.body.appendChild(t),et(t,"show",1);const n=()=>{et(t,"hide",0),document.removeEventListener("keydown",o),document.removeEventListener("mousedown",o)},o=e=>{if("keydown"===e.type&&"Space"===e.code){if(window.lastFocusedIframeTextarea)return void e.stopPropagation();e.preventDefault(),n()}if("mousedown"===e.type&&!t.contains(e.target)){let t=e.target;for(;t&&t!==document.body;){if(t.classList&&(t.classList.contains("profile")||t.classList.contains("name")||t.classList.contains("login")))return;t=t.parentElement}n()}};document.addEventListener("keydown",o),document.addEventListener("mousedown",o),t.onload=()=>{try{const e=t.contentWindow,s=e.document;s.addEventListener("focusin",(e=>{"TEXTAREA"===e.target.tagName&&(window.lastFocusedIframeTextarea=e.target)})),s.addEventListener("focusout",(()=>{setTimeout((()=>{s.activeElement&&"TEXTAREA"===s.activeElement.tagName||(window.lastFocusedIframeTextarea=null)}),0)})),e.addEventListener("keydown",o),e.addEventListener("dblclick",n),new MutationObserver(((e,t)=>{e.some((e=>[...e.removedNodes].some((e=>1===e.nodeType&&(e.classList.contains("dimming-background")||e.classList.contains("cached-users-panel"))))))&&(n(),t.disconnect())})).observe(document.body,{childList:!0,subtree:!0})}catch(e){console.warn("Unable to access iframe contents:",e)}}};let{fetchedUsers:un}=k;const{usersToTrack:mn,ignored:pn,moderator:gn}=vt;function hn(e){const t={class:"unknown",icon:"❓",color:"#000000"},n={Экстракибер:{class:"extra",icon:"🚀",color:"#06B4E9"},Кибергонщик:{class:"cyber",icon:"🤖",color:"#5681ff"},Супермен:{class:"superman",icon:"👊",color:"#B543F5"},Маньяк:{class:"maniac",icon:"🔪",color:"#DA0543"},Гонщик:{class:"racer",icon:"⚡️️",color:"#FF8C00"},Профи:{class:"profi",icon:"️💼️",color:"#C1AA00"},Таксист:{class:"driver",icon:"🚖️",color:"#2DAB4F"},Любитель:{class:"amateur",icon:"🍆️",color:"#61B5B3"},Новичок:{class:"newbie",icon:"🐥",color:"#AFAFAF"}}[e]||t;return n.class===t.class&&console.log(`Class not found for status title: ${e}. Using default class: ${t.class}`),n}function fn(e,t,n,o,s){const a=un?.[e]?.avatarTimestamp,r="00"!==a?`/storage/avatars/${e}_big.png?updated=${a}`:"",i=document.createElement("div"),l=hn(t),c=l.class,d=l.color,u=l.icon;i.classList.add(`user${e}`,c);const m=document.createElement("div");if(m.classList.add("avatar"),"00"!==a){const e=document.createElement("img");e.src=r,m.appendChild(e)}else m.style.fontSize="1.8rem",m.innerHTML=function(){let e;do{e=C[Math.floor(Math.random()*C.length)]}while(e===H);return H=e,e}();const p=document.createElement("a");p.classList.add("name"),Ge(p,{en:"Send private message",ru:"Отправить приватное сообщение"}),p.dataset.user=e,p.textContent=n,p.style.setProperty("color",d,"important");const g=document.createElement("a");g.classList.add("profile");Ge(g,`${u} ${t} - ${o}`),g.target="_blank",g.href=`/profile/${e}/`;let h=function(e,t,n){const o="http://www.w3.org/2000/svg",s=20,a=10,r=Math.random().toString(36).substring(2,22),i=n||0!==e?1:.6,l=document.createElementNS(o,"svg");if(Object.entries({width:s,height:s,viewBox:"0 0 20 20",xmlns:o}).forEach((([e,t])=>l.setAttribute(e,t))),l.classList.add("circularProgress"),n||0===e){if(!n){const e=document.createElementNS(o,"circle");Object.entries({cx:a,cy:a,r:8,fill:"none",stroke:t,"stroke-width":2}).forEach((([t,n])=>e.setAttribute(t,n))),e.classList.add("outerCircle"),l.appendChild(e)}const e=s/24*i,r=a-12*e,c=document.createElementNS(o,"g");c.setAttribute("transform",`translate(${r}, ${r}) scale(${e})`),c.classList.add("closeIconGroup");const d=document.createElementNS(o,"path");Object.entries({d:"M18.364 5.636a1 1 0 0 1 0 1.414L13.414 12l4.95 4.95a1 1 0 0 1-1.414 1.414L12 13.414l-4.95 4.95a1 1 0 0 1-1.414-1.414L10.586 12l-4.95-4.95a1 1 0 0 1 1.414-1.414L12 10.586l4.95-4.95a1 1 0 0 1 1.414 0z",fill:t}).forEach((([e,t])=>d.setAttribute(e,t))),c.appendChild(d),l.appendChild(c)}else{const n=document.createElementNS(o,"defs");n.classList.add("defs");const s=document.createElementNS(o,"clipPath");s.setAttribute("id",`clipInner-${r}`),s.classList.add("clipPath");const i=document.createElementNS(o,"rect");Object.entries({x:2,y:2,width:16,height:0,transform:"rotate(180, 10, 10)"}).forEach((([e,t])=>i.setAttribute(e,t))),i.classList.add("clipRect");const c=document.createElementNS(o,"animate");Object.entries({attributeName:"height",from:0,to:e/100*16,begin:"indefinite",dur:"1s",fill:"freeze",calcMode:"spline",keySplines:"0.4 0 0.2 1",keyTimes:"0;1"}).forEach((([e,t])=>c.setAttribute(e,t))),c.classList.add("animateProfileProgress"),i.appendChild(c),s.appendChild(i),n.appendChild(s),l.appendChild(n);const d=document.createElementNS(o,"circle");Object.entries({cx:a,cy:a,r:8,fill:"none",stroke:t,"stroke-width":2}).forEach((([e,t])=>d.setAttribute(e,t))),d.classList.add("outerCircle"),l.appendChild(d);const u=document.createElementNS(o,"circle");Object.entries({cx:a,cy:a,r:8,fill:t,"clip-path":`url(#clipInner-${r})`}).forEach((([e,t])=>u.setAttribute(e,t))),u.classList.add("innerCircle"),l.appendChild(u)}return l.outerHTML}(function(e){const t=100*Math.floor(e/100);return(e-t)/(t+100-t)*100}(o),d,s);g.innerHTML=h,setTimeout((()=>{const e=g.querySelector(".animateProfileProgress");e&&e.beginElement()}),10),g.addEventListener("click",(function(t){t.preventDefault(),Ze?window.open(y+e,"_blank"):dn(y+e)}));const f=`${y}${b}/messages/${e}/`;p.addEventListener("click",(function(t){if(t.ctrlKey&&t.shiftKey){const e=window.open(f,"_blank");e&&e.focus()}else t.ctrlKey?dn(f):function(e){const t=`<${document.querySelector(`.name[data-user="${e}"]`).textContent}>`,n=document.querySelector(".messages .text");n.value=t,n.focus(),n.selectionEnd=n.value.length}(e)})),i.appendChild(m),i.appendChild(p),i.appendChild(g);if(mn.find((e=>e.name===n&&"thawed"===e.state))){const e=document.createElement("div");Ge(e,{en:"Tracked user",ru:"Отслеживаемый пользователь"}),e.classList.add("tracked"),e.innerHTML=ne,i.appendChild(e)}if(pn.includes(n)){const e=document.createElement("div");Ge(e,{en:"Ignored user",ru:"Игнорируемый пользователь"}),e.classList.add("ignored"),e.innerHTML=oe,i.appendChild(e)}const v=document.querySelector(`.userlist-content ins.user${e} img[src*="moderator"]`),x=gn.includes(n);if(v||x){const e=document.createElement("div");Ge(e,{en:"Moderator",ru:"Модератор"}),e.classList.add("moderator"),e.innerHTML=te,i.appendChild(e)}return i}async function yn(e,t){try{const n=document.querySelector(".userlist-content");let o=document.querySelector(".chat-user-list");if(!o){o=document.createElement("div"),o.classList.add("chat-user-list");const e=document.querySelector(".userlist");e&&e.appendChild(o)}const s={};["extra","cyber","superman","maniac","racer","profi","driver","amateur","newbie"].forEach((e=>{const t=o.querySelector(`.rank-group-${e}`);t?s[e]=t:(s[e]=document.createElement("div"),s[e].classList.add(`rank-group-${e}`),o.appendChild(s[e]))}));const a=new Set;for(const o of n.querySelectorAll("ins")){const n=o.querySelector(".name"),r=n.getAttribute("data-user"),i=n.textContent;if(!a.has(r))try{const{rank:n,login:l,registeredDate:c,bestSpeed:d,ratingLevel:u,friends:m,cars:p,avatarTimestamp:g}=await cn(r);un[r]?(un[r].rank=n,un[r].login=l,un[r].registered=c,un[r].bestSpeed=d,un[r].ratingLevel=u,un[r].friends=m,un[r].cars=p,un[r].avatarTimestamp=g):un[r]={rank:n,login:l,registered:c,bestSpeed:d,ratingLevel:u,friends:m,cars:p,avatarTimestamp:g},e===i&&"enter"===t&&(un[r].visits=(un[r].visits||0)+1,un[r].tracked=mn.some((t=>t.name===e)));const{class:h}=hn(n);if(!s[h].querySelector(`.user${r}`)){const e=fn(r,n,i,d,o.classList.contains("revoked"));s[h].appendChild(e),Rs&&M(e)}a.add(r)}catch(e){console.error(`Error fetching profile summary for user ${r}:`,e)}}o.querySelectorAll('.chat-user-list [class^="user"]').forEach((e=>{const t=e.querySelector(".name").getAttribute("data-user");a.has(t)||e.remove()})),Object.values(s).forEach((e=>[...e.children].sort(((e,t)=>(un[t.querySelector(".name")?.getAttribute("data-user")]?.bestSpeed||0)-(un[e.querySelector(".name")?.getAttribute("data-user")]?.bestSpeed||0))).forEach((t=>e.appendChild(t))))),localStorage.setItem("fetchedUsers",JSON.stringify(un)),function(){const e=document.querySelector(".cache-panel-load-button .cache-user-count");if(!e)return;const t=Object.keys(JSON.parse(localStorage.getItem("fetchedUsers"))||{}).length.toString();t!==e.textContent&&(e.textContent=t,addPulseEffect(e))}()}catch(e){console.error("Error refreshing user list:",e)}}var vn=n(53),bn={};bn.styleTagTransform=g(),bn.setAttributes=d(),bn.insert=l().bind(null,"head"),bn.domAPI=r(),bn.insertStyleElement=m();s()(vn.A,bn);vn.A&&vn.A.locals&&vn.A.locals;class xn{constructor(){this.selected=new Set,this.isDragging=!1,this.toggleBtn=null,this.init()}init(){this.attachEvents(),this.updateDeletedMessages(),this.renderToggle()}attachEvents(){document.addEventListener("mousedown",(e=>{const t=e.target.closest(".messages-content p");if(t&&2===e.button&&t){if(e.target.closest(".time")){const n=Array.from(document.querySelectorAll(".messages-content p")),o=n.indexOf(t);if(-1!==o)if(e.ctrlKey)n.slice(o).forEach((e=>{this.toggleSelect(e,!0,"time-mode"),e.classList.add("time-mode")}));else{const e=t.querySelector(".username");if(e){const t=e.textContent.trim();n.slice(o).forEach((e=>{const n=e.querySelector(".username");n&&n.textContent.trim()===t&&(this.toggleSelect(e,!0,"time-mode"),e.classList.add("time-mode"))}))}}}else if(e.target.closest(".username")){const t=e.target.closest(".username").textContent.trim();document.querySelectorAll(".messages-content p").forEach((e=>{const n=e.querySelector(".username");n&&n.textContent.trim()===t&&(this.toggleSelect(e,!0,"username-mode"),e.classList.add("username-mode"))}))}else this.isDragging=!0,this.toggleSelect(t,!0,"message-mode")}})),document.addEventListener("mouseup",(()=>this.isDragging=!1)),document.addEventListener("mousemove",(e=>{if(!this.isDragging)return;const t=e.target.closest(".messages-content p");t&&this.toggleSelect(t,!0,"message-mode")})),document.addEventListener("contextmenu",(e=>{const t=e.target.closest(".messages-content p");t&&(V()||(e.preventDefault(),this.showDeleteButton(e,t)))}))}toggleSelect(e,t,n="message-mode"){if(!e)return;if(V())return;e.classList.toggle("selected-message",t),t?"message-mode"===n&&e.classList.add("message-mode"):e.classList.remove("username-mode","time-mode","message-mode");const o=wn(e);t?this.selected.add(o):this.selected.delete(o)}showDeleteButton(e,t){if(V())return;const n=document.querySelector(".delete-btn");n&&n.remove();const o=document.createElement("button");o.className="delete-btn",o.textContent="Delete",document.body.append(o);const{offsetWidth:s,offsetHeight:a}=o;let r;o.remove(),Object.assign(o.style,{position:"fixed",top:e.clientY-a/2+"px",left:e.clientX-s/2+"px"}),o.onclick=()=>{document.querySelectorAll(".selected-message").forEach((e=>{e&&(e.classList.remove("selected-message","username-mode","time-mode","message-mode"),0===e.classList.length&&e.removeAttribute("class"))})),this.storeDeleted([...this.selected]),o.remove(),this.selected.clear(),this.updateDeletedMessages(),this.renderToggle()},o.addEventListener("mouseenter",(()=>{r&&clearTimeout(r)})),o.addEventListener("mouseleave",(()=>{r=setTimeout((()=>{o.remove(),this.clearSelection()}),1e3)})),document.body.append(o)}clearSelection(){document.querySelectorAll(".selected-message").forEach((e=>{e&&(e.classList.remove("selected-message","username-mode","time-mode","message-mode"),0===e.classList.length&&e.removeAttribute("class"))})),this.selected.clear()}storeDeleted(e){const t=new Set(JSON.parse(localStorage.getItem("deletedChatMessagesContent")||"[]"));e.forEach((e=>t.add(e))),localStorage.setItem("deletedChatMessagesContent",JSON.stringify([...t]))}updateDeletedMessages(){const e=new Set(JSON.parse(localStorage.getItem("deletedChatMessagesContent")||"[]")),t=document.querySelectorAll(".messages-content p");0!==t.length&&(t.forEach((t=>{if(!t)return;const n=wn(t);t.classList.remove("shown-message"),t.classList.toggle("hidden-message",e.has(n))})),localStorage.setItem("deletedChatMessagesContent",JSON.stringify([...e])))}renderToggle(){if(!(JSON.parse(localStorage.getItem("deletedChatMessagesContent")||"[]").length>0))return void(this.toggleBtn&&(this.toggleBtn.remove(),this.toggleBtn=null));const e=document.querySelector(".messages-content");e&&(this.toggleBtn||(this.toggleBtn=document.createElement("button"),this.toggleBtn.className="toggle-button toggle-hidden",this.toggleBtn.textContent="Show",this.toggleBtn.onclick=e=>{if(e.ctrlKey)return document.querySelectorAll(".messages-content p").forEach((e=>{e&&e.classList.remove("hidden-message","shown-message")})),localStorage.setItem("deletedChatMessagesContent",JSON.stringify([])),this.selected.clear(),this.updateDeletedMessages(),void this.renderToggle();const t="Show"===this.toggleBtn.textContent,n=JSON.parse(localStorage.getItem("deletedChatMessagesContent")||"[]");document.querySelectorAll(".messages-content p").forEach((e=>{if(!e)return;const o=wn(e);n.includes(o)&&(e.classList.toggle("hidden-message",!t),e.classList.toggle("shown-message",t))})),t?(this.toggleBtn.textContent="Hide",this.toggleBtn.classList.remove("toggle-hidden"),this.toggleBtn.classList.add("toggle-shown")):(this.toggleBtn.textContent="Show",this.toggleBtn.classList.remove("toggle-shown"),this.toggleBtn.classList.add("toggle-hidden"))},e.append(this.toggleBtn)))}}function wn(e){if(!e)return"";const t=e.cloneNode(!0);Array.from(t.querySelectorAll(".time")).forEach((e=>e.remove()));return[t.textContent,[...Array.from(e.querySelectorAll("a")).map((e=>e.href)),...Array.from(e.querySelectorAll("img")).map((e=>e.title.trim())),...Array.from(e.querySelectorAll("iframe")).map((e=>e.src.trim()))].filter(Boolean).join(" ")].filter(Boolean).join(" ")}const Sn={extra:"🚀",cyber:"🤖",superman:"👊",maniac:"🔪",racer:"⚡️",profi:"💼",driver:"🚖",amateur:"🍆",newbie:"🐥"};function Cn(e,t=0){const n=document.createElement("div");n.classList.add("participant-count"),n.innerHTML=t.toString(),e&&e.appendChild(n),n.addEventListener("mouseover",(function(){const e=Object.keys(Sn).reduce(((e,t)=>{const n=document.getElementsByClassName(t).length;return n>0&&e.push(`${Sn[t]}&nbsp;${n}&nbsp;`),e}),[]).join(" ");Ge(n,e)}))}let kn=Y();const En="🙌",$n="❌",Ln="✅",Tn="🛑";function Mn(e,t){const n=Object.values(JSON.parse(localStorage.getItem("fetchedUsers")||"[]")).find((t=>t?.login===e));if(!n)return;const o=n.actionLog||[],s=o.find((e=>e.timestamp===t));if(!s)return;const a=o.indexOf(s);if(0===a)return"en"===kn?`${En} ${e}'s first action`:`${En} ${e} зашёл впервые`;const r=o.slice(0,a).reverse().find((e=>e.type!==s.type));if(!r)return"en"===kn?`${$n} No valid previous action found for ${t}`:`${$n} Не найдено предыдущего действия для ${t}`;const i=function(e,t){const n=e=>e.split(":").reduce(((e,t,n)=>e+t*[3600,60,1][n]),0),o=Math.abs(n(t)-n(e));return[Math.floor(o/3600),Math.floor(o%3600/60),o%60].map((e=>e.toString().padStart(2,"0"))).join(":")}(r.timestamp,s.timestamp);return"leave"===s.type?"en"===kn?`${Tn} ${e} left the chat after ${i}`:`${Tn} ${e} покинул чат спустя ${i}`:"en"===kn?`${Ln} ${e} stayed in chat for ${i}`:`${Ln} ${e} остался в чате на ${i}`}function Nn(e,t){const n=t.getBoundingClientRect(),o=e.getBoundingClientRect();return o.top>=n.top&&o.bottom<=n.bottom}const{usersToTrack:qn}=vt,An=e=>new Promise((t=>setTimeout(t,e)));function In(e){const t=document.createElement("span");return t.classList.add("action-icon"),t.style.margin="0 4px",t.style.setProperty("border","none","important"),t.innerHTML=e,t}function jn(e,t,n,o,s){const a={generalChat:".messages-content div",cachePanel:".fetched-users .action-log"}[s];if(!a)return void console.error("Invalid or missing container. Please provide 'generalChat' or 'cachePanel'.");const r=document.querySelector(a);if(!r)return void console.error("Container not found in DOM.");r.classList.add("generalChat"===s?"static-chat-notifications-container":"static-cache-notifications-container");const i=document.createElement("span");i.classList.add("static-chat-notification"),"generalChat"===s&&i.addEventListener("dblclick",(()=>{!async function(e=40,t=600,n=140){const o=document.querySelector(".messages-content");if(!o)return;const s=o.style.scrollBehavior;o.style.scrollBehavior="smooth";const a=[...document.querySelectorAll(".static-chat-notification")].reverse();for(const s of a){!Nn(s,o)&&(o.scrollTop=s.offsetTop-o.offsetTop-o.clientHeight/2,await An(t)),Object.assign(s.style,{transition:[`opacity ${n/1e3}s cubic-bezier(.3,.1,1,.1)`,`transform ${n/1e3}s cubic-bezier(0,.7,.3,0.95)`].join(","),opacity:0,transformOrigin:"left",transform:"translateX(8em) skewX(-20deg)"}),await An(n),s.remove(),await An(e)}o.scrollHeight-o.scrollTop<=o.clientHeight||(o.scrollTop=o.scrollHeight,await An(t));o.style.scrollBehavior=s}()}));const l=document.createElement("span");l.classList.add("action-user"),l.textContent=e;const c=In(t),d=document.createElement("span");d.classList.add("action-time"),d.textContent=n,i.appendChild(l),i.appendChild(c),i.appendChild(d),i.dataset.username=e,i.dataset.time=n,o?i.classList.add("user-enter"):i.classList.add("user-left"),r.appendChild(i),i.addEventListener("mouseover",(()=>{const e=Mn(i.dataset.username,i.dataset.time);Ge(i,e)}))}const On=[];let Bn=!1;function Dn(){if(0===On.length)return void(Bn=!1);Bn=!0;const{user:e,iconType:t,time:n,presence:o}=On.shift();!function(e,t,n,o){let s=document.querySelector(".dynamic-chat-notifications-container");s||(s=document.createElement("div"),s.classList.add("dynamic-chat-notifications-container"),document.body.appendChild(s));const a=document.createElement("span");a.classList.add("dynamic-chat-notification");const r=document.createElement("span");r.classList.add("action-user"),r.textContent=e;const i=In(t),l=document.createElement("span");l.classList.add("action-time"),l.textContent=n,a.appendChild(r),a.appendChild(i),a.appendChild(l),a.dataset.username=e,a.dataset.time=n,o?a.classList.add("user-enter"):a.classList.add("user-left"),s.appendChild(a),a.addEventListener("mouseover",(()=>{const e=Mn(a.dataset.username,a.dataset.time);Ge(a,e)})),setTimeout((()=>{a.style.transform="translateX(0)",setTimeout((()=>{a.style.transform="translateX(-100%)",setTimeout((()=>{s.removeChild(a)}),300)}),5e3)}),300)}(e,t,n,o),setTimeout(Dn,500)}function Hn(e,t,n){const o=qn.some((t=>t.name===e&&"thawed"===t.state)),s=o&&P("notifications","static"),a=P("notifications","dynamic");if(!s&&!a)return;const r=F();s&&o&&(jn(e,t,r,n,"generalChat"),Yt("generalMessages",350)),a&&function(e,t,n,o){On.push({user:e,iconType:t,time:n,presence:o}),Bn||Dn()}(e,t,r,n)}let Pn,Fn,Un=lt.voiceSettings.voiceSpeed??1.5,zn=lt.voiceSettings.voicePitch??1;function _n(){Fn.innerHTML="silence"===Pn.id?se:"beep"===Pn.id?ae:re}function Rn(){return{speed:(Un-0)/2.5*100+"%",pitch:(zn-0)/2*100+"%"}}let Jn=null,Kn=null;function Vn(e){e.preventDefault();const t=function(e){const t=0===e.button,n=e.ctrlKey||e.metaKey,o=e.altKey;if(!n&&!o)return null;const s=n?"voiceSpeed":"voicePitch",a=t?-.1:.1,r=lt.voiceSettings[s],[i,l]="voiceSpeed"===s?[0,S]:[0,2];return a<0&&r<=i||a>0&&r>=l?null:{prop:s,step:a}}(e);if(!t)return;const{prop:n,step:o}=t;Xn(n,o),Jn=setTimeout((()=>{Kn=setInterval((()=>{Xn(n,o)||clearInterval(Kn)}),100)}),500);const s=()=>{clearTimeout(Jn),clearInterval(Kn),Pn.removeEventListener("mouseup",s),Pn.removeEventListener("mouseleave",s)};Pn.addEventListener("mouseup",s),Pn.addEventListener("mouseleave",s)}function Xn(e,t){const n=parseFloat(lt.voiceSettings[e]),[o,s]="voiceSpeed"===e?[0,S]:[0,2],a=Math.min(s,Math.max(o,n+t));return n!==a&&(function(e,t){const n=parseFloat(t.toFixed(1));lt.voiceSettings[e]=n,"voiceSpeed"===e?Un=n:"voicePitch"===e&&(zn=n);localStorage.setItem("KG_Chat_Empowerment",JSON.stringify(lt)),function(){let e=document.querySelector(".voice-settings"),t=document.querySelector(".current-voice-speed"),n=document.querySelector(".current-voice-pitch");if(Ze){e||(e=document.createElement("div"),e.classList.add("voice-settings"),Pn.appendChild(e),e.offsetWidth,e.style.opacity="1"),n?.remove(),t||(t=document.createElement("span"),t.classList.add("current-voice-speed"),e.appendChild(t));let o=t.querySelector(".voice-value-info")||document.createElement("span");t.querySelector(".voice-value-info")||(o.classList.add("voice-speed","voice-value-info"),t.appendChild(o)),o.innerHTML=Un<=0||Un>=S?ce:`SPEED ${Number(Un).toFixed(1)}`;let s=t.querySelector(".voice-speed-progress")||document.createElement("span");if(!t.querySelector(".voice-speed-progress")){s.classList.add("voice-speed-progress");const e=document.createElement("span");e.classList.add("voice-speed-progress-fill"),s.appendChild(e),t.appendChild(s)}t.querySelector(".voice-speed-progress-fill").style.width=Rn().speed,e.timeoutId&&clearTimeout(e.timeoutId),e.timeoutId=setTimeout((()=>{e.style.opacity="0",setTimeout((()=>e.remove()),500)}),2e3)}else if(Qe){e||(e=document.createElement("div"),e.classList.add("voice-settings"),Pn.appendChild(e),e.offsetWidth,e.style.opacity="1"),t?.remove(),n||(n=document.createElement("span"),n.classList.add("current-voice-pitch"),e.appendChild(n));let o=n.querySelector(".voice-value-info")||document.createElement("span");n.querySelector(".voice-value-info")||(o.classList.add("voice-pitch","voice-value-info"),n.appendChild(o)),o.innerHTML=zn<=0||zn>=2?ce:`PITCH ${zn.toFixed(1)}`;let s=n.querySelector(".voice-pitch-progress")||document.createElement("span");if(!n.querySelector(".voice-pitch-progress")){s.classList.add("voice-pitch-progress");const e=document.createElement("span");e.classList.add("voice-pitch-progress-fill"),s.appendChild(e),n.appendChild(s)}n.querySelector(".voice-pitch-progress-fill").style.width=Rn().pitch,e.timeoutId&&clearTimeout(e.timeoutId),e.timeoutId=setTimeout((()=>{e.style.opacity="0",setTimeout((()=>e.remove()),500)}),2e3)}else e?.remove()}()}(e,a),t>0?a<s:a>o)}const{usersToTrack:Yn}=vt;const Gn=function(){const e=new AudioContext;return new Promise((t=>{e.onstatechange=function(){"running"===e.state&&t(e)}}))}(),Wn=[300,600],Zn=[600,300],Qn=[500],eo=[600,800],to=100;function no(e,t){Gn.then((n=>{for(let o=0;o<e.length;o++){const s=e[o];if(0===s)setTimeout((()=>{}),80);else{const e=n.createOscillator(),a=n.createGain();e.connect(a),e.frequency.value=s,e.type="sine";const r=n.createBiquadFilter();r.type="lowpass",r.frequency.value=250,e.connect(r);const i=n.createBiquadFilter();i.type="highpass",i.frequency.value=16e3,r.connect(i),a.connect(n.destination),a.gain.setValueAtTime(0,n.currentTime),a.gain.linearRampToValueAtTime(t,n.currentTime+.01),e.start(n.currentTime+o*to/1e3),e.stop(n.currentTime+(o*to+80)/1e3),a.gain.setValueAtTime(t,n.currentTime+(o*to+70)/1e3),a.gain.linearRampToValueAtTime(0,n.currentTime+(o*to+80)/1e3)}}}))}const oo=new Promise((e=>{const t=window.speechSynthesis;let n=t.getVoices();const o="Microsoft Pavel - Russian (Russia)",s="Microsoft Irina - Russian (Russia)";let a=n.find((e=>e.name===o)),r=n.find((e=>e.name===s));if(a&&r&&0!==n.length){const o=new SpeechSynthesisUtterance;o.lang="ru-RU",o.voice=r,e({synth:t,utterance:o,voices:n,pavelVoice:a,irinaVoice:r})}else t.addEventListener("voiceschanged",(()=>{if(n=t.getVoices(),a=n.find((e=>e.name===o)),r=n.find((e=>e.name===s)),a&&r){const o=new SpeechSynthesisUtterance;o.lang="ru-RU",o.voice=r,e({synth:t,utterance:o,voices:n,pavelVoice:a,irinaVoice:r})}}))}));async function so(e,t=t){const n=P("sound","gTTS"),o=await async function(e){return e.replace(/[-−_]/g," ").replace(/https?:\/\/(?:www\.)?([a-zA-Z0-9.-]+)(\/.*)?/g,((e,t)=>t)).replace(/\s(?=[?!,.:;@])/g,"").replace(/["#$%&'()*+\/<=>[\\\]^`{|}~]/g,"").split(" ").filter(Boolean).join(" ").trim()}(e);if(n){const e=(e=>e.split(/\s+/).reduce(((e,t)=>{const n=/[А-Яа-яЁё0-9]/.test(t)?"ru":"en";return e.length&&e[e.length-1].lang===n?e[e.length-1].text+=" "+t:e.push({lang:n,text:t}),e}),[]))(o);try{for(const{lang:t,text:n}of e)await new Promise(((e,o)=>{fetch(`http://127.0.0.1:5000/speak?text=${encodeURIComponent(n)}&lang=${t}`).then((e=>{if(!e.ok)throw new Error(`HTTP ${e.status}`);return e.arrayBuffer()})).then((t=>{const n=new(window.AudioContext||window.webkitAudioContext),s=new Audio(URL.createObjectURL(new Blob([t],{type:"audio/mp3"}))),a=n.createMediaElementSource(s),r=n.createGain();r.gain.value=2,a.connect(r),r.connect(n.destination),s.onended=e,s.onerror=o,s.play()})).catch(o)}))}catch(e){console.error("Server TTS failed:",e)}}else await async function(e,t=t){const{synth:n,utterance:o,voice:s}=await oo;return Object.assign(o,{text:e,rate:t,volume:1,pitch:zn,voice:s}),new Promise((e=>{o.onend=e,n.speak(o)}))}(e,t)}const ao={Male:{enter:"зашёл",leave:"вышел"},Female:{enter:"зашла",leave:"вышла"}};const{usersToTrack:ro}=vt,io=Ht().userList.general;let lo=new Map,co=0,uo=!1;function mo(e,t){if(!e)return;const n=t.toString().length;e.textContent=t,e.style.fontSize=Math.max(24-2*(n-1),12)+"px"}const po=new MutationObserver(D((e=>{e.forEach((e=>{if("childList"===e.type){const t=document.querySelector("#voice, #beep, #silence"),n=t&&"silence"===t.id,o=document.querySelector("#chat-wrapper.chat-hidden"),s=document.querySelector(".participant-count");if(o)return void(s&&(s.style.filter="grayscale(100%)",s.textContent="0"));const a=new Map(Array.from(io.children).map((e=>{const t=e.querySelector(".name"),n=t?.getAttribute("data-user"),o=t?.textContent?.trim();return n?[n,{userName:o}]:null})).filter(Boolean));if(!Rs)return;if(!uo)return s&&0===Number(s.textContent)&&function(e,t){let n=0;const o=()=>{if(n<=e){const s=Math.min(n/(e||1),1);mo(t,n++),t.style.filter=`grayscale(${100-100*s}%)`,setTimeout(o,20)}else N(t),T(t),uo=!0};setTimeout(o,20)}(a.size,s),a.forEach(((e,t)=>lo.set(t,e))),void setTimeout((()=>{uo=!0}),2e3);let r=[...a].filter((([e])=>!lo.has(e))).map((([e,t])=>({userId:e,...t}))),i=[...lo].filter((([e])=>!a.has(e))).map((([e,t])=>({userId:e,userName:t.userName})));lo=new Map(a);const l=lo.size;function c(e,t){const{userName:o,userId:s}=e,a=function(e){const t=ro.find((t=>t.name===e));return t?t.gender:null}(o),r=ro.some((e=>e.name===o&&"thawed"===e.state));Hn(o,"enter"===t?Q:ee,"enter"===t),yn(o,t),function(e,t){e&&t?(I[e]=I[e]||{},I[e].actionLog=I[e].actionLog||[],I[e].actionLog.push({type:t,timestamp:F()})):console.error("Missing userId or actionType")}(s,t),!n&&r&&function(e,t,n){if(!P("sound","presence"))return;const o=n||"Male",s=Yn.find((t=>t.name===e)),a="enter"===t?ao[o].enter:ao[o].leave;no("enter"===t?Wn:Zn,.2),setTimeout((()=>so(`${s.pronunciation} ${a}`,Un)),300)}(o,t,a)}l!==co&&uo&&s&&(mo(s,l),s.style.filter=l>0?"none":"grayscale(100%)",N(s)),r.forEach((e=>c(e,"enter"))),i.forEach((e=>c(e,"leave"))),co=l}}))}),300));let go=!1;const ho=new Set;function fo(e){ho.has(e)||(ho.add(e),go||(go=!0,async function(){for(const e of ho)await so(e,Un),ho.delete(e);go=!1}()))}const yo=["jpg","jpeg","png","gif","webp"],vo="📸",bo="🖥️",xo="💀️️",wo=.2,So=10,Co=.1;let ko=0,Eo=!1,$o=[],Lo=null;const{bigImageEvents:To}=k,Mo=e=>{const t=(e=>{try{return e.match(/\.([^?#.]+)(?:[?#]|$)/i)?.[1]?.toLowerCase()||""}catch(e){return console.error("Error extracting extension:",e.message),""}})(e);return{allowed:yo.includes(t),extension:t}},No=(e,t)=>{const n=document.createElement("img");n.src=e,n.classList.add("scaled-thumbnail"),document.body.appendChild(n),ko=t;let o=1,s=!1,a=0,r=0,i=-50,l=-50;const c=e=>{tt(e,"hide"),document.querySelector(".popup-panel")||nt("hide"),O()};return To.unfocusedClick=e=>{n.contains(e.target)||(n.remove(),O())},To.keydown=e=>{"Escape"===e.code||"Space"===e.code?(e.preventDefault(),c(n)):"ArrowLeft"===e.code?qo(-1):"ArrowRight"===e.code&&qo(1)},To.wheel=e=>{const t=e.deltaY<0?1:-1;o+=t*Co*o,o=Math.max(wo,Math.min(o,So)),n.style.transform=`translate(${i}%, ${l}%) scale(${o})`},To.mousemove=e=>{if(s){if(e.ctrlKey){const t=e.clientY-r,n=t<0?1:-1,s=Math.abs(t)*Co*.05;o+=n*s*o,o=Math.max(wo,Math.min(o,So))}else{const t=(e.clientX-a)/o*5,s=(e.clientY-r)/o*5;i+=t/n.clientWidth*100,l+=s/n.clientHeight*100}n.style.transform=`translate(${i}%, ${l}%) scale(${o})`,a=e.clientX,r=e.clientY}},To.mousedown=e=>{const{button:t,clientX:o,clientY:i,target:l,ctrlKey:d}=e;if((0===t||2===t)&&l!==n)return;const u=l.src;0===t?qo(-1):2===t?(e.preventDefault(),d?(navigator.clipboard.writeText(u).catch(console.error),c(n)):qo(1)):1===t&&(s=!0,a=o,r=i,e.preventDefault())},To.mouseup=e=>{1===e.button&&(s=!1)},To.contextmenu=e=>e.preventDefault(),Object.entries(A).forEach((([e,t])=>{document.addEventListener(e,t)})),n},qo=e=>{const t=ko+e;t>=0&&t<$o.length&&!Eo&&(Eo=!0,Lo&&(Lo.src=$o[t].imgSrc),setTimeout((()=>Eo=!1),50),ko=t)};function Ao(e){const t=document.querySelector({generalMessages:".messages-content div",chatlogsMessages:".chat-logs-container",personalMessages:".messages-container-wrapper"}[e]);if(!t)return;const n=t.querySelectorAll("a:not(.skipped):not(.processed-image)");function o(n,o){const s=document.createElement("div");s.classList.add("clickable-thumbnail"),s.dataset.sourceLink=n.href;const a=document.createElement("img");a.src=n.href,a.onload=()=>{s.appendChild(a),n.parentNode.insertBefore(s,n.nextSibling),Yt(e,600)},a.onerror=()=>{console.error("Failed to load image:",n.href),n.classList.add("skipped")},o?n.querySelector(".clickable-thumbnail")||n.addEventListener("click",(e=>{n.querySelector(".clickable-thumbnail")||(s.appendChild(a),n.parentNode.insertBefore(s,n.nextSibling))})):(s.appendChild(a),n.parentNode.insertBefore(s,n.nextSibling)),s.addEventListener("click",(e=>{e.stopPropagation(),$o=[],t.querySelectorAll(".clickable-thumbnail").forEach(((e,t)=>{const n=e.querySelector("img");n&&e.dataset.sourceLink&&$o.push({link:e.dataset.sourceLink,imgSrc:n.src,index:t})}));const o=$o.findIndex((e=>e.link===n.href||e.imgSrc===a.src));Lo=No(a.src,o>=0?o:0),tt(Lo,"show"),nt("show")}))}n.length&&n.forEach((e=>{if(!e.href||!e.href.startsWith("http"))return;const{allowed:t,extension:n}=Mo(e.href);if(!t)return;e.classList.add("media");const{isTrusted:s,domain:a}=U(e.href);Ge(e,It(e.href)?jt(e.href):e.href),s?function(e,t,n){e.textContent=`${vo} ${t.toUpperCase()} ${bo} ${n}`,e.classList.add("processed-image"),o(e,!1)}(e,n,a):function(e,t,n){e.classList.add("skipped"),e.textContent=`${vo} ${t.toUpperCase()} ${bo} ${n} ${xo} Untrusted`,e.addEventListener("click",(t=>{e.classList.contains("processed-image")||(t.preventDefault(),e.classList.remove("skipped"),e.classList.add("processed-image"),o(e,!0))}))}(e,n,a)}))}const Io="📺",jo="📹",Oo="🎬️",Bo="🖥️",Do="💀️️",Ho=["mp4","webm","ogg","mov","avi"];let Po=null,Fo=null;async function Uo(e,t,n,o,s){e.innerHTML="",t.innerHTML="";const a=await async function(e){const t=`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${e}&format=json`;try{const e=await fetch(t),n=await e.json();return{title:n.title||"Title not found",channel:n.author_name||"Channel not found"}}catch(e){return console.error("Error fetching YouTube metadata:",e),{title:"Error",channel:"Error"}}}(n),r=document.createElement("span");r.classList.add("channel-name"),r.textContent=`${Io} ${a.channel}`;const i=document.createElement("span");i.classList.add("video-title"),i.textContent=`${jo} ${a.title}`,e.append(r,i);const l=document.createElement("img");l.src=`https://img.youtube.com/vi/${n}/hqdefault.jpg`,l.alt=o,l.classList.add("youtube-thumb"),t.appendChild(l),l.addEventListener("load",(()=>{Yt(s,600)}))}function zo(e){if(!e)return void console.warn("containerType parameter is required");const t={generalMessages:".messages-content div",chatlogsMessages:".chat-logs-container",personalMessages:".messages-container-wrapper"};if(!t[e])return void console.warn(`Invalid containerType: ${e}`);const n=document.querySelector(t[e]);if(!n)return;const o=n.querySelectorAll("a:not(.skipped):not(.processed-video)");function s(e,t,n,o,s){const{youtubeMatch:a,videoType:r,videoId:i}=o,l=(e=>{const t=e.match(/\.([^?#.]+)(?:[?#]|$)/i)?.[1]?.toLowerCase()||"";return{allowed:Ho.includes(t),extension:t}})(t);if(!a&&!l.allowed)return;e.classList.add("processed-video");const c=document.createElement("div");if(c.classList.add("video-wrapper"),e.textContent=`${Oo} ${r} ${Bo} ${n}`,Ge(e,It(t)?jt(t):t),e.style.display="inline-flex",a){const t=document.createElement("div");t.classList.add("youtube-info");const n=document.createElement("div");n.classList.add("youtube-placeholder"),n.dataset.videoId=i,n.dataset.videoType=r,n.dataset.containerType=s,e.parentNode.insertBefore(c,e),c.append(e,t,n),Uo(t,n,i,r,s),n.addEventListener("click",(()=>{if(Fo&&Fo!==n){const e=Fo.dataset.videoId,t=Fo.dataset.videoType,n=Fo.dataset.containerType,o=Fo.previousElementSibling;o&&o.classList.contains("youtube-info")&&Uo(o,Fo,e,t,n)}Fo=n;const e=(Po||(Po=document.createElement("iframe"),Po.classList.add("video-container"),Po.allowFullscreen=!0,Po.setAttribute("allow","fullscreen")),Po);e.src=`https://www.youtube.com/embed/${i}?autoplay=1`,n.innerHTML="",n.appendChild(e)}))}else{const n=document.createElement("video");n.classList.add("video-container"),n.src=t,n.controls=!0,e.parentNode.insertBefore(c,e),c.append(e,n)}}o.length&&o.forEach((t=>{const n=t.href;if(!n)return;const o=function(e){const t=e.match(/(?:shorts\/|live\/|watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/i);if(t)return{youtubeMatch:!0,videoId:t[1],videoType:e.includes("shorts/")?"Shorts":e.includes("live/")?"Live":e.includes("watch?v=")?"Watch":e.includes("youtu.be/")?"Share":"YouTube"};const n=e.split(".").pop().toLowerCase();return!!Ho.includes(n)&&{youtubeMatch:!1,videoType:`Video (${n.toUpperCase()})`}}(n);if(!o)return;t.classList.add("media");const{isTrusted:a,domain:r}=U(n);if(!a)return t.classList.add("skipped"),t.textContent=`${Oo} ${o.videoType} ${Bo} ${r} ${Do} Untrusted`,void t.addEventListener("click",(a=>{t.classList.contains("processed-video")||(a.preventDefault(),t.classList.remove("skipped"),s(t,n,r,o,e))}));s(t,n,r,o,e)}))}const _o={};function Ro(){if("true"!==localStorage.getItem("shouldShowPopupMessage"))return;const e=document.querySelector(".messages-content p:last-of-type");if(e){const t=e.querySelector(".time"),n=e.querySelector(".username"),o=Array.from(e.childNodes).map((e=>{if(e.nodeType===Node.TEXT_NODE)return{type:"text",value:e.nodeValue.replace(/ /g," ")};if(e.nodeType===Node.ELEMENT_NODE){if("a"===e.tagName.toLowerCase()&&e.classList.contains("private"))return{type:"text",value:"📢 "};if("span"===e.tagName.toLowerCase()&&e.classList.contains("private"))return{type:"text",value:e.textContent.replace(/ /g," ")};if("img"===e.tagName.toLowerCase())return{type:"img",title:e.getAttribute("title")};if("a"===e.tagName.toLowerCase())return{type:"anchor",href:e.getAttribute("href")}}})).filter(Boolean),s=t.textContent.replace(/[\[\]]/g,""),a=n.textContent.replace(/[<>]/g,"");let r=_o[a];r||(r=15*Math.floor(24*Math.random()),_o[a]=r);let i=document.querySelector(".popup-messages-container");if(i||(i=document.createElement("div"),i.classList.add("popup-messages-container"),document.body.appendChild(i)),i.childElementCount>=10){const e=i.firstChild;e.classList.add("fade-out"),setTimeout((()=>{i.removeChild(e)}),300)}const l=document.createElement("div");l.classList.add("popup-chat-message"),l.style.filter=`hue-rotate(${r}deg)`;const c=document.createElement("div");c.classList.add("time-icon"),c.innerHTML=icons.clockSVG;const d=document.createElement("div");d.classList.add("time"),d.textContent=s;const u=document.createElement("div");u.classList.add("user-icon"),u.innerHTML=icons.userSVG;const m=document.createElement("div");m.classList.add("username"),m.textContent=a;const p=document.createElement("div");p.classList.add("action-icon"),p.innerHTML=icons.actionSVG;const g=document.createElement("div");g.classList.add("message"),l.appendChild(c),l.appendChild(d),l.appendChild(u),l.appendChild(m),l.appendChild(p),l.appendChild(g),o.forEach((e=>{const t=document.createElement("div");"text"===e.type?t.textContent=e.value:"img"===e.type?t.innerHTML=`&nbsp;${e.title}&nbsp;`:"anchor"===e.type&&(t.innerHTML=`&nbsp;${e.href}&nbsp;`),g.appendChild(t)})),i.appendChild(l)}}const{ignored:Jo}=vt;let Ko=!1;const Vo=new MutationObserver((async e=>{if(J(document.querySelectorAll(".username"),"all"),Rs)for(let t of e)if("childList"===t.type)for(let e of t.addedNodes)if(e.nodeType===Node.ELEMENT_NODE&&"P"===e.tagName){const t=e.querySelector(".username");t&&J(t,"one");const n=localStorage.getItem("previousMessageText"),o=await At(),s=o?.messageText||null,a=o?.usernameText||null;if(R(s)&&(console.log("Ban message detected:",s),new Audio("https://github.com/VimiummuimiV/Sounds/raw/refs/heads/main/Mario_Game_Over.mp3").play()),a&&Jo.includes(a)){const t=`from-${Ft(a)}`;e.classList.add("ignored-user",t),e.style.display="none";continue}if(s){let t=null;if(/^[^\s,]+,/.test(s)?t=s.split(",")[0].trim():/^[^\s]+ /.test(s)&&(t=s.split(" ")[0].trim()),t&&Jo.includes(t)){const n=`to-${Ft(t)}`;e.classList.add("ignored-user",n),e.style.display="none";continue}}const r=document.querySelector("#voice, #beep, #silence"),i=r&&"voice"===r.id,l=r&&"beep"===r.id,c=document.querySelector("#every-message, #mention-message"),d=c&&"every-message"===c.id,u=c&&"mention-message"===c.id,m="[шепчет вам]",p=e.querySelector(".room.private"),g=p&&p.textContent.includes(m);if(i&&Rs&&s&&s!==n&&(localStorage.setItem("previousMessageText",s),a&&!a.includes(v))){(d||u&&Ko||g)&&fo(s)}if(l&&Rs&&s&&s!==n&&(localStorage.setItem("previousMessageText",s),a&&!a.includes(v))){if(d||u&&Ko||g){no(!d||Ko?eo:Qn,.2),Ko&&(Ko=!1)}}Rs&&(Ao("generalMessages"),zo("generalMessages"),Ot("generalMessages"),Rt(),Yt("generalMessages",350),Ro(),_())}}));const{chatField:Xo,messagesContainer:Yo}=Ht();let Go=null;(j("gmid")||j("gamelist"))&&(Go=document.createElement("div"),Go.className="length-field-popup",Yo.appendChild(Go));const Wo=document.createElement("canvas").getContext("2d");let Zo,Qo,es,ts=!1,ns=0;function os(e){let t;t=e>ns?`${e} 🡆`:e<ns?`🡄 ${e}`:`${e}`,Go.textContent=t,function(e){if(!Go)return void console.error("lengthPopup is not defined");let t;if(0===e)t="hsl(200, 20%, 50%)";else if(e>=1&&e<=90)t="hsl(120, 100%, 40%)";else if(e>90&&e<=100){const n=(e-90)/10;t=`hsl(${Math.round(120+-60*n)}, 100%, 40%)`}else if(e>100&&e<=190)t="hsl(60, 100%, 50%)";else if(e>190&&e<=200){const n=(e-190)/10;t=`hsl(${Math.round(60+-30*n)}, 100%, 50%)`}else if(e>200&&e<=250)t="hsl(40, 100%, 50%)";else if(e>250&&e<=300){const n=(e-250)/50;t=`hsl(${Math.round(40+-40*n)}, 100%, 70%)`}else t="hsl(0, 100%, 70%)";Go.style.color=t}(e),ns=e}function ss(e){ts!==e&&(Go.classList.toggle("bounce-in",e),Go.classList.toggle("bounce-out",!e),ts=e,e||setTimeout((()=>Go.classList.remove("bounce-out")),500))}function as(){clearTimeout(Zo),os(Xo.value.length),function(e){const t=getComputedStyle(Xo);Wo.font=`${t.fontWeight} ${t.fontSize} ${t.fontFamily}`;const n=Wo.measureText(e).width,o=Xo.offsetLeft+n+5,s=Xo.offsetLeft+Xo.offsetWidth-Go.offsetWidth;Go.style.left=`${Math.min(o,s)}px`}(Xo.value),ss(!0),Zo=setTimeout((()=>ss(!1)),1e3)}function rs(e){"Enter"===e.key&&(os(0),Object.assign(Go.style,{left:"0px",color:"hsl(200, 20%, 50%)"}),ss(!0),Zo=setTimeout((()=>ss(!1)),1e3))}function is(){es.innerHTML="every-message"===Qo.id?ie:le}var ls=n(807),cs={};cs.styleTagTransform=g(),cs.setAttributes=d(),cs.insert=l().bind(null,"head"),cs.domAPI=r(),cs.insertStyleElement=m();s()(ls.A,cs);ls.A&&ls.A.locals&&ls.A.locals;var ds=n(805),us={};us.styleTagTransform=g(),us.setAttributes=d(),us.insert=l().bind(null,"head"),us.domAPI=r(),us.insertStyleElement=m();s()(ds.A,us);ds.A&&ds.A.locals&&ds.A.locals;const ms="chatlogs";function ps(){return new Promise(((e,t)=>{const n=indexedDB.open("chatlogsDB",1);n.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains(ms)||t.createObjectStore(ms,{keyPath:"date"})},n.onsuccess=()=>e(n.result),n.onerror=()=>t(n.error)}))}async function gs(e){const t=await ps();return new Promise(((n,o)=>{const s=t.transaction(ms,"readwrite"),a=s.objectStore(ms),r=a.get(e.date);r.onsuccess=()=>{const t=r.result,i=t&&t.html?new Blob([t.html]).size:0,l=e.html?new Blob([e.html]).size:0;a.put(e),s.oncomplete=()=>{let e=fs();e+=(l-i)/1024,ys(e),n()},s.onerror=()=>o(s.error)},r.onerror=()=>o(r.error)}))}const hs="chatlogsTotalSizeKB";function fs(){return parseFloat(localStorage.getItem(hs)||"0")}function ys(e){localStorage.setItem(hs,Number(e).toFixed(2))}function vs(e,t,n,o,s,a=[],r=!1){let i=null;const l=new Map;if(o||(t.innerHTML=""),s){const e=document.createElement("div");e.className="date-item",e.textContent=s,t.appendChild(e)}return e.forEach((({time:e,username:o,message:s})=>{l.set(o,(l.get(o)||0)+1);const c=document.createElement("div");c.classList.add("message-item");const d=document.createElement("span");d.className="message-time",d.textContent=e;const u=document.createElement("span");u.className="message-username",u.textContent=o;const m=function(e,t,n=15){let o=t[e];return o||(o=Math.floor(Math.random()*(210/n))*n,t[e]=o),o}(o,n);u.style.color=`hsl(${m}, 80%, 50%)`;const p=document.createElement("span");p.className="message-text";let g=s.replace(/:(?=\w*[a-zA-Z])(\w+):/g,((e,t)=>`<img src="/img/smilies/${t}.gif" alt=":${t}:" title=":${t}:" class="smile">`)).replace(/(https?:\/\/[^\s]+)/gi,(e=>`<a href="${e}" target="_blank" rel="noopener noreferrer">${e}</a>`));r&&a&&a.length>0&&(g=function(e,t){if(!(r&&t&&t.length&&e))return e;const n=t.map((e=>e.replace(/[.*+?^${}()|[\\]\\]/g,"\\$&"))),o=new RegExp(`(${n.join("|")})`,"gi");return e.replace(o,'<span class="search-match">$1</span>')}(g,a)),p.innerHTML=g,c.style.marginTop=i!==o?"0.6em":"",i=o,c.appendChild(d),c.appendChild(u),c.appendChild(p),t.appendChild(c)})),l}function bs(e,t,n){if("shown"===localStorage.getItem("shouldShowActiveUsers")){let o=t.querySelector(".active-users");o||(o=document.createElement("div"),o.className="active-users",t.appendChild(o));const s=Array.from(e.entries()).sort((([,e],[,t])=>t-e));o.innerHTML="",s.forEach((([e,t])=>{const s=document.createElement("div");s.className="active-user-item";const a=document.createElement("span");a.className="active-user-name",a.textContent=e;const r=n[e]||0;a.style.color=`hsl(${r}, 80%, 50%)`;const i=document.createElement("span");i.className="active-user-messages-count",i.textContent=t,i.style.color=`hsl(${r}, 80%, 50%)`,i.style.backgroundColor=`hsla(${r}, 80%, 50%, 0.2)`,s.appendChild(i),s.appendChild(a),o.appendChild(s)}))}}const xs="📌️",ws="✏️",Ss="⚠️",Cs="🔍",ks="👤",Es="📄",$s="📜",Ls="📋",Ts="📅",Ms={selectParseMode:{en:[`${xs} Select parse mode`,"1. Single date","2. From date","3. Date range","4. From start","5. From registered date"].join("\n"),ru:[`${xs} Выберите режим парсинга`,"1. Одна дата","2. С даты","3. Диапазон дат","4. С самого начала","5. С даты регистрации"].join("\n")},invalidSelection:{en:`${Ss} Invalid selection.`,ru:`${Ss} Неверный выбор.`},enterDateRange:{en:[`${ws} Enter ${Ts} date range`,`${Ls} Examples:`,"2024-01-01 - 2024-01-07","20240101 - 20240107","2024:01:01 - 2024:01:07","240101 - 240107","24-02-02 - 24-03-03"].join("\n"),ru:[`${ws} Введите диапазон ${Ts} дат`,`${Ls} Примеры:`,"2024-01-01 - 2024-01-07","20240101 - 20240107","2024:01:01 - 2024:01:07","240101 - 240107","24-02-02 - 24-03-03"].join("\n")},invalidRange:{en:`${Ss} Invalid range format or one/both ${Ts} dates out of bounds. Please try again.`,ru:`${Ss} Неверный формат диапазона или одна/обе ${Ts} даты вне допустимого диапазона. Пожалуйста, попробуйте снова.`},enterFromDate:{en:[`${ws} Enter FROM ${Ts} date`,`${Ls} Examples:`,"2024-01-01","20240101","2024:01:01","240101",`${xs} Range will be FROM this ${Ts} date to today.`].join("\n"),ru:[`${ws} Введите начальную ${Ts} дату`,`${Ls} Примеры:`,"2024-01-01","20240101","2024:01:01","240101",`${xs} Диапазон будет с этой ${Ts} даты до сегодня.`].join("\n")},invalidFromDate:{en:`${Ss} Invalid FROM ${Ts} date format or date out of bounds. Please try again.`,ru:`${Ss} Неверный формат начальной ${Ts} даты или дата вне допустимого диапазона. Пожалуйста, попробуйте снова.`},enterSingleDate:{en:[`${ws} Enter a ${Ts} date`,`${Ls} Examples:`,"2024-01-01","20240101","2024:01:01","240101"].join("\n"),ru:[`${ws} Введите ${Ts} дату`,`${Ls} Примеры:`,"2024-01-01","20240101","2024:01:01","240101"].join("\n")},invalidDate:{en:`${Ss} Invalid ${Ts} date format or date out of bounds. Please try again.`,ru:`${Ss} Неверный формат ${Ts} даты или дата вне допустимого диапазона. Пожалуйста, попробуйте снова.`},enterUsernames:{en:[`${ks} Enter ${ks} username(s) to parse (comma-separated):`,`${xs} Leave empty to search ${Es} messages from all ${ks} users.`].join("\n"),ru:[`${ks} Введите имя или имена пользователей для парсинга (через запятую):`,`${xs} Оставьте пустым, чтобы искать ${Es} сообщения всех ${ks} пользователей.`].join("\n")},userPossiblyBanned:{en:e=>`${Ss} User ${ks} ${e} not found. The user may be banned or deleted. Continue anyway?`,ru:e=>`${Ss} Пользователь ${ks} ${e} не найден. Возможно, пользователь забанен или удалён. Продолжить в любом случае?`},retrieveHistoryPrompt:{en:`${xs} Do you want to retrieve all previous ${ks} history usernames for this user? (1 - yes, 2 - no)`,ru:`${xs} Хотите получить все предыдущие ${ks} имена пользователей для этого пользователя? (1 - да, 2 - нет)`},confirmUsernames:{en:`${ws} Confirm or edit the list of ${ks} usernames to parse (comma-separated):`,ru:`${ws} Подтвердите или отредактируйте список ${ks} имён для парсинга (через запятую):`},noUsersSelected:{en:`${Ss} No ${ks} users selected.`,ru:`${Ss} Не выбраны ${ks} пользователи.`},unableToGetRegDate:{en:`${Ss} Could not get registration ${Ts} date.`,ru:`${Ss} Не удалось получить ${Ts} дату регистрации.`},editStartDate:{en:e=>`${ws} From which ${Ts} to start parsing? (registration date: ${e})`,ru:e=>`${ws} С какой ${Ts} начать парсинг? (дата регистрации: ${e})`},invalidEditedDate:{en:`${Ss} Invalid ${Ts} date format.`,ru:`${Ss} Неверный формат ${Ts} даты.`},dateBeforeMinimal:{en:e=>`${Ss} ${$s} Chat logs are only available from ${e}. Using this ${Ts} date.`,ru:e=>`${Ss} ${$s} Логи чата доступны только с ${e}. Используется эта ${Ts} дата.`},enterSearchTerms:{en:e=>[`${Cs} Enter search terms to filter ${Es} messages (comma-separated):`,e?`${xs} This will search through all ${ks} users' ${Es} messages for the specified terms.`:`${xs} Leave empty to show all ${Es} messages from selected ${ks} users.`,`${Ls} Examples:`,"hello, dude","creature, spammer, troll",`${xs} Note: Search is case-insensitive and will find ${Es} messages containing ANY of the terms.`].join("\n"),ru:e=>[`${Cs} Введите поисковое слово или слова для фильтрации ${Es} сообщений (через запятую):`,e?`${xs} Будет производиться поиск по всем ${Es} сообщениям ${ks} пользователей для указанных слов.`:`${xs} Оставьте пустым, для поиска всех ${Es} сообщений выбранных ${ks} пользователей.`,`${Ls} Примеры:`,"привет, чувак","чучело, спамер, тролль",`${xs} Примечание: поиск не чувствителен к регистру и найдёт ${Es} сообщения, содержащие ЛЮБОЕ из слов.`].join("\n")},searchAllUsersRequired:{en:`${Ss} When searching all ${ks} users, you must provide search terms to filter ${Es} messages.`,ru:`${Ss} При поиске по всем ${ks} пользователям необходимо указать поисковые слова для фильтрации ${Es} сообщений.`},searchInfoAllUsers:{en:e=>`${Cs} Searching all ${ks} users for ${Es} messages containing: ${e.join(", ")}`,ru:e=>`${Cs} Поиск по всем ${ks} пользователям сообщений ${Es}, содержащих: ${e.join(", ")}`},searchInfoSomeUsers:{en:(e,t)=>`${Cs} Searching for ${Es} messages from: ${ks} ${e.join(", ")}, containing: ${t.join(", ")}`,ru:(e,t)=>`${Cs} Поиск ${Es} сообщений от: ${ks} ${e.join(", ")}, содержащих: ${t.join(", ")}`},searchInfoAllFromUsers:{en:e=>`${Cs} Showing all ${Es} messages from: ${ks} ${e.join(", ")}`,ru:e=>`${Cs} Показаны все ${Es} сообщения от: ${ks} ${e.join(", ")}`},dateProgressInfo:{en:(e,t,n)=>`${Ts} Start: ${e} | Current: ${t} | Progress: ${n}%`,ru:(e,t,n)=>`${Ts} Начало: ${e} | Текущая: ${t} | Прогресс: ${n}%`},noMessagesFoundAll:{en:e=>`${Ss} No ${Es} messages found containing the search terms: ${e.join(", ")}`,ru:e=>`${Ss} ${Es} Сообщения, содержащие слова: ${e.join(", ")}, не найдены.`},noMessagesFoundSome:{en:e=>`${Ss} No ${Es} messages found for the selected ${ks} user(s) containing the search terms: ${e.join(", ")}`,ru:e=>`${Ss} ${Es} Сообщения выбранных ${ks} пользователей, содержащие слова: ${e.join(", ")}, не найдены.`},noMessagesFound:{en:`${Ss} No ${Es} messages found for the selected ${ks} user(s).`,ru:`${Ss} ${Es} Сообщения для выбранных ${ks} пользователей не найдены.`},deleteConfirm:{en:`${Ss} Are you sure you want to delete all saved ${$s} chatlogs?`,ru:`${Ss} Вы уверены, что хотите удалить все сохранённые ${$s} чатлоги?`},deleteSuccess:{en:`${xs} All ${$s} chatlogs deleted and cache size reset.`,ru:`${xs} Все ${$s} чатлоги удалены, размер кэша сброшен.`}};function Ns(e,t){let n=!1,o=!1,s=null;const a=Y();function r(e){let t,n,o;if(/^\d{4}[:\-]\d{2}[:\-]\d{2}$/.test(e))[t,n,o]=e.replace(/:/g,"-").split("-");else if(/^\d{8}$/.test(e))t=e.slice(0,4),n=e.slice(4,6),o=e.slice(6,8);else{if(!/^\d{6}$/.test(e))return null;t="20"+e.slice(0,2),n=e.slice(2,4),o=e.slice(4,6)}return function(e,t,n){const o=(new Date).getFullYear();return e=parseInt(e,10),t=parseInt(t,10),n=parseInt(n,10),!(e>o||t<1||t>12||n<1||n>31)}(t,n,o)?`${t}-${n.padStart(2,"0")}-${o.padStart(2,"0")}`:null}async function i(){let e="";for(;;){if(e=prompt(Ms.enterUsernames[a],e||""),null===e)return null;if(!e||!e.trim())return[];let t=e.split(",").map((e=>e.trim())).filter(Boolean);if(0===t.length)return[];const n=[];for(const e of t){(await nn(e)||confirm(Ms.userPossiblyBanned[a](e)))&&n.push(e)}if(0!==n.length){if(1===n.length){if("1"===prompt(Ms.retrieveHistoryPrompt[a],"2")){const e=await an(n[0],"usernamesHistory");if(Array.isArray(e)&&e.length>0){const t=[n[0],...e.filter((e=>e!==n[0]))],o=prompt(Ms.confirmUsernames[a],t.join(", "));return o?o.split(",").map((e=>e.trim())).filter(Boolean):null}}}return n}}}function l(e,t){if(!t||0===t.length)return!0;if(!e)return!1;const n=e.toLowerCase();return t.some((e=>n.includes(e)))}function c(){const e=t.querySelector(".panel-header-shuffle-button");e&&(e.dataset.mode="loadToday",e.classList.add("today"),e.innerHTML=Te,Ge(e,{en:"Load Today's Chat Logs",ru:"Загрузить сегодняшние логи чата"}))}function d(e,t,n){const o=n-t,s=e-t;return o<=0?100:Math.min(100,Math.max(0,Math.round(s/o*100)))}async function u(){window.chatlogsParserState||(window.chatlogsParserState={isRunning:()=>n,stop:m}),window.stopChatlogsParser||(window.stopChatlogsParser=m),n=!0,o=!1,s=new AbortController,e.innerHTML=De,function(){const e=t.querySelector(".panel-header-shuffle-button");e&&(e.dataset.mode="",e.classList.remove("today"),e.innerHTML=Le,Ge(e,{en:"Random Date",ru:"Случайная дата"}))}();const u=await async function(){let e;for(;;){if(e=prompt(Ms.selectParseMode[a],"1"),null===e)return null;if(["1","2","3","4","5"].includes(e))break;alert(Ms.invalidSelection[a])}const t={};if("5"===e)return t.mode="fromregistered",t;if("4"===e)return t.from=w,t.to=(new Date).toISOString().slice(0,10),t.mode="fromstart",t;if("3"===e){let e,n,o;for(;;){if(e=prompt(Ms.enterDateRange[a],""),null===e)return null;if(!e.trim())continue;const s=e.match(/([\d:\-]{6,10})\s*-\s*([\d:\-]{6,10})/);if(s&&(n=r(s[1]),o=r(s[2]),n&&o))return t.from=n,t.to=o,t.mode="range",t;alert(Ms.invalidRange[a])}}else if("2"===e){let e,n;for(;;){if(e=prompt(Ms.enterFromDate[a],""),null===e)return null;if(e.trim()){if(n=r(e.trim()),n)return t.from=n,t.to=(new Date).toISOString().slice(0,10),t.mode="fromdate",t;alert(Ms.invalidFromDate[a])}}}else if("1"===e){let e,n;for(;;){if(e=prompt(Ms.enterSingleDate[a],""),null===e)return null;if(e.trim()){if(n=r(e.trim()),n)return t.from=n,t.to=n,t.mode="single",t;alert(Ms.invalidDate[a])}}}}();if(!u)return void p();let g;if("fromregistered"===u.mode){let e=await i();if(null===e||0===e.length)return alert(Ms.noUsersSelected[a]),void p();let t=[];for(const n of e){let e=await an(n,"registered"),o=null;"string"==typeof e?o=e:"number"==typeof e&&(o=new Date(1e3*e).toISOString().slice(0,10)),o&&t.push(o)}if(!t.length)return alert(Ms.unableToGetRegDate[a]),void p();let n=t.sort()[0],o=prompt(Ms.editStartDate[a](n),n);if(!o)return void p();if(o=r(o.trim()),!o)return alert(Ms.invalidEditedDate[a]),void p();let s=w;o<s&&(alert(Ms.dateBeforeMinimal[a](s)),o=s),u.from=o,u.to=(new Date).toISOString().slice(0,10),g=e}else if(g=await i(),null===g)return void p();const h=0===g.length,f=function(e=!1){let t;for(;;){if(t=prompt(Ms.enterSearchTerms[a](e),""),null===t)return null;if(!t.trim()){if(e){alert(Ms.searchAllUsersRequired[a]);continue}return[]}return t.split(",").map((e=>e.trim().toLowerCase())).filter(Boolean)}}(h);if(null===f)return void p();if(h&&0===f.length)return alert(Ms.searchAllUsersRequired[a]),void p();let y=u.from,v=u.to;const b={};let x=[];const S=new Map,C=(k=t)?k.classList.contains("chat-logs-container")?k:k.querySelector(".chat-logs-container"):null;var k;C&&(C.innerHTML="");let E=null;if(C){const e=document.createElement("div");e.className="search-messages-info",h?e.textContent=Ms.searchInfoAllUsers[a](f):f.length>0?e.textContent=Ms.searchInfoSomeUsers[a](g,f):e.textContent=Ms.searchInfoAllFromUsers[a](g),C.appendChild(e),E=document.createElement("div"),E.className="search-messages-date",E.textContent="",e.insertAdjacentElement("afterend",E)}const $=new Date(y),L=new Date(v);let T=new Date($);for(;T<=L&&!o;){const e=T.toISOString().slice(0,10);if(E){const t=d(T,$,L);E.textContent=Ms.dateProgressInfo[a](y,e,t)}try{const{chatlogs:t}=await Os(e,null,s.signal);if(o)break;let n;if(h?n=t.filter((e=>e&&e.message&&l(e.message,f))):(n=t.filter((e=>e&&e.message&&g.includes(e.username))),f.length>0&&(n=n.filter((e=>l(e.message,f))))),o)break;if(x=x.concat(n),n.forEach((({username:e})=>{S.set(e,(S.get(e)||0)+1)})),o)break;if(C&&n.length>0){if(vs(n,C,b,!0,e,f,f&&f.length>0),o)break;bs(S,C.closest(".chat-logs-panel"),b)}if(o)break;if(await new Promise((e=>setTimeout(e,60))),o)break;T.setDate(T.getDate()+1)}catch(e){if("AbortError"===e.name){console.log("Parsing was aborted");break}console.error("Error during parsing:",e);break}}if(C&&0===x.length){let e;e=h?Ms.noMessagesFoundAll[a](f):f.length>0?Ms.noMessagesFoundSome[a](f):Ms.noMessagesFound[a],C.innerHTML=`<div class="no-messages-info">${e}</div>`;const t=C.closest(".chat-logs-panel");if(t){const e=t.querySelector(".active-users");e&&(e.innerHTML="")}}p(),C&&bs(S,C.closest(".chat-logs-panel"),b),c()}function m(){o=!0,s&&s.abort(),n=!1,p(),c()}function p(){e.innerHTML=Be,n=!1,o=!1,s=null}e.addEventListener("click",(async e=>{e.ctrlKey?confirm(Ms.deleteConfirm[a])&&(await async function(e){const t=await ps();return new Promise(((n,o)=>{const s=t.transaction(ms,"readwrite"),a=s.objectStore(ms),r=a.get(e);r.onsuccess=()=>{const t=r.result,i=t&&t.html?new Blob([t.html]).size:0;a.delete(e),s.oncomplete=()=>{let e=fs();e-=i/1024,ys(Math.max(0,e)),n()},s.onerror=()=>o(s.error)},r.onerror=()=>o(r.error)}))}(),alert(Ms.deleteSuccess[a])):n?m():await u()}))}const{ignored:qs}=vt,As=Y(),Is=1024e3;let{panelsEvents:js}=k;const Os=async(e,t)=>{t&&(t.innerHTML="");const n=`https://klavogonki.ru/chatlogs/${e}.html`,o={chatlogs:[],url:n,size:0,error:null,info:"ru"===As?"Пропущено: слишком большой лог.":"Skipped: chatlog too large.",placeholder:"ru"===As?"Пропущено: слишком большой лог.":"Skipped: chatlog too large."},s=`${n}?rand=${Math.floor(Math.random()*10**20)}`;let a,r=!1;const i=await async function(e){const t=await ps();return new Promise(((n,o)=>{const s=t.transaction(ms,"readonly").objectStore(ms).get(e);s.onsuccess=()=>n(s.result),s.onerror=()=>o(s.error)}))}(e);if(i){if(i.skipped)return o;i.html&&(a=i.html,r=!0)}if(!a)try{const t=await fetch(s);if(!t.ok)throw new Error("Network response was not ok");const n=t.body.getReader();let r=0,i=[],l=!1;for(;!l;){const{value:t,done:s}=await n.read();if(t){if(r+=t.length,r>Is)return n.cancel(),e!==x&&await gs({date:e,skipped:!0,reason:"too large"}),o;i.push(t)}l=s}let c=new Uint8Array(r),d=0;for(let e of i)c.set(e,d),d+=e.length;a=new TextDecoder("utf-8").decode(c),e!==x&&await gs({date:e,html:a})}catch(e){return{chatlogs:[],url:s,size:0,error:e.message,info:null,placeholder:"ru"===As?"Ошибка при обработке логов.":"Error processing logs."}}const l=a.length>Is?a.slice(0,Is):a,c=(e=>[...(new DOMParser).parseFromString(e,"text/html").querySelectorAll(".ts")].map((e=>{const t=e.nextElementSibling,n=t?.nextSibling,o=e=>e?[...e.childNodes].reduce(((e,t)=>{if(t.nodeType===Node.TEXT_NODE)e+=t.textContent;else if(t.nodeType===Node.ELEMENT_NODE)if("A"===t.tagName)e+=t.getAttribute("href");else if("BR"===t.tagName)return e;return e}),"").trim():"";if(t?.classList.contains("mn")&&n){let s="";if(n.nodeType===Node.ELEMENT_NODE)s=o(n);else if(n.nodeType===Node.TEXT_NODE){const e=t.nextElementSibling;s=e&&"A"===e.tagName?`${n.textContent.trim()} ${e.getAttribute("href")}`:n.textContent.trim()}if(!s){s=o(t.nextSibling)}return{time:e.textContent.trim().replace(/[\[\]]/g,""),username:t.textContent.trim().replace(/<|>/g,""),message:s||null}}const s=e.nextElementSibling;if(s&&s.classList.contains("mne")){const t=s.textContent.trim();return{time:e.textContent.trim().replace(/[\[\]]/g,""),username:"SYSTEM",message:t||null}}return null})).filter(Boolean))(l),d=a.length>Is,u=[];let m=null;for(const e of c){const t=e.message!==m?.message,n=e.username!==m?.username;(t||n)&&(u.push(e),m=e)}const p=u.filter((e=>!qs.includes(e.username))),g=(l.length/1024).toFixed(2),h=fs();let f="ru"===As?`Размер: ${g} КБ`:`Size: ${g} KB`;if(f+=d?"ru"===As?" (Достигнут лимит файла)":" (File limit reached)":r?"ru"===As?" (Кэш)":" (Cache)":"",null!==h&&!isNaN(h)){const e=function(e){const t=parseFloat(e);return isNaN(t)?e:t>=1048576?(t/1048576).toFixed(2)+("ru"===As?" ГБ":" GB"):t>=1024?(t/1024).toFixed(2)+("ru"===As?" МБ":" MB"):t.toFixed(2)+("ru"===As?" КБ":" KB")}(h);f+="ru"===As?` | Кэш: ${e}`:` | Cache: ${e}`}return{chatlogs:p,url:n,size:l.length,info:d?"ru"===As?"Достигнут лимит размера файла.":"File size limit reached.":r?"ru"===As?"Загружено из кэша.":"Loaded from cache.":null,error:null,placeholder:f}};async function Bs(e){const t=document.querySelector(".chat-logs-panel");if(t)return t.remove(),void nt("hide");B();const n=document.createElement("div");n.className="chat-logs-panel popup-panel";const o=document.createElement("div");o.className="panel-header";const s=document.createElement("div");s.className="panel-control-buttons";const a=document.createElement("div");a.className="search-for-chatlogs-messages";const r=document.createElement("input");function i(){requestAnimationFrame((function(){r.focus()}))}r.className="chatlogs-search-input",r.type="text",Ge(r,{en:["[Ctrl + Click] clear input and reset filtered items","[Valid date + Enter] load chat logs for the date in input field (e.g. 2023-10-01, 2023:10:01, 231001, 2310, 2310:01)"],ru:["[Ctrl + Click] очистить поле и сбросить фильтр","[Корректная дата + Enter] загрузить чат-логи за выбранную дату (например, 2023-10-01, 2023:10:01, 231001, 2310, 2310:01)"]}),a.appendChild(r),o.appendChild(a),r.addEventListener("input",(()=>F(r.value))),r.addEventListener("click",(e=>{e.ctrlKey&&(r.value="",F(r.value))})),r.addEventListener("keydown",(async e=>{const t=r.value;if("Enter"===e.key){let e=t;/^\d{8}$/.test(t)?(e=6===t.length?"20"+t:t,e=e.replace(/(\d{4})(\d{2})(\d{2})/,"$1-$2-$3")):/^\d{6}$/.test(t)&&(e="20"+t.replace(/(\d{2})(\d{2})(\d{2})/,"$1-$2-$3"));if(/^\d{2,4}[:\-]\d{2}[:\-]\d{2}$/.test(e.replace(/:/g,"-"))&&!isNaN(new Date(e.replace(/:/g,"-")).getTime()))await H(e),d(u);else{const e="ru"===Y()?["Пожалуйста, введите корректную дату.","","Допустимые форматы:","1. гггг-мм-дд","2. гггг:мм:дд","3. гг-мм-дд","4. гг:мм:дд","5. ггггммдд","6. ггммдд",""].join("\n"):["Please enter a valid date.","","Valid formats include:","1. yyyy-mm-dd","2. yyyy:mm:dd","3. yy-mm-dd","4. yy:mm:dd","5. yyyymmdd","6. yymmdd",""].join("\n");alert(e)}r.value=""}})),i();const l=document.createElement("div");l.className="large-button panel-header-parse-button",l.innerHTML=Be,Ge(l,{en:"\n      [Click] to parse Chat Logs\n      [Ctrl + Click] to delete stored Chat Logs from IndexedDB\n    ",ru:"\n      [Клик] спарсить логи чата\n      [Ctrl + Клик] удалить сохранённые логи из IndexedDB\n    "}),Ns(l,n),s.appendChild(l);const c=document.createElement("div");function d(e){"none"===e.style.display&&(e.style.display="flex")}c.className="large-button panel-header-date-button",c.innerHTML=Ce,c.addEventListener("click",(()=>{var e;(e=u).style.display="none"===e.style.display?"flex":"none"}));const u=document.createElement("input");u.type="date",u.className="chatlogs-date-input",u.style.display="none",s.appendChild(c),s.appendChild(u);const m=document.createElement("div");m.className="large-button panel-header-toggle-mention-messages-button",m.innerHTML=de,Ge(m,{en:"Toggle Mention Messages",ru:"Показать только упоминания"}),m.addEventListener("click",(async()=>{z("mention")}));const p=document.createElement("div");p.className="toggle-mention-messages-counter",p.textContent="0",m.appendChild(p),s.appendChild(m);const g=document.createElement("div");g.className="large-button panel-header-toggle-media-messages-button",g.innerHTML=me,Ge(g,{en:"Toggle Media Messages",ru:"Показать только медиа контент"}),g.addEventListener("click",(async()=>{z("media")}));const h=document.createElement("div");h.className="toggle-media-messages-counter",h.textContent="0",g.appendChild(h),s.appendChild(g);const f=document.createElement("div");f.className="large-button panel-header-copy-button",f.innerHTML=ke,Ge(f,{en:" \n      [Click] to copy Chat Logs Url\n      [Ctrl + Click] to save Chat Logs with title\n      [Shift + Click] to show/hide saved Chat Logs\n      [Alt + Click] to copy Chat Logs in BBCode, Markdown, or Plain format\n      [Alt + Shift + Click] to save Chat Logs in BBCode, Markdown, or Plain format\n    ",ru:" \n      [Клик] скопировать ссылку на чат-логи\n      [Ctrl + Клик] сохранить чат-логи с заголовком\n      [Shift + Клик] показать/скрыть сохранённые чат-логи\n      [Alt + Клик] скопировать чат-логи в BBCode, Markdown или Plain\n      [Alt + Shift + Клик] сохранить чат-логи в BBCode, Markdown или Plain\n    "});const y=e=>{const t=e.match(/(\d{4}-\d{2}-\d{2})/);return t?t[1]:null};function v(e,t){t&&(t.replaceChildren(),e.forEach((({url:e,title:n})=>{const o=y(e),s=document.createElement("div");s.classList.add("saved-chatlog-url-wrapper");const a=document.createElement("a");a.classList.add("saved-chatlog-url"),a.textContent=o,a.href=e;const r=document.createElement("span");r.classList.add("saved-chatlog-url-title"),r.textContent=n||"➕",s.appendChild(a),s.appendChild(r),t.appendChild(s)})))}f.addEventListener("click",(e=>{let t=document.querySelector(".saved-chatlog-container");!t&&!e.shiftKey&&T(f,0,0),!t||e.ctrlKey||t.contains(e.target)||t.remove();let n=JSON.parse(localStorage.getItem("savedChatlogs"))||[];if(e.altKey){const o={1:"bbcode",2:"markdown",3:"plain"};let s=prompt("Export format? (1 = BBCode, 2 = Markdown, 3 = Plain)","1");s||(s="1");let a=o[s.trim()];a||(a="bbcode");const r=Array.from(document.querySelectorAll(".chat-logs-container > .date-item, .chat-logs-container > .message-item")),i=e=>{let t=I[e];t||(t=Math.floor(Math.random()*(210/j))*j,I[e]=t);const n=t,[o,s,a]=function(e,t,n){t/=100,n/=100;let o=(1-Math.abs(2*n-1))*t,s=o*(1-Math.abs(e/60%2-1)),a=n-o/2,r=0,i=0,l=0;return 0<=e&&e<60?(r=o,i=s,l=0):60<=e&&e<120?(r=s,i=o,l=0):120<=e&&e<180?(r=0,i=o,l=s):180<=e&&e<240?(r=0,i=s,l=o):240<=e&&e<300?(r=s,i=0,l=o):300<=e&&e<360&&(r=o,i=0,l=s),r=Math.round(255*(r+a)),i=Math.round(255*(i+a)),l=Math.round(255*(l+a)),[r,i,l]}(n,80,50),r=function(e,t,n){return"#"+[e,t,n].map((e=>e.toString(16).padStart(2,"0"))).join("")}(o,s,a);return{bb:r,hex:r}};function l(e,t){if(!e)return"";let n="";for(const o of e.childNodes)o.nodeType===Node.TEXT_NODE?n+=o.textContent:o.nodeType===Node.ELEMENT_NODE&&(o.classList.contains&&o.classList.contains("search-match")?n+="bbcode"===t?`[u]${l(o,t)}[/u]`:"markdown"===t?`*${l(o,t)}*`:l(o,t):"IMG"===o.tagName?n+=o.getAttribute("alt")||o.getAttribute("title")||"":"A"===o.tagName?n+=o.textContent:n+=l(o,t));return n}let c="",d=!0;"bbcode"===a.toLowerCase()&&(c="[hide]\n");let m="";for(const p of r)if(p.classList.contains("date-item")){if("hidden"===p.style.contentVisibility||"0"===p.style.fontSize)continue;const g=p.textContent.trim();m=g,d||("bbcode"===a.toLowerCase()||a.toLowerCase(),c+="\n"),"bbcode"===a.toLowerCase()?c+=`[b][color=gray]${g}[/color][/b]\n`:"markdown"===a.toLowerCase()?c+=`**${g}**\n`:c+=`${g}\n`,d=!1}else if(p.classList.contains("message-item")){if("hidden"===p.style.contentVisibility||"0"===p.style.fontSize)continue;const h=p.querySelector(".message-time")?.textContent||"",b=p.querySelector(".message-username")?.textContent||"",w=l(p.querySelector(".message-text"),a)||"",S=i(b),C=`https://klavogonki.ru/chatlogs/${m||u.value||x}.html#${h}`;if("bbcode"===a.toLowerCase()){let k=w;k=k.replace(/(^|\s|\():(\w+):(?=\s|\.|,|!|\?|$)/g,((e,t,n)=>`${t}[img]https://klavogonki.ru/img/smilies/${n}.gif[/img]`)),c+=`[url=${C}]${h}[/url] [color=${S.hex}]${b}[/color] ${k}\n`}else"markdown"===a.toLowerCase()?c+=`[${h}](${C}) **${b}** ${w}\n`:c+=`[${h}] (${b}) ${w}\n`;d=!1}if("bbcode"===a.toLowerCase()&&(c+="[/hide]\n"),!c)return;if(e.altKey&&e.shiftKey){const E=new Blob([c],{type:"text/plain"}),$=document.createElement("a");$.href=URL.createObjectURL(E),$.download=`chatlogs_${u.value||x}_${a}.txt`,document.body.appendChild($),$.click(),setTimeout((()=>{document.body.removeChild($)}),100)}else e.altKey&&navigator.clipboard.writeText(c).catch((()=>{alert("Failed to copy chatlogs.")}))}else if(e.ctrlKey&&!e.target.closest(".saved-chatlog-url")){const L=y(D);if(!L)return;const M=prompt("Enter a title for this chat log:","➕");n.some((e=>y(e.url)===L))||(n.push({url:D,title:M||"➕"}),n.sort(((e,t)=>{const n=y(e.url),o=y(t.url);return new Date(n)-new Date(o)})),localStorage.setItem("savedChatlogs",JSON.stringify(n))),v(n,t)}else e.shiftKey?n.length>0&&!t&&(t=document.createElement("div"),t.classList.add("saved-chatlog-container"),v(n,t),f.appendChild(t)):navigator.clipboard.writeText(D).catch((e=>console.error("Failed to copy: ",e)))})),s.appendChild(f);const b=localStorage.getItem("shouldShowActiveUsers")||(localStorage.setItem("shouldShowActiveUsers","shown"),"shown"),S=document.createElement("div");function C(e){S.innerHTML="shown"===e?Se:we,Ge(S,"shown"===e?{en:"Hide User List",ru:"Скрыть список пользователей"}:{en:"Show User List",ru:"Показать список пользователей"})}S.className="large-button panel-header-toggle-button",C(b),S.addEventListener("click",(function(){const e="shown"===localStorage.getItem("shouldShowActiveUsers")?"hidden":"shown";if(localStorage.setItem("shouldShowActiveUsers",e),C(e),"shown"===e)bs(O,n,I);else{const e=n.querySelector(".active-users");e&&n.removeChild(e)}})),s.appendChild(S);const k=document.createElement("div");k.className="large-button panel-header-one-day-back-button",k.innerHTML=Ee,Ge(k,{en:"Previous Day",ru:"Предыдущий день"});const E=document.createElement("div");E.className="large-button panel-header-one-day-forward-button",E.innerHTML=$e,Ge(E,{en:"Next Day",ru:"Следующий день"});const $=document.createElement("div");function L(){return u.value?new Date(u.value):new Date}$.className="large-button panel-header-shuffle-button",$.innerHTML=Le,Ge($,{en:"Random Date",ru:"Случайная дата"});k.addEventListener("click",(async()=>{const e=L();e.setDate(e.getDate()-1),await H(e),d(u),i()})),E.addEventListener("click",(async()=>{const e=L();e.setDate(e.getDate()+1),await H(e),d(u),i()})),$.addEventListener("click",(async()=>{if("loadToday"===$.dataset.mode)await H(x),$.dataset.mode="",$.classList.remove("today");else{const e=function(){const e=new Date(w),t=new Date-e,n=Math.floor(Math.random()*t),o=new Date(e.getTime()+n);return new Intl.DateTimeFormat("en-CA").format(o)}();await H(e)}$.innerHTML=Le,Ge($,{en:"Random Date",ru:"Случайная дата"}),d(u),i()})),s.appendChild(k),s.appendChild(E),s.appendChild($);const N=document.createElement("div");N.className="large-button panel-header-close-button",N.innerHTML=he,Ge(N,{en:"Close panel",ru:"Закрыть панель"}),N.addEventListener("click",(()=>{tt(n,"hide"),nt("hide")})),s.appendChild(N),o.appendChild(s);const q=document.createElement("div");q.className="chat-logs-container",n.appendChild(o),n.appendChild(q),document.body.appendChild(n);const{scrollButtonsContainer:A}=at(q);n.appendChild(A),tt(n,"show"),nt("show");const I={},j=15,O=new Map;let D="";const H=async e=>{const t=new Intl.DateTimeFormat("en-CA").format(new Date((e=>/^\d{4}:\d{2}:\d{2}$/.test(e)?e.replace(/:/g,"-"):e)(e)));if(t<w||t>x){const e=Y();return void alert(t<w?"ru"===e?`Выбранная дата не может быть раньше ${w}.`:`The selected date cannot be earlier than ${w}.`:"ru"===e?"Вы не можете загрузить будущую дату.":"You cannot load a future date.")}(e=>{u.value=e;const t={en:`Current date: ${e}`,ru:`Текущая дата: ${e}`};Ge(u,t),Ge(c,t)})(t);const{chatlogs:o,url:s,placeholder:a}=await Os(t,q);r.placeholder=a,D=s,O.clear();const i=vs(o,q,I);O.clear();for(const[e,t]of i.entries())O.set(e,t);bs(O,n,I),requestAnimationFrame((()=>{Ao("chatlogsMessages"),zo("chatlogsMessages"),Ot("chatlogsMessages"),Nt("chatlogsMessages"),q.scrollTop=q.scrollHeight,h.textContent=document.querySelectorAll(".chat-logs-container .media").length,p.textContent=document.querySelectorAll(".chat-logs-container .mention").length,function(){if(q.childElementCount>0){const e="ru"===Y()?"Всего сообщений":"Total messages";r.placeholder+=` | ${e}: ${q.childElementCount}`}}(),r.value.length>0&&F(r.value),z(null,!1)}))},P=e||x;function F(e){if(/^[\d-:]+$/.test(e.trim()))return;function t(e){return e.replace(/[_-]/g," ").toLowerCase()}const n=t(e).trim(),o=Array.from(document.querySelectorAll(".chat-logs-container > .date-item, .chat-logs-container > .message-item")),s=o.filter((e=>e.classList.contains("message-item"))),a=function(e){return e.map((e=>{const t=e.querySelector(".message-username"),n=t?t.textContent.toLowerCase().trim():"",o=e.querySelector(".message-text");return{username:n,messageText:o?o.textContent.toLowerCase().trim():""}}))}(s),r=!n,i=n.split(",").map((e=>e.trim())).filter(Boolean),l=i.filter((e=>a.some((n=>t(n.username)===e)))).length>=2;s.forEach(((e,o)=>{const s=e.closest(".message-item"),c=a[o];let d=!1;const u=t(c.username),m=t(c.messageText);d=!!r||(l?i.some((e=>u===e)):u.includes(n)||m.includes(n)),s.style.contentVisibility=d?"visible":"hidden",s.style.fontSize=d?"":"0"}));const c=o.filter((e=>e.classList.contains("date-item")));for(let e=0;e<c.length;e++){const t=c[e];let n=o.indexOf(t)+1,s=!1;for(;n<o.length&&!o[n].classList.contains("date-item");){const e=o[n];if(e.classList.contains("message-item")&&"hidden"!==e.style.contentVisibility&&"0"!==e.style.fontSize){s=!0;break}n++}t.style.contentVisibility=s?"visible":"hidden",t.style.fontSize=s?"":"0"}}await H(P),e&&d(u),u.max=x,u.min=w,u.value=P,Ge(c,{en:`Current date: ${P}`,ru:`Текущая дата: ${P}`}),u.addEventListener("change",(async e=>{const t=e.target.value;await H(t),Ge(c,{en:`Current date: ${t}`,ru:`Текущая дата: ${t}`})})),js.handleChatLogsKeydown=e=>{"Escape"===e.key&&(tt(n,"hide"),nt("hide"),document.removeEventListener("keydown",js.handleChatLogsKeydown))},document.addEventListener("keydown",js.handleChatLogsKeydown),n.addEventListener("click",(async e=>{if(e.target.closest("a"))return;const t=e.target.closest(".message-item"),n=e.target.closest(".message-time"),o=e.target.closest(".message-username"),s=e.target.closest(".message-text");if(t||s){if(U={media:!1,mention:!1},m.classList.remove("active"),g.classList.remove("active"),r.value="",F(""),n){let t=u.value;const o=n.textContent;if(e.shiftKey){if(e.preventDefault(),e.stopPropagation(),n.closest(".chat-logs-container")){let e=n.parentElement;for(;e&&!e.classList.contains("date-item");)e=e.previousElementSibling;e&&e.classList.contains("date-item")&&(t=e.textContent.trim())}return void K(t,o,n)}const s=`https://klavogonki.ru/chatlogs/${t}.html#${o}`;return void window.open(s,"_blank","noopener,noreferrer")}if(o){const e=o.textContent,t=await async function(e){const t=JSON.parse(localStorage.getItem("userIdsCache")||"{}");if(t[e])return t[e];try{const n=await nn(e);if(n)return t[e]=n,localStorage.setItem("userIdsCache",JSON.stringify(t)),n}catch(t){console.error(`Error fetching user ID for ${e}:`,t)}return null}(e);if(t){const e=`https://klavogonki.ru/u/#/${t}/`;window.open(e,"_blank","noopener,noreferrer")}else M(o);return}requestAnimationFrame((async()=>{await Gt(q,t)}))}})),Ge(".message-time",n,(e=>({en:` \n      [Click] Open chatlog at ${e.textContent}\n      [Shift + Click] Copy chatlogs URL to clipboard\n    `,ru:` \n      [Клик] открыть чатлог на ${e.textContent}\n      [Shift + Клик] скопировать ссылку на чатлог\n   `})),!0),Ge(".message-username",n,(e=>({en:`[Click] Open ${e.textContent} profile`,ru:`[Клик] открыть профиль ${e.textContent}`})),!0),Ge(".message-text",n,(e=>({en:"[Click] Scroll message to the middle of the chat logs",ru:"[Клик] прокрутить сообщение к центру чата"})),!0),n.addEventListener("click",(e=>{const t=e.target.closest(".active-user-item");if(t){const n=t.querySelector(".active-user-name"),o=n?.textContent;if(!o)return;const s=r.value.trim(),a=e.ctrlKey?`, ${o}`:o;r.value=s===o?"":e.ctrlKey&&!s.includes(o)?s+a:o,F(r.value)}})),Ge(".active-user-name",n,(e=>({en:`\n      [Click] to filter messages by ${e.textContent}\n      [Repeat Click] to clear ${e.textContent} from the search input\n      [Ctrl + Click] to add additional username to the search input\n    `,ru:` \n      [Клик] фильтровать сообщения по ${e.textContent}\n      [Повторный клик] убрать ${e.textContent} из поиска\n      [Ctrl + Клик] добавить пользователя к поиску\n    `})),!0),Ge(".saved-chatlog-url",n,(e=>({en:`\n      [Click] Load chat logs for ${e.textContent}\n      [Ctrl + Click] Remove this saved chat log\n      [Middle Click]Open in new tab\n    `,ru:`\n      [Клик] загрузить чат - логи за ${e.textContent}\n      [Ctrl + Клик] удалить сохранённый чатлог\n      [Средний клик] открыть в новой вкладке\n    `})),!0),Ge(".saved-chatlog-url-title",n,(e=>({en:"[Click] Edit title for this chat log",ru:"[Клик] изменить заголовок для этого чатлога"})),!0),n.addEventListener("click",(async e=>{const t=e.target.closest(".saved-chatlog-url");if(t){e.preventDefault();let n=JSON.parse(localStorage.getItem("savedChatlogs"))||[];if(e.ctrlKey){const e=t.href,o=n.filter((t=>t.url!==e));if(o.length!==n.length){n=o,localStorage.setItem("savedChatlogs",JSON.stringify(n));const e=t.closest(".saved-chatlog-url-wrapper");e&&e.remove()}}else if(1===e.button)window.open(t.href,"_blank","noopener,noreferrer");else{const e=t.textContent;await H(e)}return}const n=e.target.closest(".saved-chatlog-url-title");if(n){let e=JSON.parse(localStorage.getItem("savedChatlogs"))||[];const t=n.closest(".saved-chatlog-url-wrapper"),o=t&&t.querySelector(".saved-chatlog-url");if(!o)return;const s=o.href,a=prompt("Enter a new title for this chat log:",n.textContent);if(null!==a&&a!==n.textContent){n.textContent=a;const t=e.findIndex((e=>e.url===s));-1!==t&&(e[t].title=a,localStorage.setItem("savedChatlogs",JSON.stringify(e)))}}else;}));let U={media:!1,mention:!1};function z(e,t=!0){if(t&&e){const t="mention"===e;U={media:!!("media"===e)&&!U.media,mention:!!t&&!U.mention}}q.querySelectorAll(".message-item").forEach((e=>{const t=e.querySelector(".media"),n=e.querySelector(".mention");U.media?(e.style.contentVisibility=t?"visible":"hidden",e.style.fontSize=t?"":"0"):U.mention?(e.style.contentVisibility=n?"visible":"hidden",e.style.fontSize=n?"":"0"):(e.style.contentVisibility="visible",e.style.fontSize="")})),m.classList.toggle("active",U.mention),g.classList.toggle("active",U.media)}}let{panelsEvents:Ds}=k;function Hs(e){const t=document.createElement("div");t.classList.add("empowerment-button","personal-messages-button"),t.innerHTML=de;const n=document.createElement("div");n.classList.add("message-count","total-message-count");const o=JSON.parse(localStorage.getItem("personalMessages"))||{};n.textContent=Object.keys(o).length,t.appendChild(n);const s=document.createElement("div");s.classList.add("message-count","new-message-count");let a=Number(localStorage.getItem("newMessagesCount"))||(localStorage.setItem("newMessagesCount","0"),0);s.textContent=a,s.style.visibility=a>0?"visible":"hidden",t.appendChild(s),Ge(t,{en:"Open Messages",ru:"Открыть сообщения"}),t.addEventListener("click",(function(){N(t),_s();Object.keys(JSON.parse(localStorage.getItem("personalMessages"))||{}).length>0&&(localStorage.setItem("newMessagesCount","0"),a=0,s.textContent=a)})),e.appendChild(t)}async function Ps(e,t,n){const o=document.querySelector(".messages-content");if(!o)return null;const s=e=>String(e||"").replace(/\s+/g,"").trim().toLowerCase(),a=s(t),r=s(e),i=Array.from(o.querySelectorAll("p")).find((e=>{const t=e.querySelector(".username span[data-user]");if(t){const n=s(t.textContent),o=s(function(e){let t="";for(let n of e.childNodes)n.nodeType===Node.TEXT_NODE?t+=n.textContent:n.nodeType===Node.ELEMENT_NODE&&(n.classList.contains("time")||n.classList.contains("username")||(t+=n.textContent));return t.trim()}(e));if(n===a&&o===r)return!0}return!1}));return i&&n&&await Gt(o,i),i||!1}function Fs(e){const t=180- -(new Date).getTimezoneOffset(),[n,o,s]=e.split(":").map(Number);let a=60*n+o+t;a=(a%1440+1440)%1440;const r=a%60;return`${Math.floor(a/60).toString().padStart(2,"0")}:${r.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`}function Us(e,t="single"){const n=e.querySelector(".message-time").textContent,o=e.querySelector(".message-username").textContent;let s=JSON.parse(localStorage.getItem("personalMessagesBackup"))||{};if(0===Object.keys(s).length){s={...JSON.parse(localStorage.getItem("personalMessages"))||{}},localStorage.setItem("personalMessagesBackup",JSON.stringify(s))}let a={...s};if("all"===t)document.querySelectorAll(".message-item").forEach((e=>{const t=e.querySelector(".message-username").textContent;if(t===o){e.remove();const n=e.querySelector(".message-time").textContent;delete a[`[${n}]_${t}`]}}));else if("from"===t){const t=Array.from(document.querySelectorAll(".message-item"));for(let n=t.indexOf(e);n<t.length;n++){const e=t[n],s=e.querySelector(".message-username").textContent;if(s===o){e.remove();const t=e.querySelector(".message-time").textContent;delete a[`[${t}]_${s}`]}}}else{const t=`[${n}]_${o}`;a[t]&&(delete a[t],e.remove())}localStorage.setItem("personalMessagesBackup",JSON.stringify(a));const r=document.querySelector(".personal-messages-button .total-message-count");r&&(r.textContent=Object.keys(a).length)}function zs(){const e=Object.keys(JSON.parse(localStorage.getItem("personalMessages")||"{}")).length;document.querySelector(".personal-messages-button .total-message-count").textContent=e}async function _s(){const e=document.querySelector(".cached-messages-panel");if(e)return e.remove(),void nt("hide");let t=!0,n=!1;zs(),localStorage.getItem("personalMessagesBackup")&&localStorage.removeItem("personalMessagesBackup"),B();const o=document.querySelector(".personal-messages-button .new-message-count");function s(){const e=localStorage.getItem("personalMessages");return JSON.parse(e)||{}}o&&(o.textContent="0"),o.style.visibility="hidden",localStorage.removeItem("newMessagesCount");let a=s();const r=document.createElement("div");r.className="cached-messages-panel popup-panel";const i=document.createElement("div");i.className="panel-header";const l=document.createElement("div");l.className="search-for-personal-messages";const c=document.createElement("input");c.className="personal-messages-search-input",c.type="search",Ge(c,{en:"[Ctrl + Click] to clear search input and display all personal messages",ru:"[Ctrl + Click] чтобы очистить поиск и показать все личные сообщения"}),l.appendChild(c);const d=document.createElement("div");d.className="panel-control-buttons";const u=document.createElement("div");u.className="large-button panel-header-save-button",u.innerHTML=Ae,Ge(u,{en:"Save messages",ru:"Сохранить сообщения"}),u.style.opacity="0",u.addEventListener("click",(()=>{const e=localStorage.getItem("personalMessagesBackup"),n=localStorage.getItem("personalMessages"),o=e&&n;if(o&&o&&n!==e&&!t){window.confirm("Do you want to apply changes?")&&(localStorage.setItem("personalMessages",e),localStorage.removeItem("personalMessagesBackup"),u.style.setProperty("display","none","important"),u.style.opacity="0",u.addEventListener("transitionend",(function(){u.style.display="none"})))}}));const m=document.createElement("div");m.className="large-button panel-header-import-button",m.innerHTML=Ne,Ge(m,{en:"Import messages",ru:"Импортировать сообщения"}),m.addEventListener("click",(()=>{n=!0;const e=document.createElement("input");e.type="file",e.accept=".json",e.addEventListener("change",(e=>{const t=e.target.files[0];if(t){const e=new FileReader;e.onload=async()=>{try{const t=JSON.parse(e.result),n={...JSON.parse(localStorage.getItem("personalMessages")||"{}"),...t},o=Object.fromEntries(Object.entries(n).sort((([,e],[,t])=>{const n=e.time.replace(/[[\]]/g,""),o=t.time.replace(/[[\]]/g,""),s=`${e.date} ${n}`,a=`${t.date} ${o}`;return new Date(s)-new Date(a)})));localStorage.setItem("personalMessages",JSON.stringify(o)),zs();const a=s();await $(a)}catch(e){alert("Failed to import messages. The file may be corrupted.")}},e.readAsText(t)}})),e.click()}));const p=document.createElement("div");p.className="large-button panel-header-export-button",p.innerHTML=qe,Ge(p,{en:"Export messages",ru:"Экспортировать сообщения"}),p.addEventListener("click",(()=>{const e=localStorage.getItem("personalMessages");if(e&&"{}"!==e){const t=new Intl.DateTimeFormat("en-CA").format(new Date),n=JSON.parse(e),o=JSON.stringify(n,null,2),s=new Blob([o],{type:"application/json"}),a=document.createElement("a");a.href=URL.createObjectURL(s),a.download=`Personal_Messages_${t}.json`,a.click()}else alert("No messages to export.")}));const g=document.createElement("div");g.className="large-button panel-header-copy-button",g.innerHTML=ke,Ge(g,{en:"Copy Personal Messages",ru:"Скопировать личные сообщения"}),g.addEventListener("click",(()=>{let e=!1;const t=Array.from(document.querySelector(".messages-container").children).filter((e=>{const t=window.getComputedStyle(e);return"hidden"!==t.contentVisibility&&"none"!==t.display})).map((t=>{if(t.classList.contains("date-item")){const n=t.textContent.trim();return e?"\n"+n:(e=!0,n)}{const e=t.querySelector(".message-time")?.textContent.trim(),n=t.querySelector(".message-username")?.textContent.trim(),o=t.querySelector(".message-text");return[e?`[${e}]`:"",n?`(${n})`:"",(o?X(o):"")||""].filter(Boolean).join(" ")}})).filter(Boolean).join("\n");t.trim()?(T(g,0,0),navigator.clipboard.writeText(t).catch(console.error)):alert("No messages to copy.")}));const h=document.createElement("div");h.className="large-button panel-header-clear-button",Ge(h,{en:"Clear personal messages",ru:"Очистить личные сообщения"}),h.innerHTML=Me,h.addEventListener("click",(()=>{n=!0;const e=JSON.parse(localStorage.getItem("personalMessages")||"{}");if(0===Object.keys(e).length)return void alert("No messages to delete.");y.innerHTML=null,localStorage.setItem("personalMessages",JSON.stringify({})),tt(r,"hide"),nt("hide");const t=document.querySelector(".personal-messages-button .total-message-count");t&&(t.textContent="0")}));const f=document.createElement("div");f.className="large-button panel-header-close-button",Ge(f,{en:"Close panel",ru:"Закрыть панель"}),f.innerHTML=he,f.addEventListener("click",(()=>{tt(r,"hide"),nt("hide")})),i.appendChild(l),d.appendChild(u),d.appendChild(m),d.appendChild(p),d.appendChild(g),d.appendChild(h),d.appendChild(f),i.appendChild(d),r.appendChild(i);const y=document.createElement("div");y.className="messages-container";let v=null,b=null,w=0,S=100;const C=[],k={private:"coral",mention:"darkseagreen"},E={private:"coral",mention:"lightsteelblue",default:"slategray"};async function $(e){y.children.length&&y.replaceChildren(),Object.entries(e).forEach((([,{time:e,date:t,username:n,usernameColor:o,message:s,type:a,userId:r}])=>{if(v!==t){const e=document.createElement("div");e.className="date-item",e.textContent=t===x?"Today ⏳":`${t} 📅`,e.dataset.date=t,y.appendChild(e),v=t}const i=document.createElement("div");i.className="message-item",n!==b&&(i.style.marginTop="0.6em",b=n);const l=e.replace(/[\[\]]/g,"").trim(),c=document.createElement("span");c.className="message-time",c.textContent=l,c.style.color=k[a]||"slategray";const d=document.createElement("span");d.className="message-username",d.textContent=n,d.style.color=o;const u=document.createElement("span");u.className="message-text",u.innerHTML=s.replace(/:(?=\w*[a-zA-Z])(\w+):/g,((e,t)=>`<img src="/img/smilies/${t}.gif" alt=":${t}:" title=":${t}:" class="smile">`)).replace(/(https?:\/\/[^\s]+)/gi,(e=>`<a href="${e}" target="_blank" rel="noopener noreferrer">${e}</a>`));const m={messageTextElement:u,time:e,username:n,type:a};C.push(m),i.appendChild(c),i.appendChild(d),i.appendChild(u),y.appendChild(i)})),requestAnimationFrame((()=>{Ao("personalMessages"),zo("personalMessages"),Ot("personalMessages"),Nt("personalMessages"),y.scrollTop=y.scrollHeight,new MutationObserver((e=>{n||e.find((e=>"childList"===e.type&&e.removedNodes.length>0))&&"0"===u.style.opacity&&(t=!1,u.style.visibility="visible",u.style.display="flex",u.offsetHeight,u.style.opacity="1",u.style.transition="opacity 0.5s ease")})).observe(y,{childList:!0,subtree:!0}),setTimeout((()=>{n=!1}),500)})),C.reverse().forEach((async({messageTextElement:e,username:t,type:n})=>{let o=!1;if(w<S){const n=e.textContent;try{const e=await Ps(n,t,!1);o=Boolean(e),w++,w>=S&&console.log("Reached maximum ping checks limit.")}catch(e){console.error("Error checking for pingable message:",e),o=!1}}e.style.color=o&&"mention"===n?"lightgreen":o&&"private"===n?"lemonchiffon":E[n]||E.default}))}await $(a),r.appendChild(y),document.body.appendChild(r);const{scrollButtonsContainer:L}=at(y);r.appendChild(L),tt(r,"show"),nt("show"),c.addEventListener("click",(e=>{e.ctrlKey&&(c.value="",c.dispatchEvent(new Event("input",{bubbles:!0})))})),c.addEventListener("input",(()=>{const e=c.value.toLowerCase().replace(/_/g," ");y.querySelectorAll(".date-item").forEach((t=>{let n=!1,o=t.nextElementSibling;for(;o&&!o.classList.contains("date-item");){const t=o.querySelector(".message-time")?.textContent.toLowerCase().replace(/_/g," ")||"",s=o.querySelector(".message-username")?.textContent.toLowerCase().replace(/_/g," ")||"",a=o.querySelector(".message-text"),r=(t+" "+s+" "+(a?X(a).toLowerCase().replace(/_/g," "):"")).includes(e);o.style.contentVisibility=r?"visible":"hidden",o.style.fontSize=r?"":"0",n=n||r,o=o.nextElementSibling}t.style.display=n?"":"none"}))})),requestAnimationFrame((function(){c.focus()})),Ds.handlePersonalMessagesKeydown=e=>{"Escape"===e.key&&(tt(r,"hide"),nt("hide"),document.removeEventListener("keydown",Ds.handlePersonalMessagesKeydown))},document.addEventListener("keydown",Ds.handlePersonalMessagesKeydown),Ge(".message-time",r,(e=>({en:`\n      [Click] Open chatlog at ${Fs(e.textContent)}\n      [Shift + Click] Copy chatlogs URL to clipboard\n      [Ctrl + Click] Remove all messages starting from ${Fs(e.textContent)}\n    `,ru:`\n      [Клик] Открыть чатлог в ${Fs(e.textContent)}\n      [Shift + Клик] Скопировать ссылку на чатлог\n      [Ctrl + Клик] Удалить все сообщения начиная с ${Fs(e.textContent)}\n    `})),!0),Ge(".message-username",r,(e=>({en:`\n      [Click] Open ${e.textContent} profile\n      [Ctrl + Click] Remove all messages from ${e.textContent} user\n    `,ru:`\n      [Клик] Открыть профиль ${e.textContent}\n      [Ctrl + Клик] Удалить все сообщения пользователя ${e.textContent}\n    `})),!0),Ge(".message-text",r,(e=>({en:"\n      [Click] Search for this message\n      [Ctrl + Click] Remove only this message\n    ",ru:"\n      [Клик] Найти это сообщение\n      [Ctrl + Клик] Удалить только это сообщение\n    "})),!0),y.addEventListener("mouseover",(function(e){const t=e.target.closest(".message-time");if(t&&y.contains(t)){const e=t.closest(".message-item");if(!e)return;const n=e.querySelector(".message-username")?.textContent,o=Object.values(a).find((e=>e.username===n&&e.time.replace(/[\[\]]/g,"").trim()===t.textContent.trim()))?.type;"mention"!==o&&"private"!==o||(t.style.color="mention"===o?"lightgreen":"peachpuff")}})),y.addEventListener("mouseout",(function(e){const t=e.target.closest(".message-time");if(t&&y.contains(t)){const e=t.closest(".message-item");if(!e)return;const n=e.querySelector(".message-username")?.textContent,o=Object.values(a).find((e=>e.username===n&&e.time.replace(/[\[\]]/g,"").trim()===t.textContent.trim()))?.type;"mention"!==o&&"private"!==o||(t.style.color=k[o]||"slategray")}})),y.addEventListener("click",(async function(e){const t=e.target.closest(".message-time"),n=e.target.closest(".message-username"),o=e.target.closest(".message-text"),s=e.target.closest(".message-item");if(s){if(t&&s.contains(t)){const n=s.querySelector(".message-username")?.textContent,o=Object.values(a).find((e=>e.username===n&&e.time.replace(/\[|\]/g,"").trim()===t.textContent.trim()))?.type;let r,i=s.previousElementSibling;for(;i&&!i.classList.contains("date-item");)i=i.previousElementSibling;if(i&&(r=i.dataset.date),"mention"===o||"private"===o){if(e.shiftKey)return e.preventDefault(),e.stopPropagation(),void K(r,Fs(t.textContent),t);if(e.ctrlKey)return void Us(s,"from");if("mention"===o){const e=`https://klavogonki.ru/chatlogs/${r}.html#${Fs(t.textContent)}`;window.open(e,"_blank","noopener,noreferrer")}}}if(n&&s.contains(n)){if(e.ctrlKey)return void Us(s,"all");const t=Object.values(a).find((e=>e.username===n.textContent))?.userId;if(t){const e=`https://klavogonki.ru/u/#/${t}/`;window.open(e,"_blank","noopener,noreferrer")}else addShakeEffect(n)}if(o&&s.contains(o)){if(e.ctrlKey)return void Us(s,"single");const t=s.querySelector(".message-username")?.textContent,n=s.querySelector(".message-time")?.textContent,i=Object.values(a).find((e=>e.username===t&&e.time.replace(/[\[\]]/g,"").trim()===n.trim())),l=i?.type;if("private"===l)return void requestAnimationFrame((()=>{Ps(o.textContent,t,!0)}));if(await Ps(o.textContent,t,!0))tt(r,"hide"),nt("hide");else{let e=o.parentElement.previousElementSibling;for(;e&&!e.classList.contains("date-item");)e=e.previousElementSibling;if(e){await Bs(e.dataset.date);const n=o.textContent;requestAnimationFrame((()=>{let e=0;const o=setInterval((async()=>{const s=await async function(e,t,n){const o=document.querySelector(".chat-logs-container");if(!o)return null;const s=e=>String(e||"").replace(/\s+/g,"").trim().toLowerCase(),a=s(t),r=s(e),i=Array.from(o.querySelectorAll(".message-item")).find((e=>{const t=e.querySelector(".message-username"),n=e.querySelector(".message-text");if(t&&n){const e=s(t.textContent),o=s(n.textContent);if(e===a&&o===r)return!0}return!1}));return i&&n&&await Gt(o,i),i||!1}(n,t,!0);if(s)clearInterval(o);else if(++e>=10){clearInterval(o);tt(document.querySelector(".chat-logs-panel"),"hide"),_s()}}),200)}))}}}}}))}let Rs=!1;(()=>{Zt();const e=(()=>{const e=document.createElement("div");return e.classList.add("empowerment-panel"),document.body.appendChild(e),e})();if(j("gmid")||j("gamelist")){P("elements","counter")&&Cn(e),function(){const e=getComputedStyle(document.querySelector(".chat .messages")).backgroundColor,t=document.createElement("style");t.innerHTML=`\n    #chat-general .smile-tab, .chat-user-list {\n      background-color: ${e};\n    }\n  `,document.head.appendChild(t)}()}if((j("gmid")||j("gamelist"))&&(function(e){const t={silence:{en:"Do not disturb",ru:"Не беспокоить"},beep:{en:"Notify with beep signal",ru:"Уведомлять звуковым сигналом"},voice:{en:"Notify with voice API",ru:"Уведомлять голосом"}};Pn=document.createElement("div");const n=lt.messageSettings.messageNotificationState||"silence";Pn.classList.add("empowerment-button","sound-switcher-button"),Pn.id=n,Ge(Pn,t[n]),Fn=document.createElement("span"),Fn.classList.add("sound-switcher-icon"),Pn.appendChild(Fn),e.appendChild(Pn),Pn.addEventListener("click",(function(){if(!Ze&&!Qe){switch(document.querySelector(".current-voice-speed")?.remove(),document.querySelector(".current-voice-pitch")?.remove(),N(this),this.id){case"silence":this.id="beep",Ge(this,t.beep),lt.messageSettings.messageNotificationState="beep",lt.messageSettings.messageNotificationTitle=t.beep.en;break;case"beep":this.id="voice",Ge(this,t.voice),lt.messageSettings.messageNotificationState="voice",lt.messageSettings.messageNotificationTitle=t.voice.en;break;case"voice":this.id="silence",Ge(this,t.silence),lt.messageSettings.messageNotificationState="silence",lt.messageSettings.messageNotificationTitle=t.silence.en}localStorage.setItem("KG_Chat_Empowerment",JSON.stringify(lt)),_n()}})),Pn.addEventListener("mousedown",Vn),Pn.addEventListener("contextmenu",(e=>e.preventDefault())),_n()}(e),function(e){const t={"every-message":{en:"Notify about every message",ru:"Уведомлять о каждом сообщении"},"mention-message":{en:"Notify about mention message",ru:"Уведомлять только о сообщениях с упоминанием"}};Qo=document.createElement("div");const n=lt.messageSettings.messageModeState||"every-message";Qo.classList.add("empowerment-button","message-mode-button"),Qo.id=n,Ge(Qo,t[n]),es=document.createElement("span"),es.classList.add("message-mode-icon"),Qo.appendChild(es),e.appendChild(Qo),Qo.addEventListener("click",(function(){Ze||Qe||(N(this),"every-message"===this.id?(this.id="mention-message",Ge(this,t["mention-message"]),lt.messageSettings.messageModeState="mention-message",lt.messageSettings.messageModeTitle=t["mention-message"].en):(this.id="every-message",Ge(this,t["every-message"]),lt.messageSettings.messageModeState="every-message",lt.messageSettings.messageModeTitle=t["every-message"].en),localStorage.setItem("KG_Chat_Empowerment",JSON.stringify(lt)),is())})),is()}(e)),function(e){const t=document.createElement("div");t.classList.add("empowerment-button","cache-panel-load-button"),t.style.position="relative",t.style.zIndex="3",t.innerHTML=userlistCacheSVG;const n=document.createElement("div");n.className="cache-user-count",n.textContent=Object.keys(JSON.parse(localStorage.getItem("fetchedUsers"))||{}).length,t.appendChild(n),Ge(t,{en:"Open Cache",ru:"Открыть кэш"}),t.addEventListener("click",(()=>{addPulseEffect(t),showCachePanel()})),e.appendChild(t)}(e),Hs(e),function(e){const t=document.createElement("div");t.classList.add("empowerment-button","chat-logs-button"),t.style.position="relative",t.style.zIndex="1",t.innerHTML=ue,Ge(t,{en:"Open Chat Logs",ru:"Открыть логи чата"}),t.addEventListener("click",(async function(){N(t),await Bs()})),e.appendChild(t)}(e),Ct(e),function(){const e=document.querySelector(".messages-content div");e?Vo.observe(e,{childList:!0,subtree:!0}):console.warn("Messages container not found!")}(),io?po.observe(io,{childList:!0}):console.warn("User list not found!"),!j("gmid")&&!j("gamelist"))return;const t=new xn;let n=new MutationObserver((()=>{const e=document.querySelector(".messages-content div"),o=document.querySelectorAll(".messages-content div p");document.contains(e)&&(!function(){const e=document.querySelector("#chat-fixed-placeholder");localStorage.getItem("shouldShowPopupMessage")||localStorage.setItem("shouldShowPopupMessage","false"),e.style.display=JSON.parse(localStorage.getItem("shouldShowPopupMessage"))?"none":"unset"}(),o.length>=20&&(n.disconnect(),function(){const{allMessages:e}=Ht();e.forEach((e=>{const t=e.querySelector(".username"),n=t?.textContent?.replace(/[<>]/g,"")||null,o=e.textContent||"";if(n&&Pt.includes(n)){const t=`from-${Ft(n)}`;return e.classList.add("ignored-user",t),void(e.style.display="none")}let s=null;if(/^[^\s,]+,/.test(o)?s=o.split(",")[0].trim():/^[^\s]+ /.test(o)&&(s=o.split(" ")[0].trim()),s&&Pt.includes(s)){const t=`to-${Ft(s)}`;return e.classList.add("ignored-user",t),void(e.style.display="none")}Pt.some((e=>o.includes(e)))&&(Pt.forEach((t=>{if(o.includes(t)){const n=`to-${Ft(t)}`;e.classList.add("ignored-user",n)}})),e.style.display="none")}))}(),Ao("generalMessages"),zo("generalMessages"),Ot("generalMessages"),window.location.href.includes("gmid")&&function(){const{activeChatTab:e,chatField:t}=Ht();e?.click(),t?.focus()}(),function(){const{chatField:e}=Ht();e&&(e.value=localStorage.getItem("inputBackup")||"",e.addEventListener("input",D((()=>{_t(e)||localStorage.setItem("inputBackup",e.value)}),250)),e.addEventListener("keydown",(e=>{"Enter"===e.key&&localStorage.removeItem("inputBackup")})))}(),Nt(),Rt(),Yt("generalMessages",350),Dt(!1,E),yn(),Jt(),t.updateDeletedMessages(),Xt(),function(){const e=document.querySelectorAll(".messages-content p");if(0===e.length)return;const t=new Set(Array.from(e).map((e=>wn(e)))),n=new Set(JSON.parse(localStorage.getItem("deletedChatMessagesContent")||"[]"));localStorage.setItem("deletedChatMessagesContent",JSON.stringify([...n].filter((e=>t.has(e)))))}(),setTimeout((()=>{Go&&(Xo.addEventListener("input",as),Xo.addEventListener("keydown",rs))}),600),setTimeout((()=>Rs=!0),600)))}));n.observe(document,{childList:!0,subtree:!0})})()})();